<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC210 Asistencia t√©cnica a viveros - Datos detallados</title>

  <!-- Estilos -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f5f7fa;
    }

    /* Header general del sitio */
    .header-bar {
      background-color: #0f766e;
      color: #fff;
      padding: 16px 20px;
      text-align: center;
    }
    .header-bar h1 {
      margin: 0 0 4px 0;
      font-size: 22px;
      color: #ffffff;  /* FORZAR BLANCO */
    }
    .header-bar p {
      margin: 0;
      font-size: 13px;
      color: #ffffff;  /* FORZAR BLANCO */
      opacity: 1;      /* SIN TRANSPARENCIA */
    }

    /* Contenedor principal */
    .main-container {
      max-width: 1100px;
      margin: 24px auto 40px auto;
      padding: 0 16px;
    }

    h2 {
      margin-bottom: 5px;
    }
    p {
      margin-top: 0;
      color: #555;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      filter: brightness(0.95);
    }

    #download-csv {
      background-color: #1d9bf0;
      color: white;
    }
    #download-xlsx {
      background-color: #16a34a;
      color: white;
    }
    /* Botones informe por registro */
    #generate-report-word {
      background-color: #f97316;
      color: white;
    }
    #generate-report-pdf {
      background-color: #fb923c;
      color: white;
    }

    /* Barra para informe mensual */
    .monthly-report-bar {
      margin-top: 10px;
      margin-bottom: 10px;
      padding: 10px 12px;
      background-color: #0f766e; /* cuadro azul/verde */
      color: #ffffff;
      border-radius: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .monthly-report-bar label {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
      margin-right: 4px;
    }
    .monthly-report-bar select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #cbd5f5;
      font-size: 13px;
    }
    #generate-monthly-report-word {
      background-color: #0d9488;
      color: white;
    }
    #generate-monthly-report-pdf {
      background-color: #14b8a6;
      color: white;
    }

    #tabla {
      background-color: white;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 10px;
      margin-top: 20px;
      overflow-x: auto;
    }

    /* Estilo visible para la fila seleccionada de Tabulator */
    .tabulator-row.tabulator-selected {
      background-color: #bfdbfe !important; /* azul clarito */
    }

    /* Bot√≥n para regresar al dashboard */
    .back-container {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .back-link {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #1d9bf0;
      color: #1d9bf0;
      font-size: 14px;
      text-decoration: none;
    }
    .back-link:hover {
      background-color: #e0f2ff;
    }
  
    /* === Header moderno (homog√©neo con tableros) === */
    header.site-header{
      background: linear-gradient(90deg, #0f766e, #0e7490);
      color:#fff;
      padding:14px 20px 18px;
      box-shadow:0 2px 10px rgba(15,23,42,0.25);
      position:sticky; top:0; z-index:10;
    }
    .header-inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; flex-wrap:wrap;
    }
    .logo-group{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background-color: rgba(255,255,255,0.12);
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
    }
    .logo-group img{
      height:40px; max-width:130px; object-fit:contain;
      background-color:#fff; border-radius:999px; padding:4px 8px;
      box-shadow:0 2px 6px rgba(15,23,42,0.25);
    }
    .title-group{ text-align:right; flex:1 1 260px;}
    .title-group h1{ margin:0 0 2px; font-size:22px; color:#fff; }
    .title-group p{ margin:0; opacity:.95; font-size:13px; color:#fff; }
    .chip-version{
      margin-top:8px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.18);
      font-size:12px;
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
    }
    .chip-dot{ width:9px; height:9px; border-radius:999px; background:#34d399; box-shadow:0 0 0 3px rgba(52,211,153,0.25); }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:12px 0 12px;
    }
    .tab{
      text-decoration:none;
      color:#0f172a;
      font-weight:900;
      font-size:13px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #cbd5f5;
      background:rgba(255,255,255,0.9);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(15,23,42,0.10); }
    .tab.active{
      background: rgba(29,155,240,0.12);
      border-color: rgba(29,155,240,0.45);
    }

    footer.site-footer{
      text-align:center;
      font-size:12px;
      color:#6b7280;
      padding:10px 20px 18px;
      border-top:1px solid #e5e7eb;
      background-color:rgba(248,250,252,0.9);
      margin-top:20px;
    }

    @media (max-width: 980px){
      .title-group{ text-align:center; }
      .header-inner{ justify-content:center; }
    }

  </style>

  <!-- CSS de Tabulator LOCAL -->
  <link rel="stylesheet" href="tabulator.min.css">
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="logo-group">
        <img src="conap_logo.jpg" alt="Logo CONAP">
        <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
      </div>
      <div class="title-group">
        <h1>Centro de consulta de datos</h1>
        <p>Sistema de monitoreo de actividades</p>
        <p>CONAP ‚Äì Direcci√≥n Regional Altiplano Central</p>
        <div class="chip-version">
          <span class="chip-dot"></span>
          <span>M√≥dulo AC210 ¬∑ Viveros</span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-container">
    <nav class="tabs" aria-label="Navegaci√≥n del m√≥dulo">
      <a class="tab" href="ac210_dashboard.html">üó∫Ô∏è Dashboard geogr√°fico</a>
      <a class="tab" href="ac210_tablero.html">üìà Tablero din√°mico</a>
      <a class="tab active" href="ac210_datos.html">üìã Tabla</a>
    </nav>
    <div class="top-bar">
      <div>
        <h2>AC210 Asistencia t√©cnica a viveros</h2>
        <p>Detalle de registros (tabla basada en base2_datos.csv).</p>
      </div>
      <div class="buttons">
        <button id="download-csv">Descargar CSV</button>
        <button id="download-xlsx">Descargar Excel</button>
        <!-- Botones informe por registro -->
        <button id="generate-report-word">Informe registro (Word)</button>
        <button id="generate-report-pdf">Informe registro (PDF)</button>
      </div>
    </div>

    <!-- Barra para informe mensual -->
    <div class="monthly-report-bar">
      <label for="monthly-month-select">Informe mensual de asistencia t√©cnica a viveros (AC210):</label>
      <select id="monthly-month-select">
        <option value="">Cargando meses...</option>
      </select>
      <button id="generate-monthly-report-word" disabled>Generar informe mensual (Word)</button>
      <button id="generate-monthly-report-pdf" disabled>Generar informe mensual (PDF)</button>
    </div>

    <div class="back-container">
      <a href="ac210_dashboard.html" class="back-link">‚Üê Volver al dashboard</a>
    </div>

    <!-- Solo la tabla aqu√≠ -->
    <div id="tabla"></div>
  </main>

  <!-- Librer√≠as JS necesarias (LOCALES) -->
  <script src="tabulator.min.js"></script>
  <script src="papaparse.min.js"></script>
  <script src="xlsx.full.min.js"></script>
  <!-- Librer√≠a para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Referencias globales
    let tablaAC210;
    let datosAC210 = [];
    let mapaMeses = new Map();

    function decodeArrayBuffer(buf){
      // Intentos de decodificaci√≥n para evitar s√≠mbolos raros (UTF-8 / Latin-1)
      const tries = ["utf-8","iso-8859-1","windows-1252"];
      for (let i=0;i<tries.length;i++){
        try{
          const t = new TextDecoder(tries[i], {fatal:false}).decode(buf);
          const bad = (t.match(/\uFFFD/g)||[]).length;
          if(bad <= 2) return t;
        }catch(e){}
      }
      return new TextDecoder("utf-8", {fatal:false}).decode(buf);
    }
 // "YYYY-MM" -> { anio, mes }

    // Funci√≥n para nombre de archivo "limpio"
    function slugify(texto) {
      return String(texto || "")
        .toLowerCase()
        .trim()
        .replace(/\s+/g, "_")
        .replace(/[^\w\-]/g, "");
    }

    function escapeHtml(texto) {
      return String(texto || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // Estilos comunes para informes (Word y PDF)
    const ESTILOS_INFORME = `
<style>
  body {
    font-family: "Times New Roman", serif;
    font-size: 10pt;
    line-height: 1;
  }
  .informe-contenido {
    font-family: "Times New Roman", serif;
    font-size: 10pt;
    line-height: 1;
  }
  .informe-contenido h1 {
    font-size: 14pt;
    font-weight: bold;
    margin: 0 0 8pt 0;
    text-align: center;
  }
  .informe-contenido h2 {
    font-size: 12pt;
    font-weight: bold;
    margin: 12pt 0 6pt 0;
  }
  .informe-contenido p {
    margin: 0 0 6pt 0;
    text-align: justify;
  }
  .informe-seccion {
    page-break-inside: avoid;
    margin-bottom: 8pt;
  }
</style>
`;

    // Crear y descargar Word
    function crearDocumentoWord(nombreArchivo, contenidoHTML) {
      const header =
        "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
        "xmlns:w='urn:schemas-microsoft-com:office:word' " +
        "xmlns='http://www.w3.org/TR/REC-html40'>" +
        "<head><meta charset='utf-8'><title>Informe</title>" +
        ESTILOS_INFORME +
        "</head><body>";
      const footer = "</body></html>";
      const source = header + contenidoHTML + footer;

      const blob = new Blob(["\ufeff", source], {
        type: "application/msword"
      });

      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = nombreArchivo.endsWith(".doc") ? nombreArchivo : nombreArchivo + ".doc";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Crear y descargar PDF usando html2pdf
    function crearDocumentoPDF(nombreArchivo, contenidoHTML) {
      if (typeof html2pdf === "undefined") {
        alert("No se encontr√≥ la librer√≠a para exportar a PDF (html2pdf). Verifique que se haya cargado correctamente.");
        return;
      }

      const contenedor = document.createElement("div");
      contenedor.style.padding = "10px";
      contenedor.innerHTML = ESTILOS_INFORME + contenidoHTML;
      document.body.appendChild(contenedor);

      const opt = {
        margin:       10,
        filename:     nombreArchivo.endsWith(".pdf") ? nombreArchivo : nombreArchivo + ".pdf",
        image:        { type: "jpeg", quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" }
      };

      html2pdf().set(opt).from(contenedor).save().then(function() {
        document.body.removeChild(contenedor);
      }).catch(function() {
        document.body.removeChild(contenedor);
      });
    }

    // Extraer fecha completa (anio, mes, dia) desde CreationDate
    function extraerFechaCompleta(fechaRaw) {
      if (!fechaRaw) return null;
      const str = String(fechaRaw).trim();
      if (!str) return null;
      const parteFecha = str.split(" ")[0]; // antes de la hora
      let sep = null;
      if (parteFecha.includes("/")) sep = "/";
      else if (parteFecha.includes("-")) sep = "-";
      if (!sep) return null;

      const partes = parteFecha.split(sep);
      if (partes.length < 3) return null;

      const p1 = parseInt(partes[0], 10);
      const p2 = parseInt(partes[1], 10);
      const p3 = parseInt(partes[2], 10);
      if (isNaN(p1) || isNaN(p2) || isNaN(p3)) return null;

      let dia, mes, anio;
      // si p1 > 12 y p2 <= 12: asumimos formato dd/mm/aaaa
      if (p1 > 12 && p2 >= 1 && p2 <= 12) {
        dia = p1;
        mes = p2;
        anio = p3;
      } else {
        // asumimos mm/dd/aaaa
        mes = p1;
        dia = p2;
        anio = p3;
      }

      if (mes < 1 || mes > 12 || dia < 1 || dia > 31) return null;
      return { anio: anio, mes: mes, dia: dia };
    }

    function extraerAnioMes(fechaRaw) {
      const f = extraerFechaCompleta(fechaRaw);
      if (!f) return null;
      return { anio: f.anio, mes: f.mes };
    }

    function nombreMesEspanol(mes) {
      const nombres = [
        "enero", "febrero", "marzo", "abril", "mayo", "junio",
        "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
      ];
      return nombres[mes - 1] || "";
    }

    function porcentaje(parte, total) {
      if (!total) return 0;
      return Math.round((parte * 1000) / total) / 10; // 1 decimal
    }

    function formatearNumero(valor, decimales) {
      if (typeof valor !== "number" || isNaN(valor)) return "";
      return valor.toFixed(decimales);
    }

    function obtenerDiasEnMes(anio, mes) {
      // mes: 1-12
      return new Date(anio, mes, 0).getDate();
    }

    function formatearClaveDia(claveDia) {
      // "YYYY-MM-DD" -> "D de mes"
      if (!claveDia) return "";
      const partes = claveDia.split("-");
      if (partes.length !== 3) return claveDia;
      const dia = parseInt(partes[2], 10);
      const mes = parseInt(partes[1], 10);
      const nombreMes = nombreMesEspanol(mes);
      return (isNaN(dia) ? claveDia : dia + " de " + nombreMes);
    }

    function parseHora(valor) {
      if (!valor) return null;
      const str = String(valor).trim();
      if (!str) return null;
      const m = str.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
      if (!m) return null;
      const h = parseInt(m[1], 10);
      const min = parseInt(m[2], 10);
      const sec = m[3] ? parseInt(m[3], 10) : 0;
      if (isNaN(h) || isNaN(min) || isNaN(sec)) return null;
      return h * 60 + min + sec / 60; // minutos (con decimales)
    }

    function calcularEstadisticasHoras(listaHoras) {
      if (!listaHoras || listaHoras.length === 0) {
        return { promedio: null, desviacion: null, total: 0 };
      }
      let suma = 0;
      for (let i = 0; i < listaHoras.length; i++) {
        suma += listaHoras[i];
      }
      const promedio = suma / listaHoras.length;

      let sumaCuadrados = 0;
      for (let i = 0; i < listaHoras.length; i++) {
        const diff = listaHoras[i] - promedio;
        sumaCuadrados += diff * diff;
      }
      const desviacion = Math.sqrt(sumaCuadrados / listaHoras.length);
      return { promedio: promedio, desviacion: desviacion, total: suma };
    }

    function etiquetaActividad(codigo) {
      const map = {
        "limpieza_areas_plantas": "Limpieza de √°reas y plantas",
        "limpieza_areas": "Limpieza de √°reas",
        "limpieza_plantas": "Limpieza de plantas",
        "llenado_bolsas": "Llenado de bolsas",
        "riego": "Riego",
        "recoleccion_semillas": "Recolecci√≥n de semillas",
        "mantenimiento_infraestructura": "Mantenimiento de infraestructura",
        "apoyo_tecnico_capacitacion": "Apoyo t√©cnico o capacitaci√≥n",
        "germinacion": "Actividades de germinaci√≥n",
        "preparacion_sustrato": "Preparaci√≥n de sustrato",
        "otro": "Otras actividades"
      };
      if (map[codigo]) return map[codigo];
      const limpio = codigo.replace(/_/g, " ");
      return limpio.charAt(0).toUpperCase() + limpio.slice(1);
    }

    // Inicializar selector de meses para informe mensual
    function inicializarSelectorMeses() {
      const select = document.getElementById("monthly-month-select");
      const btnWord = document.getElementById("generate-monthly-report-word");
      const btnPdf  = document.getElementById("generate-monthly-report-pdf");
      if (!select || !btnWord || !btnPdf) return;

      mapaMeses = new Map();

      datosAC210.forEach(function (reg) {
        const infoFecha = extraerAnioMes(reg["CreationDate"]);
        if (!infoFecha) return;
        const clave = infoFecha.anio + "-" + String(infoFecha.mes).padStart(2, "0");
        if (!mapaMeses.has(clave)) {
          mapaMeses.set(clave, infoFecha);
        }
      });

      const clavesOrdenadas = Array.from(mapaMeses.keys()).sort();
      select.innerHTML = "";

      if (clavesOrdenadas.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No hay meses disponibles";
        opt.disabled = true;
        opt.selected = true;
        select.appendChild(opt);
        btnWord.disabled = true;
        btnPdf.disabled = true;
        return;
      }

      const optDefault = document.createElement("option");
      optDefault.value = "";
      optDefault.textContent = "Seleccione un mes‚Ä¶";
      optDefault.disabled = true;
      optDefault.selected = true;
      select.appendChild(optDefault);

      clavesOrdenadas.forEach(function (clave) {
        const info = mapaMeses.get(clave);
        const nombreMesSel = nombreMesEspanol(info.mes);
        const etiqueta = nombreMesSel.charAt(0).toUpperCase() + nombreMesSel.slice(1) + " " + info.anio;
        const opt = document.createElement("option");
        opt.value = clave;
        opt.textContent = etiqueta;
        select.appendChild(opt);
      });

      select.addEventListener("change", function () {
        const haySeleccion = !!this.value;
        btnWord.disabled = !haySeleccion;
        btnPdf.disabled = !haySeleccion;
      });
    }

    // -------- INFORME POR REGISTRO (Word / PDF) --------
    function generarInformeRegistro(formato) {
      if (!tablaAC210) {
        alert("La tabla a√∫n no est√° lista.");
        return;
      }

      const seleccionadas = tablaAC210.getSelectedData();
      if (!seleccionadas || seleccionadas.length === 0) {
        alert("Por favor, seleccione un registro en la tabla antes de generar el informe.");
        return;
      }

      const registro = seleccionadas[0];
      console.log("Registro AC210 seleccionado para el informe:", registro);

      // Campos reales seg√∫n base2_datos.csv
      const guarda = registro["Nombre del guarda recurso"] || "";
      const municipio = registro["Municipio"] || "";
      const apoyoFuera = (registro["Esta en apoyo a un vivero fuera de su municipio"] || "").toString().trim();
      const municipioApoyo = registro["Especifique el municipio o lugar de apoyo"] || "";
      const horaInicio = registro["Hora de inicio de actividades"] || "";
      const horaFin = registro["Hora de finalizacion de actividades"] || "";
      const region = registro["Region"] || "";
      const areaProtegida = registro["Area protegida"] || "";
      const areaFuera = registro["Especifique area (Fuera de RUMCLA)"] || "";
      const nombreVivero = registro["Nombre del area y/o lugar del vivero establecido (Barrio, Caserio, Canton, Aldea, etc.)"] || "";
      const actividades = registro["Actividades realizadas"] || "";
      const otraActividad = registro["Especifique otra actividad"] || "";
      const observaciones = registro["Observaciones"] || "";
      const fechaCreacion = registro["CreationDate"] || "";
      const fechaModificacion = registro["EditDate"] || "";
      const coordX = registro["X"] || "";
      const coordY = registro["Y"] || "";

      let fechaReferencia = "";
      const fechaObj = extraerFechaCompleta(fechaCreacion);
      if (fechaObj) {
        const nombreMes = nombreMesEspanol(fechaObj.mes);
        fechaReferencia = fechaObj.dia + " de " + nombreMes + " " + fechaObj.anio;
      } else {
        fechaReferencia = fechaCreacion;
      }

      let textoAmbito = "";
      const areaUpper = (areaProtegida || "").toString().toUpperCase();
      if (areaUpper.includes("RUMCLA")) {
        textoAmbito = "dentro de la Reserva de Usos M√∫ltiples de la Cuenca del Lago de Atitl√°n (RUMCLA)";
      } else if (areaUpper.includes("FUERA")) {
        textoAmbito = "en un vivero ubicado fuera de la RUMCLA";
      } else if (areaFuera) {
        textoAmbito = "en un vivero ubicado fuera de la RUMCLA (" + areaFuera + ")";
      }

      let textoApoyo = "";
      if (apoyoFuera) {
        const v = apoyoFuera.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (v === "si" || v === "s√≠") {
          textoApoyo =
            "La jornada se registr√≥ como apoyo a un vivero fuera de su municipio de base, " +
            (municipioApoyo ? "en el municipio o lugar de " + municipioApoyo + "." : "en un vivero de apoyo externo.");
        } else {
          textoApoyo =
            "La actividad se realiz√≥ dentro del municipio de asignaci√≥n del guarda recurso.";
        }
      }

      const textoDescripcion =
        "Este informe corresponde a un registro del formulario AC210 de asistencia t√©cnica a viveros. " +
        "La atenci√≥n se realiz√≥ en torno a la fecha " + (fechaReferencia || "(sin fecha de visita reportada)") +
        ", en el vivero o √°rea denominada " + (nombreVivero || "(sin nombre de vivero reportado)") +
        ", ubicado en el municipio de " + (municipio || "(sin municipio reportado)") +
        (region ? ", regi√≥n " + region : "") +
        (textoAmbito ? ", " + textoAmbito : "") +
        ". La asistencia fue brindada por el guarda recurso " + (guarda || "(sin nombre reportado)") +
        ", en el marco del sistema de monitoreo de actividades de la Direcci√≥n Regional Altiplano Central de CONAP.";

      const textoHorario =
        "De acuerdo con el registro, la jornada inici√≥ a las " +
        (horaInicio || "(hora de inicio no registrada)") +
        " y finaliz√≥ a las " +
        (horaFin || "(hora de finalizaci√≥n no registrada)") +
        ", dentro de la jornada laboral ordinaria.";

      let textoActividades = "";
      if (actividades) {
        const partes = actividades.toString().split(/[,;]+/).map(function (p) {
          return p.trim();
        }).filter(Boolean);

        const codigosUnicos = Array.from(new Set(partes));
        const etiquetas = codigosUnicos.map(function (cod) {
          return etiquetaActividad(cod);
        });
        if (etiquetas.length > 0) {
          textoActividades =
            "Las actividades realizadas incluyeron principalmente: " +
            etiquetas.join(", ") + ".";
        }
      }

      if (otraActividad) {
        textoActividades +=
          (textoActividades ? " Adem√°s, " : "En el registro se menciona que ") +
          "se report√≥ la siguiente actividad adicional: " + otraActividad + ".";
      }

      // Detalle de variables como lista
      const entries = Object.entries(registro || {});
      let detalleHtml = "<ul>";
      entries.forEach(function (par) {
        const campo = par[0];
        const valor = par[1];
        detalleHtml +=
          "<li><strong>" +
          escapeHtml(campo) +
          ":</strong> " +
          escapeHtml(String(valor)) +
          "</li>";
      });
      detalleHtml += "</ul>";

      const html =
        "<div class='informe-contenido'>" +

          "<div class='informe-seccion'>" +
            "<h1>Informe de asistencia t√©cnica a viveros (AC210)</h1>" +
            "<p style='text-align:center;'>Sistema de monitoreo de actividades CONAP - DRAC - Altiplano Central</p>" +
            "<hr />" +
          "</div>" +

          "<div class='informe-seccion'>" +
            "<h2>1. Datos b√°sicos del registro</h2>" +
            "<p><strong>Nombre del guarda recurso:</strong> " + escapeHtml(guarda || "(sin nombre reportado)") + "</p>" +
            "<p><strong>Nombre del vivero o √°rea de trabajo:</strong> " + escapeHtml(nombreVivero || "(sin nombre de vivero reportado)") + "</p>" +
            "<p><strong>Municipio:</strong> " + escapeHtml(municipio || "(sin municipio reportado)") + "</p>" +
            "<p><strong>Regi√≥n:</strong> " + escapeHtml(region || "(sin regi√≥n reportada)") + "</p>" +
            "<p><strong>√Årea protegida / √°mbito:</strong> " + escapeHtml(areaProtegida || areaFuera || "(sin √°rea reportada)") + "</p>" +
            (textoApoyo ? "<p><strong>Apoyo fuera de municipio:</strong> " + escapeHtml(textoApoyo) + "</p>" : "") +
          "</div>" +

          "<div class='informe-seccion'>" +
            "<h2>2. Descripci√≥n de la asistencia t√©cnica</h2>" +
            "<p>" + escapeHtml(textoDescripcion) + "</p>" +
            "<p>" + escapeHtml(textoHorario) + "</p>" +
            (textoActividades ? "<p>" + escapeHtml(textoActividades) + "</p>" : "") +
          "</div>" +

          "<div class='informe-seccion'>" +
            "<h2>3. Observaciones de campo</h2>" +
            (observaciones
              ? "<p>" + escapeHtml(observaciones) + "</p>"
              : "<p>No se registraron observaciones adicionales en este formulario.</p>") +
          "</div>" +

          "<div class='informe-seccion'>" +
            "<h2>4. Detalle de las variables registradas</h2>" +
            detalleHtml +
          "</div>" +

          "<div class='informe-seccion'>" +
            "<h2>5. Metadatos del formulario</h2>" +
            "<p><strong>Fecha de creaci√≥n del registro:</strong> " + escapeHtml(fechaCreacion || "(no especificada)") + "</p>" +
            "<p><strong>Fecha de √∫ltima modificaci√≥n del registro:</strong> " + escapeHtml(fechaModificacion || "(no especificada)") + "</p>" +
            "<p><strong>Coordenadas (X, Y):</strong> " + escapeHtml(coordX || "-") + ", " + escapeHtml(coordY || "-") + "</p>" +
          "</div>" +

          "<div class='informe-seccion'>" +
            "<h2>6. Firmas (para uso institucional)</h2>" +
            "<p>______________________________<br/>Responsable de la asistencia / guarda recurso</p>" +
            "<p>______________________________<br/>Revisi√≥n / Supervisi√≥n</p>" +
          "</div>" +

        "</div>";

      const slugVivero = slugify(nombreVivero || municipio || "sin_vivero");
      const slugFecha  = slugify(fechaReferencia || "sin_fecha");
      const baseNombreArchivo = "informe_ac210_" + slugVivero + "_" + slugFecha;

      if (formato === "pdf") {
        crearDocumentoPDF(baseNombreArchivo + ".pdf", html);
      } else {
        crearDocumentoWord(baseNombreArchivo + ".doc", html);
      }
    }

    // -------- INFORME MENSUAL (Word / PDF) --------
    function generarInformeMensual(formato) {
      if (!datosAC210 || datosAC210.length === 0) {
        alert("No hay datos cargados para generar el informe mensual.");
        return;
      }

      const select = document.getElementById("monthly-month-select");
      if (!select || !select.value) {
        alert("Por favor, seleccione un mes para generar el informe mensual.");
        return;
      }

      const claveSeleccionada = select.value;
      const infoSeleccionada = mapaMeses.get(claveSeleccionada);
      if (!infoSeleccionada) {
        alert("No se encontr√≥ informaci√≥n para el mes seleccionado.");
        return;
      }

      const anioSel = infoSeleccionada.anio;
      const mesSel = infoSeleccionada.mes;
      const nombreMesSel = nombreMesEspanol(mesSel);
      const etiquetaMes = nombreMesSel.charAt(0).toUpperCase() + nombreMesSel.slice(1) + " " + anioSel;

      // Filtrar registros de ese mes
      const registrosMes = datosAC210.filter(function (reg) {
        const infoF = extraerAnioMes(reg["CreationDate"]);
        return infoF && infoF.anio === anioSel && infoF.mes === mesSel;
      });

      if (!registrosMes || registrosMes.length === 0) {
        alert("No se encontraron registros para " + etiquetaMes + ".");
        return;
      }

      const total = registrosMes.length;

      const municipiosSet = new Set();
      const conteoMunicipios = {};
      const guardasSet = new Set();
      const conteoGuardas = {};
      const conteoDias = {};

      let dentroRUMCLA = 0;
      let fueraRUMCLA = 0;
      let sinArea = 0;

      const duracionesHoras = [];
      const duracionesDentro = [];
      const duracionesFuera = [];
      const horasPorGuarda = {};

      const actividadesConteo = {};
      const otrasActividadesTexto = [];

      let apoyoSi = 0;
      let apoyoNo = 0;
      let apoyoSin = 0;
      const ejemplosApoyo = [];

      registrosMes.forEach(function (reg) {
        const muni = (reg["Municipio"] || "").toString().trim();
        if (muni) {
          municipiosSet.add(muni);
          conteoMunicipios[muni] = (conteoMunicipios[muni] || 0) + 1;
        }

        const guarda = (reg["Nombre del guarda recurso"] || "").toString().trim();
        if (guarda) {
          guardasSet.add(guarda);
          conteoGuardas[guarda] = (conteoGuardas[guarda] || 0) + 1;
        }

        const fechaObj = extraerFechaCompleta(reg["CreationDate"]);
        if (fechaObj) {
          const claveDia =
            fechaObj.anio + "-" +
            String(fechaObj.mes).padStart(2, "0") + "-" +
            String(fechaObj.dia).padStart(2, "0");
          conteoDias[claveDia] = (conteoDias[claveDia] || 0) + 1;
        }

        const areaRaw = (reg["Area protegida"] || "").toString().trim().toUpperCase();
        const fueraRaw = (reg["Especifique area (Fuera de RUMCLA)"] || "").toString().trim();
        if (!areaRaw && !fueraRaw) {
          sinArea++;
        } else if (areaRaw.includes("FUERA") || fueraRaw) {
          fueraRUMCLA++;
        } else if (areaRaw.includes("RUMCLA")) {
          dentroRUMCLA++;
        } else {
          dentroRUMCLA++;
        }

        const hIni = parseHora(reg["Hora de inicio de actividades"]);
        const hFin = parseHora(reg["Hora de finalizacion de actividades"]);
        if (hIni !== null && hFin !== null) {
          let durMin = hFin - hIni;
          if (durMin < 0) {
            durMin += 24 * 60; // cruz√≥ medianoche
          }
          const durHoras = durMin / 60.0;
          duracionesHoras.push(durHoras);

          const esDentro = areaRaw.includes("RUMCLA") && !areaRaw.includes("FUERA") && !fueraRaw;
          if (esDentro) {
            duracionesDentro.push(durHoras);
          } else {
            duracionesFuera.push(durHoras);
          }

          if (guarda) {
            if (!horasPorGuarda[guarda]) {
              horasPorGuarda[guarda] = { totalHoras: 0, numJornadas: 0 };
            }
            horasPorGuarda[guarda].totalHoras += durHoras;
            horasPorGuarda[guarda].numJornadas += 1;
          }
        }

        // Actividades (conteo por registro)
        const actStr = (reg["Actividades realizadas"] || "").toString().trim();
        if (actStr) {
          const partes = actStr.split(/[,;]+/).map(function (p) {
            return p.trim();
          }).filter(Boolean);
          const codigosUnicos = Array.from(new Set(partes));
          codigosUnicos.forEach(function (cod) {
            actividadesConteo[cod] = (actividadesConteo[cod] || 0) + 1;
          });
        }

        const otraAct = (reg["Especifique otra actividad"] || "").toString().trim();
        if (otraAct) {
          otrasActividadesTexto.push(otraAct);
        }

        const apoyoRaw = (reg["Esta en apoyo a un vivero fuera de su municipio"] || "").toString().trim().toLowerCase();
        if (!apoyoRaw) {
          apoyoSin++;
        } else {
          const norm = apoyoRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          if (norm === "si" || norm === "s√≠") {
            apoyoSi++;
            if (ejemplosApoyo.length < 3) {
              const muniBase = (reg["Municipio"] || "").toString().trim();
              const lugarApoyo = (reg["Especifique el municipio o lugar de apoyo"] || "").toString().trim();
              ejemplosApoyo.push({
                guarda: guarda,
                municipioBase: muniBase,
                lugarApoyo: lugarApoyo
              });
            }
          } else {
            apoyoNo++;
          }
        }
      });

      const numMunicipios = municipiosSet.size;
      const numGuardas = guardasSet.size;

      const diasActivos = Object.keys(conteoDias).length;
      const diasEnMes = obtenerDiasEnMes(anioSel, mesSel);
      const coberturaTemporal = porcentaje(diasActivos, diasEnMes);
      const promedioPorDiaActivo = diasActivos > 0 ? (total / diasActivos) : 0;

      let primeraFechaClave = "";
      let ultimaFechaClave = "";
      let maxRegDia = 0;
      let diasPico = [];

      const clavesDias = Object.keys(conteoDias).sort();
      if (clavesDias.length > 0) {
        primeraFechaClave = clavesDias[0];
        ultimaFechaClave = clavesDias[clavesDias.length - 1];
      }

      for (const claveDia in conteoDias) {
        if (!Object.prototype.hasOwnProperty.call(conteoDias, claveDia)) continue;
        const c = conteoDias[claveDia];
        if (c > maxRegDia) {
          maxRegDia = c;
          diasPico = [claveDia];
        } else if (c === maxRegDia) {
          diasPico.push(claveDia);
        }
      }

      const listaMunicipios = Object.keys(conteoMunicipios).map(function (muni) {
        return { nombre: muni, conteo: conteoMunicipios[muni] };
      }).sort(function (a, b) {
        return b.conteo - a.conteo;
      });

      const listaGuardas = Object.keys(conteoGuardas).map(function (g) {
        const info = horasPorGuarda[g] || { totalHoras: 0, numJornadas: 0 };
        return {
          nombre: g,
          conteo: conteoGuardas[g],
          totalHoras: info.totalHoras,
          numJornadas: info.numJornadas
        };
      }).sort(function (a, b) {
        return b.conteo - a.conteo;
      });

      const statsHoras = calcularEstadisticasHoras(duracionesHoras);
      const statsDentro = calcularEstadisticasHoras(duracionesDentro);
      const statsFuera = calcularEstadisticasHoras(duracionesFuera);

      const totalDentroFuera = dentroRUMCLA + fueraRUMCLA;
      const pctDentro = porcentaje(dentroRUMCLA, total);
      const pctFuera = porcentaje(fueraRUMCLA, total);

      const listaActividades = Object.keys(actividadesConteo).map(function (cod) {
        return { codigo: cod, conteo: actividadesConteo[cod] };
      }).sort(function (a, b) {
        return b.conteo - a.conteo;
      });

      const htmlParts = [];

      htmlParts.push("<div class='informe-contenido'>");

      // 1. Cantidad total y distribuci√≥n general
      htmlParts.push(
        "<div class='informe-seccion'>" +
          "<h1>Informe mensual de asistencia t√©cnica a viveros (AC210)</h1>" +
          "<p style='text-align:center;'>Sistema de monitoreo de actividades CONAP - DRAC - Altiplano Central</p>" +
          "<p style='text-align:center;'><strong>Mes analizado: " + escapeHtml(etiquetaMes) + "</strong></p>" +
          "<hr />" +
        "</div>" +

        "<div class='informe-seccion'>" +
          "<h2>1. Cantidad total y distribuci√≥n general de actividades en viveros</h2>" +
          "<p>Durante el mes de " + escapeHtml(etiquetaMes) +
          ", el cuerpo operativo de guarda recursos del Altiplano Central registr√≥ un total de <strong>" +
          total + "</strong> actividades v√°lidas de asistencia t√©cnica a viveros forestales en el sistema de monitoreo.</p>"
      );

      if (numMunicipios > 0) {
        htmlParts.push(
          "<p>Las acciones se distribuyeron en <strong>" + numMunicipios +
          "</strong> municipio(s): " +
          escapeHtml(Array.from(municipiosSet).join(", ")) + ".</p>"
        );
      }

      if (totalDentroFuera > 0) {
        htmlParts.push(
          "<p>De acuerdo con el campo de √°rea protegida, aproximadamente <strong>" +
          formatearNumero(pctDentro, 1) + "%</strong> de las actividades (" + dentroRUMCLA +
          " registro(s)) se realizaron dentro de la RUMCLA u otras √°reas asociadas, " +
          "mientras que alrededor de <strong>" + formatearNumero(pctFuera, 1) + "%</strong> (" +
          fueraRUMCLA + " registro(s)) corresponden a viveros ubicados fuera de la reserva. " +
          (sinArea > 0 ? "En " + sinArea + " registro(s) no se cuenta con informaci√≥n clara sobre el √°mbito territorial." : "") +
          "</p>"
        );
      }

      if (diasActivos > 0) {
        htmlParts.push(
          "<p>Las fechas de registro se concentran entre el " +
          escapeHtml(formatearClaveDia(primeraFechaClave)) + " y el " +
          escapeHtml(formatearClaveDia(ultimaFechaClave)) +
          ", con presencia documentada en <strong>" + diasActivos +
          "</strong> d√≠as distintos del mes. Esto representa aproximadamente el " +
          formatearNumero(coberturaTemporal, 1) +
          "% del periodo analizado, con un promedio de " +
          formatearNumero(promedioPorDiaActivo, 1) +
          " actividades por d√≠a con registro.</p>"
        );
      }

      htmlParts.push("</div>");

      // 2. Distribuci√≥n temporal y ritmo operativo
      htmlParts.push("<div class='informe-seccion'><h2>2. Distribuci√≥n temporal y ritmo operativo</h2>");
      if (diasActivos > 0) {
        if (maxRegDia > 0) {
          const ejemplosDias = diasPico.slice(0, 3).map(function (c) {
            return formatearClaveDia(c);
          });
          htmlParts.push(
            "<p>El ritmo operativo durante el mes fue constante, con variaciones moderadas en el n√∫mero de jornadas por d√≠a. " +
            "Los picos de actividad se concentraron en fechas como " +
            escapeHtml(ejemplosDias.join("; ")) +
            ", con hasta <strong>" + maxRegDia +
            "</strong> registros en una misma jornada.</p>"
          );
        } else {
          htmlParts.push(
            "<p>La distribuci√≥n temporal de las actividades muestra un patr√≥n estable a lo largo del mes, sin concentraciones extremas de trabajo en d√≠as espec√≠ficos.</p>"
          );
        }
      } else {
        htmlParts.push(
          "<p>No se dispone de informaci√≥n suficiente sobre la distribuci√≥n temporal de las actividades en este mes.</p>"
        );
      }
      htmlParts.push("</div>");

      // 3. Municipios
      htmlParts.push("<div class='informe-seccion'><h2>3. Desempe√±o por √°reas operativas</h2>");
      if (listaMunicipios.length > 0) {
        const topMuns = listaMunicipios.slice(0, 3);
        const partesTop = topMuns.map(function (m) {
          return escapeHtml(m.nombre) + " (" + m.conteo + " registro" + (m.conteo !== 1 ? "s" : "") + ")";
        });
        htmlParts.push(
          "<p>En t√©rminos de volumen operativo, los municipios con mayor n√∫mero de actividades fueron: " +
          partesTop.join(", ") + ". " +
          "En estos casos, las labores se desarrollaron principalmente en viveros municipales y √°reas adyacentes, " +
          "enfoc√°ndose en tareas de mantenimiento, producci√≥n de plantas y fortalecimiento de la infraestructura viverista.</p>"
        );

        if (listaMunicipios.length > 3) {
          const minResto = listaMunicipios[listaMunicipios.length - 1].conteo;
          const maxResto = listaMunicipios[3].conteo;
          htmlParts.push(
            "<p>El resto de municipios registr√≥ entre " + minResto + " y " + maxResto +
            " actividades cada uno, manteniendo una presencia de trabajo regular en los viveros comunales y municipales del Altiplano Central.</p>"
          );
        }
      } else {
        htmlParts.push("<p>No se cuenta con informaci√≥n detallada sobre la distribuci√≥n por municipio para este mes.</p>");
      }
      htmlParts.push("</div>");

      // 4. Duraci√≥n y eficiencia
      htmlParts.push("<div class='informe-seccion'><h2>4. Duraci√≥n, frecuencia y eficiencia operativa</h2>");
      if (duracionesHoras.length > 0) {
        const pctConHoras = porcentaje(duracionesHoras.length, total);
        htmlParts.push(
          "<p>El an√°lisis de los registros de campo con horario v√°lido (" +
          duracionesHoras.length + " registro(s), equivalente(s) al " +
          formatearNumero(pctConHoras, 1) +
          "% del total) indica que las jornadas de trabajo en viveros tuvieron una duraci√≥n promedio de <strong>" +
          formatearNumero(statsHoras.promedio, 1) + " horas</strong>, con una desviaci√≥n est√°ndar de aproximadamente " +
          formatearNumero(statsHoras.desviacion, 1) +
          " horas. El total estimado de horas efectivas de trabajo acumuladas durante el mes asciende a alrededor de " +
          formatearNumero(statsHoras.total, 1) + " horas.</p>"
        );

        if (duracionesDentro.length > 0 && duracionesFuera.length > 0) {
          htmlParts.push(
            "<p>Al comparar la duraci√≥n de las jornadas seg√∫n el √°mbito territorial, se observa que los trabajos dentro de la RUMCLA presentan un promedio de " +
            formatearNumero(statsDentro.promedio, 1) +
            " horas por registro, mientras que las actividades realizadas en viveros fuera de la cuenca muestran un promedio de " +
            formatearNumero(statsFuera.promedio, 1) +
            " horas. Esta diferencia responde principalmente a los tiempos de desplazamiento y a la naturaleza de las tareas ejecutadas en cada √°mbito.</p>"
          );
        }
      } else {
        htmlParts.push(
          "<p>En este mes no se dispone de informaci√≥n suficiente sobre las horas de inicio y finalizaci√≥n de las jornadas, " +
          "por lo que no es posible estimar de forma confiable la duraci√≥n promedio del trabajo en viveros.</p>"
        );
      }
      htmlParts.push("</div>");

      // 5. Variabilidad diaria
      htmlParts.push("<div class='informe-seccion'><h2>5. Variabilidad diaria y continuidad operativa</h2>");
      if (diasActivos > 0) {
        htmlParts.push(
          "<p>En total se registraron actividades en <strong>" + diasActivos +
          "</strong> d√≠as distintos del mes de " + escapeHtml(etiquetaMes) +
          ", lo que representa una cobertura temporal de aproximadamente " +
          formatearNumero(coberturaTemporal, 1) +
          "% del periodo. Este comportamiento evidencia una presencia continua del personal t√©cnico en campo " +
          "y un seguimiento regular a las tareas de mantenimiento y producci√≥n de plantas forestales.</p>"
        );

        htmlParts.push(
          "<p>El promedio general fue de " +
          formatearNumero(promedioPorDiaActivo, 1) +
          " jornadas por d√≠a con actividad registrada, sin concentraciones excesivas que indiquen sobrecarga operativa en fechas espec√≠ficas.</p>"
        );
      } else {
        htmlParts.push("<p>No se registraron d√≠as con actividad en el conjunto de datos correspondiente a este mes.</p>");
      }
      htmlParts.push("</div>");

      // 6. Desempe√±o por guarda recurso
      htmlParts.push("<div class='informe-seccion'><h2>6. Desempe√±o por guarda recurso y eficiencia operativa</h2>");
      if (listaGuardas.length > 0) {
        const topGuardas = listaGuardas.slice(0, 4);
        const partesGuardas = topGuardas.map(function (g) {
          let texto = escapeHtml(g.nombre) + " (" + g.conteo + " registro" + (g.conteo !== 1 ? "s" : "");
          if (g.totalHoras && g.totalHoras > 0) {
            texto += ", ~" + formatearNumero(g.totalHoras, 1) + " horas acumuladas";
          }
          texto += ")";
          return texto;
        });

        htmlParts.push(
          "<p>El conjunto de registros muestra la participaci√≥n activa de varios guarda recursos en la ejecuci√≥n de actividades en viveros forestales. " +
          "Destacan, por volumen de registros y horas de trabajo asociadas, los siguientes t√©cnicos: " +
          partesGuardas.join("; ") +
          ". En conjunto, este grupo concentra una proporci√≥n importante del esfuerzo operativo mensual.</p>"
        );

        htmlParts.push(
          "<p>El resto del personal mantiene rangos intermedios de participaci√≥n, lo que sugiere una distribuci√≥n relativamente equilibrada del trabajo entre los distintos municipios y viveros atendidos.</p>"
        );
      } else {
        htmlParts.push("<p>No se dispone de informaci√≥n detallada por guarda recurso para este mes.</p>");
      }
      htmlParts.push("</div>");

      // 7. Actividades
      htmlParts.push("<div class='informe-seccion'><h2>7. Distribuci√≥n de actividades y tipos de labores ejecutadas</h2>");
      if (listaActividades.length > 0) {
        const topActs = listaActividades.slice(0, 6);
        htmlParts.push(
          "<p>Durante el periodo analizado, los guarda recursos desarrollaron un conjunto diverso de actividades orientadas al mantenimiento, " +
          "operaci√≥n y fortalecimiento de los viveros forestales. La distribuci√≥n de los principales tipos de labores se resume a continuaci√≥n:</p>"
        );
        htmlParts.push("<ul>");
        topActs.forEach(function (a) {
          const pct = porcentaje(a.conteo, total);
          htmlParts.push(
            "<li>" + escapeHtml(etiquetaActividad(a.codigo)) +
            ": " + a.conteo + " registro(s), aproximadamente " +
            formatearNumero(pct, 1) + "% del total.</li>"
          );
        });
        htmlParts.push("</ul>");

        if (otrasActividadesTexto.length > 0) {
          const ejemplosOtras = Array.from(new Set(otrasActividadesTexto)).slice(0, 3);
          htmlParts.push(
            "<p>Adem√°s, en los campos de descripci√≥n libre se reportaron otras actividades complementarias, tales como: " +
            escapeHtml(ejemplosOtras.join("; ")) +
            ", que refuerzan el car√°cter t√©cnico y de apoyo comunitario del componente viveros.</p>"
          );
        }

        htmlParts.push(
          "<p>En conjunto, la mayor√≠a de las actividades se concentran en fases de mantenimiento y producci√≥n primaria, " +
          "asegurando la disponibilidad de plantas y la preparaci√≥n de materiales para las jornadas de reforestaci√≥n en la regi√≥n.</p>"
        );
      } else {
        htmlParts.push("<p>En los registros de este mes no se cuenta con informaci√≥n estructurada sobre los tipos de actividades realizadas.</p>");
      }
      htmlParts.push("</div>");

      // 8. Participaci√≥n intermunicipal
      htmlParts.push("<div class='informe-seccion'><h2>8. Participaci√≥n interinstitucional y apoyo entre municipios</h2>");
      if ((apoyoSi + apoyoNo + apoyoSin) > 0) {
        const pctApoyoSi = porcentaje(apoyoSi, total);
        htmlParts.push(
          "<p>El programa de viveros del Altiplano Central registra una participaci√≥n intermunicipal e interinstitucional que se refleja en los campos de apoyo fuera del municipio de origen. " +
          "En <strong>" + apoyoSi + "</strong> registro(s) (" +
          formatearNumero(pctApoyoSi, 1) +
          "% del total) se indica que las actividades se realizaron en apoyo a viveros de otros municipios, " +
          "mientras que el resto corresponde a acciones desarrolladas dentro del municipio de asignaci√≥n del guarda recurso.</p>"
        );

        if (ejemplosApoyo.length > 0) {
          const frasesEjemplos = ejemplosApoyo.map(function (e) {
            return escapeHtml(e.guarda || "(sin nombre)") +
                   (e.municipioBase ? " (" + escapeHtml(e.municipioBase) + ")" : "") +
                   (e.lugarApoyo ? " apoy√≥ en " + escapeHtml(e.lugarApoyo) : "");
          });
          htmlParts.push(
            "<p>Entre los casos documentados de cooperaci√≥n destacan ejemplos como: " +
            frasesEjemplos.join("; ") +
            ". Estos apoyos fortalecen la gesti√≥n compartida de los viveros municipales y comunitarios.</p>"
          );
        }
      } else {
        htmlParts.push("<p>No se dispone de informaci√≥n suficiente para caracterizar la participaci√≥n interinstitucional y el apoyo entre municipios en este mes.</p>");
      }
      htmlParts.push("</div>");

      // 9. Notas metodol√≥gicas
      htmlParts.push(
        "<div class='informe-seccion'>" +
          "<h2>9. Notas metodol√≥gicas</h2>" +
          "<p>El presente informe mensual se genera de forma autom√°tica a partir de los registros del formulario AC210 de asistencia t√©cnica a viveros " +
          "del sistema de monitoreo de actividades de la Direcci√≥n Regional Altiplano Central del CONAP. " +
          "Los totales y porcentajes se calculan √∫nicamente con base en los registros correspondientes al mes seleccionado, " +
          "por lo que pueden variar conforme se incorporen nuevos datos o se actualicen los existentes.</p>" +
        "</div>"
      );

      htmlParts.push("</div>"); // cierre informe-contenido

      const html = htmlParts.join("");
      const baseNombreArchivo = "informe_mensual_ac210_viveros_" +
                                anioSel + "_" + String(mesSel).padStart(2, "0");

      if (formato === "pdf") {
        crearDocumentoPDF(baseNombreArchivo + ".pdf", html);
      } else {
        crearDocumentoWord(baseNombreArchivo + ".doc", html);
      }
    }

    // --------- INICIALIZACI√ìN DE LA P√ÅGINA ---------
    document.addEventListener("DOMContentLoaded", function () {
      console.log("P√°gina de datos de AC210 cargada, intentando leer ./base2_datos.csv ...");

      if (typeof Tabulator === "undefined") {
        alert("No se pudo cargar la librer√≠a Tabulator desde archivos locales.");
        return;
      }

      fetch("./base2_datos.csv", { cache: "no-store" })
        .then(function (response) {
          if (!response.ok) {
            throw new Error("HTTP " + response.status + " " + response.statusText);
          }
          return response.arrayBuffer();
        })
        .then(function (buf) {
          const csvText = decodeArrayBuffer(buf);

          console.log("Contenido bruto de base2_datos.csv (primeros 200 caracteres):");
          console.log(csvText.slice(0, 200));

          const parsed = Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            delimiter: ";"
          });

          console.log("Resultado de Papa.parse:", parsed);

          const data = parsed.data;

          if (!data || data.length === 0) {
            alert("No se encontraron datos en base2_datos.csv (archivo vac√≠o o encabezados incorrectos).");
            return;
          }

          datosAC210 = data; // guardamos para el informe mensual

          // No se oculta ninguna columna: se usan todos los encabezados
          const columns = Object.keys(data[0]).map(function (field) {
            return {
              title: field,
              field: field,
              headerFilter: "input"
            };
          });

          console.log("Columnas detectadas:", columns);

          tablaAC210 = new Tabulator("#tabla", {
            data: data,
            layout: "fitDataStretch",
            pagination: "local",
            paginationSize: 20,
            paginationSizeSelector: [10, 20, 50, 100],
            columns: columns,
            movableColumns: true,
            selectableRows: 1 // solo una fila seleccionada
          });

          // Inicializar selector de meses
          inicializarSelectorMeses();

          document.getElementById("download-csv").addEventListener("click", function () {
            tablaAC210.download("csv", "ac210_asistencia_viveros.csv");
          });

          document.getElementById("download-xlsx").addEventListener("click", function () {
            tablaAC210.download("xlsx", "ac210_asistencia_viveros.xlsx", { sheetName: "Datos" });
          });

          // Botones informe por registro
          document.getElementById("generate-report-word").addEventListener("click", function () {
            generarInformeRegistro("word");
          });

          document.getElementById("generate-report-pdf").addEventListener("click", function () {
            generarInformeRegistro("pdf");
          });

          // Botones informe mensual
          document.getElementById("generate-monthly-report-word").addEventListener("click", function () {
            generarInformeMensual("word");
          });

          document.getElementById("generate-monthly-report-pdf").addEventListener("click", function () {
            generarInformeMensual("pdf");
          });

        })
        .catch(function (error) {
          console.error("Error cargando base2_datos.csv:", error);
          alert("Error al cargar base2_datos.csv: " + error);
        });
    });
  </script>
</body>
</html>
