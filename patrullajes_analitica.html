<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patrullajes - Tablero anal√≠tico</title>

  <link rel="stylesheet" href="tabulator.min.css">

  <style>
    :root{
      --verde-header:#0f766e;
      --gris-fondo:#f5f7fa;
      --texto:#0f172a;
      --sub:#6b7280;
      --borde:#e5e7eb;
      --card-radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color:var(--texto);
      background:
        radial-gradient(circle at top left, #dbeafe 0, transparent 55%),
        radial-gradient(circle at bottom right, #bbf7d0 0, transparent 55%),
        linear-gradient(180deg,#e5f3f0 0%,var(--gris-fondo) 35%,#eef2ff 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      background: linear-gradient(90deg, #0f766e, #0e7490);
      color:#fff;
      padding:14px 20px 18px;
      box-shadow:0 2px 10px rgba(15,23,42,.25);
      position:sticky;
      top:0;
      z-index:10;
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .logo-group{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      background-color: rgba(255,255,255,.12);
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.15);
      backdrop-filter: blur(4px);
    }
    .logo-group img{height:40px; width:auto; display:block;}
    .title-group h1{margin:0; font-size:20px; letter-spacing:.2px;}
    .title-group p{margin:4px 0 0; font-size:12px; opacity:.95;}
    .chip-version{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
    }
    .chip-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.22);}

    main{max-width:1100px;margin:22px auto 40px;padding:0 16px; width:100%;}
    .page-header{margin-bottom:14px;}
    .page-header h2{margin:0 0 6px;font-size:22px;}
    .page-header p{margin:0;color:var(--sub);}
    .pill{
      display:inline-flex;margin-top:10px;
      font-size:12px;padding:6px 10px;border-radius:999px;
      background:#fff;border:1px solid var(--borde); color:#0f172a;
      box-shadow:0 2px 10px rgba(15,23,42,.06);
    }

    .grid{display:grid;gap:14px;}
    .grid-2{grid-template-columns: repeat(2, minmax(0,1fr));}
    .grid-3{grid-template-columns: repeat(3, minmax(0,1fr));}
    @media (max-width: 980px){ .grid-3{grid-template-columns: 1fr;} }
    @media (max-width: 860px){ .grid-2{grid-template-columns: 1fr;} }

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(226,232,240,.9);
      border-radius: var(--card-radius);
      box-shadow:0 12px 26px rgba(15,23,42,.10);
      padding:14px;
    }
    .card h3{
      margin:0 0 8px;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .muted{color:var(--sub); font-size:12px; margin:0;}

    .filters{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 190px;
    }
    label{font-size:12px;color:#334155;font-weight:650;}
    select, input[type="date"]{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #cbd5f5;
      background:#fff;
      font-size:13px;
      outline:none;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      font-weight:650;
      border:1px solid #cbd5f5;
      text-decoration:none;
      cursor:pointer;
      background:#fff;
      color:#0f172a;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); box-shadow:0 2px 10px rgba(15,23,42,.14); background:#f8fafc;}
    .btn-primary{
      background:#1d9bf0; border-color:#1d9bf0; color:#fff;
    }
    .btn-primary:hover{background:#0f80cc;}
    .btn-ghost{background: rgba(255,255,255,.9);}
    .actions{margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;}

    .kpi{
      padding:12px;
      border-radius:12px;
      border:1px solid #e2e8f0;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(248,250,252,.92));
    }
    .kpi .name{font-size:12px;color:#475569;margin:0;}
    .kpi .val{font-size:22px;font-weight:800;margin:6px 0 0;}
    .kpi .hint{font-size:12px;color:#64748b;margin:4px 0 0;}

    .chart{height: 320px; width:100%;}
    .tableWrap{overflow-x:auto;padding-top:6px;}
    #pivotTable, #recordsTable{background:#fff;border-radius:12px;}

    footer{
      text-align:center;
      font-size:12px;
      color:#6b7280;
      padding:10px 20px 18px;
      border-top:1px solid #e5e7eb;
      background-color: rgba(248,250,252,.9);
      margin-top:auto;
    }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="logo-group">
      <img src="conap_logo.jpg" alt="Logo CONAP">
      <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
    </div>
    <div class="title-group">
      <h1>Centro de consulta de datos</h1>
      <p>Sistema de monitoreo de actividades ¬∑ CONAP ‚Äì Direcci√≥n Regional Altiplano Central</p>
      <div class="chip-version">
        <span class="chip-dot"></span>
        <span>M√≥dulo de patrullajes ¬∑ Tablero anal√≠tico</span>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="page-header">
    <h2>Tablero anal√≠tico: Patrullajes de control y vigilancia</h2>
    <p>Filtros + indicadores + gr√°ficas interactivas (basado en <code>datos_patrullaje.csv</code>).</p>
    <span class="pill">An√°lisis din√°mico ¬∑ filtros por tiempo y por atributos</span>
  </section>

  <section class="card">
    <h3>üéõÔ∏è Filtros</h3>
    <p class="muted">Tip: selecciona un mes r√°pido, o usa rango de fechas + ‚ÄúAgrupar por‚Äù.</p>

    <div class="filters">
      <div class="field">
        <label for="monthQuick">Mes (r√°pido)</label>
        <select id="monthQuick">
          <option value="">(Todos)</option>
        </select>
      </div>

      <div class="field">
        <label for="dateFrom">Desde</label>
        <input id="dateFrom" type="date">
      </div>

      <div class="field">
        <label for="dateTo">Hasta</label>
        <input id="dateTo" type="date">
      </div>

      <div class="field">
        <label for="groupBy">Agrupar por</label>
        <select id="groupBy">
          <option value="mes">Mes</option>
          <option value="semana">Semana (ISO)</option>
          <option value="dia">D√≠a</option>
        </select>
      </div>

      <div class="field">
        <label for="fGuarda">Guarda recurso</label>
        <select id="fGuarda">
          <option value="">(Todos)</option>
        </select>
      </div>

      <div class="field">
        <label for="fMunicipio">Municipio</label>
        <select id="fMunicipio">
          <option value="">(Todos)</option>
        </select>
      </div>

      <div class="field">
        <label for="fRegion">Regi√≥n</label>
        <select id="fRegion">
          <option value="">(Todos)</option>
        </select>
      </div>

      <button class="btn" id="btnReset" type="button">üßπ Limpiar</button>
    </div>
  </section>

  <section class="grid grid-3" style="margin-top:14px;">
    <div class="kpi">
      <p class="name">Patrullajes (filtrados)</p>
      <p class="val" id="kpiTotal">‚Äî</p>
      <p class="hint" id="kpiRango">‚Äî</p>
    </div>
    <div class="kpi">
      <p class="name">Horas estimadas (si hay hora inicio/fin)</p>
      <p class="val" id="kpiHoras">‚Äî</p>
      <p class="hint" id="kpiHorasHint">‚Äî</p>
    </div>
    <div class="kpi">
      <p class="name">Registros con fecha v√°lida</p>
      <p class="val" id="kpiFechaOk">‚Äî</p>
      <p class="hint">Para series temporales y agrupaciones</p>
    </div>
  </section>

  <section class="grid grid-2" style="margin-top:14px;">
    <div class="card">
      <h3>üìà Patrullajes en el tiempo</h3>
      <p class="muted">Conteo seg√∫n ‚ÄúAgrupar por‚Äù.</p>
      <div id="chartTime" class="chart"></div>
    </div>
    <div class="card">
      <h3>üßë‚Äç‚úàÔ∏è Patrullajes por guarda recurso</h3>
      <p class="muted">Top 15 (con filtros aplicados).</p>
      <div id="chartGuarda" class="chart"></div>
    </div>
  </section>

  <section class="card" style="margin-top:14px;">
    <h3>üèòÔ∏è Municipios con m√°s patrullajes</h3>
    <p class="muted">Top 15 (con filtros aplicados).</p>
    <div id="chartMunicipio" class="chart"></div>
  </section>

  <section class="card" style="margin-top:14px;">
    <h3>üßæ Tabla din√°mica (pivote): Guarda √ó Tiempo</h3>
    <p class="muted">Cruza ‚ÄúGuarda recurso‚Äù vs el agrupamiento temporal elegido (mes/semana/d√≠a).</p>
    <div class="tableWrap">
      <div id="pivotTable"></div>
    </div>
  </section>

  <section class="card" style="margin-top:14px;">
    <h3>üîé Muestra de registros filtrados</h3>
    <p class="muted">Solo para revisar r√°pidamente (la tabla completa con informes sigue en ‚ÄúDatos detallados‚Äù).</p>
    <div class="tableWrap">
      <div id="recordsTable"></div>
    </div>
  </section>

  <div class="actions">
    <a class="btn btn-ghost" href="patrullajes_dashboard.html">‚Üê Volver al dashboard</a>
    <a class="btn btn-primary" href="patrullajes_datos.html">üìä Ir a datos detallados (informes)</a>
  </div>
</main>

<footer>
  <p>¬© 2025 Laboratorio SIG AALA en apoyo a CONAP ‚Äì Direcci√≥n Regional Altiplano Central</p>
</footer>

<script src="tabulator.min.js"></script>
<script src="papaparse.min.js"></script>
<script src="xlsx.full.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
  // ====== Config de columnas del CSV (seg√∫n tu patrullajes_datos.html) ======
  const F_FECHA = "Fecha de patrullaje";
  const F_GUARDA = "Guarda recursos responsable";
  const F_MUNI = "Municipio";
  const F_REGION = "Region";
  const F_HI = "Hora de Inicio del patrullaje";
  const F_HF = "Hora de finalizacion de patrullaje";
  const F_UBI = "Ubicacion";

  // ====== Estado ======
  const state = {
    monthQuick: "",
    dateFrom: "",
    dateTo: "",
    groupBy: "mes",
    guarda: "",
    municipio: "",
    region: ""
  };

  let raw = [];
  let rows = []; // enriquecidas con __fecha, __mes, __semana, __dia, __durHoras
  let pivotTable = null;
  let recordsTable = null;

  // ====== Utilidades ======
  const pad2 = (n) => String(n).padStart(2, "0");

  function parseDateFlexible(s) {
    if (!s) return null;
    const str = String(s).trim();
    if (!str) return null;

    // ISO / DateTime
    const dIso = new Date(str);
    if (!isNaN(dIso.getTime())) return dIso;

    // dd/mm/yyyy o mm/dd/yyyy
    // Intentamos detectar: si primer bloque > 12 asumimos dd/mm
    const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (m) {
      let a = parseInt(m[1],10);
      let b = parseInt(m[2],10);
      let y = parseInt(m[3],10);
      if (y < 100) y += 2000;

      let day, month;
      if (a > 12) { day = a; month = b; }           // dd/mm
      else if (b > 12) { day = b; month = a; }      // mm/dd
      else { day = a; month = b; }                  // ambiguo: asumimos dd/mm (ajustable)
      const d = new Date(y, month - 1, day);
      if (!isNaN(d.getTime())) return d;
    }

    return null;
  }

  function dateKey(d) {
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function monthKey(d) {
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }

  // ISO week (YYYY-W##)
  function isoWeekKey(d) {
    const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = tmp.getUTCDay() || 7;
    tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
    return `${tmp.getUTCFullYear()}-W${pad2(weekNo)}`;
  }

  function parseHourToMinutes(h) {
    if (!h) return null;
    const s = String(h).trim();
    const m = s.match(/^(\d{1,2}):(\d{2})/);
    if (!m) return null;
    const hh = parseInt(m[1],10), mm = parseInt(m[2],10);
    if (isNaN(hh) || isNaN(mm) || hh<0 || hh>23 || mm<0 || mm>59) return null;
    return hh*60 + mm;
  }

  function durationHours(row) {
    const a = parseHourToMinutes(row[F_HI]);
    const b = parseHourToMinutes(row[F_HF]);
    if (a == null || b == null) return null;
    let diff = b - a;
    if (diff < 0) diff += 24*60; // por si cruz√≥ medianoche
    return diff / 60;
  }

  function uniqSorted(values) {
    return Array.from(new Set(values.filter(v => v != null && String(v).trim() !== "").map(v => String(v).trim())))
      .sort((a,b)=>a.localeCompare(b,"es"));
  }

  function setOptions(selectEl, options, includeAll=true) {
    const current = selectEl.value;
    selectEl.innerHTML = "";
    if (includeAll) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(Todos)";
      selectEl.appendChild(opt);
    }
    for (const v of options) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
    // intenta conservar selecci√≥n
    if ([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
  }

  function setMonthQuickOptions(monthKeys) {
    const el = document.getElementById("monthQuick");
    const current = el.value;
    el.innerHTML = "";
    const all = document.createElement("option");
    all.value = "";
    all.textContent = "(Todos)";
    el.appendChild(all);
    for (const mk of monthKeys) {
      const opt = document.createElement("option");
      opt.value = mk;
      opt.textContent = mk; // puedes cambiarlo a "Mes A√±o" si quieres
      el.appendChild(opt);
    }
    if ([...el.options].some(o => o.value === current)) el.value = current;
  }

  function monthRange(mk) {
    // mk: YYYY-MM
    const [y, m] = mk.split("-").map(x=>parseInt(x,10));
    const from = new Date(y, m-1, 1);
    const to = new Date(y, m, 0);
    to.setHours(23,59,59,999);
    return {from, to};
  }

  function applyFilters(rowsIn) {
    const g = state.guarda.trim();
    const mu = state.municipio.trim();
    const r = state.region.trim();

    let from = state.dateFrom ? new Date(state.dateFrom + "T00:00:00") : null;
    let to = state.dateTo ? new Date(state.dateTo + "T23:59:59") : null;

    // Mes r√°pido ‚Äúmanda‚Äù: ajusta rango si est√° elegido
    if (state.monthQuick) {
      const mr = monthRange(state.monthQuick);
      from = mr.from; to = mr.to;
    }

    return rowsIn.filter(row => {
      if (g && String(row[F_GUARDA]||"").trim() !== g) return false;
      if (mu && String(row[F_MUNI]||"").trim() !== mu) return false;
      if (r && String(row[F_REGION]||"").trim() !== r) return false;

      const d = row.__fecha;
      if (from || to) {
        if (!d) return false;
        if (from && d < from) return false;
        if (to && d > to) return false;
      }
      return true;
    });
  }

  function groupKey(row) {
    if (state.groupBy === "semana") return row.__semana || "(sin fecha)";
    if (state.groupBy === "dia") return row.__dia || "(sin fecha)";
    return row.__mes || "(sin fecha)";
  }

  function countBy(rowsIn, keyFn) {
    const m = new Map();
    for (const row of rowsIn) {
      const k = keyFn(row);
      m.set(k, (m.get(k) || 0) + 1);
    }
    const keys = Array.from(m.keys()).sort((a,b)=>a.localeCompare(b));
    return { keys, values: keys.map(k => m.get(k)) };
  }

  function topBy(rowsIn, field, topN=15) {
    const m = new Map();
    for (const row of rowsIn) {
      const k = String(row[field] || "").trim() || "(vac√≠o)";
      m.set(k, (m.get(k) || 0) + 1);
    }
    return Array.from(m.entries())
      .sort((a,b)=>b[1]-a[1])
      .slice(0, topN);
  }

  function buildPivot(rowsIn) {
    // Guarda x Tiempo
    const rowKey = (row) => String(row[F_GUARDA]||"").trim() || "(vac√≠o)";
    const colKey = (row) => groupKey(row);

    const colSet = new Set();
    const tableMap = new Map(); // guarda -> obj

    for (const row of rowsIn) {
      const rk = rowKey(row);
      const ck = colKey(row);
      colSet.add(ck);
      if (!tableMap.has(rk)) tableMap.set(rk, { guarda: rk });
      const obj = tableMap.get(rk);
      obj[ck] = (obj[ck] || 0) + 1;
    }

    const cols = Array.from(colSet).sort((a,b)=>a.localeCompare(b));
    const data = Array.from(tableMap.values()).sort((a,b)=>a.guarda.localeCompare(b.guarda,"es"));

    const tabCols = [
      { title: "Guarda recurso", field: "guarda", frozen:true, headerFilter:"input", minWidth: 220 },
      ...cols.map(c => ({ title: c, field: c, hozAlign:"right" }))
    ];

    return { tabCols, data };
  }

  function fmtNum(x, digits=0) {
    if (x == null || isNaN(x)) return "‚Äî";
    return Number(x).toLocaleString("es-GT", { maximumFractionDigits: digits, minimumFractionDigits: digits });
  }

  function update() {
    const filtered = applyFilters(rows);

    // KPI
    const total = filtered.length;
    document.getElementById("kpiTotal").textContent = fmtNum(total);
    const rangoTxt = state.monthQuick
      ? `Mes: ${state.monthQuick}`
      : ((state.dateFrom || state.dateTo) ? `Rango: ${state.dateFrom || "‚Ä¶"} ‚Üí ${state.dateTo || "‚Ä¶"}`
      : "Rango: (todo)");
    document.getElementById("kpiRango").textContent = rangoTxt;

    const hrs = filtered.map(r => r.__durHoras).filter(v => v != null && !isNaN(v));
    const sumHrs = hrs.reduce((a,b)=>a+b,0);
    document.getElementById("kpiHoras").textContent = hrs.length ? fmtNum(sumHrs,1) : "‚Äî";
    document.getElementById("kpiHorasHint").textContent =
      hrs.length ? `${fmtNum(hrs.length)} registro(s) con horas` : "No hay horas consistentes en el filtro";

    const fechaOk = filtered.filter(r => r.__fecha).length;
    document.getElementById("kpiFechaOk").textContent = fmtNum(fechaOk);

    // Chart tiempo
    const serie = countBy(filtered.filter(r => r.__fecha), (row)=>groupKey(row));
    Plotly.react("chartTime", [{
      x: serie.keys,
      y: serie.values,
      type: "bar",
      hovertemplate: "%{x}<br>Patrullajes: %{y}<extra></extra>"
    }], {
      margin: {l: 50, r: 10, t: 16, b: 70},
      xaxis: { tickangle: -30, automargin:true },
      yaxis: { title: "Patrullajes" }
    }, {responsive:true, displayModeBar:false});

    // Chart guardas
    const topG = topBy(filtered, F_GUARDA, 15);
    Plotly.react("chartGuarda", [{
      x: topG.map(x=>x[0]),
      y: topG.map(x=>x[1]),
      type: "bar",
      hovertemplate: "%{x}<br>Patrullajes: %{y}<extra></extra>"
    }], {
      margin: {l: 50, r: 10, t: 16, b: 120},
      xaxis: { tickangle: -35, automargin:true },
      yaxis: { title: "Patrullajes" }
    }, {responsive:true, displayModeBar:false});

    // Chart municipios
    const topM = topBy(filtered, F_MUNI, 15);
    Plotly.react("chartMunicipio", [{
      x: topM.map(x=>x[0]),
      y: topM.map(x=>x[1]),
      type: "bar",
      hovertemplate: "%{x}<br>Patrullajes: %{y}<extra></extra>"
    }], {
      margin: {l: 50, r: 10, t: 16, b: 120},
      xaxis: { tickangle: -35, automargin:true },
      yaxis: { title: "Patrullajes" }
    }, {responsive:true, displayModeBar:false});

    // Pivot Tabulator
    const piv = buildPivot(filtered);
    if (!pivotTable) {
      pivotTable = new Tabulator("#pivotTable", {
        data: piv.data,
        columns: piv.tabCols,
        layout: "fitDataStretch",
        pagination: "local",
        paginationSize: 15,
        paginationSizeSelector: [15, 30, 50, 100],
        movableColumns: true
      });
    } else {
      pivotTable.setColumns(piv.tabCols);
      pivotTable.setData(piv.data);
    }

    // Tabla muestra de registros
    const sampleCols = [
      { title: "Fecha", field: F_FECHA, headerFilter:"input", width: 140 },
      { title: "Guarda", field: F_GUARDA, headerFilter:"input", minWidth: 220 },
      { title: "Municipio", field: F_MUNI, headerFilter:"input", width: 160 },
      { title: "Regi√≥n", field: F_REGION, headerFilter:"input", width: 140 },
      { title: "Ubicaci√≥n", field: F_UBI, headerFilter:"input", minWidth: 220 },
      { title: "Hora Inicio", field: F_HI, headerFilter:"input", width: 120 },
      { title: "Hora Fin", field: F_HF, headerFilter:"input", width: 120 }
    ];

    if (!recordsTable) {
      recordsTable = new Tabulator("#recordsTable", {
        data: filtered.slice(0, 500),
        columns: sampleCols,
        layout: "fitDataStretch",
        pagination: "local",
        paginationSize: 20,
        paginationSizeSelector: [20, 50, 100, 200],
        movableColumns: true
      });
    } else {
      recordsTable.setColumns(sampleCols);
      recordsTable.setData(filtered.slice(0, 500));
    }
  }

  function wireControls() {
    const monthQuick = document.getElementById("monthQuick");
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const groupBy = document.getElementById("groupBy");
    const fGuarda = document.getElementById("fGuarda");
    const fMunicipio = document.getElementById("fMunicipio");
    const fRegion = document.getElementById("fRegion");
    const btnReset = document.getElementById("btnReset");

    monthQuick.addEventListener("change", () => { state.monthQuick = monthQuick.value; update(); });
    dateFrom.addEventListener("change", () => { state.dateFrom = dateFrom.value; state.monthQuick=""; monthQuick.value=""; update(); });
    dateTo.addEventListener("change", () => { state.dateTo = dateTo.value; state.monthQuick=""; monthQuick.value=""; update(); });
    groupBy.addEventListener("change", () => { state.groupBy = groupBy.value; update(); });

    fGuarda.addEventListener("change", () => { state.guarda = fGuarda.value; update(); });
    fMunicipio.addEventListener("change", () => { state.municipio = fMunicipio.value; update(); });
    fRegion.addEventListener("change", () => { state.region = fRegion.value; update(); });

    btnReset.addEventListener("click", () => {
      state.monthQuick = "";
      state.dateFrom = "";
      state.dateTo = "";
      state.groupBy = "mes";
      state.guarda = "";
      state.municipio = "";
      state.region = "";

      monthQuick.value = "";
      dateFrom.value = "";
      dateTo.value = "";
      groupBy.value = "mes";
      fGuarda.value = "";
      fMunicipio.value = "";
      fRegion.value = "";

      update();
    });
  }

  // ====== Carga CSV ======
  document.addEventListener("DOMContentLoaded", () => {
    wireControls();

    fetch("./datos_patrullaje.csv", { cache: "no-store" })
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status + " " + r.statusText);
        return r.text();
      })
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true, delimiter:";" });
        raw = parsed.data || [];

        rows = raw.map(r => {
          const d = parseDateFlexible(r[F_FECHA]);
          const out = Object.assign({}, r);
          out.__fecha = d;
          out.__mes = d ? monthKey(d) : null;
          out.__semana = d ? isoWeekKey(d) : null;
          out.__dia = d ? dateKey(d) : null;
          out.__durHoras = durationHours(r);
          return out;
        });

        // Opciones filtros
        setOptions(document.getElementById("fGuarda"), uniqSorted(rows.map(r=>r[F_GUARDA])));
        setOptions(document.getElementById("fMunicipio"), uniqSorted(rows.map(r=>r[F_MUNI])));
        setOptions(document.getElementById("fRegion"), uniqSorted(rows.map(r=>r[F_REGION])));

        // Mes r√°pido (ordenado)
        const months = uniqSorted(rows.map(r=>r.__mes).filter(Boolean));
        setMonthQuickOptions(months);

        // Default: √∫ltimo mes si existe
        if (months.length) {
          state.monthQuick = months[months.length - 1];
          document.getElementById("monthQuick").value = state.monthQuick;
        }

        update();
      })
      .catch(err => {
        console.error(err);
        alert("Error al cargar datos_patrullaje.csv: " + err.message);
      });
  });
</script>
</body>
</html>
