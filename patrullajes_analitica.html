<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patrullajes - Tablero anal√≠tico</title>

  <!-- Librer√≠as locales (como tu proyecto actual) -->
  <link rel="stylesheet" href="tabulator.min.css">

  <!-- Plotly para gr√°ficas -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    :root{
      --bg1:#e5f3f0;
      --bg2:#f5f7fa;
      --bg3:#eef2ff;
      --ink:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.10);
      --card:rgba(255,255,255,.92);
      --shadow:0 12px 26px rgba(15,23,42,.10);
      --r:16px;
      --brand1:#0f766e;
      --brand2:#0e7490;
      --blue1:#1d9bf0;
      --blue2:#38bdf8;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(circle at top left, #dbeafe 0, transparent 55%),
        radial-gradient(circle at bottom right, #bbf7d0 0, transparent 55%),
        linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 35%,var(--bg3) 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color:#fff;
      padding:14px 18px 16px;
      box-shadow:0 2px 10px rgba(15,23,42,.25);
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .logos{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.15);
      border-radius:999px;
      padding:6px 10px;
      backdrop-filter: blur(4px);
    }
    .logos img{height:42px; width:auto; display:block; object-fit:contain;}
    .headtxt{flex:1; min-width:240px; text-align:center}
    .headtxt h1{margin:0; font-size:20px; letter-spacing:.2px;}
    .headtxt p{margin:4px 0 0; font-size:12px; opacity:.95;}
    .chip{
      margin-top:10px;
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.22)}

    main{
      max-width:1100px;
      width:100%;
      margin:18px auto 38px;
      padding:0 16px;
    }
    .page-title h2{margin:0 0 6px; font-size:22px;}
    .page-title p{margin:0; color:var(--muted);}
    .pill{
      display:inline-flex;
      margin-top:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(148,163,184,.45);
      box-shadow:0 2px 10px rgba(15,23,42,.06);
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      font-weight:700;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(255,255,255,.9);
      color:var(--ink);
      text-decoration:none;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 20px rgba(15,23,42,.10); background:rgba(248,250,252,.95);}
    .btn-primary{
      background:linear-gradient(90deg,var(--blue1),var(--blue2));
      border-color:rgba(59,130,246,.35);
      color:#fff;
    }
    .btn-primary:hover{background:linear-gradient(90deg,#0f80cc,#0ea5e9);}
    .btn-ghost{background:rgba(255,255,255,.85);}

    .grid{display:grid; gap:14px; margin-top:14px;}
    .grid-2{grid-template-columns: 1.2fr .8fr;}
    .grid-3{grid-template-columns: repeat(3, minmax(0,1fr));}
    .grid-2b{grid-template-columns: 1fr 1fr;}
    @media (max-width: 980px){
      .grid-2{grid-template-columns:1fr;}
      .grid-2b{grid-template-columns:1fr;}
      .grid-3{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h3{margin:0 0 8px; font-size:15px; display:flex; align-items:center; gap:8px;}
    .sub{margin:0; color:var(--muted); font-size:12px;}

    .filters{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px;
      align-items:end;
    }
    @media (max-width: 980px){ .filters{grid-template-columns: repeat(2, minmax(0,1fr));} }

    label{display:block; font-size:12px; color:#334155; font-weight:750; margin:0 0 6px;}
    select, input[type="date"]{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(255,255,255,.95);
      outline:none;
      font-size:13px;
    }
    select:focus, input[type="date"]:focus{
      border-color:#60a5fa;
      box-shadow:0 0 0 3px rgba(96,165,250,.18);
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .kpi{
      border-radius:14px;
      border:1px solid rgba(15,23,42,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,250,252,.92));
      padding:10px 12px;
    }
    .kpi .klabel{font-size:12px; color:var(--muted); margin:0;}
    .kpi .kval{font-size:20px; font-weight:900; margin:6px 0 0;}

    .chart{height:320px; width:100%;}
    .tableWrap{overflow-x:auto; padding-top:6px;}
    #pivotTable, #recordsTable{background:#fff; border-radius:12px;}

    footer{
      margin-top:auto;
      text-align:center;
      font-size:12px;
      color:#6b7280;
      padding:12px 20px 18px;
      border-top:1px solid #e5e7eb;
      background:rgba(248,250,252,.9);
    }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="logos">
      <img src="conap_logo.jpg" alt="Logo CONAP">
      <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
    </div>
    <div class="headtxt">
      <h1>Centro de consulta de datos</h1>
      <p>Sistema de monitoreo de actividades ¬∑ CONAP ‚Äì Direcci√≥n Regional Altiplano Central</p>
      <div class="chip"><span class="dot"></span><span>Patrullajes ¬∑ Tablero anal√≠tico</span></div>
    </div>
  </div>
</header>

<main>
  <section class="page-title">
    <h2>Tablero din√°mico (CSV)</h2>
    <p>Gr√°ficas + tabla din√°mica (pivote) + filtros por tiempo, guardarecurso y atributos.</p>
    <span class="pill">Fuente: <code>datos_patrullaje.csv</code> ¬∑ An√°lisis local en el navegador</span>

    <!-- Botones en el orden pedido -->
    <div class="actions">
      <a class="btn btn-ghost" href="patrullajes_dashboard.html">‚Üê Volver al dashboard</a>
      <a class="btn btn-primary" href="patrullajes_datos.html">üìä Ir a datos detallados (informes)</a>
    </div>
  </section>

  <section class="card">
    <h3>üéõÔ∏è Filtros</h3>
    <p class="sub">Al cambiar un filtro, se actualizan KPIs, gr√°ficas y tablas.</p>

    <div class="filters">
      <div>
        <label for="monthQuick">Mes (r√°pido)</label>
        <select id="monthQuick"><option value="">Todos</option></select>
      </div>

      <div>
        <label for="dateFrom">Desde</label>
        <input id="dateFrom" type="date">
      </div>

      <div>
        <label for="dateTo">Hasta</label>
        <input id="dateTo" type="date">
      </div>

      <div>
        <label for="groupBy">Agrupar tiempo</label>
        <select id="groupBy">
          <option value="mes">Mes</option>
          <option value="semana">Semana (ISO)</option>
          <option value="dia">D√≠a</option>
        </select>
      </div>

      <div>
        <label for="fGuarda">Guarda recurso</label>
        <select id="fGuarda"><option value="">Todos</option></select>
      </div>

      <div>
        <label for="fMunicipio">Municipio</label>
        <select id="fMunicipio"><option value="">Todos</option></select>
      </div>

      <div>
        <label for="fRegion">Regi√≥n</label>
        <select id="fRegion"><option value="">Todos</option></select>
      </div>

      <div>
        <label for="fArea">√Årea protegida</label>
        <select id="fArea"><option value="">Todos</option></select>
      </div>

      <div>
        <label for="fTipo">Tipo de patrullaje</label>
        <select id="fTipo"><option value="">Todos</option></select>
      </div>

      <div>
        <label for="fIlegal">Actividad ilegal</label>
        <select id="fIlegal">
          <option value="">Todas</option>
          <option value="si">Con registro</option>
          <option value="no">Sin registro</option>
        </select>
      </div>

      <div>
        <label for="fInst">Instituciones</label>
        <select id="fInst">
          <option value="">Todas</option>
          <option value="si">Con instituciones</option>
          <option value="no">Sin instituciones</option>
        </select>
      </div>

      <div>
        <label>&nbsp;</label>
        <button class="btn" id="btnReset" type="button">üßπ Limpiar</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><p class="klabel">Registros filtrados</p><p class="kval" id="kTotal">‚Äî</p></div>
      <div class="kpi"><p class="klabel">Guardas √∫nicos</p><p class="kval" id="kGuardas">‚Äî</p></div>
      <div class="kpi"><p class="klabel">Municipios √∫nicos</p><p class="kval" id="kMunis">‚Äî</p></div>
      <div class="kpi"><p class="klabel">Prom. duraci√≥n (h)</p><p class="kval" id="kDur">‚Äî</p></div>
      <div class="kpi"><p class="klabel">% con actividad ilegal</p><p class="kval" id="kPctIlegal">‚Äî</p></div>
      <div class="kpi"><p class="klabel">% con instituciones</p><p class="kval" id="kPctInst">‚Äî</p></div>
    </div>
  </section>

  <section class="grid grid-2" style="margin-top:14px;">
    <div class="card">
      <h3>üìà Patrullajes por periodo</h3>
      <p class="sub">Conteo seg√∫n ‚ÄúAgrupar tiempo‚Äù.</p>
      <div id="chartTime" class="chart"></div>
    </div>

    <div class="card">
      <h3>‚öñÔ∏è Actividad ilegal (proporci√≥n)</h3>
      <p class="sub">Se calcula desde ‚ÄúActividad ilegal observada‚Äù.</p>
      <div id="chartIlegal" class="chart"></div>
    </div>
  </section>

  <section class="grid grid-2b" style="margin-top:14px;">
    <div class="card">
      <h3>üßë‚Äç‚úàÔ∏è Top Guardarecursos</h3>
      <p class="sub">Top 15 por conteo.</p>
      <div id="chartGuarda" class="chart"></div>
    </div>

    <div class="card">
      <h3>üèòÔ∏è Top Municipios</h3>
      <p class="sub">Top 15 por conteo.</p>
      <div id="chartMuni" class="chart"></div>
    </div>
  </section>

  <section class="card" style="margin-top:14px;">
    <h3>üßæ Tabla din√°mica (pivote): Guarda √ó Periodo</h3>
    <p class="sub">Filas: guarda recurso ¬∑ Columnas: mes/semana/d√≠a ¬∑ Valores: conteos.</p>
    <div class="tableWrap"><div id="pivotTable"></div></div>
  </section>

  <section class="card" style="margin-top:14px;">
    <h3>üìã Registros filtrados (muestra)</h3>
    <p class="sub">Muestra hasta 800 filas filtradas (para revisi√≥n). La tabla completa est√° en ‚ÄúDatos detallados‚Äù.</p>
    <div class="tableWrap"><div id="recordsTable"></div></div>
  </section>

  <!-- Botones en el orden pedido (tambi√©n al final) -->
  <div class="actions">
    <a class="btn btn-ghost" href="patrullajes_dashboard.html">‚Üê Volver al dashboard</a>
    <a class="btn btn-primary" href="patrullajes_datos.html">üìä Ir a datos detallados (informes)</a>
  </div>
</main>

<footer>
  <p>¬© 2025 Laboratorio SIG AALA en apoyo a CONAP ‚Äì Direcci√≥n Regional Altiplano Central</p>
</footer>

<!-- Librer√≠as locales (como tu tabla actual) -->
<script src="tabulator.min.js"></script>
<script src="papaparse.min.js"></script>
<script src="xlsx.full.min.js"></script>

<script>
  // ===== Config CSV =====
  const CSV_URL = "./datos_patrullaje.csv";
  const DELIM = ";";

  // Columnas reales del CSV (seg√∫n tu archivo)
  const F = {
    guarda: "Guarda recursos responsable",
    municipio: "Municipio",
    fecha: "Fecha de patrullaje",
    hIni: "Hora de Inicio del patrullaje",
    hFin: "Hora de finalizacion de patrullaje",
    region: "Region",
    ubic: "Ubicacion",
    area: "Area protegida",
    tipo: "Tipo de patrullaje",
    hayInst: "Hay mas instituciones involucradas en el patrullaje",
    inst: "Instituciones involucradas",
    ilegal: "Actividad ilegal observada",
  };

  // ===== Estado =====
  const state = {
    monthQuick: "",
    dateFrom: "",
    dateTo: "",
    groupBy: "mes",
    guarda: "",
    municipio: "",
    region: "",
    area: "",
    tipo: "",
    ilegal: "", // "", "si", "no"
    inst: ""    // "", "si", "no"
  };

  let raw = [];
  let rows = [];
  let tPivot = null;
  let tRecords = null;

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function parseDateFlexible(value){
    if(!value) return null;
    let s = String(value).trim();
    if(!s) return null;

    // corta si viene con hora
    if (s.includes("T")) s = s.split("T")[0];
    if (s.includes(" ")) s = s.split(" ")[0];

    // YYYY-MM-DD
    let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m){
      const y = +m[1], mo = +m[2], d = +m[3];
      const dt = new Date(y, mo-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // dd/mm/yyyy o mm/dd/yyyy (heur√≠stica)
    const parts = s.split(/[\/\-]/).map(x => parseInt(x, 10));
    if(parts.length === 3 && parts.every(n => Number.isFinite(n))){
      let [a,b,y] = parts;
      if (y < 100) y += 2000;
      let day, month;
      if (a > 12 && b <= 12) { day = a; month = b; }
      else if (b > 12 && a <= 12) { day = b; month = a; }
      else { day = a; month = b; } // default dd/mm
      const dt = new Date(y, month-1, day);
      return isNaN(dt.getTime()) ? null : dt;
    }

    return null;
  }

  function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function monthKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }

  function isoWeekKey(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `${d.getUTCFullYear()}-W${pad2(weekNo)}`;
  }

  function parseTimeToMin(s){
    if(!s) return null;
    const t = String(s).trim();
    const m = t.match(/^(\d{1,2}):(\d{2})/);
    if(!m) return null;
    const hh = +m[1], mm = +m[2];
    if(!Number.isFinite(hh)||!Number.isFinite(mm)||hh<0||hh>23||mm<0||mm>59) return null;
    return hh*60 + mm;
  }

  function durHours(row){
    const a = parseTimeToMin(row[F.hIni]);
    const b = parseTimeToMin(row[F.hFin]);
    if(a==null || b==null) return null;
    let diff = b - a;
    if(diff < 0) diff += 24*60;
    return diff/60;
  }

  function norm(s){
    return (s||"").toString().trim();
  }

  function isYesText(v){
    const t = norm(v).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    return t === "si" || t === "s√≠";
  }

  function isIlegal(row){
    const v = norm(row[F.ilegal]).toLowerCase();
    if(!v) return false;
    if(v === "no") return false;
    return true;
  }

  function hasInstituciones(row){
    if (isYesText(row[F.hayInst])) return true;
    const inst = norm(row[F.inst]);
    return inst.length > 0;
  }

  function uniqSorted(arr){
    return Array.from(new Set(arr.map(norm).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"es"));
  }

  function setOptions(selectEl, values){
    const curr = selectEl.value;
    selectEl.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "Todos";
    selectEl.appendChild(optAll);
    values.forEach(v=>{
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      selectEl.appendChild(o);
    });
    if ([...selectEl.options].some(o=>o.value===curr)) selectEl.value = curr;
  }

  function monthRange(mk){
    const [y,m] = mk.split("-").map(x=>parseInt(x,10));
    const from = new Date(y, m-1, 1);
    const to = new Date(y, m, 0);
    to.setHours(23,59,59,999);
    return {from,to};
  }

  function groupLabel(row){
    if(!row.__date) return "(sin fecha)";
    if(state.groupBy === "dia") return row.__day;
    if(state.groupBy === "semana") return row.__week;
    return row.__month;
  }

  function applyFilters(){
    let from = state.dateFrom ? new Date(state.dateFrom + "T00:00:00") : null;
    let to = state.dateTo ? new Date(state.dateTo + "T23:59:59") : null;

    if(state.monthQuick){
      const mr = monthRange(state.monthQuick);
      from = mr.from; to = mr.to;
    }

    return rows.filter(r=>{
      if(state.guarda && norm(r[F.guarda]) !== state.guarda) return false;
      if(state.municipio && norm(r[F.municipio]) !== state.municipio) return false;
      if(state.region && norm(r[F.region]) !== state.region) return false;
      if(state.area && norm(r[F.area]) !== state.area) return false;
      if(state.tipo && norm(r[F.tipo]) !== state.tipo) return false;

      if(state.ilegal === "si" && !isIlegal(r)) return false;
      if(state.ilegal === "no" && isIlegal(r)) return false;

      if(state.inst === "si" && !hasInstituciones(r)) return false;
      if(state.inst === "no" && hasInstituciones(r)) return false;

      if(from || to){
        if(!r.__date) return false;
        if(from && r.__date < from) return false;
        if(to && r.__date > to) return false;
      }
      return true;
    });
  }

  function countBy(rowsIn, keyFn){
    const m = new Map();
    rowsIn.forEach(r=>{
      const k = keyFn(r);
      m.set(k, (m.get(k)||0) + 1);
    });
    const keys = Array.from(m.keys()).sort((a,b)=>a.localeCompare(b));
    return {x: keys, y: keys.map(k=>m.get(k))};
  }

  function topBy(rowsIn, field, n=15){
    const m = new Map();
    rowsIn.forEach(r=>{
      const k = norm(r[field]) || "(vac√≠o)";
      m.set(k, (m.get(k)||0) + 1);
    });
    return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
  }

  function fmt(x, d=0){
    if(x==null || !isFinite(x)) return "‚Äî";
    return Number(x).toLocaleString("es-GT",{maximumFractionDigits:d,minimumFractionDigits:d});
  }

  function updateKPIs(filtered){
    const total = filtered.length;
    const guardas = new Set(filtered.map(r=>norm(r[F.guarda])).filter(Boolean));
    const munis = new Set(filtered.map(r=>norm(r[F.municipio])).filter(Boolean));

    const durs = filtered.map(r=>r.__durH).filter(v => typeof v === "number" && isFinite(v));
    const avgDur = durs.length ? durs.reduce((a,b)=>a+b,0)/durs.length : null;

    const ileg = filtered.filter(isIlegal).length;
    const inst = filtered.filter(hasInstituciones).length;

    $("kTotal").textContent = fmt(total);
    $("kGuardas").textContent = fmt(guardas.size);
    $("kMunis").textContent = fmt(munis.size);
    $("kDur").textContent = avgDur==null ? "‚Äî" : fmt(avgDur, 1);
    $("kPctIlegal").textContent = total ? fmt((ileg*100)/total, 1) + "%" : "‚Äî";
    $("kPctInst").textContent = total ? fmt((inst*100)/total, 1) + "%" : "‚Äî";
  }

  function drawCharts(filtered){
    const withDate = filtered.filter(r=>r.__date);

    // Time
    const s = countBy(withDate, groupLabel);
    Plotly.react("chartTime", [{
      x: s.x, y: s.y, type:"bar",
      hovertemplate: "%{x}<br><b>%{y}</b> registro(s)<extra></extra>"
    }], {
      margin:{l:50,r:10,t:10,b:70},
      xaxis:{tickangle:-30, automargin:true},
      yaxis:{title:"Conteo"}
    }, {responsive:true, displayModeBar:false});

    // Illegal pie
    const y = filtered.filter(isIlegal).length;
    const n = filtered.length - y;
    Plotly.react("chartIlegal", [{
      labels:["Con registro","Sin registro"],
      values:[y,n],
      type:"pie",
      textinfo:"percent",
      hovertemplate: "%{label}: <b>%{value}</b><extra></extra>"
    }], {
      margin:{l:10,r:10,t:10,b:10},
      legend:{orientation:"h", y:-0.05}
    }, {responsive:true, displayModeBar:false});

    // Top guarda
    const tg = topBy(filtered, F.guarda, 15);
    Plotly.react("chartGuarda", [{
      x: tg.map(e=>e[0]),
      y: tg.map(e=>e[1]),
      type:"bar",
      hovertemplate: "%{x}<br><b>%{y}</b><extra></extra>"
    }], {
      margin:{l:50,r:10,t:10,b:120},
      xaxis:{tickangle:-35, automargin:true},
      yaxis:{title:"Conteo"}
    }, {responsive:true, displayModeBar:false});

    // Top muni
    const tm = topBy(filtered, F.municipio, 15);
    Plotly.react("chartMuni", [{
      x: tm.map(e=>e[0]),
      y: tm.map(e=>e[1]),
      type:"bar",
      hovertemplate: "%{x}<br><b>%{y}</b><extra></extra>"
    }], {
      margin:{l:50,r:10,t:10,b:120},
      xaxis:{tickangle:-35, automargin:true},
      yaxis:{title:"Conteo"}
    }, {responsive:true, displayModeBar:false});
  }

  function buildPivot(filtered){
    const colSet = new Set();
    const map = new Map(); // guarda -> obj

    filtered.forEach(r=>{
      const rk = norm(r[F.guarda]) || "(vac√≠o)";
      const ck = groupLabel(r);
      colSet.add(ck);
      if(!map.has(rk)) map.set(rk, {guarda: rk});
      const obj = map.get(rk);
      obj[ck] = (obj[ck]||0) + 1;
    });

    const cols = Array.from(colSet).sort((a,b)=>a.localeCompare(b));
    const data = Array.from(map.values()).sort((a,b)=>a.guarda.localeCompare(b.guarda,"es"));

    const tabCols = [
      { title:"Guarda recurso", field:"guarda", frozen:true, headerFilter:"input", minWidth:220 },
      ...cols.map(c=>({ title:c, field:c, hozAlign:"right" }))
    ];
    return {tabCols, data};
  }

  function updateTables(filtered){
    // Pivot
    const piv = buildPivot(filtered);
    if(!tPivot){
      tPivot = new Tabulator("#pivotTable", {
        data: piv.data,
        columns: piv.tabCols,
        layout:"fitDataStretch",
        pagination:"local",
        paginationSize:15,
        paginationSizeSelector:[15,30,50,100],
        movableColumns:true
      });
    }else{
      tPivot.setColumns(piv.tabCols);
      tPivot.setData(piv.data);
    }

    // Records sample
    const cols = [
      {title:"Fecha", field:F.fecha, headerFilter:"input", width:140},
      {title:"Guarda", field:F.guarda, headerFilter:"input", minWidth:220},
      {title:"Municipio", field:F.municipio, headerFilter:"input", width:160},
      {title:"Regi√≥n", field:F.region, headerFilter:"input", width:140},
      {title:"√Årea", field:F.area, headerFilter:"input", width:160},
      {title:"Tipo", field:F.tipo, headerFilter:"input", width:170},
      {title:"Actividad ilegal", field:F.ilegal, headerFilter:"input", width:160},
      {title:"Instituciones", field:F.inst, headerFilter:"input", minWidth:220},
      {title:"Hora inicio", field:F.hIni, headerFilter:"input", width:120},
      {title:"Hora fin", field:F.hFin, headerFilter:"input", width:120},
      {title:"Ubicaci√≥n", field:F.ubic, headerFilter:"input", minWidth:220},
    ];

    const sample = filtered.slice(0, 800);
    if(!tRecords){
      tRecords = new Tabulator("#recordsTable", {
        data: sample,
        columns: cols,
        layout:"fitDataStretch",
        pagination:"local",
        paginationSize:20,
        paginationSizeSelector:[20,50,100,200],
        movableColumns:true
      });
    }else{
      tRecords.setColumns(cols);
      tRecords.setData(sample);
    }
  }

  function updateAll(){
    const filtered = applyFilters();
    updateKPIs(filtered);
    drawCharts(filtered);
    updateTables(filtered);
  }

  function wire(){
    const ids = ["monthQuick","dateFrom","dateTo","groupBy","fGuarda","fMunicipio","fRegion","fArea","fTipo","fIlegal","fInst"];
    ids.forEach(id => $(id).addEventListener("change", () => {
      if(id === "monthQuick" && $("monthQuick").value){
        state.monthQuick = $("monthQuick").value;
      }else if(id === "dateFrom" || id === "dateTo"){
        // si tocan rango manual, se limpia el monthQuick
        state.monthQuick = "";
        $("monthQuick").value = "";
        state.dateFrom = $("dateFrom").value;
        state.dateTo = $("dateTo").value;
      }else{
        state[idMap(id)] = $(id).value;
      }
      // sincroniza los que no pasan por idMap
      if(id === "groupBy") state.groupBy = $("groupBy").value;
      if(id === "monthQuick") state.monthQuick = $("monthQuick").value;

      updateAll();
    }));

    $("btnReset").addEventListener("click", ()=>{
      Object.assign(state, {
        monthQuick:"",
        dateFrom:"",
        dateTo:"",
        groupBy:"mes",
        guarda:"",
        municipio:"",
        region:"",
        area:"",
        tipo:"",
        ilegal:"",
        inst:""
      });

      $("monthQuick").value = "";
      $("dateFrom").value = "";
      $("dateTo").value = "";
      $("groupBy").value = "mes";
      $("fGuarda").value = "";
      $("fMunicipio").value = "";
      $("fRegion").value = "";
      $("fArea").value = "";
      $("fTipo").value = "";
      $("fIlegal").value = "";
      $("fInst").value = "";

      updateAll();
    });
  }

  function idMap(id){
    // mapea ids de selects al state
    if(id==="fGuarda") return "guarda";
    if(id==="fMunicipio") return "municipio";
    if(id==="fRegion") return "region";
    if(id==="fArea") return "area";
    if(id==="fTipo") return "tipo";
    if(id==="fIlegal") return "ilegal";
    if(id==="fInst") return "inst";
    return id;
  }

  async function load(){
    const res = await fetch(CSV_URL, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const csv = await res.text();

    const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true, delimiter:DELIM});
    raw = (parsed.data || []).filter(r => r && Object.keys(r).some(k => norm(r[k])));

    rows = raw.map(r=>{
      const d = parseDateFlexible(r[F.fecha]);
      return {
        ...r,
        __date: d,
        __day: d ? ymd(d) : null,
        __month: d ? monthKey(d) : null,
        __week: d ? isoWeekKey(d) : null,
        __durH: durHours(r)
      };
    });

    // opciones filtros
    setOptions($("fGuarda"), uniqSorted(rows.map(r=>r[F.guarda])));
    setOptions($("fMunicipio"), uniqSorted(rows.map(r=>r[F.municipio])));
    setOptions($("fRegion"), uniqSorted(rows.map(r=>r[F.region])));
    setOptions($("fArea"), uniqSorted(rows.map(r=>r[F.area])));
    setOptions($("fTipo"), uniqSorted(rows.map(r=>r[F.tipo])));

    // meses r√°pidos (√∫ltimo mes por defecto si existe)
    const months = uniqSorted(rows.map(r=>r.__month).filter(Boolean));
    const mq = $("monthQuick");
    mq.innerHTML = `<option value="">Todos</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join("");
    if(months.length){
      state.monthQuick = months[months.length-1];
      mq.value = state.monthQuick;
    }

    updateAll();
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    wire();
    load().catch(err=>{
      console.error(err);
      alert("No se pudo cargar datos_patrullaje.csv: " + err.message);
    });
  });
</script>
</body>
</html>
