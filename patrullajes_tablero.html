<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC192 · Patrullajes - Tablero dinámico (CSV)</title>

  <!-- Tabulator local (repo) -->
  <link rel="stylesheet" href="tabulator.min.css">

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.heat -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- leaflet-image (captura del mapa a canvas) -->
  <script src="https://unpkg.com/leaflet-image@latest/leaflet-image.js"></script>

  <!-- jsPDF (PDF liviano con texto real + imágenes comprimidas) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --verde-header:#34d399;
      --verde-header-2:#60a5fa;

      --azul-boton:#2563eb;
      --azul-boton-hover:#1d4ed8;

      --gris-fondo:#f4f7fb;
      --texto-principal:#0f172a;
      --texto-secundario:#475569;
      --borde-suave: rgba(148,163,184,0.35);
      --card-radius:16px;

      --chart-grid: rgba(2,6,23,0.08);
      --chart-tick: rgba(15,23,42,0.85);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto-principal);
      background:
        radial-gradient(circle at 10% 15%, rgba(52,211,153,0.28) 0, transparent 55%),
        radial-gradient(circle at 90% 30%, rgba(96,165,250,0.25) 0, transparent 55%),
        radial-gradient(circle at 40% 95%, rgba(14,165,233,0.12) 0, transparent 60%),
        linear-gradient(180deg, #f7fbff 0%, var(--gris-fondo) 45%, #f2fbf7 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      background: linear-gradient(90deg, rgba(16,185,129,0.95), rgba(59,130,246,0.95));
      color:#fff;
      padding:14px 20px 18px;
      box-shadow:0 6px 24px rgba(15,23,42,.14);
      position:sticky; top:0; z-index:50;
    }
    .header-inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; flex-wrap:wrap;
    }
    .logo-group{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background-color: rgba(255,255,255,0.12);
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
    }
    .logo-group img{
      height:40px; max-width:130px; object-fit:contain;
      background-color:#fff; border-radius:999px; padding:4px 8px;
      box-shadow:0 2px 6px rgba(15,23,42,.18);
    }
    .title-group{ text-align:right; flex:1 1 260px;}
    .title-group h1{ margin:0 0 2px; font-size:22px; letter-spacing:.02em;}
    .title-group p{ margin:0; font-size:13px; opacity:.96; line-height:1.4;}

    main{
      max-width:1100px; width:100%;
      margin:16px auto 0;
      padding:0 20px 40px;
      flex:1 0 auto;
    }

    .page-header{ margin-bottom:10px; }
    .page-header h2{ margin:0 0 6px; font-size:20px;}
    .page-header p{ margin:2px 0; font-size:14px; color:var(--texto-secundario);}

    .pill{
      display:inline-block; margin-top:6px;
      padding:3px 10px; font-size:11px; border-radius:999px;
      background-color: rgba(37,99,235,0.08);
      color:#1d4ed8;
      border:1px solid rgba(191,219,254,0.9);
      text-transform:uppercase; letter-spacing:.08em;
    }

    .topnav{
      position: sticky;
      top: 82px;
      z-index: 40;
      margin: 12px 0 14px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:center;
      margin:0;
    }
    .tab{
      text-decoration:none;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(255,255,255,0.95);
      color:#0f172a;
      font-weight:750;
      font-size:13px;
    }
    .tab:hover{ background:#eef6ff; border-color:rgba(59,130,246,0.35); }
    .tab.active{
      background:var(--azul-boton);
      border-color:transparent;
      color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.16);
    }

    .nav-actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin-top:10px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; font-size:14px;
      border-radius:999px; text-decoration:none;
      cursor:pointer; border:1px solid transparent;
      font-weight:800;
      transition: background-color .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn-primary{
      background-color:var(--azul-boton); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }
    .btn-primary:hover{
      background-color:var(--azul-boton-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.16);
    }
    .btn-ghost{
      background-color:rgba(255,255,255,.95);
      color:#0f172a;
      border-color: rgba(148,163,184,0.45);
    }
    .btn-ghost:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,.10);
    }
    .btn-warn{
      background: rgba(16,185,129,0.95); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }
    .btn-warn:hover{
      background: rgba(5,150,105,0.98);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.14);
    }

    .card{
      background: rgba(255,255,255,0.92);
      border-radius:var(--card-radius);
      border:1px solid var(--borde-suave);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:16px;
      margin-bottom:14px;
      overflow:hidden;
      position:relative;
    }
    .card.soft{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.98));
    }

    .subnote{ margin:0; color:var(--texto-secundario); font-size:13px; }

    .infobox{
      border:1px solid rgba(59,130,246,.18);
      background: rgba(219,234,254,.40);
      border-radius:14px;
      padding:10px 12px;
      color:#0f172a;
      font-size:13px;
      margin-top:10px;
      text-align:center;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      justify-content:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,0.85);
      font-size:12px;
      font-weight:700;
      color:#0f172a;
    }
    .chip b{ font-weight:800; }

    .filters{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .field{ grid-column: span 3; min-width:160px; }
    .field.wide{ grid-column: span 4; }

    label{
      display:block; font-size:12px; color:var(--texto-secundario);
      font-weight:900; margin-bottom:6px;
    }
    select, input{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    input.small{
      padding:7px 10px;
      border-radius:12px;
      background: rgba(241,245,249,.7);
      margin-bottom:6px;
    }

    .kpis{
      display:grid; grid-template-columns:repeat(12,1fr); gap:12px;
    }
    .kpi{
      grid-column: span 2;
      border:1px solid rgba(148,163,184,0.35);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(248,250,252,.98));
      min-height:80px;
    }
    .kpi .t{ font-size:12px; color:var(--texto-secundario); font-weight:950;}
    .kpi .v{ font-size:18px; font-weight:950; margin-top:6px; }
    .kpi .s{ font-size:12px; color:var(--texto-secundario); margin-top:2px; }

    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-12{ grid-column:span 12; }
    .col-6{ grid-column:span 6; }

    /* CHARTS compactas */
    .chartwrap{ height:240px; }
    .chartwrap.tall{ height:240px; }
    canvas{ width:100% !important; height:100% !important; }

    /* MAPA */
    #map{
      width:100%;
      height:280px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.35);
      overflow:hidden;
      background:#fff;
    }
    .maprow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .mini-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .mini-btn{
      padding:7px 10px;
      font-size:13px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:800;
    }
    .mini-btn:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      box-shadow:0 3px 10px rgba(15,23,42,.10);
    }

    .tablewrap{ overflow-x:auto; }
    footer{
      text-align:center;
      font-size:12px;
      color:#64748b;
      padding:10px 20px 18px;
      border-top:1px solid rgba(148,163,184,0.25);
      background-color:rgba(248,250,252,.9);
      margin-top:auto;
    }

    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 10px 25px rgba(15,23,42,.30);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    @media (max-width: 980px){
      .field{ grid-column: span 12; min-width:unset; }
      .field.wide{ grid-column: span 12; }
      .kpi{ grid-column: span 6; }
      .col-6{ grid-column: span 12; }
      .title-group{ text-align:center; }
      .header-inner{ justify-content:center; }
      .topnav{ top: 116px; }
      .chartwrap{ height: 250px; }
      #map{ height: 260px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="logo-group">
        <img src="conap_logo.jpg" alt="Logo CONAP">
        <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
      </div>
      <div class="title-group">
        <h1>Centro de consulta de datos</h1>
        <p>Sistema de monitoreo de actividades</p>
        <p>CONAP – Dirección Regional Altiplano Central</p>
      </div>
    </div>
  </header>

  <main>
    <section class="page-header">
      <h2>AC192 · Patrullajes de control y vigilancia · Tablero dinámico</h2>
      <p>Este tablero se genera automáticamente desde <strong>datos_patrullaje.csv</strong> y permite filtrar, graficar y generar un informe PDF liviano.</p>
      <span class="pill">Tablero dinámico · CSV</span>
    </section>

    <section class="topnav" aria-label="Navegación y acciones del módulo">
      <nav class="tabs" aria-label="Navegación del módulo">
        <a class="tab" href="patrullajes_dashboard.html">Dashboard geográfico</a>
        <a class="tab active" href="patrullajes_tablero.html">Tablero dinámico</a>
        <a class="tab" href="patrullajes_datos.html">Tabla de datos</a>
      </nav>

      <!-- BOTONES: una sola fila, sin duplicados -->
      <div class="nav-actions">
        <a class="btn btn-ghost" href="index.html">Inicio</a>
        <button class="btn btn-ghost" id="btn-reset" type="button">Limpiar filtros</button>
        <button class="btn btn-warn" id="btn-pdf" type="button">Generar informe PDF (liviano)</button>
      </div>

      <div class="infobox">
        <b>Sugerencia:</b> haga clic sobre la serie temporal o un ranking para aplicar un filtro adicional.
        <div class="chips" id="chips-filtros" aria-label="Resumen de filtros"></div>
      </div>

      <p class="subnote" id="estado" style="margin-top:10px;">Cargando datos…</p>
    </section>

    <section class="card soft">
      <div class="filters">
        <div class="field wide">
          <label for="f-temporal">Filtro temporal</label>
          <select id="f-temporal">
            <option value="todo">Todo</option>
            <option value="mes">Por mes</option>
            <option value="semana">Por semana (ISO)</option>
            <option value="rango">Rango de fechas</option>
          </select>
        </div>

        <div class="field" id="wrap-mes" style="display:none;">
          <label for="f-mes">Mes</label>
          <select id="f-mes"></select>
        </div>

        <div class="field" id="wrap-semana" style="display:none;">
          <label for="f-semana">Semana</label>
          <select id="f-semana"></select>
        </div>

        <div class="field" id="wrap-desde" style="display:none;">
          <label for="f-desde">Desde</label>
          <input id="f-desde" type="date" />
        </div>

        <div class="field" id="wrap-hasta" style="display:none;">
          <label for="f-hasta">Hasta</label>
          <input id="f-hasta" type="date" />
        </div>

        <div class="field">
          <label for="f-guarda">Guarda recursos responsable (buscable)</label>
          <input id="s-guarda" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-guarda"></select>
        </div>

        <div class="field">
          <label for="f-muni">Municipio (buscable)</label>
          <input id="s-muni" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-muni"></select>
        </div>

        <div class="field">
          <label for="f-region">Región (buscable)</label>
          <input id="s-region" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-region"></select>
        </div>

        <div class="field">
          <label for="f-area">Área protegida (buscable)</label>
          <input id="s-area" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-area"></select>
        </div>

        <div class="field">
          <label for="f-tipo">Tipo patrullaje (buscable)</label>
          <input id="s-tipo" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-tipo"></select>
        </div>

        <div class="field">
          <label for="f-ilegal">Actividad ilegal</label>
          <select id="f-ilegal">
            <option value="todo">Todas</option>
            <option value="si">Sí</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="field">
          <label for="f-inst">Instituciones</label>
          <select id="f-inst">
            <option value="todo">Todas</option>
            <option value="si">Con instituciones</option>
            <option value="no">Sin instituciones</option>
          </select>
        </div>

        <div class="field">
          <label for="f-agrupar">Agrupar serie</label>
          <select id="f-agrupar">
            <option value="dia">Día</option>
            <option value="semana">Semana</option>
            <option value="mes">Mes</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="t">Registros (filtrados)</div>
          <div class="v" id="k-total">–</div>
          <div class="s" id="k-total-s">–</div>
        </div>
        <div class="kpi">
          <div class="t">Municipios únicos</div>
          <div class="v" id="k-munis">–</div>
          <div class="s">en el filtro actual</div>
        </div>
        <div class="kpi">
          <div class="t">Guardas únicos</div>
          <div class="v" id="k-guardas">–</div>
          <div class="s">en el filtro actual</div>
        </div>
        <div class="kpi">
          <div class="t">% Actividad ilegal</div>
          <div class="v" id="k-pct-ilegal">–</div>
          <div class="s">sobre filtrados</div>
        </div>
        <div class="kpi">
          <div class="t">Horas válidas (suma)</div>
          <div class="v" id="k-horas">–</div>
          <div class="s">duración</div>
        </div>
        <div class="kpi">
          <div class="t">% Coord válidas</div>
          <div class="v" id="k-coord">–</div>
          <div class="s">Lat/Lon o X/Y</div>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="card col-12">
        <div class="maprow">
          <div>
            <h3 style="margin:0 0 4px;">Distribución espacial (mapa)</h3>
            <p class="subnote" style="margin:0;">Puntos georreferenciados y densidad (heat) según filtros.</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-map" type="button">Exportar PNG</button>
            <button class="mini-btn" id="toggle-heat" type="button">Densidad: ON</button>
          </div>
        </div>
        <div id="map" aria-label="Mapa"></div>
        <p class="subnote" id="map-note" style="margin-top:8px;">—</p>
      </div>

      <div class="card col-12">
        <div class="maprow">
          <div>
            <h3 style="margin:0 0 4px;">Patrullajes en el tiempo</h3>
            <p class="subnote" style="margin:0;">Serie (línea) según el agrupamiento seleccionado.</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-tiempo" type="button">Exportar PNG</button>
          </div>
        </div>
        <div class="chartwrap tall"><canvas id="c-tiempo"></canvas></div>
      </div>

      <div class="card col-6">
        <div class="maprow">
          <div>
            <h3 style="margin:0 0 4px;">Top municipios</h3>
            <p class="subnote" style="margin:0;">Top 20 por registros (barras horizontales).</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-muni" type="button">Exportar PNG</button>
          </div>
        </div>
        <div class="chartwrap"><canvas id="c-muni"></canvas></div>
      </div>

      <div class="card col-6">
        <div class="maprow">
          <div>
            <h3 style="margin:0 0 4px;">Top guardarecursos</h3>
            <p class="subnote" style="margin:0;">Top 20 por registros (barras horizontales).</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-guarda" type="button">Exportar PNG</button>
          </div>
        </div>
        <div class="chartwrap"><canvas id="c-guarda"></canvas></div>
      </div>
    </section>

    <section class="card">
      <div class="maprow">
        <div>
          <h3 style="margin:0 0 4px;">Tabla pivote (Guarda × Periodo)</h3>
          <p class="subnote" style="margin:0;">Filas: guarda · Columnas: periodo · Valores: conteo.</p>
        </div>
        <div class="mini-actions">
          <button class="mini-btn" id="piv-csv" type="button">CSV</button>
          <button class="mini-btn" id="piv-xlsx" type="button">Excel</button>
        </div>
      </div>
      <div class="tablewrap">
        <div id="tabla-pivote"></div>
      </div>
    </section>

    <section class="card">
      <div class="maprow">
        <div>
          <h3 style="margin:0 0 4px;">Registros filtrados</h3>
          <p class="subnote" style="margin:0;">Tabla completa filtrada (exporta lo filtrado).</p>
        </div>
        <div class="mini-actions">
          <button class="mini-btn" id="btn-dl-csv" type="button">CSV</button>
          <button class="mini-btn" id="btn-dl-xlsx" type="button">Excel</button>
          <button class="mini-btn" id="btn-dl-json" type="button">JSON</button>
        </div>
      </div>
      <div class="tablewrap" style="margin-top:12px;">
        <div id="tabla-registros"></div>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2026 Laboratorio SIG AALA en apoyo a CONAP – Dirección Regional Altiplano Central</p>
  </footer>

  <div class="toast" id="toast">Listo</div>

  <!-- Librerías locales (repo) -->
  <script src="papaparse.min.js"></script>
  <script src="tabulator.min.js"></script>
  <script src="xlsx.full.min.js"></script>

  <script>
    // ===== CSV config =====
    const CSV_URL = "./datos_patrullaje.csv";
    const DELIM = ";";

    // Campos esperados
    const F = {
      fecha: "Fecha de patrullaje",
      guarda: "Guarda recursos responsable",
      municipio: "Municipio",
      region: "Region",
      area: "Area protegida",
      tipo: "Tipo de patrullaje",
      ilegal: "Actividad ilegal observada",
      hayInst: "Hay mas instituciones involucradas en el patrullaje",
      inst: "Instituciones involucradas",
      otraInst: "Otra (especifique)",
      hIni: "Hora de Inicio del patrullaje",
      hFin: "Hora de finalizacion de patrullaje",
      ubic: "Ubicacion",
      lon: "Longitud",
      lat: "Latitud",
      x: "X",
      y: "Y",
    };

    let DATA = [];
    let chartTiempo=null, chartMuni=null, chartGuarda=null;
    let tPivote=null, tRegistros=null;

    // ===== MAPA =====
    let map=null, layerPoints=null, layerHeat=null;
    let heatEnabled = true;

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);

    const estado = $("estado");
    const mapNote = $("map-note");

    const fTemporal = $("f-temporal");
    const wrapMes = $("wrap-mes");
    const wrapSemana = $("wrap-semana");
    const wrapDesde = $("wrap-desde");
    const wrapHasta = $("wrap-hasta");

    const fMes = $("f-mes");
    const fSemana = $("f-semana");
    const fDesde = $("f-desde");
    const fHasta = $("f-hasta");

    const fGuarda = $("f-guarda");
    const fMuni = $("f-muni");
    const fRegion = $("f-region");
    const fArea = $("f-area");
    const fTipo = $("f-tipo");
    const fIlegal = $("f-ilegal");
    const fInst = $("f-inst");
    const fAgrupar = $("f-agrupar");

    const sGuarda = $("s-guarda");
    const sMuni = $("s-muni");
    const sRegion = $("s-region");
    const sArea = $("s-area");
    const sTipo = $("s-tipo");

    const kTotal = $("k-total");
    const kTotalS = $("k-total-s");
    const kMunis = $("k-munis");
    const kGuardas = $("k-guardas");
    const kPctIlegal = $("k-pct-ilegal");
    const kHoras = $("k-horas");
    const kCoord = $("k-coord");

    const chipsFiltros = $("chips-filtros");

    const toast = $("toast");
    let toastTimer=null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 1600);
    }

    // ===== Helpers =====
    function norm(s){ return String(s || "").trim(); }
    function normalizar(t){
      return String(t || "").toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function isNum(v){ return v !== null && v !== "" && isFinite(Number(v)); }
    function safeNum(v){
      if (v === null || v === undefined) return null;
      const s = String(v).trim().replace(",", ".");
      if(!s) return null;
      const n = Number(s);
      return isFinite(n) ? n : null;
    }

    function extraerFechaCompleta(fechaRaw){
      if (!fechaRaw) return null;
      let str = String(fechaRaw).trim();
      if (!str) return null;
      if (str.includes(" ")) str = str.split(" ")[0];
      if (str.includes("T")) str = str.split("T")[0];

      const mIso = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (mIso){
        const y = +mIso[1], mo = +mIso[2], d = +mIso[3];
        const dt = new Date(y, mo-1, d);
        if (isNaN(dt.getTime())) return null;
        return { anio:y, mes:mo, dia:d, date: dt };
      }

      const sep = str.includes("/") ? "/" : (str.includes("-") ? "-" : null);
      if (!sep) return null;
      const partes = str.split(sep);
      if (partes.length < 3) return null;

      let p1 = parseInt(partes[0], 10);
      let p2 = parseInt(partes[1], 10);
      let anio = parseInt(partes[2], 10);
      if (isNaN(p1) || isNaN(p2) || isNaN(anio)) return null;

      let mes, dia;
      if (p1 > 12 && p2 >= 1 && p2 <= 12) { dia = p1; mes = p2; }
      else { mes = p1; dia = p2; }

      if (mes < 1 || mes > 12 || dia < 1 || dia > 31) return null;
      const dt = new Date(anio, mes-1, dia);
      if (isNaN(dt.getTime())) return null;
      return { anio, mes, dia, date: dt };
    }

    function isoWeekKey(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${pad2(weekNo)}`;
    }

    function parseHoraMin(h){
      if(!h) return null;
      const s = String(h).trim().replace(".", ":");
      const m = s.match(/(\d{1,2}):(\d{2})/);
      if(!m) return null;
      const hh = parseInt(m[1],10), mm = parseInt(m[2],10);
      if(!isFinite(hh)||!isFinite(mm)||hh<0||hh>23||mm<0||mm>59) return null;
      return hh*60+mm;
    }

    function duracionHoras(reg){
      const a = parseHoraMin(reg[F.hIni]);
      const b = parseHoraMin(reg[F.hFin]);
      if(a==null || b==null) return null;
      let diff = b - a;
      if(diff < 0) diff += 24*60;
      return diff/60;
    }

    function tieneInstituciones(reg){
      const hay = normalizar(reg[F.hayInst]);
      if (hay === "si" || hay === "sí") return true;
      if (norm(reg[F.inst]).length) return true;
      if (norm(reg[F.otraInst]).length) return true;
      return false;
    }

    function esIlegal(reg){
      const v = normalizar(reg[F.ilegal]);
      if (!v) return false;
      if (v === "no") return false;
      return true;
    }

    function uniqueSorted(arr){
      return Array.from(new Set(arr.map(norm).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"es"));
    }

    function llenarSelect(select, valores, placeholder){
      if(!select) return;
      select.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "todo";
      o0.textContent = placeholder || "Todos";
      select.appendChild(o0);

      valores.forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        select.appendChild(o);
      });
    }

    function setTemporalUI(){
      const v = fTemporal.value;
      wrapMes.style.display = (v === "mes") ? "" : "none";
      wrapSemana.style.display = (v === "semana") ? "" : "none";
      wrapDesde.style.display = (v === "rango") ? "" : "none";
      wrapHasta.style.display = (v === "rango") ? "" : "none";
    }

    function aplicarFiltros(){
      let out = DATA.slice();

      const t = fTemporal.value;
      if (t === "mes" && fMes.value !== "todo"){
        out = out.filter(r => r.__ym === fMes.value);
      } else if (t === "semana" && fSemana.value !== "todo"){
        out = out.filter(r => r.__yw === fSemana.value);
      } else if (t === "rango"){
        const d1 = fDesde.value ? new Date(fDesde.value + "T00:00:00") : null;
        const d2 = fHasta.value ? new Date(fHasta.value + "T23:59:59") : null;
        out = out.filter(r=>{
          if (!r.__date) return false;
          if (d1 && r.__date < d1) return false;
          if (d2 && r.__date > d2) return false;
          return true;
        });
      }

      if (fGuarda.value !== "todo") out = out.filter(r => r.__guarda === fGuarda.value);
      if (fMuni.value !== "todo") out = out.filter(r => r.__muni === fMuni.value);
      if (fRegion.value !== "todo") out = out.filter(r => r.__region === fRegion.value);
      if (fArea.value !== "todo") out = out.filter(r => r.__area === fArea.value);
      if (fTipo.value !== "todo") out = out.filter(r => r.__tipo === fTipo.value);

      if (fIlegal.value === "si") out = out.filter(r => r.__ilegal === "si");
      if (fIlegal.value === "no") out = out.filter(r => r.__ilegal === "no");

      if (fInst.value === "si") out = out.filter(r => r.__inst === "si");
      if (fInst.value === "no") out = out.filter(r => r.__inst === "no");

      return out;
    }

    function actualizarKPIs(rows){
      const total = rows.length;
      kTotal.textContent = total.toLocaleString("es");
      kTotalS.textContent = `De ${DATA.length.toLocaleString("es")} registros totales`;

      const munis = new Set(rows.map(r=>r.__muni).filter(Boolean));
      const guardas = new Set(rows.map(r=>r.__guarda).filter(Boolean));
      kMunis.textContent = munis.size.toLocaleString("es");
      kGuardas.textContent = guardas.size.toLocaleString("es");

      const ilegalSi = rows.filter(r=>r.__ilegal === "si").length;
      const pct = total ? Math.round((ilegalSi*1000)/total)/10 : 0;
      kPctIlegal.textContent = total ? (pct.toLocaleString("es") + "%") : "—";

      const horas = rows.map(r=>r.__durH).filter(v=>v!=null && isFinite(v)).reduce((a,b)=>a+b, 0);
      kHoras.textContent = horas ? (Math.round(horas*10)/10).toLocaleString("es") : "—";

      const coordLatLon = rows.filter(r => safeNum(r[F.lat])!=null && safeNum(r[F.lon])!=null).length;
      const coordXY     = rows.filter(r => isNum(r[F.x]) && isNum(r[F.y])).length;
      const valid = Math.max(coordLatLon, coordXY);
      const pctCoord = total ? Math.round((valid*1000)/total)/10 : 0;
      kCoord.textContent = total ? (pctCoord.toLocaleString("es") + "%") : "—";
    }

    function countBy(rows, keyFn){
      const m = new Map();
      rows.forEach(r=>{
        const k = keyFn(r);
        if(!k) return;
        m.set(k, (m.get(k)||0)+1);
      });
      return m;
    }

    function topN(map, n){
      return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
    }

    // ===== CHARTS: fondo blanco para export + estilo =====
    const whiteBgPlugin = {
      id: "white-bg",
      beforeDraw: (chart) => {
        const {ctx, width, height} = chart;
        ctx.save();
        ctx.globalCompositeOperation = "destination-over";
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, width, height);
        ctx.restore();
      }
    };

    function commonChartOptions(extra){
      const tick = getComputedStyle(document.documentElement).getPropertyValue("--chart-tick").trim() || "rgba(15,23,42,0.85)";
      const grid = getComputedStyle(document.documentElement).getPropertyValue("--chart-grid").trim() || "rgba(2,6,23,0.08)";
      const base = {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:true, labels:{ color: tick, boxWidth: 10, boxHeight: 10 } },
          tooltip:{ borderWidth: 0 }
        },
        elements:{
          line:{ borderWidth: 2 },
          point:{ radius: 2.2, hoverRadius: 3.8, borderWidth: 0 }
        },
        scales:{
          x:{ ticks:{ color: tick, maxRotation: 0, autoSkip: true }, grid:{ color: grid } },
          y:{ beginAtZero:true, ticks:{ color: tick }, grid:{ color: grid } }
        }
      };
      // merge superficial
      return Object.assign({}, base, extra || {});
    }

    function renderChart(canvasId, prev, cfg){
      const el = $(canvasId);
      if(!el) return prev;
      const ctx = el.getContext("2d");
      if(prev) prev.destroy();
      cfg.plugins = (cfg.plugins || []).concat([whiteBgPlugin]);
      cfg.options = commonChartOptions(cfg.options);
      return new Chart(ctx, cfg);
    }

    // ===== CHARTS: Serie + Top20 barras horizontales pastel =====
    function actualizarCharts(rows){
      const agr = fAgrupar.value; // dia/semana/mes
      const keyFn = (agr === "mes") ? (r=>r.__ym) : (agr === "semana") ? (r=>r.__yw) : (r=>r.__yd);

      // Serie temporal (línea)
      const mTiempo = countBy(rows, keyFn);
      const labelsT = Array.from(mTiempo.keys()).sort();
      const dataT = labelsT.map(k=>mTiempo.get(k));

      chartTiempo = renderChart("c-tiempo", chartTiempo, {
        type:"line",
        data:{
          labels: labelsT,
          datasets:[{
            label:"Patrullajes",
            data: dataT,
            borderColor: "rgba(59,130,246,0.85)",
            backgroundColor: "rgba(59,130,246,0.10)",
            fill: true,
            pointBackgroundColor: "rgba(59,130,246,0.85)",
            pointBorderColor: "rgba(0,0,0,0)"
          }]
        },
        options:{
          onClick:(evt, elements)=>{
            if(!elements || !elements.length) return;
            const idx = elements[0].index;
            const label = labelsT[idx];

            if(agr === "mes"){
              fTemporal.value = "mes"; setTemporalUI(); fMes.value = label;
            } else if(agr === "semana"){
              fTemporal.value = "semana"; setTemporalUI(); fSemana.value = label;
            } else {
              fTemporal.value = "rango"; setTemporalUI(); fDesde.value = label; fHasta.value = label;
            }
            refrescar(true);
          }
        }
      });

      // Top municipios (Top 20) - barras horizontales pastel verde
      const mM = countBy(rows, r=>r.__muni || "(Sin municipio)");
      const topM = topN(mM, 20);
      const labelsM = topM.map(x=>x[0]);
      const dataM = topM.map(x=>x[1]);

      chartMuni = renderChart("c-muni", chartMuni, {
        type:"bar",
        data:{
          labels: labelsM,
          datasets:[{
            label:"Registros",
            data: dataM,
            backgroundColor: "rgba(167, 243, 208, 0.95)",
            borderWidth: 0
          }]
        },
        options:{
          indexAxis:"y",
          plugins:{ legend:{ display:false } },
          onClick:(evt, elements)=>{
            if(!elements || !elements.length) return;
            const idx = elements[0].index;
            fMuni.value = labelsM[idx];
            refrescar(true);
          },
          scales:{
            x:{ beginAtZero:true },
            y:{ ticks:{ autoSkip:false } }
          }
        }
      });

      // Top guardas (Top 20) - barras horizontales pastel celeste
      const mG = countBy(rows, r=>r.__guarda || "(Sin guarda)");
      const topG = topN(mG, 20);
      const labelsG = topG.map(x=>x[0]);
      const dataG = topG.map(x=>x[1]);

      chartGuarda = renderChart("c-guarda", chartGuarda, {
        type:"bar",
        data:{
          labels: labelsG,
          datasets:[{
            label:"Registros",
            data: dataG,
            backgroundColor: "rgba(191, 219, 254, 0.95)",
            borderWidth: 0
          }]
        },
        options:{
          indexAxis:"y",
          plugins:{ legend:{ display:false } },
          onClick:(evt, elements)=>{
            if(!elements || !elements.length) return;
            const idx = elements[0].index;
            fGuarda.value = labelsG[idx];
            refrescar(true);
          },
          scales:{
            x:{ beginAtZero:true },
            y:{ ticks:{ autoSkip:false } }
          }
        }
      });
    }

    // ===== MAPA =====
    function initMap(){
      if(map) return;

      map = L.map("map", {
        zoomControl:true,
        attributionControl:true,
        preferCanvas:true
      });

      // Base con CORS para export (CARTO)
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        subdomains: "abcd",
        crossOrigin: true,
        attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
      }).addTo(map);

      layerPoints = L.layerGroup().addTo(map);
      layerHeat = null;

      map.setView([14.7, -91.2], 9);

      // Heat sensible al zoom (en vivo)
      map.on("zoomend", ()=>{
        if(!layerHeat || !heatEnabled) return;
        const z = map.getZoom() || 10;
        const radius = Math.max(12, Math.min(38, z * 2.2));
        const blur   = Math.max(10, Math.min(28, z * 1.6));
        layerHeat.setOptions({ radius, blur });
      });
    }

    function getLatLonRows(rows){
      const pts = [];
      rows.forEach(r=>{
        const lat = safeNum(r[F.lat]);
        const lon = safeNum(r[F.lon]);
        if(lat==null || lon==null) return;
        if(lat < -90 || lat > 90 || lon < -180 || lon > 180) return;
        pts.push({lat, lon, r});
      });
      return pts;
    }

    function escapeHtml(texto) {
      return String(texto || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // puntos + heat, sensible a zoom, y actualiza con filtros
    function updateMap(rows){
      initMap();

      layerPoints.clearLayers();
      if(layerHeat){
        map.removeLayer(layerHeat);
        layerHeat = null;
      }

      const pts = getLatLonRows(rows);

      if(!pts.length){
        mapNote.textContent = "No hay Latitud/Longitud válidas en el subconjunto filtrado.";
        return;
      }

      // 1) heat primero (fondo)
      if(heatEnabled && typeof L.heatLayer === "function" && pts.length >= 3){
        const heatPts = pts.map(p=>[p.lat, p.lon, 0.7]);
        const z = map.getZoom() || 10;
        const radius = Math.max(12, Math.min(38, z * 2.2));
        const blur   = Math.max(10, Math.min(28, z * 1.6));

        layerHeat = L.heatLayer(heatPts, {
          radius,
          blur,
          maxZoom: 18
        }).addTo(map);
      }

      // 2) puntos encima (más visibles)
      pts.forEach(p=>{
        const m = L.circleMarker([p.lat, p.lon], {
          radius: 6.5,
          stroke: false,
          fillColor: "rgba(59,130,246,0.55)",
          fillOpacity: 1,
          renderer: L.canvas()
        });
        m.bindPopup(
          `<b>Guarda:</b> ${escapeHtml(p.r.__guarda)}<br>`+
          `<b>Municipio:</b> ${escapeHtml(p.r.__muni)}<br>`+
          `<b>Área:</b> ${escapeHtml(p.r.__area)}<br>`+
          `<b>Fecha:</b> ${escapeHtml(norm(p.r[F.fecha]))}`
        );
        layerPoints.addLayer(m);
      });

      const bounds = L.latLngBounds(pts.map(p=>[p.lat, p.lon]));
      map.fitBounds(bounds.pad(0.25));

      mapNote.textContent = `Mapa generado con ${pts.length} puntos (Lat/Lon) ${heatEnabled ? "con densidad" : "sin densidad"}.`;

      // refresco fuerte para canvas/tiles
      setTimeout(()=> {
        map.invalidateSize(true);
        if(layerHeat && heatEnabled){
          const z = map.getZoom() || 10;
          const radius = Math.max(12, Math.min(38, z * 2.2));
          const blur   = Math.max(10, Math.min(28, z * 1.6));
          layerHeat.setOptions({ radius, blur });
        }
      }, 250);
    }

    function downloadDataUrl(dataUrl, filename){
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function exportChartPNG(chart, name){
      if(!chart) return;
      const url = chart.toBase64Image("image/png", 0.92);
      downloadDataUrl(url, name);
    }

    function exportMapPNG(){
      if(!map || typeof leafletImage !== "function"){
        showToast("No se pudo exportar el mapa (leaflet-image no disponible).");
        return;
      }
      leafletImage(map, (err, canvas)=>{
        if(err || !canvas){
          console.error(err);
          showToast("Error exportando mapa.");
          return;
        }
        try{
          const url = canvas.toDataURL("image/png");
          downloadDataUrl(url, "mapa.png");
          showToast("Mapa exportado");
        }catch(e){
          console.error(e);
          showToast("Error exportando mapa.");
        }
      });
    }

    // ===== Tablas =====
    function construirPivote(rows){
      const agr = fAgrupar.value;
      const keyCol = (agr === "mes") ? "__ym" : (agr === "semana") ? "__yw" : "__yd";

      const colSet = new Set();
      const map = new Map();

      rows.forEach(r=>{
        const rowKey = r.__guarda || "(Sin guarda)";
        const colKey = r[keyCol] || "(Sin fecha)";
        colSet.add(colKey);

        if(!map.has(rowKey)) map.set(rowKey, { guarda: rowKey });
        const obj = map.get(rowKey);
        obj[colKey] = (obj[colKey] || 0) + 1;
      });

      const cols = Array.from(colSet).sort((a,b)=>a.localeCompare(b));
      const data = Array.from(map.values()).sort((a,b)=>a.guarda.localeCompare(b.guarda,"es"));

      const tabCols = [
        { title:"Guarda recurso", field:"guarda", frozen:true, headerFilter:"input", minWidth:220 },
        ...cols.map(c=>({ title:c, field:c, hozAlign:"right" }))
      ];

      return { tabCols, data };
    }

    function actualizarTablas(rows){
      const piv = construirPivote(rows);
      if(!tPivote){
        tPivote = new Tabulator("#tabla-pivote", {
          data: piv.data,
          columns: piv.tabCols,
          layout:"fitDataStretch",
          pagination:"local",
          paginationSize: 15,
          paginationSizeSelector: [15, 30, 50, 100],
          movableColumns:true
        });
      } else {
        tPivote.setColumns(piv.tabCols);
        tPivote.setData(piv.data);
      }

      const cols = [
        {title:"Fecha", field:F.fecha, headerFilter:"input", width:160},
        {title:"Guarda", field:F.guarda, headerFilter:"input", minWidth:220},
        {title:"Municipio", field:F.municipio, headerFilter:"input", width:160},
        {title:"Región", field:F.region, headerFilter:"input", width:140},
        {title:"Área", field:F.area, headerFilter:"input", width:160},
        {title:"Tipo", field:F.tipo, headerFilter:"input", width:170},
        {title:"Ilegal", field:F.ilegal, headerFilter:"input", width:160},
        {title:"Instituciones", field:F.inst, headerFilter:"input", minWidth:220},
        {title:"Inicio", field:F.hIni, headerFilter:"input", width:120},
        {title:"Fin", field:F.hFin, headerFilter:"input", width:120},
        {title:"Ubicación", field:F.ubic, headerFilter:"input", minWidth:220},
      ];

      if(!tRegistros){
        tRegistros = new Tabulator("#tabla-registros", {
          data: rows,
          columns: cols,
          layout:"fitDataStretch",
          pagination:"local",
          paginationSize: 20,
          paginationSizeSelector: [10, 20, 50, 100, 200],
          movableColumns:true
        });
      } else {
        tRegistros.setData(rows);
      }
    }

    // ===== URL state (se mantiene, aunque ya no hay botón copiar) =====
    function getState(){
      return {
        temporal: fTemporal.value,
        mes: fMes.value,
        semana: fSemana.value,
        desde: fDesde.value,
        hasta: fHasta.value,
        guarda: fGuarda.value,
        muni: fMuni.value,
        region: fRegion.value,
        area: fArea.value,
        tipo: fTipo.value,
        ilegal: fIlegal.value,
        inst: fInst.value,
        agrupar: fAgrupar.value
      };
    }

    function setURLFromState(){
      const s = getState();
      const p = new URLSearchParams();

      if(s.temporal !== "todo") p.set("temporal", s.temporal);
      if(s.mes && s.mes !== "todo") p.set("mes", s.mes);
      if(s.semana && s.semana !== "todo") p.set("semana", s.semana);
      if(s.desde) p.set("desde", s.desde);
      if(s.hasta) p.set("hasta", s.hasta);
      if(s.guarda !== "todo") p.set("guarda", s.guarda);
      if(s.muni !== "todo") p.set("muni", s.muni);
      if(s.region !== "todo") p.set("region", s.region);
      if(s.area !== "todo") p.set("area", s.area);
      if(s.tipo !== "todo") p.set("tipo", s.tipo);
      if(s.ilegal !== "todo") p.set("ilegal", s.ilegal);
      if(s.inst !== "todo") p.set("inst", s.inst);
      if(s.agrupar !== "dia") p.set("agrupar", s.agrupar);

      const newUrl = location.pathname + (p.toString() ? ("?" + p.toString()) : "");
      history.replaceState(null, "", newUrl);
    }

    function applyURLToControls(){
      const p = new URLSearchParams(location.search);

      const temporal = p.get("temporal");
      if(temporal && ["todo","mes","semana","rango"].includes(temporal)) fTemporal.value = temporal;

      setTemporalUI();

      const agr = p.get("agrupar");
      if(agr && ["dia","semana","mes"].includes(agr)) fAgrupar.value = agr;

      const mes = p.get("mes");
      if(mes) fMes.value = mes;

      const semana = p.get("semana");
      if(semana) fSemana.value = semana;

      const desde = p.get("desde");
      const hasta = p.get("hasta");
      if(desde) fDesde.value = desde;
      if(hasta) fHasta.value = hasta;

      const setIfExists = (sel, val) => {
        if(!val) return;
        const opt = Array.from(sel.options).some(o=>o.value === val);
        if(opt) sel.value = val;
      };

      setIfExists(fGuarda, p.get("guarda"));
      setIfExists(fMuni, p.get("muni"));
      setIfExists(fRegion, p.get("region"));
      setIfExists(fArea, p.get("area"));
      setIfExists(fTipo, p.get("tipo"));
      setIfExists(fIlegal, p.get("ilegal"));
      setIfExists(fInst, p.get("inst"));
    }

    // ===== Searchable selects =====
    const fullOptions = new Map();
    function cacheOptions(select, placeholder){
      if(!select) return;
      const values = Array.from(select.options).map(o=>o.value).filter(v=>v && v !== "todo");
      fullOptions.set(select.id, { placeholder, values });
    }
    function filterSelect(select, q){
      if(!select) return;
      const info = fullOptions.get(select.id);
      if(!info) return;

      const cur = select.value;
      const qq = normalizar(q);

      const filtered = info.values.filter(v=>{
        if(!qq) return true;
        return normalizar(v).includes(qq);
      });

      llenarSelect(select, filtered, info.placeholder);
      const still = Array.from(select.options).some(o=>o.value === cur);
      if(still) select.value = cur;
    }

    function resumenFiltrosTexto(){
      const parts = [];
      const t = fTemporal.value;
      if(t === "todo") parts.push("Temporal: Todo");
      if(t === "mes") parts.push("Temporal: Mes " + (fMes.value || "—"));
      if(t === "semana") parts.push("Temporal: Semana " + (fSemana.value || "—"));
      if(t === "rango") parts.push("Temporal: " + (fDesde.value||"—") + " a " + (fHasta.value||"—"));

      if(fGuarda.value !== "todo") parts.push("Guarda: " + fGuarda.value);
      if(fMuni.value !== "todo") parts.push("Municipio: " + fMuni.value);
      if(fRegion.value !== "todo") parts.push("Región: " + fRegion.value);
      if(fArea.value !== "todo") parts.push("Área: " + fArea.value);
      if(fTipo.value !== "todo") parts.push("Tipo: " + fTipo.value);
      if(fIlegal.value !== "todo") parts.push("Ilegal: " + (fIlegal.value === "si" ? "Sí" : "No"));
      if(fInst.value !== "todo") parts.push("Instituciones: " + (fInst.value === "si" ? "Con" : "Sin"));
      parts.push("Agrupar: " + fAgrupar.value);
      return parts.join(" · ");
    }

    function renderChipsResumen(){
      if(!chipsFiltros) return;

      const chips = [];
      const t = fTemporal.value;
      if(t === "todo")   chips.push(["Temporal", "Todo"]);
      if(t === "mes")    chips.push(["Temporal", "Mes: " + (fMes.value || "—")]);
      if(t === "semana") chips.push(["Temporal", "Semana: " + (fSemana.value || "—")]);
      if(t === "rango")  chips.push(["Temporal", "Rango: " + (fDesde.value||"—") + " a " + (fHasta.value||"—")]);

      if(fMuni.value   !== "todo") chips.push(["Municipio", fMuni.value]);
      if(fGuarda.value !== "todo") chips.push(["Guarda", fGuarda.value]);
      if(fRegion.value !== "todo") chips.push(["Región", fRegion.value]);
      if(fArea.value   !== "todo") chips.push(["Área", fArea.value]);
      if(fTipo.value   !== "todo") chips.push(["Tipo", fTipo.value]);
      if(fIlegal.value !== "todo") chips.push(["Ilegal", (fIlegal.value === "si" ? "Sí" : "No")]);
      if(fInst.value   !== "todo") chips.push(["Instituciones", (fInst.value === "si" ? "Con" : "Sin")]);

      chips.push(["Agrupar", fAgrupar.value]);

      chipsFiltros.innerHTML = chips.map(([k, v]) =>
        `<span class="chip"><b>${escapeHtml(k)}:</b> ${escapeHtml(v)}</span>`
      ).join("");
    }

    // ===== INFORME PDF (jsPDF: texto real + imágenes JPEG) =====
    function fmtNum(n){ return (n ?? 0).toLocaleString("es"); }
    function fmtPct(num, den){
      if(!den) return "—";
      const pct = Math.round((num * 1000) / den) / 10;
      return pct.toLocaleString("es") + "%";
    }
    function fmtDateShort(d){
      try{ return d.toLocaleDateString("es", {year:"numeric", month:"2-digit", day:"2-digit"}); }
      catch(e){ return "—"; }
    }

    function computeReportStats(rows){
      const total = rows.length;

      const withDate = rows.filter(r => r.__date instanceof Date && !isNaN(r.__date.getTime()));
      const dates = withDate.map(r => r.__date.getTime()).sort((a,b)=>a-b);
      const minDate = dates.length ? new Date(dates[0]) : null;
      const maxDate = dates.length ? new Date(dates[dates.length-1]) : null;

      const ilegalSi = rows.filter(r=>r.__ilegal==="si").length;
      const instSi   = rows.filter(r=>r.__inst==="si").length;

      const horasArr = rows.map(r=>r.__durH).filter(v=>v!=null && isFinite(v));
      const horasSum = horasArr.reduce((a,b)=>a+b, 0);
      const horasAvg = horasArr.length ? (horasSum/horasArr.length) : null;

      const coordLatLon = rows.filter(r => safeNum(r[F.lat])!=null && safeNum(r[F.lon])!=null).length;
      const coordXY     = rows.filter(r => isNum(r[F.x]) && isNum(r[F.y])).length;
      const coordValidas = Math.max(coordLatLon, coordXY);

      const munis = new Set(rows.map(r=>r.__muni).filter(Boolean)).size;
      const guardas = new Set(rows.map(r=>r.__guarda).filter(Boolean)).size;

      return {
        total, withDateCount: withDate.length, minDate, maxDate,
        ilegalSi, instSi,
        horasSum, horasAvg, horasCount: horasArr.length,
        coordValidas,
        munis, guardas
      };
    }

    function topItems(rows, key, n=5){
      const total = rows.length || 0;
      const m = countBy(rows, r => r[key] || "(Sin dato)");
      return topN(m, n).map(([k,v])=>({
        name: k,
        count: v,
        pct: total ? (Math.round((v*1000)/total)/10) : 0
      }));
    }

    function joinTopSentence(arr){
      if(!arr.length) return "Sin datos suficientes para ranking.";
      return arr.map((it)=>`${it.name} (${fmtNum(it.count)}, ${it.pct.toLocaleString("es")}%)`).join("; ") + ".";
    }

    function getChartJpeg(chart, quality=0.78){
      if(!chart) return "";
      try{
        return chart.toBase64Image("image/jpeg", quality);
      }catch(e){
        return "";
      }
    }

    function waitMapStable(ms=450){
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function getMapJpeg(quality=0.74){
      if(!map || typeof leafletImage !== "function") return "";
      await waitMapStable(450); // asegura tiles/heat/puntos dibujados
      return new Promise((resolve)=>{
        leafletImage(map, (err, canvas)=>{
          if(err || !canvas) return resolve("");
          try{
            resolve(canvas.toDataURL("image/jpeg", quality));
          }catch(e){
            resolve("");
          }
        });
      });
    }

    function pdfAddParagraph(doc, text, x, y, w, lineH){
      const lines = doc.splitTextToSize(text, w);
      doc.text(lines, x, y);
      return y + lines.length * lineH;
    }

    function pdfEnsureSpace(doc, y, needed, margin){
      const pageH = doc.internal.pageSize.getHeight();
      if(y + needed > pageH - margin){
        doc.addPage();
        return margin;
      }
      return y;
    }

    function pdfAddImageFit(doc, dataUrl, x, y, maxW, maxH){
      if(!dataUrl) return {w:0,h:0};
      const props = doc.getImageProperties(dataUrl);
      const iw = props.width || 1;
      const ih = props.height || 1;
      const ratio = iw / ih;
      let w = maxW;
      let h = w / ratio;
      if(h > maxH){
        h = maxH;
        w = h * ratio;
      }
      doc.addImage(dataUrl, "JPEG", x, y, w, h, undefined, "FAST");
      return {w,h};
    }

    async function generarInformePDF(){
      if(!window.jspdf || !window.jspdf.jsPDF){
        showToast("No se cargó jsPDF.");
        return;
      }

      const rows = aplicarFiltros();
      const stats = computeReportStats(rows);

      const fechaInicio = stats.minDate ? fmtDateShort(stats.minDate) : "—";
      const fechaFin    = stats.maxDate ? fmtDateShort(stats.maxDate) : "—";

      const horasSum = stats.horasCount ? (Math.round(stats.horasSum*10)/10).toLocaleString("es") : "—";
      const horasAvg = stats.horasCount ? (Math.round(stats.horasAvg*10)/10).toLocaleString("es") : "—";

      const topMuni = topItems(rows, "__muni", 5);
      const topGua  = topItems(rows, "__guarda", 5);
      const topArea = topItems(rows, "__area", 5);
      const topTipo = topItems(rows, "__tipo", 5);

      const filtros = resumenFiltrosTexto();
      const stamp = new Date().toLocaleString("es");

      // Párrafos largos (tu formato)
      const p1 =
        `Se analizaron ${fmtNum(stats.total)} registros correspondientes a ${fmtNum(stats.munis)} municipios y ${fmtNum(stats.guardas)} guardarecursos, considerando exclusivamente el subconjunto resultante de los filtros activos en el tablero. El periodo evaluado abarca ${fechaInicio} a ${fechaFin}, tomando en cuenta únicamente los registros con fecha válida (n=${fmtNum(stats.withDateCount)}). En el estado actual del filtrado, la variable de “actividad ilegal” se registra en ${fmtNum(stats.ilegalSi)} de ${fmtNum(stats.total)} casos (${fmtPct(stats.ilegalSi, stats.total)}), mientras que la participación de instituciones se observa en ${fmtNum(stats.instSi)} de ${fmtNum(stats.total)} registros (${fmtPct(stats.instSi, stats.total)}). En términos de esfuerzo operativo, la duración acumulada de patrullajes (calculada solo para registros con horas válidas) alcanza ${horasSum} horas, con un promedio de ${horasAvg} horas por registro con información horaria consistente. Finalmente, la cobertura espacial del análisis depende de la disponibilidad de coordenadas: en el subconjunto filtrado se identifican ${fmtNum(stats.coordValidas)} registros con coordenadas válidas, lo que representa ${fmtPct(stats.coordValidas, stats.total)} del total filtrado.`;

      const p2 =
        `La lectura temporal del subconjunto, según el agrupamiento seleccionado (${fAgrupar.value}), permite observar la distribución de registros en el tiempo y detectar concentraciones de actividad en periodos específicos. Cuando el número de observaciones es reducido, la interpretación debe entenderse como descriptiva y no inferencial; en esos casos, lo más consistente es reportar la ocurrencia de fechas con registros aislados, sin afirmar patrones estacionales. Aun así, la serie temporal funciona como un control operativo útil, pues evidencia si los registros se concentran en ventanas cortas o si se distribuyen de manera más constante a lo largo del periodo considerado.`;

      const p3 =
        `En el componente espacial, la representación cartográfica se construye sobre un mapa base OpenStreetMap/CARTO, ubicando los registros con coordenadas válidas como puntos georreferenciados y, cuando corresponde, una capa de densidad (heat) para visualizar concentraciones. Este enfoque permite interpretar rápidamente si los patrullajes tienden a agruparse en zonas específicas o si cubren de manera más amplia el territorio del municipio o área protegida analizada. Para el análisis de categorías operativas, se resumen las dimensiones más frecuentes en el subconjunto filtrado: municipios, áreas protegidas, tipos de patrullaje y guardarecursos (Top 5), con el objetivo de describir la composición del esfuerzo de vigilancia.`;

      const p4 =
        `Municipios con mayor frecuencia (Top 5): ${joinTopSentence(topMuni)} Guardarecursos con mayor frecuencia (Top 5): ${joinTopSentence(topGua)} Áreas protegidas con mayor frecuencia (Top 5): ${joinTopSentence(topArea)} Tipos de patrullaje con mayor frecuencia (Top 5): ${joinTopSentence(topTipo)}`;

      // Capturas JPEG (livianas)
      const chartTiempoJ = getChartJpeg(chartTiempo, 0.78);
      const chartMuniJ   = getChartJpeg(chartMuni, 0.78);
      const chartGuarJ   = getChartJpeg(chartGuarda, 0.78);
      const mapJ         = await getMapJpeg(0.74);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4", compress:true });

      const margin = 14;
      const pageW = doc.internal.pageSize.getWidth();
      const x = margin;
      const w = pageW - margin*2;
      let y = margin;

      doc.setFont("times", "bold");
      doc.setFontSize(13);
      doc.text("Informe técnico · Patrullajes AC192 (control y vigilancia)", x, y); y += 6;

      doc.setFont("times", "normal");
      doc.setFontSize(9);
      doc.text(`Fuente: datos_patrullaje.csv · Tablero dinámico`, x, y); y += 4;
      doc.text(`Generado: ${stamp}`, x, y); y += 4;

      y = pdfEnsureSpace(doc, y, 10, margin);
      y = pdfAddParagraph(doc, `Filtros aplicados: ${filtros}`, x, y, w, 4); y += 2;

      doc.setFontSize(10);
      y = pdfEnsureSpace(doc, y, 60, margin);
      y = pdfAddParagraph(doc, p1, x, y, w, 4.5); y += 2;
      y = pdfEnsureSpace(doc, y, 60, margin);
      y = pdfAddParagraph(doc, p2, x, y, w, 4.5); y += 2;
      y = pdfEnsureSpace(doc, y, 60, margin);
      y = pdfAddParagraph(doc, p3, x, y, w, 4.5); y += 2;
      y = pdfEnsureSpace(doc, y, 40, margin);
      y = pdfAddParagraph(doc, p4, x, y, w, 4.5); y += 3;

      doc.setFontSize(9);
      const kline =
        `Registros: ${fmtNum(stats.total)} · Municipios: ${fmtNum(stats.munis)} · Guardas: ${fmtNum(stats.guardas)} · %Ilegal: ${fmtPct(stats.ilegalSi, stats.total)} · %Coord: ${fmtPct(stats.coordValidas, stats.total)} · Horas(suma): ${horasSum}`;
      y = pdfEnsureSpace(doc, y, 10, margin);
      y = pdfAddParagraph(doc, kline, x, y, w, 4); y += 3;

      // Figura 1 (serie)
      y = pdfEnsureSpace(doc, y, 80, margin);
      if(chartTiempoJ){
        const imgBox1 = pdfAddImageFit(doc, chartTiempoJ, x, y, w, 65);
        y += imgBox1.h + 4;
        doc.text(`Figura 1. Serie temporal de patrullajes (agrupamiento: ${fAgrupar.value}).`, x, y);
        y += 6;
      }

      // Nueva página: mapa + tops
      doc.addPage();
      y = margin;

      // Figura 2 mapa
      y = pdfEnsureSpace(doc, y, 95, margin);
      if(mapJ){
        const imgBoxM = pdfAddImageFit(doc, mapJ, x, y, w, 78);
        y += imgBoxM.h + 4;
        doc.text("Figura 2. Distribución espacial (puntos y densidad según disponibilidad).", x, y);
        y += 7;
      }else{
        doc.text("No se pudo incluir el mapa: faltan coordenadas válidas o el proveedor de tiles no permite exportación (CORS).", x, y);
        y += 7;
      }

      // Figura 3 top municipios
      y = pdfEnsureSpace(doc, y, 80, margin);
      if(chartMuniJ){
        const imgBox2 = pdfAddImageFit(doc, chartMuniJ, x, y, w, 65);
        y += imgBox2.h + 4;
        doc.text("Figura 3. Ranking Top 20 de municipios (frecuencia de registros).", x, y);
        y += 7;
      }

      // Figura 4 top guardas
      y = pdfEnsureSpace(doc, y, 80, margin);
      if(chartGuarJ){
        const imgBox3 = pdfAddImageFit(doc, chartGuarJ, x, y, w, 65);
        y += imgBox3.h + 4;
        doc.text("Figura 4. Ranking Top 20 de guardarecursos (frecuencia de registros).", x, y);
        y += 6;
      }

      doc.save("informe_tecnico_patrullajes_AC192.pdf");
      showToast("Informe PDF generado (liviano)");
    }

    // ===== Refresh =====
    function refrescar(updateURL){
      const rows = aplicarFiltros();
      actualizarKPIs(rows);
      actualizarCharts(rows);
      actualizarTablas(rows);
      updateMap(rows);
      renderChipsResumen();
      if(updateURL) setURLFromState();
    }

    function limpiarFiltros(){
      fTemporal.value = "todo";
      fMes.value = "todo";
      fSemana.value = "todo";
      fDesde.value = "";
      fHasta.value = "";
      fGuarda.value = "todo";
      fMuni.value = "todo";
      fRegion.value = "todo";
      fArea.value = "todo";
      fTipo.value = "todo";
      fIlegal.value = "todo";
      fInst.value = "todo";
      fAgrupar.value = "dia";

      sGuarda.value = ""; sMuni.value = ""; sRegion.value = ""; sArea.value = ""; sTipo.value = "";
      setTemporalUI();

      filterSelect(fGuarda, "");
      filterSelect(fMuni, "");
      filterSelect(fRegion, "");
      filterSelect(fArea, "");
      filterSelect(fTipo, "");

      refrescar(true);
    }

    function wire(){
      setTemporalUI();

      const watchers = [fTemporal,fMes,fSemana,fDesde,fHasta,fGuarda,fMuni,fRegion,fArea,fTipo,fIlegal,fInst,fAgrupar];
      watchers.forEach(el=>{
        el.addEventListener("change", ()=>{
          if(el === fTemporal) setTemporalUI();
          refrescar(true);
        });
      });

      $("btn-reset").addEventListener("click", limpiarFiltros);

      $("btn-dl-csv").addEventListener("click", ()=>{ if(tRegistros) tRegistros.download("csv", "patrullajes_filtrado.csv"); });
      $("btn-dl-xlsx").addEventListener("click", ()=>{ if(tRegistros) tRegistros.download("xlsx", "patrullajes_filtrado.xlsx", {sheetName:"Filtrado"}); });
      $("btn-dl-json").addEventListener("click", ()=>{ if(tRegistros) tRegistros.download("json", "patrullajes_filtrado.json"); });

      $("piv-csv").addEventListener("click", ()=>{ if(tPivote) tPivote.download("csv", "pivote_guarda_periodo.csv"); });
      $("piv-xlsx").addEventListener("click", ()=>{ if(tPivote) tPivote.download("xlsx", "pivote_guarda_periodo.xlsx", {sheetName:"Pivote"}); });

      $("png-tiempo").addEventListener("click", ()=> exportChartPNG(chartTiempo, "serie_tiempo.png"));
      $("png-muni").addEventListener("click", ()=> exportChartPNG(chartMuni, "top_municipios.png"));
      $("png-guarda").addEventListener("click", ()=> exportChartPNG(chartGuarda, "top_guardas.png"));

      $("png-map").addEventListener("click", exportMapPNG);

      $("toggle-heat").addEventListener("click", ()=>{
        heatEnabled = !heatEnabled;
        $("toggle-heat").textContent = heatEnabled ? "Densidad: ON" : "Densidad: OFF";
        refrescar(false);
      });

      $("btn-pdf").addEventListener("click", generarInformePDF);

      sGuarda.addEventListener("input", ()=> filterSelect(fGuarda, sGuarda.value));
      sMuni.addEventListener("input", ()=> filterSelect(fMuni, sMuni.value));
      sRegion.addEventListener("input", ()=> filterSelect(fRegion, sRegion.value));
      sArea.addEventListener("input", ()=> filterSelect(fArea, sArea.value));
      sTipo.addEventListener("input", ()=> filterSelect(fTipo, sTipo.value));
    }

    async function load(){
      if(typeof Papa === "undefined"){
        estado.textContent = "No se cargó papaparse.min.js (debe existir en el repo).";
        return;
      }
      if(typeof Tabulator === "undefined"){
        estado.textContent = "No se cargó tabulator.min.js (debe existir en el repo).";
        return;
      }
      if(typeof Chart === "undefined"){
        estado.textContent = "No se cargó Chart.js.";
        return;
      }

      // para que no explote el peso en export/canvas
      Chart.defaults.devicePixelRatio = 1;

      estado.textContent = "Leyendo datos_patrullaje.csv…";
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
      const csvText = await res.text();

      const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true, delimiter: DELIM });
      const rows = (parsed.data || []).filter(r => r && Object.keys(r).some(k => norm(r[k])));

      DATA = rows.map(r=>{
        const info = extraerFechaCompleta(r[F.fecha]);
        const d = info ? info.date : null;

        const ym = info ? (info.anio + "-" + pad2(info.mes)) : "";
        const yd = info ? (info.anio + "-" + pad2(info.mes) + "-" + pad2(info.dia)) : "";
        const yw = d ? isoWeekKey(d) : "";

        const guarda = norm(r[F.guarda]) || "(Sin guarda)";
        const muni = norm(r[F.municipio]) || "(Sin municipio)";
        const region = norm(r[F.region]) || "(Sin región)";
        const area = norm(r[F.area]) || "(Sin área)";
        const tipo = norm(r[F.tipo]) || "(Sin tipo)";

        const ilegal = esIlegal(r) ? "si" : "no";
        const inst = tieneInstituciones(r) ? "si" : "no";

        const coordLatLon = (safeNum(r[F.lat]) != null) && (safeNum(r[F.lon]) != null);
        const coordXY = isNum(r[F.x]) && isNum(r[F.y]);
        const coordOk = coordLatLon || coordXY;

        r.__date = d;
        r.__ym = ym;
        r.__yd = yd;
        r.__yw = yw;
        r.__guarda = guarda;
        r.__muni = muni;
        r.__region = region;
        r.__area = area;
        r.__tipo = tipo;
        r.__ilegal = ilegal;
        r.__inst = inst;
        r.__durH = duracionHoras(r);
        r.__coordOk = coordOk;

        return r;
      });

      llenarSelect(fGuarda, uniqueSorted(DATA.map(r=>r.__guarda)), "Todos los guardas");
      llenarSelect(fMuni, uniqueSorted(DATA.map(r=>r.__muni)), "Todos los municipios");
      llenarSelect(fRegion, uniqueSorted(DATA.map(r=>r.__region)), "Todas las regiones");
      llenarSelect(fArea, uniqueSorted(DATA.map(r=>r.__area)), "Todas las áreas");
      llenarSelect(fTipo, uniqueSorted(DATA.map(r=>r.__tipo)), "Todos los tipos");

      cacheOptions(fGuarda, "Todos los guardas");
      cacheOptions(fMuni, "Todos los municipios");
      cacheOptions(fRegion, "Todas las regiones");
      cacheOptions(fArea, "Todas las áreas");
      cacheOptions(fTipo, "Todos los tipos");

      const meses = uniqueSorted(DATA.map(r=>r.__ym).filter(Boolean));
      fMes.innerHTML = "";
      fMes.appendChild(new Option("Todos los meses","todo"));
      meses.forEach(m=>fMes.appendChild(new Option(m,m)));

      const semanas = uniqueSorted(DATA.map(r=>r.__yw).filter(Boolean));
      fSemana.innerHTML = "";
      fSemana.appendChild(new Option("Todas las semanas","todo"));
      semanas.forEach(w=>fSemana.appendChild(new Option(w,w)));

      applyURLToControls();

      estado.textContent = `Listo. ${DATA.length.toLocaleString("es")} registros cargados.`;
      refrescar(true);
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      try{
        wire();
        load().catch(err=>{
          console.error(err);
          estado.textContent = "Error inicializando el tablero: " + err.message;
          showToast("Error: " + err.message);
        });
      }catch(err){
        console.error(err);
        estado.textContent = "Error inicializando el tablero: " + err.message;
        showToast("Error: " + err.message);
      }
    });
  </script>
</body>
</html>
