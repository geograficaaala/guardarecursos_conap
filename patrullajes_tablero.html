<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC192 · Patrullajes - Tablero dinámico (CSV)</title>

  <!-- Tabulator (local + CDN fallback via CSS duplicado, no pasa nada) -->
  <link rel="stylesheet" href="tabulator.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css">

  <!-- Leaflet (local opcional + CDN) -->
  <link rel="stylesheet" href="leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1c2230;
      --muted:#667085;
      --line:#e6e8ef;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
      --radius:14px;
      --shadow:0 10px 24px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 40px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;object-fit:contain}
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:2px 0 0 0;color:var(--muted);font-size:13px}
    .nav{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end
    }
    .btn, a.btn{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);background:#fff;color:var(--text);
      padding:10px 12px;border-radius:12px;text-decoration:none;font-size:13px;cursor:pointer;
      transition:transform .02s ease, border-color .2s ease, background .2s ease;
      user-select:none
    }
    .btn:hover{border-color:#cbd5e1}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:#fff;border-color:#fecaca;color:#991b1b}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{
      display:grid;gap:14px;margin-top:14px
    }
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px
    }
    .card h2{font-size:15px;margin:0 0 8px 0}
    .sub{color:var(--muted);font-size:13px;margin:0 0 10px 0}
    .status{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:12px;background:#f1f5ff;border:1px solid #dbeafe;
      font-size:13px;color:#1e3a8a
    }
    .status .small{color:#1e40af;font-size:12px}
    .filters{
      display:grid;grid-template-columns:repeat(12,1fr);gap:10px
    }
    .f{grid-column:span 3;display:flex;flex-direction:column;gap:6px}
    .f.wide{grid-column:span 6}
    label{font-size:12px;color:var(--muted)}
    select,input{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      outline:none;background:#fff;font-size:13px
    }
    input:focus, select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .kpis{
      display:grid;grid-template-columns:repeat(5,1fr);gap:10px
    }
    .kpi{
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px
    }
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-size:20px;margin-top:6px;font-weight:700}
    .kpi .h{font-size:12px;color:var(--muted);margin-top:2px}
    .twocol{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
    .twocol2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    canvas{max-width:100%}
    #map{height:360px;border-radius:14px;border:1px solid var(--line);overflow:hidden}
    .mapbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tablebar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .foot{
      margin-top:14px;color:var(--muted);font-size:12px;text-align:center
    }
    @media (max-width: 980px){
      .filters{grid-template-columns:repeat(6,1fr)}
      .f{grid-column:span 3}
      .f.wide{grid-column:span 6}
      .kpis{grid-template-columns:repeat(2,1fr)}
      .twocol,.twocol2{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start}
      .nav{justify-content:flex-start}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="conap_logo.jpg" alt="Logo CONAP">
        <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
        <div>
          <h1>Centro de consulta de datos · AC192 Patrullajes</h1>
          <p>Sistema de monitoreo de actividades · CONAP – Dirección Regional Altiplano Central</p>
        </div>
      </div>
      <div class="nav">
        <a class="btn" href="index.html">Inicio</a>
        <a class="btn" href="patrullajes_dashboard.html">Dashboard geográfico</a>
        <a class="btn" href="patrullajes_datos.html">Tabla de datos</a>
        <button id="btnReset" class="btn danger" type="button">Limpiar filtros</button>
        <button id="btnPdf" class="btn primary" type="button" disabled>Generar informe PDF (liviano)</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="status">
          <div>
            <strong id="statusText">Cargando datos…</strong>
            <div class="small" id="statusSub">Leyendo datos_patrullaje.csv</div>
          </div>
          <div class="small" id="statusCount">—</div>
        </div>
      </div>

      <div class="card">
        <h2>Filtros</h2>
        <p class="sub">Los filtros se aplican a indicadores, gráficos, mapa y tabla.</p>

        <div class="filters" id="filtersGrid">
          <div class="f"><label for="fYear">Año</label><select id="fYear"></select></div>
          <div class="f"><label for="fMonth">Mes</label><select id="fMonth"></select></div>

          <div class="f"><label for="fRegion">Región</label><select id="fRegion"></select></div>
          <div class="f"><label for="fMunicipio">Municipio</label><select id="fMunicipio"></select></div>
          <div class="f wide"><label for="fArea">Área protegida</label><select id="fArea"></select></div>

          <div class="f wide"><label for="fGuarda">Guardarrecursos responsable</label><select id="fGuarda"></select></div>

          <div class="f wide"><label for="fTipo">Tipo de patrullaje</label><select id="fTipo"></select></div>
          <div class="f wide"><label for="fIlegal">Actividad ilegal observada</label><select id="fIlegal"></select></div>

          <div class="f wide"><label for="fUbicacion">Ubicación</label><select id="fUbicacion"></select></div>

          <div class="f wide"><label for="fSearch">Buscar</label><input id="fSearch" placeholder="Texto libre (municipio, área, guardarrecursos, actividad, etc.)"/></div>
        </div>
      </div>

      <div class="card">
        <h2>Indicadores</h2>
        <div class="kpis">
          <div class="kpi"><div class="t">Registros</div><div class="v" id="kTotal">—</div><div class="h">Total</div></div>
          <div class="kpi"><div class="t">Rango de fechas</div><div class="v" id="kRange">—</div><div class="h">Según “Fecha de patrullaje”</div></div>
          <div class="kpi"><div class="t">Regiones</div><div class="v" id="kReg">—</div><div class="h">Únicas</div></div>
          <div class="kpi"><div class="t">Municipios</div><div class="v" id="kMun">—</div><div class="h">Únicos</div></div>
          <div class="kpi"><div class="t">Con coordenadas</div><div class="v" id="kCoords">—</div><div class="h">Para el mapa</div></div>
        </div>
      </div>

      <div class="twocol2">
        <div class="card">
          <h2>Serie temporal (registros por mes)</h2>
          <p class="sub">Clic en un punto para filtrar por mes.</p>
          <canvas id="chartTime" height="110"></canvas>
        </div>
        <div class="card">
          <h2>Distribución por tipo</h2>
          <p class="sub">Clic en una barra para filtrar por categoría.</p>
          <div class="mapbar">
            <button id="btnClearTipo" class="btn" type="button" disabled>Quitar filtro gráfico</button>
          </div>
          <canvas id="chartTipo" height="120"></canvas>
        </div>
      </div>

      <div class="card" id="mapCard">
        <h2>Mapa (coordenadas)</h2>
        <p class="sub">Se usan columnas Latitud/Longitud (o equivalentes). Si no hay coordenadas, el mapa se oculta.</p>
        <div class="mapbar">
          <button id="btnFit" class="btn" type="button">Centrar</button>
          <button id="btnGeojson" class="btn" type="button">Descargar GeoJSON</button>
        </div>
        <div id="map"></div>
      </div>

      <div class="card">
        <h2>Tabla (Tabulator)</h2>
        <div class="tablebar">
          <button id="btnCsv" class="btn" type="button">Descargar CSV</button>
          <button id="btnXlsx" class="btn" type="button">Descargar Excel</button>
        </div>
        <div id="table"></div>
        <p class="sub">Tip: puede usar filtros por columna en los encabezados.</p>
      </div>

      <div class="foot">© 2026 Laboratorio SIG AALA en apoyo a CONAP – Dirección Regional Altiplano Central</div>
    </div>
  </div>

  <script>
    // -------------------------
    // Utilidades de carga de scripts (local -> CDN)
    // -------------------------
    function loadScript(url) {
      return new Promise(function(resolve, reject){
        var s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = function(){ resolve(url); };
        s.onerror = function(){ reject(new Error("No se pudo cargar: " + url)); };
        document.head.appendChild(s);
      });
    }

    async function loadScriptWithFallback(urls) {
      var lastErr = null;
      for (var i=0; i<urls.length; i++){
        try{
          await loadScript(urls[i]);
          return urls[i];
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("Error cargando script");
    }

    function el(id){ return document.getElementById(id); }

    // -------------------------
    // CSV: decode + parse
    // -------------------------
    function decodeBytes(bytes){
      try{
        return new TextDecoder("utf-8", {fatal:true}).decode(bytes);
      }catch(e){
        return new TextDecoder("windows-1252").decode(bytes);
      }
    }

    function guessDelimiter(csvText){
      var line = (csvText.split(/\r?\n/)[0] || "");
      var sc = line.split(";").length;
      var cc = line.split(",").length;
      return (sc >= cc) ? ";" : ",";
    }

    function normalizeKey(k){
      return (k || "").toString().trim();
    }

    function normalizeVal(v){
      if (v === null || v === undefined) return "";
      var s = v.toString().trim();
      return s;
    }

    // -------------------------
    // Fechas: detección de formato + parse robusto (DMY por defecto)
    // -------------------------
    function detectarFormatoFechaGlobal(rows, field){
      var seenDMY = false;
      var seenMDY = false;
      var seenYMD = false;

      for (var i=0; i<rows.length; i++){
        var raw = rows[i][field];
        if (!raw) continue;
        var str = raw.toString().trim();
        if (!str) continue;

        var part = str.split(" ")[0];
        var sep = part.indexOf("/")>=0 ? "/" : (part.indexOf("-")>=0 ? "-" : null);
        if (!sep) continue;
        var p = part.split(sep);
        if (p.length<3) continue;

        var p1 = (p[0]||"").trim();
        var p2 = (p[1]||"").trim();
        var p3 = (p[2]||"").trim();
        if (!p1 || !p2 || !p3) continue;

        if (p1.length === 4){ seenYMD = true; continue; }

        var a = parseInt(p1,10);
        var b = parseInt(p2,10);
        if (!isFinite(a) || !isFinite(b)) continue;

        if (a > 12 && b>=1 && b<=12) seenDMY = true;
        if (b > 12 && a>=1 && a<=12) seenMDY = true;

        if (seenDMY) break;
      }

      if (seenYMD) return "YMD";
      if (seenDMY) return "DMY";
      if (seenMDY) return "MDY";
      return "DMY";
    }

    function construirDateSeguro(y,m,d){
      var dt = new Date(y, m-1, d);
      if (dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d) return dt;
      return null;
    }

    function parseFechaSmart(raw, hint){
      if (!raw) return null;
      var str = raw.toString().trim();
      if (!str) return null;

      var part = str.split(" ")[0];
      var sep = part.indexOf("/")>=0 ? "/" : (part.indexOf("-")>=0 ? "-" : null);
      if (!sep) return null;
      var p = part.split(sep);
      if (p.length<3) return null;

      var p1 = (p[0]||"").trim();
      var p2 = (p[1]||"").trim();
      var p3 = (p[2]||"").trim();

      if (p1.length===4 || hint==="YMD"){
        var y = parseInt(p1,10), m = parseInt(p2,10), d = parseInt(p3,10);
        if (!isFinite(y)||!isFinite(m)||!isFinite(d)) return null;
        return construirDateSeguro(y,m,d);
      }

      var a = parseInt(p1,10);
      var b = parseInt(p2,10);
      var ym = p3.match(/\d{2,4}/);
      if (!isFinite(a)||!isFinite(b)||!ym) return null;
      var y2 = parseInt(ym[0],10);
      if (y2 < 100) y2 = (y2<=50) ? (2000+y2) : (1900+y2);

      // no ambiguo
      if (a>12 && b>=1 && b<=12){ // DMY
        return construirDateSeguro(y2, b, a);
      }
      if (b>12 && a>=1 && a<=12){ // MDY
        return construirDateSeguro(y2, a, b);
      }

      // ambiguo
      var dtMDY = construirDateSeguro(y2, a, b);
      var dtDMY = construirDateSeguro(y2, b, a);

      if (hint==="MDY" && dtMDY) return dtMDY;
      if (hint==="DMY" && dtDMY) return dtDMY;

      // default DMY (Guatemala)
      if (dtDMY) return dtDMY;
      if (dtMDY) return dtMDY;
      return null;
    }

    function monthKey(dt){
      var y = dt.getFullYear();
      var m = dt.getMonth()+1;
      return y + "-" + String(m).padStart(2,"0");
    }

    function nombreMesEs(m){
      var n=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      return n[m-1] || "";
    }
    function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

    // -------------------------
    // Campos (AC192)
    // -------------------------
    var FIELD_DATE = "Fecha de patrullaje";
    var FIELD_REGION = "Region";
    var FIELD_MUNI = "Municipio";
    var FIELD_AREA = "Area protegida";
    var FIELD_GUARDA = "Guarda recursos responsable";
    var FIELD_TIPO = "Tipo de patrullaje";
    var FIELD_ILEGAL = "Actividad ilegal observada";
    var FIELD_UBICACION = "Ubicacion";

    // Coordenadas (en tu CSV hay Longitud/Latitud y también X/Y)
    var FIELD_LAT_CAND = ["Latitud","latitud","LATITUD","lat","Lat"];
    var FIELD_LON_CAND = ["Longitud","longitud","LONGITUD","lon","Lon","lng","LNG"];

    function findFieldName(row, candidates){
      var keys = Object.keys(row || {});
      for (var i=0;i<candidates.length;i++){
        var c=candidates[i].toLowerCase();
        for (var k=0;k<keys.length;k++){
          if (keys[k].toLowerCase()===c) return keys[k];
        }
      }
      return null;
    }

    // -------------------------
    // Estado global
    // -------------------------
    var RAW = [];
    var FILTERED = [];
    var DATE_HINT = "DMY";
    var LAT_FIELD = null;
    var LON_FIELD = null;

    var chartTime = null;
    var chartTipo = null;
    var table = null;
    var map = null;
    var layer = null;
    var mapReady = false;

    function setStatus(main, sub, count){
      el("statusText").textContent = main;
      el("statusSub").textContent = sub || "";
      el("statusCount").textContent = count || "";
    }

    function uniqueSorted(rows, field){
      var s = new Set();
      for (var i=0;i<rows.length;i++){
        var v = rows[i][field];
        if (v===null || v===undefined) continue;
        var t = v.toString().trim();
        if (!t) continue;
        s.add(t);
      }
      return Array.from(s).sort(function(a,b){ return a.localeCompare(b,"es"); });
    }

    function fillSelect(selectId, values, opts){
      opts = opts || {};
      var select = el(selectId);
      if (!select) return;

      select.innerHTML = "";
      var optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = opts.allLabel || "Todos";
      select.appendChild(optAll);

      for (var i=0;i<values.length;i++){
        var o = document.createElement("option");
        o.value = values[i].value;
        o.textContent = values[i].label;
        select.appendChild(o);
      }
    }

    function getVal(id){ var e = el(id); return e ? (e.value || "").trim() : ""; }

    function applyFilters(){
      var fy = getVal("fYear");
      var fm = getVal("fMonth");
      var fr = getVal("fRegion");
      var fmu = getVal("fMunicipio");
      var fa = getVal("fArea");
      var fg = getVal("fGuarda");
      var ft = getVal("fTipo");
      var fi = getVal("fIlegal");
      var fu = getVal("fUbicacion");
      var fs = getVal("fSearch").toLowerCase();

      FILTERED = RAW.filter(function(r){
        if (fy && String(r._year) !== fy) return false;
        if (fm && r._monthKey !== fm) return false;
        if (fr && normalizeVal(r[FIELD_REGION]) !== fr) return false;
        if (fmu && normalizeVal(r[FIELD_MUNI]) !== fmu) return false;
        if (fa && normalizeVal(r[FIELD_AREA]) !== fa) return false;
        if (fg && normalizeVal(r[FIELD_GUARDA]) !== fg) return false;
        if (ft && normalizeVal(r[FIELD_TIPO]) !== ft) return false;
        if (fi && normalizeVal(r[FIELD_ILEGAL]) !== fi) return false;
        if (fu && normalizeVal(r[FIELD_UBICACION]) !== fu) return false;

        if (fs){
          var blob = (
            normalizeVal(r[FIELD_REGION]) + " " +
            normalizeVal(r[FIELD_MUNI]) + " " +
            normalizeVal(r[FIELD_AREA]) + " " +
            normalizeVal(r[FIELD_GUARDA]) + " " +
            normalizeVal(r[FIELD_TIPO]) + " " +
            normalizeVal(r[FIELD_ILEGAL]) + " " +
            normalizeVal(r[FIELD_UBICACION])
          ).toLowerCase();
          if (blob.indexOf(fs) === -1) return false;
        }
        return true;
      });

      updateAll();
    }

    function updateKpis(){
      el("kTotal").textContent = FILTERED.length.toLocaleString("es-GT");

      var dates = FILTERED.map(function(r){ return r._dateObj; }).filter(Boolean).sort(function(a,b){ return a-b; });
      if (dates.length){
        var min = dates[0], max = dates[dates.length-1];
        var fmt = function(d){
          var dd = String(d.getDate()).padStart(2,"0");
          var mm = String(d.getMonth()+1).padStart(2,"0");
          var yy = d.getFullYear();
          return dd + "/" + mm + "/" + yy;
        };
        el("kRange").textContent = fmt(min) + " – " + fmt(max);
      }else{
        el("kRange").textContent = "—";
      }

      el("kReg").textContent = new Set(FILTERED.map(function(r){return normalizeVal(r[FIELD_REGION]);}).filter(Boolean)).size;
      el("kMun").textContent = new Set(FILTERED.map(function(r){return normalizeVal(r[FIELD_MUNI]);}).filter(Boolean)).size;

      var coords = FILTERED.filter(function(r){ return isFinite(r._lat) && isFinite(r._lon); }).length;
      el("kCoords").textContent = coords.toLocaleString("es-GT");

      el("btnPdf").disabled = (FILTERED.length === 0);
    }

    function countsByMonth(rows){
      var m = new Map();
      rows.forEach(function(r){
        if (!r._monthKey) return;
        m.set(r._monthKey, (m.get(r._monthKey)||0) + 1);
      });
      var keys = Array.from(m.keys()).sort();
      return {labels: keys, values: keys.map(function(k){ return m.get(k); })};
    }

    function labelsMonth(keys){
      return keys.map(function(k){
        var parts = k.split("-");
        var y = parseInt(parts[0],10);
        var m = parseInt(parts[1],10);
        return cap(nombreMesEs(m)) + " " + y;
      });
    }

    function updateCharts(){
      // time series
      var t = countsByMonth(FILTERED);
      var labels = labelsMonth(t.labels);
      if (!chartTime){
        chartTime = new Chart(el("chartTime"), {
          type: "line",
          data: { labels: labels, datasets:[{label:"Registros", data:t.values, tension:0.25, pointRadius:4}] },
          options: {
            responsive:true,
            plugins:{legend:{display:false}},
            scales:{ y:{beginAtZero:true, ticks:{precision:0}} },
            onClick: function(evt, elements){
              if (!elements || !elements.length) return;
              var idx = elements[0].index;
              var key = t.labels[idx];
              if (key) { el("fMonth").value = key; applyFilters(); }
            }
          }
        });
      }else{
        chartTime.data.labels = labels;
        chartTime.data.datasets[0].data = t.values;
        chartTime.update();
      }

      // bars by tipo
      var mapTipo = new Map();
      FILTERED.forEach(function(r){
        var v = normalizeVal(r[FIELD_TIPO]) || "Sin clasificar";
        mapTipo.set(v, (mapTipo.get(v)||0)+1);
      });
      var tipos = Array.from(mapTipo.keys()).sort(function(a,b){ return mapTipo.get(b)-mapTipo.get(a); });
      var vals = tipos.map(function(k){ return mapTipo.get(k); });

      if (!chartTipo){
        chartTipo = new Chart(el("chartTipo"), {
          type: "bar",
          data: { labels: tipos, datasets:[{label:"Registros", data: vals}] },
          options: {
            responsive:true,
            plugins:{legend:{display:false}},
            scales:{ y:{beginAtZero:true, ticks:{precision:0}} },
            onClick: function(evt, elements){
              if (!elements || !elements.length) return;
              var idx = elements[0].index;
              var cat = tipos[idx];
              if (cat){
                el("fTipo").value = cat;
                el("btnClearTipo").disabled = false;
                applyFilters();
              }
            }
          }
        });
      }else{
        chartTipo.data.labels = tipos;
        chartTipo.data.datasets[0].data = vals;
        chartTipo.update();
      }
    }

    function initMapIfNeeded(){
      if (mapReady) return;
      if (!LAT_FIELD || !LON_FIELD) return;

      map = L.map("map", { preferCanvas:true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      layer = L.layerGroup().addTo(map);
      mapReady = true;
    }

    function updateMap(){
      var hasCoords = FILTERED.some(function(r){ return isFinite(r._lat) && isFinite(r._lon); });

      if (!LAT_FIELD || !LON_FIELD || !hasCoords){
        // ocultar tarjeta si no hay coords
        el("mapCard").style.display = "none";
        return;
      }
      el("mapCard").style.display = "block";

      initMapIfNeeded();
      layer.clearLayers();

      var bounds = [];
      FILTERED.forEach(function(r){
        if (!isFinite(r._lat) || !isFinite(r._lon)) return;
        var pt = [r._lat, r._lon];
        bounds.push(pt);

        var marker = L.circleMarker(pt, { radius: 4, weight: 1, fillOpacity: 0.65 });
        var html = "<strong>Patrullaje</strong><br>" +
          "Fecha: " + (r[FIELD_DATE] || "") + "<br>" +
          "Municipio: " + (r[FIELD_MUNI] || "") + "<br>" +
          "Área: " + (r[FIELD_AREA] || "") + "<br>" +
          "Tipo: " + (r[FIELD_TIPO] || "");
        marker.bindPopup(html);
        marker.addTo(layer);
      });

      if (bounds.length){
        map.fitBounds(bounds, { padding:[20,20] });
      }else{
        map.setView([14.7,-91.1], 9);
      }
    }

    function buildGeoJSON(rows){
      var feats = [];
      rows.forEach(function(r){
        if (!isFinite(r._lat) || !isFinite(r._lon)) return;
        var props = {};
        Object.keys(r).forEach(function(k){
          if (k.startsWith("_")) return;
          props[k]=r[k];
        });
        feats.push({
          type:"Feature",
          geometry:{ type:"Point", coordinates:[r._lon, r._lat] },
          properties: props
        });
      });
      return { type:"FeatureCollection", features: feats };
    }

    function downloadBlob(filename, mime, content){
      var blob = (content instanceof Blob) ? content : new Blob([content], {type:mime});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }, 0);
    }

    function updateTable(){
      if (!table){
        var cols = [];
        if (RAW.length){
          Object.keys(RAW[0]).forEach(function(k){
            if (k.startsWith("_")) return;
            cols.push({
              title: k,
              field: k,
              headerFilter: "input",
              headerFilterPlaceholder: "filtrar…",
              headerFilterFunc: "like",
              minWidth: 140
            });
          });
        }
        table = new Tabulator("#table", {
          data: FILTERED,
          layout:"fitDataStretch",
          pagination:"local",
          paginationSize: 20,
          paginationSizeSelector:[10,20,50,100],
          movableColumns:true,
          columns: cols
        });
      }else{
        table.replaceData(FILTERED);
      }
    }

    function updateAll(){
      setStatus("Listo", "Filtros aplicados", "Mostrando " + FILTERED.length.toLocaleString("es-GT") + " de " + RAW.length.toLocaleString("es-GT"));
      updateKpis();
      updateCharts();
      updateMap();
      updateTable();
    }

    async function loadAllDependencies(){
      setStatus("Cargando librerías…", "Esto puede tardar unos segundos", "—");

      // PapaParse
      await loadScriptWithFallback(["papaparse.min.js","https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"]);
      // Tabulator
      await loadScriptWithFallback(["tabulator.min.js","https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"]);
      // XLSX
      await loadScriptWithFallback(["xlsx.full.min.js","https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"]);
      // Chart.js
      await loadScriptWithFallback(["https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"]);
      // Leaflet
      await loadScriptWithFallback(["leaflet.js","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"]);
      // html2pdf
      await loadScriptWithFallback(["https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"]);
    }

    async function fetchCsv(){
      setStatus("Cargando datos…", "Leyendo datos_patrullaje.csv", "—");
      var urls = ["./datos_patrullaje.csv","datos_patrullaje.csv","./data/datos_patrullaje.csv"];
      var lastErr = null;
      for (var i=0; i<urls.length; i++){
        try{
          var res = await fetch(urls[i], {cache:"no-store"});
          if (!res.ok) throw new Error("HTTP "+res.status);
          var buf = await res.arrayBuffer();
          var txt = decodeBytes(new Uint8Array(buf));
          return {text: txt, url: urls[i]};
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("No se pudo cargar el CSV");
    }

    function buildOptions(){
      // years and months from parsed dates
      var yearsSet = new Set();
      var monthsSet = new Set();
      RAW.forEach(function(r){
        if (isFinite(r._year)) yearsSet.add(String(r._year));
        if (r._monthKey) monthsSet.add(r._monthKey);
      });

      var years = Array.from(yearsSet).sort();
      fillSelect("fYear", years.map(function(y){ return {value:y,label:y}; }), {allLabel:"Todos"});

      var months = Array.from(monthsSet).sort();
      fillSelect("fMonth", months.map(function(k){
        var parts = k.split("-");
        var y = parseInt(parts[0],10), m = parseInt(parts[1],10);
        return {value:k, label: cap(nombreMesEs(m)) + " " + y};
      }), {allLabel:"Todos"});

      function simple(field, selectId){
        var vals = uniqueSorted(RAW, field).map(function(v){ return {value:v,label:v}; });
        fillSelect(selectId, vals, {allLabel:"Todos"});
      }

      simple(FIELD_REGION, "fRegion");
      simple(FIELD_MUNI, "fMunicipio");
      simple(FIELD_AREA, "fArea");
      simple(FIELD_GUARDA, "fGuarda");
      simple(FIELD_TIPO, "fTipo");
      simple(FIELD_ILEGAL, "fIlegal");
      simple(FIELD_UBICACION, "fUbicacion");
    }

    function wireEvents(){
      ["fYear","fMonth","fRegion","fMunicipio","fArea","fGuarda","fTipo","fIlegal","fUbicacion"].forEach(function(id){
        var e = el(id);
        if (e) e.addEventListener("change", applyFilters);
      });
      el("fSearch").addEventListener("input", function(){
        clearTimeout(window.__t);
        window.__t = setTimeout(applyFilters, 150);
      });

      el("btnReset").addEventListener("click", function(){
        ["fYear","fMonth","fRegion","fMunicipio","fArea","fGuarda","fTipo","fIlegal","fUbicacion"].forEach(function(id){
          if (el(id)) el(id).value = "";
        });
        el("fSearch").value = "";
        el("btnClearTipo").disabled = true;
        applyFilters();
      });

      el("btnClearTipo").addEventListener("click", function(){
        el("fTipo").value = "";
        el("btnClearTipo").disabled = true;
        applyFilters();
      });

      el("btnCsv").addEventListener("click", function(){
        if (!table) return;
        table.download("csv", "ac192_patrullajes_filtrado.csv");
      });

      el("btnXlsx").addEventListener("click", function(){
        if (!table || typeof XLSX === "undefined") return;
        table.download("xlsx", "ac192_patrullajes_filtrado.xlsx", {sheetName:"AC192"});
      });

      el("btnFit").addEventListener("click", function(){
        if (!map || !layer) return;
        var pts = [];
        FILTERED.forEach(function(r){
          if (isFinite(r._lat) && isFinite(r._lon)) pts.push([r._lat,r._lon]);
        });
        if (pts.length) map.fitBounds(pts, {padding:[20,20]});
      });

      el("btnGeojson").addEventListener("click", function(){
        var gj = buildGeoJSON(FILTERED);
        downloadBlob("ac192_patrullajes_filtrado.geojson", "application/geo+json", JSON.stringify(gj));
      });

      el("btnPdf").addEventListener("click", function(){
        if (typeof html2pdf === "undefined") return;
        var clone = document.querySelector(".wrap").cloneNode(true);
        // quitar tabla grande para PDF liviano
        var tableDiv = clone.querySelector("#table");
        if (tableDiv) tableDiv.innerHTML = "<p style='color:#667085;font-size:12px'>Tabla omitida en PDF liviano. Use la descarga CSV/Excel para el detalle.</p>";
        var opt = {
          margin: 0.35,
          filename: "ac192_patrullajes_resumen.pdf",
          image: { type: "jpeg", quality: 0.92 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
        };
        html2pdf().set(opt).from(clone).save();
      });
    }

    async function main(){
      try{
        await loadAllDependencies();

        var csv = await fetchCsv();
        setStatus("Parseando datos…", "Origen: " + csv.url, "—");

        var delim = guessDelimiter(csv.text);
        var parsed = Papa.parse(csv.text, {header:true, skipEmptyLines:true, delimiter: delim});
        if (parsed.errors && parsed.errors.length){
          // reintento rápido
          parsed = Papa.parse(csv.text, {header:true, skipEmptyLines:true, delimiter: (delim===";" ? "," : ";")});
        }

        var rows = parsed.data || [];
        if (!rows.length){
          setStatus("Sin datos", "El CSV se cargó pero no contiene filas", "0");
          return;
        }

        // normalizar filas
        var norm = [];
        for (var i=0;i<rows.length;i++){
          var r = rows[i] || {};
          var obj = {};
          Object.keys(r).forEach(function(k){
            obj[normalizeKey(k)] = normalizeVal(r[k]);
          });
          norm.push(obj);
        }

        DATE_HINT = detectarFormatoFechaGlobal(norm, FIELD_DATE);

        // localizar campos de coordenadas
        LAT_FIELD = findFieldName(norm[0], FIELD_LAT_CAND);
        LON_FIELD = findFieldName(norm[0], FIELD_LON_CAND);

        // añadir campos derivados
        norm.forEach(function(r){
          var dt = parseFechaSmart(r[FIELD_DATE], DATE_HINT);
          r._dateObj = dt;
          r._year = dt ? dt.getFullYear() : null;
          r._monthKey = dt ? monthKey(dt) : "";

          if (LAT_FIELD && LON_FIELD){
            var lat = parseFloat((r[LAT_FIELD]||"").replace(",","."));
            var lon = parseFloat((r[LON_FIELD]||"").replace(",","."));
            // validación básica
            if (isFinite(lat) && isFinite(lon) && Math.abs(lat)<=90 && Math.abs(lon)<=180){
              r._lat = lat; r._lon = lon;
            }else{
              r._lat = NaN; r._lon = NaN;
            }
          }else{
            r._lat = NaN; r._lon = NaN;
          }
        });

        RAW = norm;
        FILTERED = RAW.slice();

        buildOptions();
        wireEvents();
        updateAll();
      }catch(e){
        console.error(e);
        setStatus("Error", "No se pudo inicializar el tablero: " + (e && e.message ? e.message : e), "—");
        alert("Error en el tablero dinámico: " + (e && e.message ? e.message : e));
      }
    }

    document.addEventListener("DOMContentLoaded", main);
  </script>
</body>
</html>
