<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC192 · Patrullajes - Tablero dinámico</title>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Leaflet (OSM) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- html2pdf (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --brand:#1f6feb; --warn:#b91c1c;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--ink)}
    a{color:inherit; text-decoration:none}
    header{background:#fff; border-bottom:1px solid var(--line)}
    .header-inner{max-width:1200px; margin:0 auto; padding:14px 16px; display:flex; gap:16px; align-items:center}
    .logo-group{display:flex; gap:10px; align-items:center}
    .logo-group img{height:46px; width:auto; object-fit:contain}
    .title-group h1{margin:0; font-size:18px}
    .title-group p{margin:2px 0 0; color:var(--muted); font-size:13px}

    main{max-width:1200px; margin:0 auto; padding:16px}
    .page-header{margin:4px 0 10px}
    .page-header h2{margin:0; font-size:18px}

    .topnav{background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:10px 12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:8px 10px; border:1px solid var(--line); border-radius:999px; font-size:13px; color:var(--muted); background:#fff}
    .tab.active{border-color:var(--brand); color:var(--brand); font-weight:600}
    .nav-actions{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; font-size:13px; cursor:pointer}
    .btn:hover{border-color:#cbd5e1}
    .btn-warn{border-color:#fecaca; background:#fff5f5; color:var(--warn)}
    .btn-ghost{background:#fff}
    .infobox{flex-basis:100%; padding:8px 10px; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:12px; color:var(--muted); font-size:13px}
    .chips{margin-top:8px; display:flex; flex-wrap:wrap; gap:6px}
    .chip{background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; padding:4px 8px; border-radius:999px; font-size:12px}

    .subnote{color:var(--muted); font-size:13px; margin:8px 2px 0}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:12px 12px; box-shadow:0 1px 0 rgba(15,23,42,.02)}
    .card.soft{background:#fbfdff}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-top:12px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    @media (max-width: 960px){
      .col-6,.col-4,.col-8{grid-column:span 12}
      .nav-actions{margin-left:0}
      .logo-group img{height:40px}
    }

    .filters{display:grid; grid-template-columns:repeat(12,1fr); gap:10px; margin-top:8px}
    .field{grid-column:span 3; min-width:160px}
    .field.wide{grid-column:span 6}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px}
    select,input{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; font-size:13px; background:#fff}
    input::placeholder{color:#94a3b8}
    .kpis{display:grid; grid-template-columns:repeat(6,1fr); gap:10px}
    @media (max-width: 960px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{border:1px solid var(--line); border-radius:14px; padding:10px 10px; background:#fff}
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:20px; font-weight:700; margin-top:4px}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:2px}

    .chartwrap{height:320px}
    canvas{width:100%; height:100%}

    /* MAPA: altura fija para que NO desproporcione el layout */
    #map{height:340px; min-height:340px; max-height:340px; border-radius:12px; border:1px solid var(--line); overflow:hidden}
    .mapnote{margin-top:8px; color:var(--muted); font-size:13px}

    .error{color:var(--warn); font-weight:700}
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="logo-group">
      <img src="conap_logo.jpg" alt="Logo CONAP"/>
      <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA"/>
    </div>
    <div class="title-group">
      <h1>Centro de consulta de datos</h1>
      <p>Sistema de monitoreo de actividades</p>
      <p>CONAP – Dirección Regional Altiplano Central</p>
    </div>
  </div>
</header>

<main>
  <section class="page-header">
    <h2>AC192 · Patrullajes de control y vigilancia · Tablero dinámico</h2>
  </section>

  <section class="topnav" aria-label="Navegación y acciones del módulo">
    <nav class="tabs" aria-label="Navegación del módulo">
      <a class="tab" href="patrullajes_dashboard.html">Dashboard geográfico</a>
      <a class="tab active" href="patrullajes_tablero.html">Tablero dinámico</a>
      <a class="tab" href="patrullajes_datos.html">Tabla de datos</a>
    </nav>
    <div class="nav-actions">
      <a class="btn btn-ghost" href="index.html">Inicio</a>
      <button class="btn btn-ghost" id="btn-reset" type="button">Limpiar filtros</button>
      <button class="btn btn-warn" id="btn-pdf" type="button">Generar informe PDF (liviano)</button>
    </div>

    <div class="infobox">
      <b>Sugerencia:</b> use filtros para explorar, y haga clic en barras del gráfico “Tipo” para filtrar.
      <div class="chips" id="chips-filtros" aria-label="Resumen de filtros"></div>
      <div class="subnote" id="estado" style="margin-top:8px;">Cargando datos…</div>
    </div>
  </section>

  <section class="card soft" id="card-filtros" aria-label="Filtros del tablero" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Filtros</h3>
    <p class="subnote" style="margin:0;">Los filtros se aplican a indicadores, gráficos y mapa.</p>

    <div class="filters" id="filters-grid">
      <div class="field" id="wrap-anio">
        <label for="f-anio">Año</label>
        <select id="f-anio"></select>
      </div>

      <div class="field" id="wrap-mes">
        <label for="f-mes">Mes</label>
        <select id="f-mes"></select>
      </div>

      <div class="field wide" id="wrap-region">
        <label for="f-region">Región</label>
        <select id="f-region"></select>
      </div>

      <div class="field wide" id="wrap-municipio">
        <label for="f-municipio">Municipio</label>
        <select id="f-municipio"></select>
      </div>

      <div class="field wide" id="wrap-area">
        <label for="f-area">Área protegida</label>
        <select id="f-area"></select>
      </div>

      <div class="field wide" id="wrap-guarda">
        <label for="f-guarda">Guardarrecursos responsable</label>
        <select id="f-guarda"></select>
      </div>

      <div class="field wide" id="wrap-tipo">
        <label for="f-tipo">Tipo de patrullaje</label>
        <select id="f-tipo"></select>
      </div>

      <div class="field wide" id="wrap-ilegal">
        <label for="f-ilegal">Actividad ilegal observada</label>
        <select id="f-ilegal"></select>
      </div>

      <div class="field wide" id="wrap-ubicacion">
        <label for="f-ubicacion">Ubicación</label>
        <select id="f-ubicacion"></select>
      </div>

      <div class="field" id="wrap-buscar">
        <label for="f-buscar">Buscar</label>
        <input id="f-buscar" type="text" placeholder="palabra clave (en cualquier campo)"/>
      </div>
    </div>
  </section>

  <section class="card" aria-label="Indicadores" style="margin-top:12px;">
    <h3 style="margin:0 0 10px;">Indicadores</h3>
    <div class="kpis">
      <div class="kpi"><div class="t">Registros</div><div class="v" id="kpi-registros">–</div><div class="s">Filtrados</div></div>
      <div class="kpi"><div class="t">Rango de fechas</div><div class="v" id="kpi-rango">–</div><div class="s">Según “Fecha de patrullaje”</div></div>
      <div class="kpi"><div class="t">Regiones</div><div class="v" id="kpi-regiones">–</div><div class="s">Únicas</div></div>
      <div class="kpi"><div class="t">Municipios</div><div class="v" id="kpi-municipios">–</div><div class="s">Únicos</div></div>
      <div class="kpi"><div class="t">Áreas protegidas</div><div class="v" id="kpi-areas">–</div><div class="s">Únicas</div></div>
      <div class="kpi"><div class="t">Puntos (Guatemala)</div><div class="v" id="kpi-coords">–</div><div class="s">Para el mapa</div></div>
    </div>
  </section>

  <section class="grid" aria-label="Gráficos">
    <div class="card col-6">
      <h3 style="margin:0 0 8px;">Patrullajes por mes</h3>
      <div class="chartwrap"><canvas id="c-mes"></canvas></div>
      <p class="subnote" style="margin:8px 0 0;">Muestra el total de registros por mes (solo meses existentes en el CSV).</p>
    </div>

    <div class="card col-6">
      <h3 style="margin:0 0 8px;">Distribución por tipo</h3>
      <div class="chartwrap"><canvas id="c-tipo"></canvas></div>
      <p class="subnote" style="margin:8px 0 0;">Clic en una barra para filtrar por ese tipo.</p>
    </div>

    <div class="card col-6">
      <h3 style="margin:0 0 8px;">Top municipios</h3>
      <div class="chartwrap"><canvas id="c-municipio"></canvas></div>
    </div>

    <div class="card col-6">
      <h3 style="margin:0 0 8px;">Top guardarrecursos</h3>
      <div class="chartwrap"><canvas id="c-guarda"></canvas></div>
    </div>
  </section>

  <section class="card" aria-label="Mapa" style="margin-top:12px;">
    <h3 style="margin:0 0 8px;">Mapa (solo puntos en Guatemala)</h3>
    <div id="map" role="application" aria-label="Mapa con puntos de patrullaje"></div>
    <div class="mapnote" id="mapnote">—</div>
  </section>

  <footer style="text-align:center; padding:18px 8px; color:var(--muted); font-size:12px;">
    © 2026 · Centro de consulta de datos
  </footer>
</main>

<script>
/* =========================
   Utilidades: texto/canon
========================= */
function normStr(v){
  if(v === null || v === undefined) return "";
  let s = String(v).trim();
  s = s.replace(/\s+/g, " ");
  return s;
}
function canon(v){
  const s = normStr(v);
  if(!s) return "";
  return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}
function prefersAccents(s){
  // retorna true si contiene letras con acento/ñ
  return /[áéíóúüñÁÉÍÓÚÜÑ]/.test(String(s || ""));
}
function bestLabel(prev, cand){
  const a = normStr(prev), b = normStr(cand);
  if(!a) return b;
  if(!b) return a;
  // preferir etiqueta con acentos si la otra no tiene
  if(prefersAccents(b) && !prefersAccents(a)) return b;
  // preferir la más larga si difieren
  if(b.length > a.length) return b;
  return a;
}

/* =========================
   Decodificación robusta
========================= */
async function fetchArrayBuffer(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("HTTP " + res.status + " al cargar " + url);
  return await res.arrayBuffer();
}
function decodeSmart(buf){
  const u8 = new Uint8Array(buf);
  // 1) intentar UTF-8
  let t1 = new TextDecoder("utf-8", {fatal:false}).decode(u8);
  const rep1 = (t1.match(/\uFFFD/g)||[]).length;

  // 2) intentar Windows-1252
  let t2 = new TextDecoder("windows-1252", {fatal:false}).decode(u8);
  const rep2 = (t2.match(/\uFFFD/g)||[]).length;

  // elegir el que tenga menos reemplazos
  if(rep2 < rep1) return t2;
  return t1;
}

/* =========================
   CSV parser (sin librerías)
========================= */
function detectDelimiter(text){
  const firstLine = (text.split(/\r?\n/).find(l => l.trim().length) || "");
  const counts = {
    ";": (firstLine.match(/;/g)||[]).length,
    ",": (firstLine.match(/,/g)||[]).length,
    "\t": (firstLine.match(/\t/g)||[]).length
  };
  let best = ";", max = counts[";"];
  if(counts[","] > max){ best=","; max=counts[","]; }
  if(counts["\t"] > max){ best="\t"; max=counts["\t"]; }
  return best;
}
function parseCSV(text){
  const delim = detectDelimiter(text);
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;

  function pushField(){
    row.push(field);
    field="";
  }
  function pushRow(){
    if(row.length===0) return;
    rows.push(row);
    row=[];
  }

  while(i < text.length){
    const c = text[i];

    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else {
        field += c; i++; continue;
      }
    } else {
      if(c === '"'){ inQuotes = true; i++; continue; }
      if(delim !== "\t" && c === delim){ pushField(); i++; continue; }
      if(delim === "\t" && c === "\t"){ pushField(); i++; continue; }
      if(c === "\n"){ pushField(); pushRow(); i++; continue; }
      if(c === "\r"){ // CRLF
        if(text[i+1] === "\n"){ i += 2; pushField(); pushRow(); continue; }
        i++; pushField(); pushRow(); continue;
      }
      field += c; i++; continue;
    }
  }
  // final
  pushField(); pushRow();

  if(rows.length < 2) return {data:[], headers:[]};

  const headers = rows[0].map(h => normStr(h));
  const data = [];
  for(let r=1; r<rows.length; r++){
    if(rows[r].every(v => String(v||"").trim()==="")) continue;
    const obj = {};
    for(let c=0; c<headers.length; c++){
      obj[headers[c]] = rows[r][c] !== undefined ? normStr(rows[r][c]) : "";
    }
    data.push(obj);
  }
  return {data, headers};
}

/* =========================
   Fecha: DD/MM vs MM/DD
========================= */
function inferDayFirst(samples){
  // si hay algún caso con primer número > 12 -> dayfirst
  // si hay algún caso con segundo número > 12 -> monthfirst
  let seenDayFirst = 0, seenMonthFirst = 0;
  for(const s of samples){
    const v = normStr(s);
    if(!v || !v.includes("/")) continue;
    const parts = v.split("/");
    if(parts.length < 3) continue;
    const a = parseInt(parts[0],10);
    const b = parseInt(parts[1],10);
    if(!isNaN(a) && a > 12) seenDayFirst++;
    if(!isNaN(b) && b > 12) seenMonthFirst++;
  }
  if(seenDayFirst > 0 && seenMonthFirst === 0) return true;
  if(seenMonthFirst > 0 && seenDayFirst === 0) return false;
  // por defecto Guatemala: dayfirst
  return true;
}
function parseDateSmart(s, dayFirst){
  const v = normStr(s);
  if(!v) return null;
  // YYYY-MM-DD
  const m1 = v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(m1){
    const y = +m1[1], mo = +m1[2], d = +m1[3];
    const dt = new Date(Date.UTC(y, mo-1, d));
    return isNaN(dt.getTime()) ? null : dt;
  }
  // DD/MM/YYYY o MM/DD/YYYY
  if(v.includes("/")){
    const p = v.split("/");
    if(p.length>=3){
      let a = parseInt(p[0],10), b = parseInt(p[1],10), y = parseInt(p[2],10);
      if(isNaN(a)||isNaN(b)||isNaN(y)) return null;
      let d, mo;
      if(dayFirst){ d=a; mo=b; } else { mo=a; d=b; }
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
  }
  // fallback
  const dt = new Date(v);
  return isNaN(dt.getTime()) ? null : dt;
}
function monthKey(dt){
  const y = dt.getUTCFullYear();
  const m = dt.getUTCMonth()+1;
  return String(y) + "-" + String(m).padStart(2,"0");
}
const MONTHS_ES = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
function monthLabel(key){
  const [y,m]=key.split("-");
  const idx = parseInt(m,10)-1;
  return (MONTHS_ES[idx] || m) + " " + y;
}

/* =========================
   Guatemala: filtro de puntos
========================= */
// Bounding box Guatemala (amplio)
function inGuatemalaBBox(lat, lon){
  return (lat >= 13.6 && lat <= 18.1 && lon >= -92.6 && lon <= -88.0);
}
// Polígono simplificado Guatemala (lon,lat). Suficiente para excluir outliers.
const GT_POLY = [
  [-92.23, 14.55], [-92.10, 14.30], [-91.95, 14.05], [-91.70, 13.90],
  [-91.30, 13.72], [-90.70, 13.70], [-90.00, 13.74], [-89.55, 13.74],
  [-89.25, 13.74], [-88.95, 14.10], [-88.60, 14.55], [-88.40, 15.05],
  [-88.25, 15.55], [-88.20, 16.10], [-88.20, 17.82], [-89.10, 17.82],
  [-90.00, 17.82], [-91.45, 17.82], [-91.85, 17.25], [-92.17, 16.50],
  [-92.30, 15.50], [-92.23, 14.55]
];
function pointInPoly(lon, lat, poly){
  // ray casting
  let inside = false;
  for(let i=0, j=poly.length-1; i<poly.length; j=i++){
    const xi = poly[i][0], yi = poly[i][1];
    const xj = poly[j][0], yj = poly[j][1];
    const intersect = ((yi > lat) !== (yj > lat)) &&
      (lon < (xj - xi) * (lat - yi) / ((yj - yi) || 1e-12) + xi);
    if(intersect) inside = !inside;
  }
  return inside;
}
function inGuatemala(lat, lon){
  if(!inGuatemalaBBox(lat, lon)) return false;
  return pointInPoly(lon, lat, GT_POLY);
}

/* =========================
   Estado global
========================= */
let RAW = [];          // filas originales
let ROWS = [];         // filas enriquecidas (canon + fecha)
let HEADERS = [];      // headers
let dayFirst = true;

const FIELD_MAP = {
  anio:  { id:"f-anio",      col:null },
  mes:   { id:"f-mes",       col:null },
  region:{ id:"f-region",    col:"Region" },
  muni:  { id:"f-municipio", col:"Municipio" },
  area:  { id:"f-area",      col:"Area protegida" },
  guarda:{ id:"f-guarda",    col:"Guarda recursos responsable" },
  tipo:  { id:"f-tipo",      col:"Tipo de patrullaje" },
  ilegal:{ id:"f-ilegal",    col:"Actividad ilegal observada" },
  ubic:  { id:"f-ubicacion", col:"Ubicacion" }
};

// mapeo etiqueta bonita por cada campo (canon -> label)
const LABELS = {
  region:new Map(), muni:new Map(), area:new Map(), guarda:new Map(), tipo:new Map(), ilegal:new Map(), ubic:new Map()
};

function setEstado(msg, isErr=false){
  const el = document.getElementById("estado");
  el.textContent = msg;
  el.className = isErr ? "subnote error" : "subnote";
}

function hideIfMissing(fieldKey){
  const wrapId = {
    region:"wrap-region", muni:"wrap-municipio", area:"wrap-area", guarda:"wrap-guarda",
    tipo:"wrap-tipo", ilegal:"wrap-ilegal", ubic:"wrap-ubicacion"
  }[fieldKey];
  if(!wrapId) return;
  const col = FIELD_MAP[fieldKey].col;
  if(!HEADERS.includes(col)){
    document.getElementById(wrapId).style.display = "none";
  }
}

/* =========================
   Carga CSV
========================= */
async function loadCSV(){
  const candidates = [
    "./datos_patrullaje.csv",
    "datos_patrullaje.csv",
    "./data/datos_patrullaje.csv",
    "data/datos_patrullaje.csv",
    "https://raw.githubusercontent.com/geograficaaala/guardarecursos_conap/main/datos_patrullaje.csv",
    "https://raw.githubusercontent.com/geograficaaala/guardarecursos_conap/master/datos_patrullaje.csv"
  ];

  let lastErr = null;
  for(const url of candidates){
    try{
      const buf = await fetchArrayBuffer(url);
      const text = decodeSmart(buf);
      const parsed = parseCSV(text);
      if(parsed.data.length){
        return { url, ...parsed };
      }
      lastErr = new Error("CSV vacío en " + url);
    } catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("No se pudo cargar el CSV.");
}

/* =========================
   Preparación de datos
========================= */
function enrichRows(data){
  // inferir dayFirst usando muestra
  const sampleDates = data.slice(0, 200).map(r => r["Fecha de patrullaje"]);
  dayFirst = inferDayFirst(sampleDates);

  const out = [];
  for(const r of data){
    const rr = {...r};

    // Fix común de typo observado: "Reginal" -> "Regional"
    if(rr["Region"] && canon(rr["Region"]) === "reginal"){
      rr["Region"] = "Regional";
    }

    // parse fecha patrullaje
    const dt = parseDateSmart(rr["Fecha de patrullaje"], dayFirst);
    rr.__dt = dt;
    rr.__anio = dt ? String(dt.getUTCFullYear()) : "";
    rr.__mes = dt ? monthKey(dt) : "";

    // canon por campo para filtros
    rr.__c_region = canon(rr["Region"]);
    rr.__c_muni = canon(rr["Municipio"]);
    rr.__c_area = canon(rr["Area protegida"]);
    rr.__c_guarda = canon(rr["Guarda recursos responsable"]);
    rr.__c_tipo = canon(rr["Tipo de patrullaje"]);
    rr.__c_ilegal = canon(rr["Actividad ilegal observada"]);
    rr.__c_ubic = canon(rr["Ubicacion"]);

    // coords
    const lon = parseFloat(String(rr["Longitud"] || "").replace(",", "."));
    const lat = parseFloat(String(rr["Latitud"] || "").replace(",", "."));
    rr.__lon = isFinite(lon) ? lon : null;
    rr.__lat = isFinite(lat) ? lat : null;

    out.push(rr);

    // labels bonitos
    if(rr.__c_region) LABELS.region.set(rr.__c_region, bestLabel(LABELS.region.get(rr.__c_region), rr["Region"]));
    if(rr.__c_muni) LABELS.muni.set(rr.__c_muni, bestLabel(LABELS.muni.get(rr.__c_muni), rr["Municipio"]));
    if(rr.__c_area) LABELS.area.set(rr.__c_area, bestLabel(LABELS.area.get(rr.__c_area), rr["Area protegida"]));
    if(rr.__c_guarda) LABELS.guarda.set(rr.__c_guarda, bestLabel(LABELS.guarda.get(rr.__c_guarda), rr["Guarda recursos responsable"]));
    if(rr.__c_tipo) LABELS.tipo.set(rr.__c_tipo, bestLabel(LABELS.tipo.get(rr.__c_tipo), rr["Tipo de patrullaje"]));
    if(rr.__c_ilegal) LABELS.ilegal.set(rr.__c_ilegal, bestLabel(LABELS.ilegal.get(rr.__c_ilegal), rr["Actividad ilegal observada"]));
    if(rr.__c_ubic) LABELS.ubic.set(rr.__c_ubic, bestLabel(LABELS.ubic.get(rr.__c_ubic), rr["Ubicacion"]));
  }
  return out;
}

function fillSelect(selectEl, options, placeholder="Todos"){
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  selectEl.appendChild(opt0);
  for(const {value,label} of options){
    const o = document.createElement("option");
    o.value = value;
    o.textContent = label;
    selectEl.appendChild(o);
  }
}

function initFilters(){
  // ocultar campos inexistentes
  hideIfMissing("region");
  hideIfMissing("muni");
  hideIfMissing("area");
  hideIfMissing("guarda");
  hideIfMissing("tipo");
  hideIfMissing("ilegal");
  hideIfMissing("ubic");

  // Año (desde filas con fecha)
  const years = Array.from(new Set(ROWS.map(r => r.__anio).filter(Boolean))).sort();
  fillSelect(document.getElementById("f-anio"), years.map(y => ({value:y, label:y})));

  // Mes (solo meses existentes)
  const months = Array.from(new Set(ROWS.map(r => r.__mes).filter(Boolean))).sort();
  fillSelect(document.getElementById("f-mes"), months.map(k => ({value:k, label:monthLabel(k)})));

  // Otros campos (canon->label)
  function optionsFromMap(map){
    const keys = Array.from(map.keys());
    // ordenar por etiqueta bonita
    keys.sort((a,b) => (map.get(a)||"").localeCompare(map.get(b)||"", "es", {sensitivity:"base"}));
    return keys.map(k => ({value:k, label: map.get(k)}));
  }
  fillSelect(document.getElementById("f-region"), optionsFromMap(LABELS.region));
  fillSelect(document.getElementById("f-municipio"), optionsFromMap(LABELS.muni));
  fillSelect(document.getElementById("f-area"), optionsFromMap(LABELS.area));
  fillSelect(document.getElementById("f-guarda"), optionsFromMap(LABELS.guarda));
  fillSelect(document.getElementById("f-tipo"), optionsFromMap(LABELS.tipo));
  fillSelect(document.getElementById("f-ilegal"), optionsFromMap(LABELS.ilegal));
  fillSelect(document.getElementById("f-ubicacion"), optionsFromMap(LABELS.ubic));
}

function getFilterState(){
  return {
    anio: document.getElementById("f-anio").value,
    mes: document.getElementById("f-mes").value,
    region: document.getElementById("f-region").value,
    muni: document.getElementById("f-municipio").value,
    area: document.getElementById("f-area").value,
    guarda: document.getElementById("f-guarda").value,
    tipo: document.getElementById("f-tipo").value,
    ilegal: document.getElementById("f-ilegal").value,
    ubic: document.getElementById("f-ubicacion").value,
    buscar: canon(document.getElementById("f-buscar").value)
  };
}

function matchesFilters(r, f){
  if(f.anio && r.__anio !== f.anio) return false;
  if(f.mes && r.__mes !== f.mes) return false;
  if(f.region && r.__c_region !== f.region) return false;
  if(f.muni && r.__c_muni !== f.muni) return false;
  if(f.area && r.__c_area !== f.area) return false;
  if(f.guarda && r.__c_guarda !== f.guarda) return false;
  if(f.tipo && r.__c_tipo !== f.tipo) return false;
  if(f.ilegal && r.__c_ilegal !== f.ilegal) return false;
  if(f.ubic && r.__c_ubic !== f.ubic) return false;
  if(f.buscar){
    const joined = canon(Object.values(r).join(" "));
    if(!joined.includes(f.buscar)) return false;
  }
  return true;
}

function renderChips(f){
  const chips = document.getElementById("chips-filtros");
  chips.innerHTML = "";
  const items = [];

  if(f.anio) items.push(["Año", f.anio]);
  if(f.mes) items.push(["Mes", monthLabel(f.mes)]);
  if(f.region) items.push(["Región", LABELS.region.get(f.region) || f.region]);
  if(f.muni) items.push(["Municipio", LABELS.muni.get(f.muni) || f.muni]);
  if(f.area) items.push(["Área", LABELS.area.get(f.area) || f.area]);
  if(f.guarda) items.push(["Guarda", LABELS.guarda.get(f.guarda) || f.guarda]);
  if(f.tipo) items.push(["Tipo", LABELS.tipo.get(f.tipo) || f.tipo]);
  if(f.ilegal) items.push(["Ilegal", LABELS.ilegal.get(f.ilegal) || f.ilegal]);
  if(f.ubic) items.push(["Ubicación", LABELS.ubic.get(f.ubic) || f.ubic]);
  if(f.buscar) items.push(["Buscar", document.getElementById("f-buscar").value]);

  for(const [k,v] of items){
    const s = document.createElement("span");
    s.className = "chip";
    s.textContent = k + ": " + v;
    chips.appendChild(s);
  }
}

/* =========================
   KPIs
========================= */
function fmtDate(dt){
  if(!dt) return "–";
  const y = dt.getUTCFullYear();
  const m = String(dt.getUTCMonth()+1).padStart(2,"0");
  const d = String(dt.getUTCDate()).padStart(2,"0");
  return d + "/" + m + "/" + y;
}
function updateKPIs(filtered){
  document.getElementById("kpi-registros").textContent = String(filtered.length);

  const dates = filtered.map(r => r.__dt).filter(Boolean).sort((a,b)=>a-b);
  const rango = dates.length ? (fmtDate(dates[0]) + " → " + fmtDate(dates[dates.length-1])) : "—";
  document.getElementById("kpi-rango").textContent = rango;

  const uniq = (arr) => new Set(arr.filter(Boolean)).size;
  document.getElementById("kpi-regiones").textContent = String(uniq(filtered.map(r => r.__c_region)));
  document.getElementById("kpi-municipios").textContent = String(uniq(filtered.map(r => r.__c_muni)));
  document.getElementById("kpi-areas").textContent = String(uniq(filtered.map(r => r.__c_area)));

  const pts = filtered.filter(r => r.__lat !== null && r.__lon !== null && r.__lat !== 0 && r.__lon !== 0 && inGuatemala(r.__lat, r.__lon));
  document.getElementById("kpi-coords").textContent = String(pts.length);
}

/* =========================
   Charts
========================= */
let CH_MES=null, CH_TIPO=null, CH_MUNI=null, CH_GUARDA=null;

function destroyChart(ch){
  if(ch){ try{ ch.destroy(); }catch(e){} }
}
function countByKey(rows, keyFn){
  const m = new Map();
  for(const r of rows){
    const k = keyFn(r);
    if(!k) continue;
    m.set(k, (m.get(k)||0) + 1);
  }
  return m;
}
function topN(map, n){
  const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
  return {labels: arr.map(x=>x[0]), values: arr.map(x=>x[1])};
}

function updateCharts(filtered){
  // por mes
  const mMes = countByKey(filtered, r => r.__mes);
  const keys = Array.from(mMes.keys()).sort();
  const labelsMes = keys.map(k => monthLabel(k));
  const valuesMes = keys.map(k => mMes.get(k));

  destroyChart(CH_MES);
  CH_MES = new Chart(document.getElementById("c-mes"), {
    type:"line",
    data:{ labels: labelsMes, datasets:[{ label:"Registros", data: valuesMes, tension:0.25 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  // por tipo (clic filtra)
  const mTipo = countByKey(filtered, r => r.__c_tipo);
  const tipoSorted = Array.from(mTipo.entries()).sort((a,b)=>b[1]-a[1]);
  const tipoLabels = tipoSorted.map(([k]) => LABELS.tipo.get(k) || k);
  const tipoValues = tipoSorted.map(([,v]) => v);

  destroyChart(CH_TIPO);
  CH_TIPO = new Chart(document.getElementById("c-tipo"), {
    type:"bar",
    data:{ labels: tipoLabels, datasets:[{ label:"Registros", data: tipoValues }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}},
      onClick:(evt, elements)=>{
        if(!elements || !elements.length) return;
        const idx = elements[0].index;
        const pickedLabel = tipoLabels[idx];
        // encontrar canon para esa etiqueta
        let pickedCanon = null;
        for(const [k,v] of LABELS.tipo.entries()){
          if(v === pickedLabel){ pickedCanon = k; break; }
        }
        if(!pickedCanon && tipoSorted[idx]) pickedCanon = tipoSorted[idx][0];
        if(pickedCanon){
          document.getElementById("f-tipo").value = pickedCanon;
          applyAll();
        }
      }
    }
  });

  // top municipio
  const mMuni = countByKey(filtered, r => r.__c_muni);
  const muniTop = topN(mMuni, 10);
  const muniLabels = muniTop.labels.map(k => LABELS.muni.get(k) || k);
  destroyChart(CH_MUNI);
  CH_MUNI = new Chart(document.getElementById("c-municipio"), {
    type:"bar",
    data:{ labels: muniLabels, datasets:[{ label:"Registros", data: muniTop.values }]},
    options:{ indexAxis:"y", responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}} }
  });

  // top guarda
  const mG = countByKey(filtered, r => r.__c_guarda);
  const gTop = topN(mG, 10);
  const gLabels = gTop.labels.map(k => LABELS.guarda.get(k) || k);
  destroyChart(CH_GUARDA);
  CH_GUARDA = new Chart(document.getElementById("c-guarda"), {
    type:"bar",
    data:{ labels: gLabels, datasets:[{ label:"Registros", data: gTop.values }]},
    options:{ indexAxis:"y", responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}} }
  });
}

/* =========================
   Mapa
========================= */
let MAP=null, LAYER=null;

function initMap(){
  MAP = L.map("map", {scrollWheelZoom:false});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "© OpenStreetMap"
  }).addTo(MAP);
  LAYER = L.layerGroup().addTo(MAP);

  // vista base Atitlán
  MAP.setView([14.69, -91.15], 10);
}

function updateMap(filtered){
  if(!MAP) initMap();
  LAYER.clearLayers();

  let kept=0, dropped=0;
  const latlngs = [];

  for(const r of filtered){
    const lat = r.__lat, lon = r.__lon;
    if(lat === null || lon === null){ dropped++; continue; }
    if(lat === 0 || lon === 0){ dropped++; continue; }
    if(!inGuatemala(lat, lon)){ dropped++; continue; }

    kept++;
    const ll = [lat, lon];
    latlngs.push(ll);

    const muni = LABELS.muni.get(r.__c_muni) || r["Municipio"] || "";
    const area = LABELS.area.get(r.__c_area) || r["Area protegida"] || "";
    const fecha = r.__dt ? fmtDate(r.__dt) : (r["Fecha de patrullaje"] || "");
    const tipo = LABELS.tipo.get(r.__c_tipo) || r["Tipo de patrullaje"] || "";

    L.circleMarker(ll, {radius:5, weight:1, fillOpacity:0.7})
      .bindPopup("<b>" + (muni || "Sin municipio") + "</b><br/>" +
                 (area ? (area + "<br/>") : "") +
                 (tipo ? (tipo + "<br/>") : "") +
                 (fecha ? ("<i>" + fecha + "</i>") : ""))
      .addTo(LAYER);
  }

  const note = document.getElementById("mapnote");
  note.textContent = "Puntos en Guatemala: " + kept + " · Ignorados (inválidos o fuera de Guatemala): " + dropped;

  if(latlngs.length){
    const b = L.latLngBounds(latlngs);
    MAP.fitBounds(b, {padding:[18,18], maxZoom:12});
  } else {
    MAP.setView([14.69, -91.15], 10);
  }
  setTimeout(()=>MAP.invalidateSize(true), 120);
}

/* =========================
   Aplicar todo
========================= */
function applyAll(){
  const f = getFilterState();
  renderChips(f);
  const filtered = ROWS.filter(r => matchesFilters(r, f));

  updateKPIs(filtered);
  updateCharts(filtered);
  updateMap(filtered);

  setEstado("Mostrando " + filtered.length + " de " + ROWS.length + " registros.");
}

function resetFilters(){
  document.getElementById("f-anio").value = "";
  document.getElementById("f-mes").value = "";
  document.getElementById("f-region").value = "";
  document.getElementById("f-municipio").value = "";
  document.getElementById("f-area").value = "";
  document.getElementById("f-guarda").value = "";
  document.getElementById("f-tipo").value = "";
  document.getElementById("f-ilegal").value = "";
  document.getElementById("f-ubicacion").value = "";
  document.getElementById("f-buscar").value = "";
  applyAll();
}

/* =========================
   PDF liviano
========================= */
function exportPDF(){
  const el = document.querySelector("main");
  const opt = {
    margin: 6,
    filename: "AC192_patrullajes_informe.pdf",
    image: { type: "jpeg", quality: 0.92 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  };
  if(window.html2pdf){
    window.html2pdf().set(opt).from(el).save();
  } else {
    alert("No se pudo cargar html2pdf.");
  }
}

/* =========================
   Inicio
========================= */
(async function(){
  try{
    const loaded = await loadCSV();
    RAW = loaded.data;
    HEADERS = loaded.headers;

    // enriquecer
    ROWS = enrichRows(RAW);

    initFilters();

    // listeners
    const ids = ["f-anio","f-mes","f-region","f-municipio","f-area","f-guarda","f-tipo","f-ilegal","f-ubicacion"];
    for(const id of ids){
      const el = document.getElementById(id);
      if(el) el.addEventListener("change", applyAll);
    }
    document.getElementById("f-buscar").addEventListener("input", ()=>{
      // debounce simple
      clearTimeout(window.__tBuscar);
      window.__tBuscar = setTimeout(applyAll, 180);
    });
    document.getElementById("btn-reset").addEventListener("click", resetFilters);
    document.getElementById("btn-pdf").addEventListener("click", exportPDF);

    applyAll();
  } catch(e){
    console.error(e);
    setEstado("Error al cargar datos: " + (e && e.message ? e.message : e), true);
  }
})();
</script>
</body>
</html>
