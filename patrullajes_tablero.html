<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC192 · Patrullajes - Tablero dinámico (CSV)</title>

  <!-- Tabulator local (repo) -->
  <link rel="stylesheet" href="tabulator.min.css">

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Leaflet (OSM) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --verde-header:#34d399;
      --verde-header-2:#60a5fa;

      --azul-boton:#2563eb;
      --azul-boton-hover:#1d4ed8;

      --gris-fondo:#f4f7fb;
      --texto-principal:#0f172a;
      --texto-secundario:#475569;
      --borde-suave: rgba(148,163,184,0.35);
      --card-radius:16px;

      --chart-grid: rgba(2,6,23,0.08);
      --chart-tick: rgba(15,23,42,0.85);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto-principal);
      background:
        radial-gradient(circle at 10% 15%, rgba(52,211,153,0.28) 0, transparent 55%),
        radial-gradient(circle at 90% 30%, rgba(96,165,250,0.25) 0, transparent 55%),
        radial-gradient(circle at 40% 95%, rgba(14,165,233,0.12) 0, transparent 60%),
        linear-gradient(180deg, #f7fbff 0%, var(--gris-fondo) 45%, #f2fbf7 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      background: linear-gradient(90deg, rgba(16,185,129,0.95), rgba(59,130,246,0.95));
      color:#fff;
      padding:14px 20px 18px;
      box-shadow:0 6px 24px rgba(15,23,42,.14);
      position:sticky; top:0; z-index:50;
    }
    .header-inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; flex-wrap:wrap;
    }
    .logo-group{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background-color: rgba(255,255,255,0.12);
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
    }
    .logo-group img{
      height:40px; max-width:130px; object-fit:contain;
      background-color:#fff; border-radius:999px; padding:4px 8px;
      box-shadow:0 2px 6px rgba(15,23,42,.18);
    }
    .title-group{ text-align:right; flex:1 1 260px;}
    .title-group h1{ margin:0 0 2px; font-size:22px; letter-spacing:.02em;}
    .title-group p{ margin:0; font-size:13px; opacity:.96; line-height:1.4;}

    main{
      max-width:1100px; width:100%;
      margin:16px auto 0;
      padding:0 20px 40px;
      flex:1 0 auto;
    }

    .page-header{ margin-bottom:10px; }
    .page-header h2{ margin:0 0 6px; font-size:20px;}
    .page-header p{ margin:2px 0; font-size:14px; color:var(--texto-secundario);}

    .pill{
      display:inline-block; margin-top:6px;
      padding:3px 10px; font-size:11px; border-radius:999px;
      background-color: rgba(37,99,235,0.08);
      color:#1d4ed8;
      border:1px solid rgba(191,219,254,0.9);
      text-transform:uppercase; letter-spacing:.08em;
    }

    .topnav{
      position: sticky;
      top: 82px;
      z-index: 40;
      margin: 12px 0 14px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:center;
      margin:0;
    }
    .tab{
      text-decoration:none;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(255,255,255,0.95);
      color:#0f172a;
      font-weight:750;
      font-size:13px;
    }
    .tab:hover{ background:#eef6ff; border-color:rgba(59,130,246,0.35); }
    .tab.active{
      background:var(--azul-boton);
      border-color:transparent;
      color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.16);
    }

    .nav-actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      margin-top:10px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; font-size:14px;
      border-radius:999px; text-decoration:none;
      cursor:pointer; border:1px solid transparent;
      font-weight:800;
      transition: background-color .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn-primary{
      background-color:var(--azul-boton); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }
    .btn-primary:hover{
      background-color:var(--azul-boton-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.16);
    }
    .btn-ghost{
      background-color:rgba(255,255,255,.95);
      color:#0f172a;
      border-color: rgba(148,163,184,0.45);
    }
    .btn-ghost:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,.10);
    }
    .btn-warn{
      background: rgba(16,185,129,0.95); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }
    .btn-warn:hover{
      background: rgba(5,150,105,0.98);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.14);
    }

    .card{
      background: rgba(255,255,255,0.92);
      border-radius:var(--card-radius);
      border:1px solid var(--borde-suave);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:16px;
      margin-bottom:14px;
      overflow:hidden;
      position:relative;
    }
    .card.soft{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.98));
    }

    .subnote{ margin:0; color:var(--texto-secundario); font-size:13px; }

    .infobox{
      border:1px solid rgba(59,130,246,.18);
      background: rgba(219,234,254,.40);
      border-radius:14px;
      padding:10px 12px;
      color:#0f172a;
      font-size:13px;
      margin-top:10px;
      text-align:center;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      justify-content:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,0.85);
      font-size:12px;
      font-weight:700;
      color:#0f172a;
    }
    .chip b{ font-weight:800; }

    .filters{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .field{ grid-column: span 3; min-width:160px; }
    .field.wide{ grid-column: span 4; }

    label{
      display:block; font-size:12px; color:var(--texto-secundario);
      font-weight:900; margin-bottom:6px;
    }
    select, input{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    input.small{
      padding:7px 10px;
      border-radius:12px;
      background: rgba(241,245,249,.7);
      margin-bottom:6px;
    }

    .kpis{
      display:grid; grid-template-columns:repeat(12,1fr); gap:12px;
    }
    .kpi{
      grid-column: span 2;
      border:1px solid rgba(148,163,184,0.35);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(248,250,252,.98));
      min-height:80px;
    }
    .kpi .t{ font-size:12px; color:var(--texto-secundario); font-weight:950;}
    .kpi .v{ font-size:18px; font-weight:950; margin-top:6px; }
    .kpi .s{ font-size:12px; color:var(--texto-secundario); margin-top:2px; }

    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-12{ grid-column:span 12; }
    .col-6{ grid-column:span 6; }

    .chartwrap{ height:240px; }
    .chartwrap.tall{ height:260px; }
    canvas{ width:100% !important; height:100% !important; }

    #map{
      width:100%;
      height:280px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.35);
      overflow:hidden;
      background:#fff;
    }

    .maprow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .mini-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .mini-btn{
      padding:7px 10px;
      font-size:13px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:800;
    }
    .mini-btn:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      box-shadow:0 3px 10px rgba(15,23,42,.10);
    }

    .tablewrap{ overflow-x:auto; }
    footer{
      text-align:center;
      font-size:12px;
      color:#64748b;
      padding:10px 20px 18px;
      border-top:1px solid rgba(148,163,184,0.25);
      background-color:rgba(248,250,252,.9);
      margin-top:auto;
    }

    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 10px 25px rgba(15,23,42,.30);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    @media (max-width: 980px){
      .field{ grid-column: span 12; min-width:unset; }
      .field.wide{ grid-column: span 12; }
      .kpi{ grid-column: span 6; }
      .col-6{ grid-column: span 12; }
      .title-group{ text-align:center; }
      .header-inner{ justify-content:center; }
      .topnav{ top: 116px; }
      .chartwrap{ height: 230px; }
      #map{ height: 250px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="logo-group">
        <img src="conap_logo.jpg" alt="Logo CONAP">
        <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
      </div>
      <div class="title-group">
        <h1>Centro de consulta de datos</h1>
        <p>Sistema de monitoreo de actividades</p>
        <p>CONAP – Dirección Regional Altiplano Central</p>
      </div>
    </div>
  </header>

  <main>
    <section class="page-header">
      <h2>AC192 · Patrullajes de control y vigilancia · Tablero dinámico</h2>
      <p>Este tablero se genera automáticamente desde los datos extraídos de la boleta AC 192 y permite filtrar, graficar y generar un informe PDF liviano.</p>
      <span class="pill">Tablero dinámico · CSV</span>
    </section>

    <section class="topnav" aria-label="Navegación y acciones del módulo">
      <nav class="tabs" aria-label="Navegación del módulo">
        <a class="tab" href="patrullajes_dashboard.html">Dashboard geográfico</a>
        <a class="tab active" href="patrullajes_tablero.html">Tablero dinámico</a>
        <a class="tab" href="patrullajes_datos.html">Tabla de datos</a>
      </nav>

      <div class="nav-actions">
        <a class="btn btn-ghost" href="index.html">Inicio</a>
        <button class="btn btn-ghost" id="btn-reset" type="button">Limpiar filtros</button>
        <button class="btn btn-warn" id="btn-pdf" type="button">Generar informe PDF (liviano)</button>
      </div>

      <div class="infobox">
        <b>Sugerencia:</b> haga clic sobre la serie temporal o sobre el gráfico de barras para filtrar.
        <div class="chips" id="chips-filtros" aria-label="Resumen de filtros"></div>
      </div>

      <p class="subnote" id="estado" style="margin-top:10px;">Cargando datos…</p>
    </section>

    <section class="card soft" id="card-filtros" aria-label="Filtros del tablero">
      <h3 style="margin:0 0 6px;">Filtros</h3>
      <p class="subnote">Los filtros se aplican a KPIs, gráficos, mapa y tabla. Si un filtro no aplica (campo inexistente), se oculta automáticamente.</p>

      <div class="filters" id="filters-grid">
        <div class="field" id="wrap-anio">
          <label for="f-anio">Año</label>
          <select id="f-anio"></select>
        </div>

        <div class="field" id="wrap-mes">
          <label for="f-mes">Mes</label>
          <select id="f-mes"></select>
        </div>

        <div class="field wide" id="wrap-region">
          <label for="f-region">Región</label>
          <select id="f-region"></select>
        </div>

        <div class="field wide" id="wrap-municipio">
          <label for="f-municipio">Municipio</label>
          <select id="f-municipio"></select>
        </div>

        <div class="field wide" id="wrap-area">
          <label for="f-area">Área protegida</label>
          <select id="f-area"></select>
        </div>

        <div class="field wide" id="wrap-guarda">
          <label for="f-guarda">Guardarrecursos responsable</label>
          <select id="f-guarda"></select>
        </div>

        <div class="field wide" id="wrap-tipo">
          <label for="f-tipo">Tipo de patrullaje</label>
          <select id="f-tipo"></select>
        </div>

        <div class="field wide" id="wrap-ilegal">
          <label for="f-ilegal">Actividad ilegal observada</label>
          <select id="f-ilegal"></select>
        </div>

        <div class="field wide" id="wrap-ubicacion">
          <label for="f-ubicacion">Ubicación</label>
          <select id="f-ubicacion"></select>
        </div>

        <div class="field" id="wrap-buscar">
          <label for="f-buscar">Buscar</label>
          <input id="f-buscar" type="text" placeholder="palabra clave (en cualquier campo)" />
        </div>
      </div>
    </section>

    <section class="card" aria-label="Indicadores">
      <h3 style="margin:0 0 10px;">Indicadores</h3>
      <div class="kpis">
        <div class="kpi"><div class="t">Registros</div><div class="v" id="kpi-registros">–</div><div class="s" id="kpi-registros-s">Total</div></div>
        <div class="kpi"><div class="t">Rango de fechas</div><div class="v" id="kpi-rango">–</div><div class="s">Según “Fecha de patrullaje”</div></div>
        <div class="kpi"><div class="t">Regiones</div><div class="v" id="kpi-regiones">–</div><div class="s">Únicas</div></div>
        <div class="kpi"><div class="t">Municipios</div><div class="v" id="kpi-municipios">–</div><div class="s">Únicos</div></div>
        <div class="kpi"><div class="t">Áreas protegidas</div><div class="v" id="kpi-areas">–</div><div class="s">Únicas</div></div>
        <div class="kpi"><div class="t">Con coordenadas</div><div class="v" id="kpi-coords">–</div><div class="s">Para el mapa</div></div>
      </div>
    </section>

    <section class="grid" aria-label="Gráficos">
      <div class="card col-6">
        <h3 style="margin:0 0 8px;">Serie temporal (registros)</h3>
        <div class="chartwrap tall"><canvas id="chart-tiempo"></canvas></div>
        <p class="subnote" id="note-tiempo">Clic en un punto para filtrar por mes.</p>
      </div>

      <div class="card col-6">
        <div class="maprow">
          <h3 style="margin:0;">Distribución por tipo</h3>
          <div class="mini-actions">
            <button class="mini-btn" id="btn-clear-chart" type="button">Quitar filtro gráfico</button>
          </div>
        </div>
        <div class="chartwrap tall"><canvas id="chart-tipo"></canvas></div>
        <p class="subnote">Clic en una barra para filtrar por categoría.</p>
      </div>
    </section>

    <section class="card" aria-label="Mapa">
      <div class="maprow">
        <h3 style="margin:0;">Mapa (si hay coordenadas)</h3>
        <div class="mini-actions">
          <button class="mini-btn" id="btn-centrar" type="button">Centrar</button>
          <button class="mini-btn" id="btn-geojson" type="button">Descargar GeoJSON</button>
        </div>
      </div>
      <div id="map"></div>
      <p class="subnote" id="map-note">Si el CSV no incluye coordenadas, el mapa se ocultará automáticamente.</p>
    </section>

    <section class="card" aria-label="Tabla de registros">
      <div class="maprow">
        <h3 style="margin:0;">Tabla (Tabulator)</h3>
        <div class="mini-actions">
          <button class="mini-btn" id="btn-csv" type="button">Descargar CSV</button>
          <button class="mini-btn" id="btn-xlsx" type="button">Descargar Excel</button>
        </div>
      </div>
      <div class="tablewrap"><div id="tabla"></div></div>
      <p class="subnote">Tip: use el buscador superior y el filtro por columna (en encabezados) para refinar aún más.</p>
    </section>
  </main>

  <footer>
    <p>© 2026 Laboratorio SIG AALA en apoyo a CONAP – Dirección Regional Altiplano Central</p>
  </footer>

  <div class="toast" id="toast">Listo</div>

  <!-- Librerías locales del repositorio -->
  <script src="papaparse.min.js"></script>
  <script src="tabulator.min.js"></script>
  <script src="xlsx.full.min.js"></script>
  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <script>
  (function () {
    // =============================
    // Configuración
    // =============================
    var CSV_CANDIDATES = [
      "datos_patrullaje.csv",
      "./datos_patrullaje.csv",
      "data/datos_patrullaje.csv",
      "./data/datos_patrullaje.csv"
    ];

    // Nombres esperados (se resuelven por coincidencia exacta o "fuzzy")
    var EXPECTED = {
      fecha:   { exact: ["Fecha de patrullaje","Fecha patrullaje","Fecha"], tokens: ["fecha","patrull"] },
      region:  { exact: ["Region","Región"], tokens: ["region"] },
      municipio:{ exact: ["Municipio"], tokens: ["municip"] },
      area:    { exact: ["Area protegida","Área protegida","Área Protegida","Area Protegida"], tokens: ["area","proteg"] },
      guarda:  { exact: ["Guarda recursos responsable","Guardarrecursos responsable","Guarda recurso responsable","Guarda recurso"], tokens: ["guarda","recurso"] },
      tipo:    { exact: ["Tipo de patrullaje","Tipo patrullaje","Tipo"], tokens: ["tipo","patrull"] },
      ilegal:  { exact: ["Actividad ilegal observada","Actividad ilegal"], tokens: ["actividad","ilegal"] },
      ubic:    { exact: ["Ubicacion","Ubicación","Ubicación (Lugar)","Lugar","Sitio"], tokens: ["ubic","lugar","sitio"] }
    };

    // =============================
    // Estado
    // =============================
    var rawData = [];
    var filteredData = [];
    var fields = {}; // {fecha, region, municipio, area, guarda, tipo, ilegal, ubic}
    var tabla = null;
    var chartTiempo = null;
    var chartTipo = null;
    var map = null;
    var markersLayer = null;

    // filtro extra por interacción con gráficos
    var chartFilter = { monthKey: null, tipoValue: null };

    // =============================
    // Helpers DOM
    // =============================
    function $(id){ return document.getElementById(id); }

    function showToast(msg){
      var t = $("toast");
      if(!t) return;
      t.textContent = msg || "Listo";
      t.classList.add("show");
      setTimeout(function(){ t.classList.remove("show"); }, 1700);
    }

    function setEstado(msg){
      var el = $("estado");
      if(el) el.textContent = msg;
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    // =============================
    // Carga de librerías con fallback (por si faltan archivos locales)
    // =============================
    function loadScript(url){
      return new Promise(function(resolve){
        var s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = function(){ resolve(true); };
        s.onerror = function(){ resolve(false); };
        document.head.appendChild(s);
      });
    }
    function loadCss(url){
      return new Promise(function(resolve){
        var l = document.createElement("link");
        l.rel = "stylesheet";
        l.href = url;
        l.onload = function(){ resolve(true); };
        l.onerror = function(){ resolve(false); };
        document.head.appendChild(l);
      });
    }

    async function ensureLibs(){
      // PapaParse
      if(!window.Papa){
        await loadScript("papaparse.min.js");
        if(!window.Papa){
          await loadScript("https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js");
        }
      }
      // Tabulator + CSS
      if(!window.Tabulator){
        await loadCss("tabulator.min.css"); // si existe local
        await loadScript("tabulator.min.js");
        if(!window.Tabulator){
          await loadCss("https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.6.2/css/tabulator.min.css");
          await loadScript("https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.6.2/js/tabulator.min.js");
        }
      }
      // XLSX
      if(!window.XLSX){
        await loadScript("xlsx.full.min.js");
        if(!window.XLSX){
          await loadScript("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js");
        }
      }
      // Chart.js (solo para gráficos; si no carga, degradamos)
      if(!window.Chart){
        await loadScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js");
      }
      // Leaflet (solo para mapa; si no carga, ocultamos mapa)
      if(!window.L){
        await loadCss("https://unpkg.com/leaflet@1.9.4/dist/leaflet.css");
        await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js");
      }
      return true;
    }

    // =============================
    // CSV: decodificación + delimitador
    // =============================
    function decodeSmartCsv(buffer){
      try{
        var u8 = new Uint8Array(buffer);
        var utf8 = new TextDecoder("utf-8", {fatal:false}).decode(u8);
        var win  = null;
        try{ win = new TextDecoder("windows-1252", {fatal:false}).decode(u8); }catch(e){ win = null; }

        function score(s){
          if(!s) return 999999;
          var bad = ["\uFFFD", "Ã", "Â", "â€™", "â€“", "â€œ", "â€"];
          var c = 0;
          for(var i=0;i<bad.length;i++){
            var b = bad[i];
            c += (s.split(b).length - 1);
          }
          return c;
        }

        if(win && score(win) < score(utf8)) return win;
        return utf8;
      }catch(e){
        try{ return new TextDecoder("utf-8").decode(new Uint8Array(buffer)); }catch(_){}
        return "";
      }
    }

    function detectarDelimitador(csvText){
      var lines = String(csvText || "").split(/\r?\n/).slice(0,5).join("\n");
      var sc = (lines.match(/;/g) || []).length;
      var cc = (lines.match(/,/g) || []).length;
      if(sc === 0 && cc === 0) return "";
      return (sc >= cc) ? ";" : ",";
    }

    async function fetchCsvFromCandidates(){
      var tried = [];
      for(var i=0;i<CSV_CANDIDATES.length;i++){
        var url = CSV_CANDIDATES[i];
        tried.push(url);
        try{
          var r = await fetch(url, {cache:"no-store"});
          if(!r.ok) continue;
          var buf = await r.arrayBuffer();
          var txt = decodeSmartCsv(buf);
          if(txt && txt.length > 20){
            return {url:url, text:txt};
          }
        }catch(e){
          // continuar probando
        }
      }
      throw new Error("No se pudo cargar el CSV. Probé: " + tried.join(", "));
    }

    // =============================
    // Normalización de encabezados / resolución de campos
    // =============================
    function norm(s){
      // lower + quitar acentos + espacios extras
      s = String(s || "").trim().toLowerCase();
      try{
        s = s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      }catch(e){}
      s = s.replace(/\s+/g," ").replace(/[^\w\s]/g,"");
      return s;
    }

    function resolveField(headers, spec){
      // 1) exact
      for(var i=0;i<spec.exact.length;i++){
        var ex = spec.exact[i];
        for(var j=0;j<headers.length;j++){
          if(headers[j] === ex) return headers[j];
        }
      }
      // 2) fuzzy por tokens
      var headersNorm = headers.map(norm);
      for(var h=0;h<headers.length;h++){
        var hn = headersNorm[h];
        var ok = true;
        for(var t=0;t<spec.tokens.length;t++){
          if(hn.indexOf(spec.tokens[t]) === -1){ ok = false; break; }
        }
        if(ok) return headers[h];
      }
      return null;
    }

    // =============================
    // Fechas
    // =============================
    function detectarFormatoFecha(fechaRaw){
      if(!fechaRaw) return null;
      var str = String(fechaRaw).trim();
      if(!str) return null;
      var parteFecha = str.split(" ")[0];
      var sep = parteFecha.indexOf("/") >= 0 ? "/" : (parteFecha.indexOf("-") >= 0 ? "-" : null);
      if(!sep) return null;

      var partes = parteFecha.split(sep);
      if(partes.length < 3) return null;

      var p1s = String(partes[0] || "").trim();
      var p2s = String(partes[1] || "").trim();
      var p3s = String(partes[2] || "").trim();
      var p1 = parseInt(p1s,10), p2 = parseInt(p2s,10), p3 = parseInt(p3s,10);
      if(!(isFinite(p1)&&isFinite(p2)&&isFinite(p3))) return null;

      if(p1s.length === 4) return "YMD";
      if(p1 > 12 && p2 <= 12) return "DMY";
      if(p2 > 12 && p1 <= 12) return "MDY";
      return null;
    }

    function prepararHintsFechas(data){
      var hints = [];
      for(var i=0;i<data.length;i++){
        var v = fields.fecha ? data[i][fields.fecha] : null;
        hints.push(detectarFormatoFecha(v));
      }

      var last = null;
      for(i=0;i<hints.length;i++){
        if(!hints[i]) hints[i] = last;
        else last = hints[i];
      }
      var next = null;
      for(i=hints.length-1;i>=0;i--){
        if(!hints[i]) hints[i] = next;
        else next = hints[i];
      }

      for(i=0;i<data.length;i++){
        data[i]._dateHint = hints[i] || null;
      }
    }

    function parseFecha(fechaRaw, hint){
      if(!fechaRaw) return null;
      var str = String(fechaRaw).trim();
      if(!str) return null;

      var parteFecha = str.split(" ")[0];
      var sep = parteFecha.indexOf("/") >= 0 ? "/" : (parteFecha.indexOf("-") >= 0 ? "-" : null);
      if(!sep) return null;

      var partes = parteFecha.split(sep);
      if(partes.length < 3) return null;

      var p1s = String(partes[0] || "").trim();
      var p2s = String(partes[1] || "").trim();
      var p3s = String(partes[2] || "").trim();

      var p1 = parseInt(p1s,10), p2 = parseInt(p2s,10), p3 = parseInt(p3s,10);
      if(!(isFinite(p1)&&isFinite(p2)&&isFinite(p3))) return null;

      var anio, mes, dia;

      if(hint === "YMD" || p1s.length === 4){
        anio = p1; mes = p2; dia = p3;
      }else if(hint === "DMY"){
        dia = p1; mes = p2; anio = p3;
      }else if(hint === "MDY"){
        mes = p1; dia = p2; anio = p3;
      }else{
        if(p1 > 12 && p2 <= 12){ dia = p1; mes = p2; anio = p3; }
        else { mes = p1; dia = p2; anio = p3; }
      }

      if(anio < 100) anio = anio + 2000;
      var dt = new Date(anio, mes-1, dia);
      if(dt && dt.getFullYear() === anio && (dt.getMonth()+1) === mes && dt.getDate() === dia) return dt;
      return null;
    }

    function monthKey(dt){
      var y = dt.getFullYear();
      var m = String(dt.getMonth()+1).padStart(2,"0");
      return y + "-" + m;
    }

    function monthLabel(key){
      // key "YYYY-MM"
      var parts = String(key || "").split("-");
      if(parts.length !== 2) return key;
      var y = parts[0], m = parseInt(parts[1],10);
      var meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      return meses[(m-1+12)%12] + " " + y;
    }

    // =============================
    // Coordenadas
    // =============================
    function detectCoordKeys(headers){
      var n = headers.map(norm);
      function findByIncludes(arr){
        for(var i=0;i<n.length;i++){
          for(var j=0;j<arr.length;j++){
            if(n[i].indexOf(arr[j]) !== -1) return headers[i];
          }
        }
        return null;
      }
      var lat = findByIncludes(["lat","latitude","y","coordy","coordenaday"]);
      var lon = findByIncludes(["lon","lng","long","longitude","x","coordx","coordenadax"]);
      return {latKey:lat, lonKey:lon};
    }

    function parseLatLonFromRow(r, coordKeys){
      // 1) columnas dedicadas
      var lat = null, lon = null;
      if(coordKeys && coordKeys.latKey && coordKeys.lonKey){
        var a = String(r[coordKeys.latKey] || "").replace(",",".").trim();
        var b = String(r[coordKeys.lonKey] || "").replace(",",".").trim();
        var la = parseFloat(a), lo = parseFloat(b);
        if(isFinite(la) && isFinite(lo)){
          // si parecen UTM (muy grandes), no mapear
          if(Math.abs(la) <= 90 && Math.abs(lo) <= 180){
            lat = la; lon = lo;
          }
        }
      }
      if(lat !== null && lon !== null) return {lat:lat, lon:lon};

      // 2) desde campo de ubicación tipo "14.55,-91.12"
      var uField = fields.ubic;
      if(uField){
        var u = String(r[uField] || "");
        var m = u.match(/(-?\d+(?:\.\d+)?)\s*[, ]\s*(-?\d+(?:\.\d+)?)/);
        if(m){
          var la2 = parseFloat(m[1]), lo2 = parseFloat(m[2]);
          if(isFinite(la2) && isFinite(lo2) && Math.abs(la2)<=90 && Math.abs(lo2)<=180){
            return {lat:la2, lon:lo2};
          }
        }
      }
      return null;
    }

    // =============================
    // Filtros
    // =============================
    function getValue(row, field){
      if(!field) return "";
      var v = row[field];
      if(v === undefined || v === null) return "";
      return String(v).trim();
    }

    function buildUniqueValues(data, field){
      var s = {};
      for(var i=0;i<data.length;i++){
        var v = getValue(data[i], field);
        if(v) s[v] = true;
      }
      return Object.keys(s).sort(function(a,b){ return a.localeCompare(b,"es",{sensitivity:"base"}); });
    }

    function setSelectOptions(sel, values){
      if(!sel) return;
      var current = sel.value || "";
      sel.innerHTML = "";
      var opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Todos";
      sel.appendChild(opt0);

      for(var i=0;i<values.length;i++){
        var o = document.createElement("option");
        o.value = values[i];
        o.textContent = values[i];
        sel.appendChild(o);
      }
      // restaurar selección si todavía existe
      sel.value = current;
      if(sel.value !== current) sel.value = "";
    }

    function hideWrap(idWrap, hide){
      var el = $(idWrap);
      if(!el) return;
      el.style.display = hide ? "none" : "";
    }

    function readFilters(){
      return {
        anio: $("f-anio") ? $("f-anio").value : "",
        mes: $("f-mes") ? $("f-mes").value : "",
        region: $("f-region") ? $("f-region").value : "",
        municipio: $("f-municipio") ? $("f-municipio").value : "",
        area: $("f-area") ? $("f-area").value : "",
        guarda: $("f-guarda") ? $("f-guarda").value : "",
        tipo: $("f-tipo") ? $("f-tipo").value : "",
        ilegal: $("f-ilegal") ? $("f-ilegal").value : "",
        ubic: $("f-ubicacion") ? $("f-ubicacion").value : "",
        buscar: $("f-buscar") ? $("f-buscar").value : ""
      };
    }

    function rowMatchesSearch(row, q, headers){
      if(!q) return true;
      q = String(q).toLowerCase();
      for(var i=0;i<headers.length;i++){
        var v = row[headers[i]];
        if(v === undefined || v === null) continue;
        if(String(v).toLowerCase().indexOf(q) !== -1) return true;
      }
      return false;
    }

    function applyFilters(){
      var f = readFilters();
      var headers = rawData.length ? Object.keys(rawData[0]) : [];

      filteredData = rawData.filter(function(r){
        // filtros por selects (solo si el campo existe)
        if(f.region && fields.region && getValue(r, fields.region) !== f.region) return false;
        if(f.municipio && fields.municipio && getValue(r, fields.municipio) !== f.municipio) return false;
        if(f.area && fields.area && getValue(r, fields.area) !== f.area) return false;
        if(f.guarda && fields.guarda && getValue(r, fields.guarda) !== f.guarda) return false;
        if(f.tipo && fields.tipo && getValue(r, fields.tipo) !== f.tipo) return false;
        if(f.ilegal && fields.ilegal && getValue(r, fields.ilegal) !== f.ilegal) return false;
        if(f.ubic && fields.ubic && getValue(r, fields.ubic) !== f.ubic) return false;

        // año/mes se basan en _dt
        if(f.anio){
          if(!r._dt || String(r._dt.getFullYear()) !== f.anio) return false;
        }
        if(f.mes){
          if(!r._dt || monthKey(r._dt) !== f.mes) return false;
        }

        // interacción con gráficos
        if(chartFilter.monthKey){
          if(!r._dt || monthKey(r._dt) !== chartFilter.monthKey) return false;
        }
        if(chartFilter.tipoValue){
          if(fields.tipo && getValue(r, fields.tipo) !== chartFilter.tipoValue) return false;
        }

        // búsqueda libre
        if(f.buscar && !rowMatchesSearch(r, f.buscar, headers)) return false;

        return true;
      });

      updateUI();
    }

    function resetAll(){
      if($("f-anio")) $("f-anio").value = "";
      if($("f-mes")) $("f-mes").value = "";
      if($("f-region")) $("f-region").value = "";
      if($("f-municipio")) $("f-municipio").value = "";
      if($("f-area")) $("f-area").value = "";
      if($("f-guarda")) $("f-guarda").value = "";
      if($("f-tipo")) $("f-tipo").value = "";
      if($("f-ilegal")) $("f-ilegal").value = "";
      if($("f-ubicacion")) $("f-ubicacion").value = "";
      if($("f-buscar")) $("f-buscar").value = "";
      chartFilter.monthKey = null;
      chartFilter.tipoValue = null;
      if($("btn-clear-chart")) $("btn-clear-chart").disabled = true;
      applyFilters();
      showToast("Filtros limpiados");
    }

    // =============================
    // KPIs + Chips
    // =============================
    function setKpi(id, val){
      var el = $(id);
      if(el) el.textContent = val;
    }

    function updateChips(){
      var box = $("chips-filtros");
      if(!box) return;
      box.innerHTML = "";
      var f = readFilters();
      var chips = [];

      function add(label, value){
        if(value) chips.push({label:label, value:value});
      }

      add("Año", f.anio);
      add("Mes", f.mes ? monthLabel(f.mes) : "");
      add("Región", f.region);
      add("Municipio", f.municipio);
      add("Área", f.area);
      add("Guardarrecursos", f.guarda);
      add("Tipo", f.tipo);
      add("Ilegal", f.ilegal);
      add("Ubicación", f.ubic);
      add("Buscar", f.buscar);

      if(chartFilter.monthKey) chips.push({label:"(Gráfico) Mes", value: monthLabel(chartFilter.monthKey)});
      if(chartFilter.tipoValue) chips.push({label:"(Gráfico) Tipo", value: chartFilter.tipoValue});

      if(!chips.length){
        var empty = document.createElement("span");
        empty.className = "chip";
        empty.textContent = "Sin filtros";
        box.appendChild(empty);
        return;
      }

      for(var i=0;i<chips.length;i++){
        var c = document.createElement("span");
        c.className = "chip";
        c.textContent = chips[i].label + ": " + chips[i].value;
        box.appendChild(c);
      }
    }

    function updateKpis(){
      setKpi("kpi-registros", filteredData.length);
      setKpi("kpi-registros-s", rawData.length);

      // rango de fechas
      var dts = filteredData.map(function(r){ return r._dt; }).filter(function(d){ return d instanceof Date; });
      dts.sort(function(a,b){ return a-b; });
      if(dts.length){
        var a = dts[0], b = dts[dts.length-1];
        var fmt = function(d){
          var dd = String(d.getDate()).padStart(2,"0");
          var mm = String(d.getMonth()+1).padStart(2,"0");
          var yy = d.getFullYear();
          return dd + "/" + mm + "/" + yy;
        };
        setKpi("kpi-rango", fmt(a) + " – " + fmt(b));
      }else{
        setKpi("kpi-rango", "—");
      }

      // únicos
      function uniqCount(field){
        if(!field) return "—";
        var s = {};
        for(var i=0;i<filteredData.length;i++){
          var v = getValue(filteredData[i], field);
          if(v) s[v] = true;
        }
        return Object.keys(s).length;
      }
      setKpi("kpi-regiones", uniqCount(fields.region));
      setKpi("kpi-municipios", uniqCount(fields.municipio));
      setKpi("kpi-areas", uniqCount(fields.area));

      // coords
      var withCoord = 0;
      for(i=0;i<filteredData.length;i++){
        if(filteredData[i]._ll) withCoord++;
      }
      setKpi("kpi-coords", withCoord);
    }

    // =============================
    // Charts
    // =============================
    function destroyChart(ch){
      try{ if(ch && ch.destroy) ch.destroy(); }catch(e){}
      return null;
    }

    function updateCharts(){
      // si Chart.js no está, ocultar canvas (pero el tablero sigue funcionando)
      var hasChart = !!window.Chart;
      if(!hasChart){
        if($("chart-tiempo")) $("chart-tiempo").style.display = "none";
        if($("chart-tipo")) $("chart-tipo").style.display = "none";
        if($("note-tiempo")) $("note-tiempo").textContent = "Gráficos deshabilitados (no cargó Chart.js).";
        return;
      }else{
        if($("chart-tiempo")) $("chart-tiempo").style.display = "";
        if($("chart-tipo")) $("chart-tipo").style.display = "";
      }

      // serie temporal por mes
      var series = {};
      for(var i=0;i<filteredData.length;i++){
        var r = filteredData[i];
        if(!r._dt) continue;
        var k = monthKey(r._dt);
        series[k] = (series[k] || 0) + 1;
      }
      var keys = Object.keys(series).sort();
      var labels = keys.map(monthLabel);
      var vals = keys.map(function(k){ return series[k]; });

      var ctxT = $("chart-tiempo") ? $("chart-tiempo").getContext("2d") : null;
      chartTiempo = destroyChart(chartTiempo);
      if(ctxT){
        chartTiempo = new Chart(ctxT, {
          type: "line",
          data: { labels: labels, datasets: [{ label: "Registros", data: vals, tension: 0.25, fill: false }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
            onClick: function(evt, elements){
              if(!elements || !elements.length) return;
              var idx = elements[0].index;
              var monthK = keys[idx];
              chartFilter.monthKey = monthK;
              if($("btn-clear-chart")) $("btn-clear-chart").disabled = false;
              applyFilters();
              showToast("Filtro gráfico: " + monthLabel(monthK));
            }
          }
        });
      }

      // barras por tipo
      var tipoCounts = {};
      if(fields.tipo){
        for(i=0;i<filteredData.length;i++){
          var tv = getValue(filteredData[i], fields.tipo) || "Sin dato";
          tipoCounts[tv] = (tipoCounts[tv] || 0) + 1;
        }
      }
      var tKeys = Object.keys(tipoCounts).sort(function(a,b){ return (tipoCounts[b]-tipoCounts[a]); }).slice(0, 25);
      var tVals = tKeys.map(function(k){ return tipoCounts[k]; });

      var ctxB = $("chart-tipo") ? $("chart-tipo").getContext("2d") : null;
      chartTipo = destroyChart(chartTipo);
      if(ctxB){
        chartTipo = new Chart(ctxB, {
          type: "bar",
          data: { labels: tKeys, datasets: [{ label: "Registros", data: tVals }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display:false } },
            scales: { y: { beginAtZero:true } },
            onClick: function(evt, elements){
              if(!elements || !elements.length) return;
              var idx2 = elements[0].index;
              var val = tKeys[idx2];
              chartFilter.tipoValue = val === "Sin dato" ? "" : val;
              if($("btn-clear-chart")) $("btn-clear-chart").disabled = false;
              applyFilters();
              showToast("Filtro gráfico: " + val);
            }
          }
        });
      }
    }

    function clearChartFilters(){
      chartFilter.monthKey = null;
      chartFilter.tipoValue = null;
      if($("btn-clear-chart")) $("btn-clear-chart").disabled = true;
      applyFilters();
      showToast("Filtro de gráficos quitado");
    }

    // =============================
    // Mapa
    // =============================
    function ensureMap(){
      if(!window.L){
        // sin Leaflet
        if($("map")) $("map").style.display = "none";
        if($("map-note")) $("map-note").textContent = "Mapa deshabilitado (no cargó Leaflet).";
        return false;
      }
      if(map) return true;

      map = L.map("map", { scrollWheelZoom: false });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
      map.setView([14.6, -90.5], 7); // Guatemala aprox.
      return true;
    }

    function updateMap(){
      var note = $("map-note");
      if(!filteredData.length){
        if(note) note.textContent = "Sin datos filtrados.";
      }
      if(!ensureMap()) return;

      markersLayer.clearLayers();

      // recolectar puntos
      var pts = [];
      for(var i=0;i<filteredData.length;i++){
        var r = filteredData[i];
        if(r._ll) pts.push(r);
      }

      if(!pts.length){
        if($("map")) $("map").style.display = "none";
        if(note) note.textContent = "Sin coordenadas válidas (lat/lon) en el filtro actual.";
        return;
      }

      if($("map")) $("map").style.display = "";
      if(note) note.textContent = "Mostrando " + Math.min(pts.length, 2500) + " puntos (máx. 2500).";

      var bounds = [];
      for(i=0;i<pts.slice(0,2500).length;i++){
        var rr = pts[i];
        var lat = rr._ll[0], lon = rr._ll[1];
        bounds.push([lat,lon]);

        var popup = "<b>" + escapeHtml(getValue(rr, fields.guarda) || "Patrullaje") + "</b><br/>" +
          "<b>Fecha:</b> " + escapeHtml(getValue(rr, fields.fecha)) + "<br/>" +
          "<b>Región:</b> " + escapeHtml(getValue(rr, fields.region)) + "<br/>" +
          "<b>Municipio:</b> " + escapeHtml(getValue(rr, fields.municipio)) + "<br/>" +
          "<b>Tipo:</b> " + escapeHtml(getValue(rr, fields.tipo)) + "<br/>";

        L.circleMarker([lat,lon], { radius:5, weight:1, fillOpacity:0.75 })
          .bindPopup(popup)
          .addTo(markersLayer);
      }

      try{
        var b = L.latLngBounds(bounds);
        map.fitBounds(b, {padding:[20,20]});
      }catch(e){}

      // botones
      var btnC = $("btn-centrar");
      if(btnC){
        btnC.onclick = function(){
          try{
            var b2 = L.latLngBounds(bounds);
            map.fitBounds(b2, {padding:[20,20]});
          }catch(e){}
        };
      }

      var btnG = $("btn-geojson");
      if(btnG){
        btnG.onclick = function(){
          var feats = pts.slice(0,2500).map(function(r){
            return {
              type:"Feature",
              geometry:{ type:"Point", coordinates:[r._ll[1], r._ll[0]] },
              properties:r
            };
          });
          var geo = { type:"FeatureCollection", features:feats };
          var blob = new Blob([JSON.stringify(geo)], {type:"application/geo+json"});
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "ac192_patrullajes_filtrado.geojson";
          a.click();
          URL.revokeObjectURL(a.href);
        };
      }
    }

    // =============================
    // Tabla
    // =============================
    function buildTable(){
      var container = $("tabla");
      if(!container) return;

      // preferir Tabulator, si existe
      if(window.Tabulator){
        var cols = [];
        if(filteredData.length){
          var keys = Object.keys(filteredData[0]).filter(function(k){ return k.indexOf("_") !== 0; });
          cols = keys.map(function(k){
            return { title: k, field: k, headerFilter: "input", headerFilterPlaceholder: "Filtrar…" };
          });
        }

        if(!tabla){
          tabla = new Tabulator("#tabla", {
            data: filteredData,
            layout: "fitDataStretch",
            height: 520,
            pagination: "local",
            paginationSize: 25,
            movableColumns: true,
            reactiveData: false,
            columns: cols.length ? cols : undefined
          });
        }else{
          try{
            tabla.setColumns(cols.length ? cols : tabla.getColumns());
          }catch(e){}
          tabla.replaceData(filteredData);
        }

        // downloads
        var bCsv = $("btn-csv");
        if(bCsv){
          bCsv.onclick = function(){
            tabla.download("csv", "ac192_patrullajes_filtrado.csv");
          };
        }
        var bXlsx = $("btn-xlsx");
        if(bXlsx){
          bXlsx.onclick = function(){
            tabla.download("xlsx", "ac192_patrullajes_filtrado.xlsx", {sheetName:"AC192"});
          };
        }
        return;
      }

      // fallback: tabla HTML simple
      container.innerHTML = "";
      var keys2 = filteredData.length ? Object.keys(filteredData[0]).filter(function(k){ return k.indexOf("_") !== 0; }) : [];
      if(!keys2.length){
        container.textContent = "No hay datos para mostrar.";
        return;
      }

      var table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";

      var thead = document.createElement("thead");
      var trh = document.createElement("tr");
      for(var i=0;i<keys2.length;i++){
        var th = document.createElement("th");
        th.textContent = keys2[i];
        th.style.textAlign = "left";
        th.style.borderBottom = "2px solid #cbd5e1";
        th.style.padding = "6px";
        trh.appendChild(th);
      }
      thead.appendChild(trh);
      table.appendChild(thead);

      var tbody = document.createElement("tbody");
      for(var r=0;r<Math.min(filteredData.length, 200);r++){
        var tr = document.createElement("tr");
        for(i=0;i<keys2.length;i++){
          var td = document.createElement("td");
          var vv = filteredData[r][keys2[i]];
          if(vv === undefined || vv === null) vv = "";
          td.textContent = String(vv);
          td.style.borderBottom = "1px solid #e2e8f0";
          td.style.padding = "6px";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.appendChild(table);

      // downloads fallback
      var bc = $("btn-csv");
      if(bc){
        bc.onclick = function(){
          var csv = keys2.join(",") + "\n";
          for(var rr=0;rr<filteredData.length;rr++){
            var row = filteredData[rr];
            var line = keys2.map(function(k){
              var val = row[k];
              if(val === undefined || val === null) val = "";
              val = String(val).replace(/"/g,'""');
              if(val.indexOf(",")>=0 || val.indexOf("\n")>=0) val = '"' + val + '"';
              return val;
            }).join(",");
            csv += line + "\n";
          }
          var blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "ac192_patrullajes_filtrado.csv";
          a.click();
          URL.revokeObjectURL(a.href);
        };
      }
      var bx = $("btn-xlsx");
      if(bx){
        bx.onclick = function(){
          if(!window.XLSX){
            alert("No se pudo exportar a Excel (no cargó XLSX).");
            return;
          }
          var ws = XLSX.utils.json_to_sheet(filteredData.map(function(r0){
            var o = {};
            for(var i2=0;i2<keys2.length;i2++){
              o[keys2[i2]] = r0[keys2[i2]];
            }
            return o;
          }));
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "AC192");
          XLSX.writeFile(wb, "ac192_patrullajes_filtrado.xlsx");
        };
      }
    }

    // =============================
    // PDF liviano
    // =============================
    function generarPdfLiviano(){
      // si no existe html2pdf, usar print
      if(!window.html2pdf){
        window.print();
        return;
      }

      var f = readFilters();
      var resumen = "Registros: " + filteredData.length + " / " + rawData.length;
      var chips = $("chips-filtros") ? $("chips-filtros").innerText : "";

      var div = document.createElement("div");
      div.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
      div.style.padding = "10px 12px";
      div.innerHTML =
        "<h2 style='margin:0 0 6px 0'>AC192 · Patrullajes</h2>" +
        "<div style='margin:0 0 10px 0; color:#334155'>" + escapeHtml(resumen) + "</div>" +
        "<div style='margin:0 0 12px 0; color:#475569; font-size:12px'>" + escapeHtml(chips) + "</div>";

      // incluir una tablita con primeras filas (liviano)
      var keys = filteredData.length ? Object.keys(filteredData[0]).filter(function(k){ return k.indexOf("_") !== 0; }) : [];
      var small = filteredData.slice(0, 40).map(function(r){ 
        var o = {};
        for(var i=0;i<Math.min(keys.length, 12);i++){ o[keys[i]] = r[keys[i]]; }
        return o;
      });

      if(window.XLSX){
        // no necesario
      }

      var table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.fontSize = "10px";

      var thead = document.createElement("thead");
      var trh = document.createElement("tr");
      for(var i=0;i<Math.min(keys.length, 12);i++){
        var th = document.createElement("th");
        th.textContent = keys[i];
        th.style.textAlign = "left";
        th.style.borderBottom = "2px solid #0f172a";
        th.style.padding = "3px";
        trh.appendChild(th);
      }
      thead.appendChild(trh);
      table.appendChild(thead);

      var tbody = document.createElement("tbody");
      for(var r=0;r<small.length;r++){
        var tr = document.createElement("tr");
        for(i=0;i<Math.min(keys.length,12);i++){
          var td = document.createElement("td");
          var v = small[r][keys[i]];
          if(v === undefined || v === null) v = "";
          td.textContent = String(v);
          td.style.borderBottom = "1px solid #cbd5e1";
          td.style.padding = "3px";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      div.appendChild(table);

      var opt = {
        margin: 8,
        filename: "ac192_patrullajes_informe_liviano.pdf",
        image: { type: "jpeg", quality: 0.92 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };
      html2pdf().set(opt).from(div).save();
    }

    // =============================
    // UI update global
    // =============================
    function updateUI(){
      updateChips();
      updateKpis();
      updateCharts();
      updateMap();
      buildTable();

      setEstado("Mostrando " + filteredData.length + " de " + rawData.length + " registros.");
    }

    // =============================
    // Inicialización
    // =============================
    function wireEvents(){
      var ids = ["f-anio","f-mes","f-region","f-municipio","f-area","f-guarda","f-tipo","f-ilegal","f-ubicacion"];
      for(var i=0;i<ids.length;i++){
        var el = $(ids[i]);
        if(el) el.addEventListener("change", applyFilters);
      }
      if($("f-buscar")) $("f-buscar").addEventListener("input", function(){ 
        // debounce simple
        clearTimeout(window.__ac192deb); 
        window.__ac192deb = setTimeout(applyFilters, 120);
      });

      if($("btn-reset")) $("btn-reset").addEventListener("click", resetAll);
      if($("btn-pdf")) $("btn-pdf").addEventListener("click", generarPdfLiviano);
      if($("btn-clear-chart")) $("btn-clear-chart").addEventListener("click", clearChartFilters);
    }

    async function loadData(){
      try{
        setEstado("Cargando librerías…");
        await ensureLibs();

        setEstado("Cargando datos…");
        var res = await fetchCsvFromCandidates();
        var csvText = res.text;

        if(!window.Papa) throw new Error("No se pudo cargar PapaParse (CSV).");

        var delim = detectarDelimitador(csvText);
        var parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          delimiter: delim || undefined
        });
        if(parsed.errors && parsed.errors.length){
          // no abortar, pero mostrar primer error
          console.warn(parsed.errors[0]);
        }
        rawData = parsed.data || [];
        if(!rawData.length){
          throw new Error("El CSV se cargó pero no hay filas. Revise delimitador/cabeceras.");
        }

        // Resolver campos
        var headers = Object.keys(rawData[0]);
        fields.fecha = resolveField(headers, EXPECTED.fecha);
        fields.region = resolveField(headers, EXPECTED.region);
        fields.municipio = resolveField(headers, EXPECTED.municipio);
        fields.area = resolveField(headers, EXPECTED.area);
        fields.guarda = resolveField(headers, EXPECTED.guarda);
        fields.tipo = resolveField(headers, EXPECTED.tipo);
        fields.ilegal = resolveField(headers, EXPECTED.ilegal);
        fields.ubic = resolveField(headers, EXPECTED.ubic);

        // Ocultar filtros que no aplican
        hideWrap("wrap-region", !fields.region);
        hideWrap("wrap-municipio", !fields.municipio);
        hideWrap("wrap-area", !fields.area);
        hideWrap("wrap-guarda", !fields.guarda);
        hideWrap("wrap-tipo", !fields.tipo);
        hideWrap("wrap-ilegal", !fields.ilegal);
        hideWrap("wrap-ubicacion", !fields.ubic);

        // Fechas + coordenadas
        prepararHintsFechas(rawData);
        var coordKeys = detectCoordKeys(headers);

        for(var i=0;i<rawData.length;i++){
          var r = rawData[i];

          // fecha
          var dt = null;
          if(fields.fecha){
            dt = parseFecha(r[fields.fecha], r._dateHint);
          }
          r._dt = dt;

          // coords
          var ll = parseLatLonFromRow(r, coordKeys);
          r._ll = ll ? [ll.lat, ll.lon] : null;
        }

        // Opciones de filtros (año/mes)
        var years = {};
        var months = {};
        for(i=0;i<rawData.length;i++){
          var d = rawData[i]._dt;
          if(d){
            years[String(d.getFullYear())] = true;
            months[monthKey(d)] = true;
          }
        }
        var yList = Object.keys(years).sort();
        var mList = Object.keys(months).sort();

        setSelectOptions($("f-anio"), yList);
        setSelectOptions($("f-mes"), mList);

        // selects por campos
        if(fields.region) setSelectOptions($("f-region"), buildUniqueValues(rawData, fields.region));
        if(fields.municipio) setSelectOptions($("f-municipio"), buildUniqueValues(rawData, fields.municipio));
        if(fields.area) setSelectOptions($("f-area"), buildUniqueValues(rawData, fields.area));
        if(fields.guarda) setSelectOptions($("f-guarda"), buildUniqueValues(rawData, fields.guarda));
        if(fields.tipo) setSelectOptions($("f-tipo"), buildUniqueValues(rawData, fields.tipo));
        if(fields.ilegal) setSelectOptions($("f-ilegal"), buildUniqueValues(rawData, fields.ilegal));
        if(fields.ubic){
          var vals = buildUniqueValues(rawData, fields.ubic);
          // si es demasiado largo, ocultarlo (queda la búsqueda libre)
          if(vals.length > 250){
            hideWrap("wrap-ubicacion", true);
          }else{
            setSelectOptions($("f-ubicacion"), vals);
          }
        }

        wireEvents();
        if($("btn-clear-chart")) $("btn-clear-chart").disabled = true;

        // primer render
        filteredData = rawData.slice();
        updateUI();
        showToast("Datos cargados");
      }catch(e){
        console.error(e);
        setEstado("Error: " + e.message);
        alert("Error al cargar el tablero AC192: " + e.message + "\n\nSugerencia: verifique que datos_patrullaje.csv y las librerías (papaparse/tabulator/xlsx) estén en la misma carpeta, o que el navegador tenga acceso a CDNs.");
      }
    }

    document.addEventListener("DOMContentLoaded", loadData);
  })();
  </script>

</body>
</html>
