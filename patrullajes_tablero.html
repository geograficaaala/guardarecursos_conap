<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC192 · Patrullajes - Tablero dinámico (CSV)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Leaflet (OSM) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --verde-header:#34d399;
      --verde-header-2:#60a5fa;
      --azul-boton:#2563eb;
      --azul-boton-hover:#1d4ed8;

      --gris-fondo:#f4f7fb;
      --texto-principal:#0f172a;
      --texto-secundario:#475569;
      --borde-suave: rgba(148,163,184,0.35);
      --card-radius:16px;
      --shadow: 0 10px 30px rgba(15,23,42,0.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto-principal);
      background:
        radial-gradient(circle at 10% 15%, rgba(52,211,153,0.28) 0, transparent 55%),
        radial-gradient(circle at 90% 30%, rgba(96,165,250,0.25) 0, transparent 55%),
        linear-gradient(180deg, #f8fbff 0%, #ffffff 40%, #f4f7fb 100%);
      min-height:100vh;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(90deg, rgba(52,211,153,0.95), rgba(96,165,250,0.95));
      color:white;
      box-shadow: 0 6px 22px rgba(15,23,42,0.18);
    }
    .header-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .logo-group{display:flex; gap:10px; align-items:center;}
    .logo-group img{height:46px; width:auto; border-radius:10px; background:white; padding:6px; box-shadow: 0 6px 18px rgba(15,23,42,0.18);}
    .title-group h1{margin:0; font-size:18px; letter-spacing:.2px;}
    .title-group p{margin:2px 0 0; font-size:12px; opacity:.95;}

    main{max-width:1200px; margin:0 auto; padding: 16px 14px 40px;}

    .page-header{
      padding: 14px 14px 10px;
      background: rgba(255,255,255,0.92);
      border:1px solid var(--borde-suave);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .page-header h2{margin:0 0 6px; font-size:20px;}
    .page-header p{margin:0 0 8px; color:var(--texto-secundario); line-height:1.35;}
    .pill{
      display:inline-block;
      padding:6px 10px;
      font-size:11px;
      font-weight:800;
      border-radius:999px;
      background:#e0f2fe;
      color:#1d4ed8;
      border:1px solid rgba(191,219,254,0.9);
      text-transform:uppercase; letter-spacing:.08em;
    }

    .topnav{
      position: sticky;
      top: 82px;
      z-index: 40;
      margin: 12px 0 14px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }
    .tabs{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:0;}
    .tab{
      text-decoration:none;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(255,255,255,0.95);
      color:#0f172a;
      font-weight:750;
      font-size:13px;
    }
    .tab:hover{ background:#eef6ff; border-color:rgba(59,130,246,0.35); }
    .tab.active{
      background: linear-gradient(90deg, rgba(52,211,153,0.18), rgba(96,165,250,0.18));
      border-color: rgba(59,130,246,0.35);
    }

    .nav-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .btn{
      border:0;
      cursor:pointer;
      padding:10px 12px;
      border-radius: 12px;
      font-weight:800;
      font-size:13px;
      transition: transform .06s ease, background .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--azul-boton); color:white; }
    .btn-primary:hover{ background: var(--azul-boton-hover); }
    .btn-ghost{ background: rgba(15,23,42,0.06); color:#0f172a; border:1px solid rgba(148,163,184,0.35); }
    .btn-ghost:hover{ background: rgba(15,23,42,0.09); }
    .btn-warn{ background: rgba(234,179,8,0.18); color:#713f12; border:1px solid rgba(234,179,8,0.35); }
    .btn-warn:hover{ background: rgba(234,179,8,0.26); }

    .infobox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(59,130,246,0.45);
      background: rgba(239,246,255,0.78);
      color:#0f172a;
      font-size:13px;
      line-height:1.35;
    }

    .grid{display:grid; gap:12px;}
    .grid-2{grid-template-columns: repeat(2, minmax(0,1fr));}
    .grid-3{grid-template-columns: repeat(3, minmax(0,1fr));}
    .grid-4{grid-template-columns: repeat(4, minmax(0,1fr));}
    @media (max-width: 980px){
      .grid-4{grid-template-columns: repeat(2, minmax(0,1fr));}
      .grid-3{grid-template-columns: repeat(1, minmax(0,1fr));}
      .grid-2{grid-template-columns: repeat(1, minmax(0,1fr));}
    }

    .card{
      background: rgba(255,255,255,0.94);
      border:1px solid var(--borde-suave);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 12px 12px;
      backdrop-filter: blur(8px);
    }
    .card h3{margin:0 0 8px; font-size:15px;}
    .muted{color:var(--texto-secundario);}
    .status{
      font-size:12px;
      color: var(--texto-secundario);
    }
    .error{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(239,68,68,0.10);
      border:1px solid rgba(239,68,68,0.25);
      color:#7f1d1d;
      display:none;
      white-space: pre-wrap;
      font-size:13px;
      line-height:1.35;
    }
    .ok{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(34,197,94,0.10);
      border:1px solid rgba(34,197,94,0.25);
      color:#14532d;
      display:none;
      white-space: pre-wrap;
      font-size:13px;
      line-height:1.35;
    }

    label{font-size:12px; font-weight:800; color:#0f172a; display:block; margin-bottom:6px;}
    select, input[type="text"]{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,0.45);
      background:white;
      font-size:13px;
      outline:none;
    }
    select:focus, input[type="text"]:focus{border-color: rgba(37,99,235,0.55); box-shadow:0 0 0 4px rgba(37,99,235,0.12);}

    .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .kpi{
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,0.30);
      background: rgba(248,250,252,0.80);
    }
    .kpi .num{font-size:22px; font-weight:900; line-height:1.1;}
    .kpi .lab{font-size:12px; color:var(--texto-secundario); font-weight:800; margin-top:3px;}

    .chartbox{height:320px;}
    canvas{max-width:100%;}
    #map{height: 380px; border-radius: 14px; border:1px solid rgba(148,163,184,0.35);}

    .tablewrap{
      border:1px solid rgba(148,163,184,0.35);
      border-radius: 14px;
      overflow:auto;
      background:white;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      min-width: 980px;
    }
    thead th{
      position: sticky;
      top: 0;
      background: #f8fafc;
      border-bottom:1px solid rgba(148,163,184,0.45);
      padding:10px 10px;
      text-align:left;
      font-weight:900;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    tbody td{
      border-bottom:1px solid rgba(148,163,184,0.20);
      padding:9px 10px;
      vertical-align: top;
      white-space:nowrap;
    }
    tbody tr:hover{background:#f8fbff;}
    .th-sort{
      display:inline-flex; gap:6px; align-items:center;
    }
    .sort-ind{font-size:12px; opacity:.7;}

    .pager{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .pager-left{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .small{font-size:12px; color:var(--texto-secundario);}

    footer{
      margin-top: 18px;
      padding: 20px 8px 10px;
      text-align:center;
      color: rgba(15,23,42,0.6);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="logo-group">
        <img src="conap_logo.jpg" alt="Logo CONAP">
        <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
      </div>
      <div class="title-group">
        <h1>Centro de consulta de datos</h1>
        <p>Sistema de monitoreo de actividades</p>
        <p>CONAP – Dirección Regional Altiplano Central</p>
      </div>
    </div>
  </header>

  <main>
    <section class="page-header">
      <h2>AC192 · Patrullajes de control y vigilancia · Tablero dinámico</h2>
      <p>Este tablero se genera automáticamente desde el CSV <b>datos_patrullaje.csv</b>. Incluye filtros homogéneos, gráficos y mapa. (Sin Tabulator)</p>
      <span class="pill">Tablero dinámico · CSV</span>
    </section>

    <section class="topnav" aria-label="Navegación y acciones del módulo">
      <nav class="tabs" aria-label="Navegación del módulo">
        <a class="tab" href="patrullajes_dashboard.html">Dashboard geográfico</a>
        <a class="tab active" href="patrullajes_tablero.html">Tablero dinámico</a>
        <a class="tab" href="patrullajes_datos.html">Tabla de datos</a>
      </nav>

      <div class="nav-actions">
        <a class="btn btn-ghost" href="index.html">Inicio</a>
        <button class="btn btn-ghost" id="btn-reset" type="button">Limpiar filtros</button>
        <button class="btn btn-primary" id="btn-csv" type="button">Descargar CSV filtrado</button>
        <button class="btn btn-warn" id="btn-xlsx" type="button">Descargar Excel filtrado</button>
        <button class="btn btn-ghost" id="btn-print" type="button">Imprimir / PDF</button>
      </div>

      <div class="infobox">
        <b>Tip:</b> los filtros eliminan duplicados (acentos, mayúsculas y espacios). El mapa ignora coordenadas inválidas (0/0) o fuera de rango para Guatemala.
      </div>

      <div class="status" id="status">Cargando datos…</div>
      <div class="error" id="errorBox"></div>
      <div class="ok" id="okBox"></div>
    </section>

    <section class="grid grid-1">
      <div class="card">
        <h3>Filtros</h3>
        <div class="grid grid-4">
          <div>
            <label for="fYear">Año</label>
            <select id="fYear"><option value="">Todos</option></select>
          </div>
          <div>
            <label for="fMonth">Mes</label>
            <select id="fMonth"><option value="">Todos</option></select>
          </div>
          <div>
            <label for="fRegion">Región</label>
            <select id="fRegion"><option value="">Todas</option></select>
          </div>
          <div>
            <label for="fMunicipio">Municipio</label>
            <select id="fMunicipio"><option value="">Todos</option></select>
          </div>
        </div>

        <div class="grid grid-4" style="margin-top:10px;">
          <div>
            <label for="fArea">Área protegida</label>
            <select id="fArea"><option value="">Todas</option></select>
          </div>
          <div>
            <label for="fGuarda">Guardarrecursos responsable</label>
            <select id="fGuarda"><option value="">Todos</option></select>
          </div>
          <div>
            <label for="fTipo">Tipo de patrullaje</label>
            <select id="fTipo"><option value="">Todos</option></select>
          </div>
          <div>
            <label for="fActividad">Actividad ilegal observada</label>
            <select id="fActividad"><option value="">Todas</option></select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="fSearch">Buscar (en todos los campos)</label>
          <input id="fSearch" type="text" placeholder="Ej. Santiago Atitlán, RUMCLA, control y vigilancia…">
        </div>
      </div>

      <div class="card">
        <h3>Resumen</h3>
        <div class="kpis">
          <div class="kpi"><div class="num" id="kpiReg">0</div><div class="lab">Registros</div></div>
          <div class="kpi"><div class="num" id="kpiMun">0</div><div class="lab">Municipios (únicos)</div></div>
          <div class="kpi"><div class="num" id="kpiGuar">0</div><div class="lab">Guardarrecursos (únicos)</div></div>
          <div class="kpi"><div class="num" id="kpiMes">0</div><div class="lab">Meses con datos</div></div>
        </div>
        <div class="small" style="margin-top:8px;" id="countLabel">Mostrando 0 de 0 registros</div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h3>Registros por mes</h3>
          <div class="chartbox"><canvas id="chMes"></canvas></div>
        </div>
        <div class="card">
          <h3>Patrullajes por tipo (Top)</h3>
          <div class="chartbox"><canvas id="chTipo"></canvas></div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h3>Registros por municipio (Top 10)</h3>
          <div class="chartbox"><canvas id="chMun"></canvas></div>
        </div>
        <div class="card">
          <h3>Mapa de ubicaciones</h3>
          <div id="map"></div>
          <div class="small" style="margin-top:8px;" id="mapNote"></div>
        </div>
      </div>

      <div class="card">
        <h3>Registros (tabla simple)</h3>
        <div class="tablewrap">
          <table id="tbl">
            <thead><tr id="tblHead"></tr></thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>

        <div class="pager">
          <div class="pager-left">
            <button class="btn btn-ghost" id="btnPrev" type="button">← Anterior</button>
            <button class="btn btn-ghost" id="btnNext" type="button">Siguiente →</button>
            <span class="small" id="pageInfo">Página 1/1</span>
          </div>
          <div class="pager-left">
            <span class="small">Filas por página</span>
            <select id="pageSize" style="width:130px; padding:8px 10px;">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="small" id="sortInfo"></span>
          </div>
        </div>
      </div>
    </section>

    <footer>
      © 2026 · Laboratorio SIG AALA · CONAP · AC192 Patrullajes
    </footer>
  </main>

<script>
(function(){
  // ========= Utilidades (texto/normalización) =========
  function normText(v){
    if(v === null || v === undefined) return "";
    var s = String(v).trim();
    s = s.replace(/\s+/g, " ");
    // quitar acentos
    try{
      s = s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"");
    }catch(e){}
    return s.toLowerCase();
  }
  function cleanSpaces(v){
    if(v === null || v === undefined) return "";
    return String(v).replace(/\s+/g," ").trim();
  }
  function toNumber(v){
    if(v === null || v === undefined) return NaN;
    var s = String(v).trim().replace(",", ".");
    if(!s) return NaN;
    var n = parseFloat(s);
    return isFinite(n) ? n : NaN;
  }

  // ========= Carga de scripts (PapaParse / XLSX) =========
  function loadScriptSequential(urls){
    return new Promise(function(resolve, reject){
      var i = 0;
      function tryNext(){
        if(i >= urls.length) return reject(new Error("No se pudo cargar ninguna librería: " + urls.join(", ")));
        var url = urls[i++];
        var s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = function(){ resolve(url); };
        s.onerror = function(){ tryNext(); };
        document.head.appendChild(s);
      }
      tryNext();
    });
  }

  // ========= Carga y decodificación del CSV =========
  var CSV_NAME = "datos_patrullaje.csv";
  var RAW_FALLBACK = "https://raw.githubusercontent.com/geograficaaala/guardarecursos_conap/main/" + CSV_NAME;

  var PATHS = [
    "./" + CSV_NAME,
    CSV_NAME,
    "./data/" + CSV_NAME,
    "data/" + CSV_NAME,
    RAW_FALLBACK
  ];

  async function fetchArrayBufferAny(paths){
    var lastErr = null;
    for(var i=0;i<paths.length;i++){
      var p = paths[i];
      try{
        var res = await fetch(p, {cache:"no-store"});
        if(!res.ok) throw new Error("HTTP " + res.status + " al cargar " + p);
        return {buf: await res.arrayBuffer(), used:p};
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("No se pudo cargar el CSV.");
  }

  function decodeSmart(buf){
    // Intento UTF-8 primero, si hay muchos reemplazos, usar Windows-1252
    var utf8 = new TextDecoder("utf-8", {fatal:false}).decode(buf);
    var bad = (utf8.match(/�/g) || []).length;
    if(bad > 0){
      try{
        return new TextDecoder("windows-1252", {fatal:false}).decode(buf);
      }catch(e){
        return utf8;
      }
    }
    return utf8;
  }

  // ========= Parser CSV =========
  function parseWithPapa(text){
    return new Promise(function(resolve, reject){
      try{
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: function(r){ resolve(r.data || []); },
          error: function(err){ reject(err); }
        });
      }catch(e){
        reject(e);
      }
    });
  }

  function detectDelimiter(text){
    var line = (text.split(/\r?\n/).find(function(l){ return l && l.indexOf(";")>-1 || l.indexOf(",")>-1; }) || "");
    var semi = (line.match(/;/g) || []).length;
    var comma = (line.match(/,/g) || []).length;
    return semi >= comma ? ";" : ",";
  }

  function parseSimpleCSV(text){
    // Parser simple (sin comillas complejas). Sirve como fallback.
    var delim = detectDelimiter(text);
    var lines = text.split(/\r?\n/).filter(function(l){return l.trim().length>0;});
    if(lines.length < 2) return [];
    var headers = lines[0].split(delim).map(function(h){return h.trim();});
    var out = [];
    for(var i=1;i<lines.length;i++){
      var parts = lines[i].split(delim);
      var row = {};
      for(var j=0;j<headers.length;j++){
        row[headers[j]] = parts[j] !== undefined ? parts[j].trim() : "";
      }
      out.push(row);
    }
    return out;
  }

  // ========= Fechas =========
  function inferDayFirst(rows, field){
    var dayFirstScore = 0;
    var monthFirstScore = 0;
    for(var i=0;i<Math.min(rows.length, 250);i++){
      var v = cleanSpaces(rows[i][field]);
      if(!v) continue;
      var m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(!m) continue;
      var a = parseInt(m[1],10), b = parseInt(m[2],10);
      if(a>12) dayFirstScore++;
      else if(b>12) monthFirstScore++;
    }
    return dayFirstScore >= monthFirstScore; // prefer dayfirst si empata
  }

  function parseDateSmart(v, preferDayFirst){
    v = cleanSpaces(v);
    if(!v) return null;

    // YYYY-MM-DD
    var iso = v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(iso){
      var y = parseInt(iso[1],10), mo = parseInt(iso[2],10)-1, d = parseInt(iso[3],10);
      var dt = new Date(y, mo, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // DD/MM/YYYY o MM/DD/YYYY
    var sl = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(sl){
      var p1 = parseInt(sl[1],10), p2 = parseInt(sl[2],10), y2 = parseInt(sl[3],10);
      var dayFirst = preferDayFirst;
      if(p1>12) dayFirst = true;
      else if(p2>12) dayFirst = false;

      var d2 = dayFirst ? p1 : p2;
      var m2 = dayFirst ? p2 : p1;
      var dt2 = new Date(y2, m2-1, d2);
      return isNaN(dt2.getTime()) ? null : dt2;
    }

    // fallback Date parse (último recurso)
    var dt3 = new Date(v);
    return isNaN(dt3.getTime()) ? null : dt3;
  }

  var MONTHS_ES = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  function monthKey(dt){
    var y = dt.getFullYear();
    var m = (dt.getMonth()+1);
    return y + "-" + String(m).padStart(2,"0");
  }
  function monthLabel(key){
    var parts = key.split("-");
    var y = parseInt(parts[0],10);
    var m = parseInt(parts[1],10);
    return (MONTHS_ES[m-1] || key) + " " + y;
  }

  // ========= UI refs =========
  var elStatus = document.getElementById("status");
  var elError = document.getElementById("errorBox");
  var elOk = document.getElementById("okBox");

  function showError(msg){
    elError.style.display="block";
    elError.textContent = msg;
  }
  function showOk(msg){
    elOk.style.display="block";
    elOk.textContent = msg;
  }
  function clearMsgs(){
    elError.style.display="none"; elError.textContent="";
    elOk.style.display="none"; elOk.textContent="";
  }

  // ========= Data state =========
  var ALL = [];
  var FILTERED = [];
  var preferDayFirst = true;

  var state = {
    page: 1,
    pageSize: 25,
    sortCol: "__date",
    sortDir: "desc"
  };

  // ========= Filtros (campos) =========
  var FIELDS = {
    year: {id:"fYear", type:"year"},
    month: {id:"fMonth", type:"month"},
    region: {id:"fRegion", col:"Region"},
    municipio: {id:"fMunicipio", col:"Municipio"},
    area: {id:"fArea", col:"Area protegida"},
    guarda: {id:"fGuarda", col:"Guarda recursos responsable"},
    tipo: {id:"fTipo", col:"Tipo de patrullaje"},
    actividad: {id:"fActividad", col:"Actividad ilegal observada"}
  };

  function uniqueCanonOptions(rows, col){
    // retorna array de {value: canon, label: mejor etiqueta, count}
    var map = Object.create(null); // canon -> {labelCounts}
    var counts = Object.create(null); // canon -> total
    for(var i=0;i<rows.length;i++){
      var raw = cleanSpaces(rows[i][col]);
      if(!raw) continue;
      var canon = normText(raw);
      if(!canon) continue;
      counts[canon] = (counts[canon]||0) + 1;
      if(!map[canon]) map[canon] = Object.create(null);
      map[canon][raw] = (map[canon][raw]||0) + 1;
    }
    var out = [];
    for(var c in counts){
      var best = "";
      var bestN = -1;
      for(var lab in map[c]){
        var n = map[c][lab];
        if(n > bestN || (n===bestN && lab.length > best.length)){
          bestN = n; best = lab;
        }
      }
      out.push({value:c, label:best, count:counts[c]});
    }
    out.sort(function(a,b){
      return a.label.localeCompare(b.label, "es", {sensitivity:"base"});
    });
    return out;
  }

  function fillSelect(id, options, allLabel){
    var sel = document.getElementById(id);
    sel.innerHTML = "";
    var opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = allLabel || "Todos";
    sel.appendChild(opt0);
    for(var i=0;i<options.length;i++){
      var o = document.createElement("option");
      o.value = options[i].value;
      o.textContent = options[i].label;
      sel.appendChild(o);
    }
  }

  function fillYearMonth(rows){
    var years = Object.create(null);
    var months = Object.create(null); // key -> count
    for(var i=0;i<rows.length;i++){
      var dt = rows[i].__date;
      if(!dt) continue;
      years[dt.getFullYear()] = true;
      var mk = rows[i].__monthKey;
      months[mk] = (months[mk]||0) + 1;
    }
    var yList = Object.keys(years).map(function(x){return parseInt(x,10);}).sort(function(a,b){return a-b;});
    var yOpts = yList.map(function(y){ return {value:String(y), label:String(y)}; });
    fillSelect("fYear", yOpts, "Todos");

    var mList = Object.keys(months).sort(); // YYYY-MM sorts
    var mOpts = mList.map(function(k){ return {value:k, label: monthLabel(k)}; });
    fillSelect("fMonth", mOpts, "Todos");
  }

  // ========= Aplicar filtros =========
  function getSel(id){
    return document.getElementById(id).value;
  }

  function applyFilters(){
    var fy = getSel("fYear");
    var fm = getSel("fMonth");
    var fr = getSel("fRegion");
    var fmu = getSel("fMunicipio");
    var fa = getSel("fArea");
    var fg = getSel("fGuarda");
    var ft = getSel("fTipo");
    var fac = getSel("fActividad");
    var q = normText(document.getElementById("fSearch").value);

    FILTERED = ALL.filter(function(r){
      if(fy && String(r.__year) !== fy) return false;
      if(fm && r.__monthKey !== fm) return false;
      if(fr && r.__canonRegion !== fr) return false;
      if(fmu && r.__canonMunicipio !== fmu) return false;
      if(fa && r.__canonArea !== fa) return false;
      if(fg && r.__canonGuarda !== fg) return false;
      if(ft && r.__canonTipo !== ft) return false;
      if(fac && r.__canonActividad !== fac) return false;

      if(q){
        return r.__search.indexOf(q) !== -1;
      }
      return true;
    });

    // sort
    sortFiltered();
    state.page = 1;
    updateAllViews();
  }

  function sortFiltered(){
    var col = state.sortCol;
    var dir = state.sortDir === "asc" ? 1 : -1;
    FILTERED.sort(function(a,b){
      var av = a[col], bv = b[col];
      // date
      if(col === "__date"){
        var at = av ? av.getTime() : 0;
        var bt = bv ? bv.getTime() : 0;
        return (at - bt) * dir;
      }
      // numeric?
      if(typeof av === "number" || typeof bv === "number"){
        var an = (typeof av==="number") ? av : toNumber(av);
        var bn = (typeof bv==="number") ? bv : toNumber(bv);
        if(isNaN(an) && isNaN(bn)) return 0;
        if(isNaN(an)) return 1;
        if(isNaN(bn)) return -1;
        return (an - bn) * dir;
      }
      var as = cleanSpaces(av);
      var bs = cleanSpaces(bv);
      return as.localeCompare(bs, "es", {sensitivity:"base"}) * dir;
    });

    document.getElementById("sortInfo").textContent = "Orden: " + prettyCol(col) + " (" + (state.sortDir==="asc"?"asc":"desc") + ")";
  }

  function prettyCol(c){
    if(c==="__date") return "Fecha";
    if(c==="Municipio") return "Municipio";
    if(c==="Guarda recursos responsable") return "Guardarrecursos";
    if(c==="Region") return "Región";
    if(c==="Area protegida") return "Área";
    if(c==="Tipo de patrullaje") return "Tipo";
    return c;
  }

  // ========= KPIs =========
  function setText(id, t){ document.getElementById(id).textContent = t; }

  function updateKPIs(){
    setText("kpiReg", String(FILTERED.length));

    var mun = Object.create(null), guar = Object.create(null), mes = Object.create(null);
    for(var i=0;i<FILTERED.length;i++){
      if(FILTERED[i].__canonMunicipio) mun[FILTERED[i].__canonMunicipio] = true;
      if(FILTERED[i].__canonGuarda) guar[FILTERED[i].__canonGuarda] = true;
      if(FILTERED[i].__monthKey) mes[FILTERED[i].__monthKey] = true;
    }
    setText("kpiMun", String(Object.keys(mun).length));
    setText("kpiGuar", String(Object.keys(guar).length));
    setText("kpiMes", String(Object.keys(mes).length));

    document.getElementById("countLabel").textContent =
      "Mostrando " + FILTERED.length + " de " + ALL.length + " registros";
  }

  // ========= Charts =========
  var chMes=null, chTipo=null, chMun=null;

  function countBy(rows, keyFn){
    var c = Object.create(null);
    for(var i=0;i<rows.length;i++){
      var k = keyFn(rows[i]);
      if(!k) continue;
      c[k] = (c[k]||0) + 1;
    }
    return c;
  }

  function topEntries(counter, topN){
    var arr = [];
    for(var k in counter){ arr.push([k, counter[k]]); }
    arr.sort(function(a,b){ return b[1]-a[1]; });
    return arr.slice(0, topN);
  }

  function ensureCharts(){
    var ctxMes = document.getElementById("chMes");
    var ctxTipo = document.getElementById("chTipo");
    var ctxMun = document.getElementById("chMun");

    if(!chMes){
      chMes = new Chart(ctxMes, {
        type: "bar",
        data: {labels: [], datasets: [{label:"Registros", data: []}]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins:{ legend:{display:false} },
          scales:{
            x:{ ticks:{ maxRotation:0, autoSkip:true } },
            y:{ beginAtZero:true, ticks:{ precision:0 } }
          }
        }
      });
    }
    if(!chTipo){
      chTipo = new Chart(ctxTipo, {
        type: "bar",
        data: {labels: [], datasets: [{label:"Registros", data: []}]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins:{ legend:{display:false} },
          scales:{
            x:{ ticks:{ maxRotation:0, autoSkip:true } },
            y:{ beginAtZero:true, ticks:{ precision:0 } }
          }
        }
      });
    }
    if(!chMun){
      chMun = new Chart(ctxMun, {
        type: "bar",
        data: {labels: [], datasets: [{label:"Registros", data: []}]},
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins:{ legend:{display:false} },
          scales:{
            x:{ beginAtZero:true, ticks:{ precision:0 } },
            y:{ ticks:{ autoSkip:false } }
          }
        }
      });
    }
  }

  function updateCharts(){
    ensureCharts();

    // por mes (orden natural)
    var cm = countBy(FILTERED, function(r){ return r.__monthKey; });
    var labels = Object.keys(cm).sort(); // YYYY-MM
    var data = labels.map(function(k){ return cm[k]; });
    chMes.data.labels = labels.map(monthLabel);
    chMes.data.datasets[0].data = data;
    chMes.update();

    // por tipo (top 8)
    var ct = countBy(FILTERED, function(r){ return r.__labelTipo; });
    var topT = topEntries(ct, 8);
    chTipo.data.labels = topT.map(function(x){ return x[0]; });
    chTipo.data.datasets[0].data = topT.map(function(x){ return x[1]; });
    chTipo.update();

    // por municipio (top 10)
    var cmun = countBy(FILTERED, function(r){ return r.__labelMunicipio; });
    var topM = topEntries(cmun, 10);
    chMun.data.labels = topM.map(function(x){ return x[0]; });
    chMun.data.datasets[0].data = topM.map(function(x){ return x[1]; });
    chMun.update();
  }

  // ========= Map =========
  var map=null, markers=null;
  function ensureMap(){
    if(map) return;
    map = L.map("map", {scrollWheelZoom:true});
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);
    markers = L.layerGroup().addTo(map);

    // vista inicial cerca de Atitlán
    map.setView([14.7, -91.2], 10);
  }

  function isGuatemala(lat, lon){
    // rango amplio para Guatemala
    return (lat >= 13.0 && lat <= 18.5 && lon >= -93.5 && lon <= -88.0);
  }

  function updateMap(){
    ensureMap();
    markers.clearLayers();

    var valid = 0, ignored = 0;
    var bounds = [];
    for(var i=0;i<FILTERED.length;i++){
      var r = FILTERED[i];
      var lat = r.__lat, lon = r.__lon;
      if(!isFinite(lat) || !isFinite(lon) || (lat===0 && lon===0)){
        ignored++; continue;
      }
      // evitar outliers fuera de GT
      if(!isGuatemala(lat, lon)){ ignored++; continue; }

      valid++;
      var tip = "<b>Fecha:</b> " + (r["Fecha de patrullaje"]||"") +
                "<br><b>Municipio:</b> " + (r.__labelMunicipio||"") +
                "<br><b>Tipo:</b> " + (r.__labelTipo||"") +
                "<br><b>Área:</b> " + (r.__labelArea||"") +
                "<br><b>Guardarrecursos:</b> " + (r.__labelGuarda||"");

      L.circleMarker([lat, lon], {radius:5, weight:1, fillOpacity:0.7}).bindPopup(tip).addTo(markers);
      bounds.push([lat, lon]);
    }

    var note = document.getElementById("mapNote");
    note.textContent = "Puntos: " + valid + " · Ignorados: " + ignored + " (inválidos / fuera de rango)";

    if(bounds.length){
      try{
        map.fitBounds(bounds, {padding:[20,20]});
      }catch(e){}
      // fuerza render
      setTimeout(function(){ map.invalidateSize(true); }, 120);
    }
  }

  // ========= Tabla simple =========
  var DISPLAY_COLS = [
    "Fecha de patrullaje",
    "Municipio",
    "Guarda recursos responsable",
    "Region",
    "Area protegida",
    "Tipo de patrullaje",
    "Actividad ilegal observada",
    "Ubicacion",
    "Longitud",
    "Latitud"
  ];

  function buildTableHeader(){
    var tr = document.getElementById("tblHead");
    tr.innerHTML = "";
    DISPLAY_COLS.forEach(function(c){
      var th = document.createElement("th");
      var wrap = document.createElement("span");
      wrap.className = "th-sort";
      wrap.textContent = c;
      var ind = document.createElement("span");
      ind.className = "sort-ind";
      ind.textContent = "";
      wrap.appendChild(ind);
      th.appendChild(wrap);

      th.addEventListener("click", function(){
        if(state.sortCol === c){
          state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
        }else{
          state.sortCol = c;
          state.sortDir = "asc";
        }
        sortFiltered();
        state.page = 1;
        renderTable();
      });
      tr.appendChild(th);
    });
    // Fecha por defecto desc
    document.getElementById("sortInfo").textContent = "Orden: Fecha (desc)";
  }

  function renderTable(){
    var body = document.getElementById("tblBody");
    body.innerHTML = "";

    var ps = state.pageSize;
    var totalPages = Math.max(1, Math.ceil(FILTERED.length / ps));
    if(state.page > totalPages) state.page = totalPages;

    var start = (state.page - 1) * ps;
    var end = Math.min(FILTERED.length, start + ps);
    for(var i=start;i<end;i++){
      var r = FILTERED[i];
      var tr = document.createElement("tr");
      for(var j=0;j<DISPLAY_COLS.length;j++){
        var c = DISPLAY_COLS[j];
        var td = document.createElement("td");
        td.textContent = (r[c] === null || r[c] === undefined) ? "" : String(r[c]);
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }

    document.getElementById("pageInfo").textContent = "Página " + state.page + "/" + totalPages + " (" + FILTERED.length + " registros)";
    document.getElementById("btnPrev").disabled = (state.page <= 1);
    document.getElementById("btnNext").disabled = (state.page >= totalPages);
  }

  // ========= Export CSV/XLSX =========
  function rowsToCSV(rows){
    var cols = Object.keys(rows[0] || {}).filter(function(k){
      return k.indexOf("__") !== 0; // no campos internos
    });

    // mantén un orden amigable si existen
    var preferred = [
      "Guarda recursos responsable","Municipio","Fecha de patrullaje",
      "Hora de Inicio del patrullaje","Hora de finalizacion de patrullaje",
      "Region","Ubicacion","Area protegida","Tipo de patrullaje",
      "Hay mas instituciones involucradas en el patrullaje",
      "Instituciones involucradas","Otra (especifique)","Actividad ilegal observada",
      "Fecha de creacion de registro","Fecha de modificacion de registro",
      "Longitud","Latitud","X","Y"
    ];
    cols.sort(function(a,b){
      var ia = preferred.indexOf(a); var ib = preferred.indexOf(b);
      if(ia === -1 && ib === -1) return a.localeCompare(b);
      if(ia === -1) return 1;
      if(ib === -1) return -1;
      return ia - ib;
    });

    var delim = ";";
    function esc(v){
      v = (v === null || v === undefined) ? "" : String(v);
      if(v.indexOf('"')>-1) v = v.replace(/"/g,'""');
      if(v.indexOf(delim)>-1 || v.indexOf("\n")>-1 || v.indexOf('"')>-1) v = '"' + v + '"';
      return v;
    }
    var lines = [];
    lines.push(cols.map(esc).join(delim));
    for(var i=0;i<rows.length;i++){
      var r = rows[i];
      lines.push(cols.map(function(c){ return esc(r[c]); }).join(delim));
    }
    return "\uFEFF" + lines.join("\n"); // BOM para Excel
  }

  function downloadBlob(filename, content, mime){
    var blob = new Blob([content], {type: mime || "text/plain;charset=utf-8"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
      URL.revokeObjectURL(url);
      a.remove();
    }, 200);
  }

  async function ensureXLSX(){
    if(window.XLSX) return;
    try{
      await loadScriptSequential([
        "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
        "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js",
        "xlsx.full.min.js"
      ]);
    }catch(e){
      // si no se puede, se queda solo CSV
      throw e;
    }
  }

  async function downloadXLSX(){
    if(FILTERED.length === 0) return;
    await ensureXLSX();
    var rows = FILTERED.map(function(r){
      var o = {};
      for(var k in r){
        if(k.indexOf("__")===0) continue;
        o[k] = r[k];
      }
      return o;
    });
    var ws = XLSX.utils.json_to_sheet(rows);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "AC192");
    var out = XLSX.write(wb, {bookType:"xlsx", type:"array"});
    downloadBlob("AC192_patrullajes_filtrado.xlsx", out, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
  }

  // ========= Update everything =========
  function updateAllViews(){
    updateKPIs();
    updateCharts();
    updateMap();
    renderTable();
  }

  // ========= Init =========
  async function init(){
    clearMsgs();
    elStatus.textContent = "Cargando CSV…";

    // PapaParse (para parsear bien)
    try{
      if(!window.Papa){
        await loadScriptSequential([
          "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js",
          "https://unpkg.com/papaparse@5.4.1/papaparse.min.js",
          "papaparse.min.js"
        ]);
      }
    }catch(e){
      // Papa no está: seguimos con parser simple
    }

    var fetched = await fetchArrayBufferAny(PATHS);
    var text = decodeSmart(fetched.buf);

    var rows = [];
    try{
      if(window.Papa){
        rows = await parseWithPapa(text);
      }else{
        rows = parseSimpleCSV(text);
      }
    }catch(e){
      // fallback parser simple
      rows = parseSimpleCSV(text);
    }

    if(!rows || rows.length === 0){
      throw new Error("El CSV se cargó pero no se pudieron leer registros. Verifica el separador y la codificación.");
    }

    preferDayFirst = inferDayFirst(rows, "Fecha de patrullaje");

    // procesar y preparar campos internos
    ALL = rows.map(function(r){
      // normaliza strings
      var out = {};
      for(var k in r){
        out[k] = cleanSpaces(r[k]);
      }

      // fecha
      var dt = parseDateSmart(out["Fecha de patrullaje"], preferDayFirst);
      out.__date = dt;
      out.__year = dt ? dt.getFullYear() : "";
      out.__monthKey = dt ? monthKey(dt) : "";

      // canonical values
      out.__canonRegion = normText(out["Region"]);
      out.__canonMunicipio = normText(out["Municipio"]);
      out.__canonArea = normText(out["Area protegida"]);
      out.__canonGuarda = normText(out["Guarda recursos responsable"]);
      out.__canonTipo = normText(out["Tipo de patrullaje"]);
      out.__canonActividad = normText(out["Actividad ilegal observada"]);

      // coords (en español)
      out.__lon = toNumber(out["Longitud"]);
      out.__lat = toNumber(out["Latitud"]);

      // search string
      var blob = [];
      for(var kk in out){
        if(kk.indexOf("__")===0) continue;
        var v = out[kk];
        if(v) blob.push(v);
      }
      out.__search = normText(blob.join(" "));

      return out;
    });

    // construir etiquetas "bonitas" por canon (para evitar duplicados)
    function labelFromMap(col, canonKey){
      if(!canonKey) return "";
      return canonLabelMaps[col] && canonLabelMaps[col][canonKey] ? canonLabelMaps[col][canonKey] : "";
    }

    // maps canon -> label
    var canonLabelMaps = {
      "Region": Object.create(null),
      "Municipio": Object.create(null),
      "Area protegida": Object.create(null),
      "Guarda recursos responsable": Object.create(null),
      "Tipo de patrullaje": Object.create(null),
      "Actividad ilegal observada": Object.create(null)
    };

    function computeCanonLabels(col){
      var labelCounts = Object.create(null); // canon -> {label->count}
      var canonTotals = Object.create(null);
      for(var i=0;i<ALL.length;i++){
        var raw = cleanSpaces(ALL[i][col]);
        if(!raw) continue;
        var c = normText(raw);
        if(!c) continue;
        canonTotals[c] = (canonTotals[c]||0) + 1;
        if(!labelCounts[c]) labelCounts[c] = Object.create(null);
        labelCounts[c][raw] = (labelCounts[c][raw]||0) + 1;
      }
      for(var ckey in canonTotals){
        var bestLab = "";
        var bestN = -1;
        for(var lab in labelCounts[ckey]){
          var n = labelCounts[ckey][lab];
          if(n > bestN || (n===bestN && lab.length > bestLab.length)){
            bestN = n; bestLab = lab;
          }
        }
        canonLabelMaps[col][ckey] = bestLab;
      }
    }

    Object.keys(canonLabelMaps).forEach(computeCanonLabels);

    // guardar label en cada fila para gráficos/tabla
    ALL.forEach(function(r){
      r.__labelRegion = labelFromMap("Region", r.__canonRegion) || r["Region"] || "";
      r.__labelMunicipio = labelFromMap("Municipio", r.__canonMunicipio) || r["Municipio"] || "";
      r.__labelArea = labelFromMap("Area protegida", r.__canonArea) || r["Area protegida"] || "";
      r.__labelGuarda = labelFromMap("Guarda recursos responsable", r.__canonGuarda) || r["Guarda recursos responsable"] || "";
      r.__labelTipo = labelFromMap("Tipo de patrullaje", r.__canonTipo) || r["Tipo de patrullaje"] || "";
      r.__labelActividad = labelFromMap("Actividad ilegal observada", r.__canonActividad) || r["Actividad ilegal observada"] || "";
    });

    // llenar selects (sin duplicados)
    fillYearMonth(ALL);
    fillSelect("fRegion", uniqueCanonOptions(ALL, "Region"), "Todas");
    fillSelect("fMunicipio", uniqueCanonOptions(ALL, "Municipio"), "Todos");
    fillSelect("fArea", uniqueCanonOptions(ALL, "Area protegida"), "Todas");
    fillSelect("fGuarda", uniqueCanonOptions(ALL, "Guarda recursos responsable"), "Todos");
    fillSelect("fTipo", uniqueCanonOptions(ALL, "Tipo de patrullaje"), "Todos");
    fillSelect("fActividad", uniqueCanonOptions(ALL, "Actividad ilegal observada"), "Todas");

    buildTableHeader();

    FILTERED = ALL.slice();
    // sort default: fecha desc
    state.sortCol = "__date";
    state.sortDir = "desc";
    sortFiltered();

    updateAllViews();

    elStatus.textContent = "Listo. Fuente: " + fetched.used;
    showOk("Cargados " + ALL.length + " registros. Formato fecha: " + (preferDayFirst ? "DD/MM" : "MM/DD") + ".");
  }

  // ========= Eventos =========
  function wire(){
    function onChange(){
      clearMsgs();
      applyFilters();
    }
    ["fYear","fMonth","fRegion","fMunicipio","fArea","fGuarda","fTipo","fActividad"].forEach(function(id){
      document.getElementById(id).addEventListener("change", onChange);
    });
    document.getElementById("fSearch").addEventListener("input", function(){
      clearMsgs();
      applyFilters();
    });

    document.getElementById("btn-reset").addEventListener("click", function(){
      clearMsgs();
      ["fYear","fMonth","fRegion","fMunicipio","fArea","fGuarda","fTipo","fActividad"].forEach(function(id){
        document.getElementById(id).value = "";
      });
      document.getElementById("fSearch").value = "";
      applyFilters();
    });

    document.getElementById("pageSize").addEventListener("change", function(e){
      state.pageSize = parseInt(e.target.value,10) || 25;
      state.page = 1;
      renderTable();
    });

    document.getElementById("btnPrev").addEventListener("click", function(){
      state.page = Math.max(1, state.page - 1);
      renderTable();
    });
    document.getElementById("btnNext").addEventListener("click", function(){
      var totalPages = Math.max(1, Math.ceil(FILTERED.length / state.pageSize));
      state.page = Math.min(totalPages, state.page + 1);
      renderTable();
    });

    document.getElementById("btn-csv").addEventListener("click", function(){
      if(FILTERED.length === 0) return;
      var rows = FILTERED.map(function(r){
        var o = {};
        for(var k in r){
          if(k.indexOf("__")===0) continue;
          o[k] = r[k];
        }
        return o;
      });
      var csv = rowsToCSV(rows);
      downloadBlob("AC192_patrullajes_filtrado.csv", csv, "text/csv;charset=utf-8");
    });

    document.getElementById("btn-xlsx").addEventListener("click", async function(){
      try{
        await downloadXLSX();
      }catch(e){
        showError("No se pudo generar Excel. Intenta descargar CSV.\nDetalle: " + e.message);
      }
    });

    document.getElementById("btn-print").addEventListener("click", function(){
      window.print();
    });

    // Si cambia tamaño, re-ajustar mapa para evitar render raro
    window.addEventListener("resize", function(){
      if(map) setTimeout(function(){ map.invalidateSize(true); }, 120);
    });
  }

  wire();
  init().catch(function(e){
    elStatus.textContent = "Error";
    showError("No se pudo cargar el tablero.\n\n" +
      "Causas comunes:\n" +
      "• El CSV no está en la misma carpeta del HTML (datos_patrullaje.csv)\n" +
      "• GitHub Pages publica desde otra carpeta (por eso se usa fallback RAW)\n" +
      "• El navegador bloqueó la petición por caché/actualización\n\n" +
      "Detalle técnico: " + (e && e.message ? e.message : String(e)));
    console.error(e);
  });

})();
</script>
</body>
</html>
