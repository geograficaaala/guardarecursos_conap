<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>AC192 · Patrullajes - Tablero dinámico (CSV)</title>
<!-- Tabulator local (repo) -->
<link href="tabulator.min.css" rel="stylesheet"/>
<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Leaflet (OSM) -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    :root{
      --verde-header:#34d399;
      --verde-header-2:#60a5fa;

      --azul-boton:#2563eb;
      --azul-boton-hover:#1d4ed8;

      --gris-fondo:#f4f7fb;
      --texto-principal:#0f172a;
      --texto-secundario:#475569;
      --borde-suave: rgba(148,163,184,0.35);
      --card-radius:16px;

      --chart-grid: rgba(2,6,23,0.08);
      --chart-tick: rgba(15,23,42,0.85);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto-principal);
      background:
        radial-gradient(circle at 10% 15%, rgba(52,211,153,0.28) 0, transparent 55%),
        radial-gradient(circle at 90% 30%, rgba(96,165,250,0.25) 0, transparent 55%),
        radial-gradient(circle at 40% 95%, rgba(14,165,233,0.12) 0, transparent 60%),
        linear-gradient(180deg, #f7fbff 0%, var(--gris-fondo) 45%, #f2fbf7 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      background: linear-gradient(90deg, rgba(16,185,129,0.95), rgba(59,130,246,0.95));
      color:#fff;
      padding:14px 20px 18px;
      box-shadow:0 6px 24px rgba(15,23,42,.14);
      position:sticky; top:0; z-index:50;
    }
    .header-inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; flex-wrap:wrap;
    }
    .logo-group{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background-color: rgba(255,255,255,0.12);
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
    }
    .logo-group img{
      height:40px; max-width:130px; object-fit:contain;
      background-color:#fff; border-radius:999px; padding:4px 8px;
      box-shadow:0 2px 6px rgba(15,23,42,.18);
    }
    .title-group{ text-align:right; flex:1 1 260px;}
    .title-group h1{ margin:0 0 2px; font-size:22px; letter-spacing:.02em;}
    .title-group p{ margin:0; font-size:13px; opacity:.96; line-height:1.4;}

    main{
      max-width:1100px; width:100%;
      margin:16px auto 0;
      padding:0 20px 40px;
      flex:1 0 auto;
    }

    .page-header{ margin-bottom:10px; }
    .page-header h2{ margin:0 0 6px; font-size:20px;}
    .page-header p{ margin:2px 0; font-size:14px; color:var(--texto-secundario);}

    .pill{
      display:inline-block; margin-top:6px;
      padding:3px 10px; font-size:11px; border-radius:999px;
      background-color: rgba(37,99,235,0.08);
      color:#1d4ed8;
      border:1px solid rgba(191,219,254,0.9);
      text-transform:uppercase; letter-spacing:.08em;
    }

    .topnav{
      position: sticky;
      top: 82px;
      z-index: 40;
      margin: 12px 0 14px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:center;
      margin:0;
    }
    .tab{
      text-decoration:none;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(255,255,255,0.95);
      color:#0f172a;
      font-weight:750;
      font-size:13px;
    }
    .tab:hover{ background:#eef6ff; border-color:rgba(59,130,246,0.35); }
    .tab.active{
      background:var(--azul-boton);
      border-color:transparent;
      color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.16);
    }

    .nav-actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      margin-top:10px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; font-size:14px;
      border-radius:999px; text-decoration:none;
      cursor:pointer; border:1px solid transparent;
      font-weight:800;
      transition: background-color .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn-primary{
      background-color:var(--azul-boton); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }
    .btn-primary:hover{
      background-color:var(--azul-boton-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.16);
    }
    .btn-ghost{
      background-color:rgba(255,255,255,.95);
      color:#0f172a;
      border-color: rgba(148,163,184,0.45);
    }
    .btn-ghost:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,.10);
    }
    .btn-warn{
      background: rgba(16,185,129,0.95); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }
    .btn-warn:hover{
      background: rgba(5,150,105,0.98);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.14);
    }

    .card{
      background: rgba(255,255,255,0.92);
      border-radius:var(--card-radius);
      border:1px solid var(--borde-suave);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:16px;
      margin-bottom:14px;
      overflow:hidden;
      position:relative;
    }
    .card.soft{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.98));
    }

    .subnote{ margin:0; color:var(--texto-secundario); font-size:13px; }

    .infobox{
      border:1px solid rgba(59,130,246,.18);
      background: rgba(219,234,254,.40);
      border-radius:14px;
      padding:10px 12px;
      color:#0f172a;
      font-size:13px;
      margin-top:10px;
      text-align:center;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      justify-content:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,0.85);
      font-size:12px;
      font-weight:700;
      color:#0f172a;
    }
    .chip b{ font-weight:800; }

    .filters{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .field{ grid-column: span 3; min-width:160px; }
    .field.wide{ grid-column: span 4; }

    label{
      display:block; font-size:12px; color:var(--texto-secundario);
      font-weight:900; margin-bottom:6px;
    }
    select, input{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    input.small{
      padding:7px 10px;
      border-radius:12px;
      background: rgba(241,245,249,.7);
      margin-bottom:6px;
    }

    .kpis{
      display:grid; grid-template-columns:repeat(12,1fr); gap:12px;
    }
    .kpi{
      grid-column: span 2;
      border:1px solid rgba(148,163,184,0.35);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(248,250,252,.98));
      min-height:80px;
    }
    .kpi .t{ font-size:12px; color:var(--texto-secundario); font-weight:950;}
    .kpi .v{ font-size:18px; font-weight:950; margin-top:6px; }
    .kpi .s{ font-size:12px; color:var(--texto-secundario); margin-top:2px; }

    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-12{ grid-column:span 12; }
    .col-6{ grid-column:span 6; }

    .chartwrap{ height:240px; }
    .chartwrap.tall{ height:260px; }
    canvas{ width:100% !important; height:100% !important; }

    #map{
      width:100%;
      height:420px;
      min-height:320px;
      max-height:520px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.35);
      overflow:hidden;
      background:#fff;
    }

    .maprow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .mini-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .mini-btn{
      padding:7px 10px;
      font-size:13px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:800;
    }
    .mini-btn:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      box-shadow:0 3px 10px rgba(15,23,42,.10);
    }

    .tablewrap{ overflow:hidden; }
    footer{
      text-align:center;
      font-size:12px;
      color:#64748b;
      padding:10px 20px 18px;
      border-top:1px solid rgba(148,163,184,0.25);
      background-color:rgba(248,250,252,.9);
      margin-top:auto;
    }

    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 10px 25px rgba(15,23,42,.30);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    @media (max-width: 980px){
      .field{ grid-column: span 12; min-width:unset; }
      .field.wide{ grid-column: span 12; }
      .kpi{ grid-column: span 6; }
      .col-6{ grid-column: span 12; }
      .title-group{ text-align:center; }
      .header-inner{ justify-content:center; }
      .topnav{ top: 116px; }
      .chartwrap{ height: 230px; }
      #map{ height: 300px; }
    }
  
#tabla{ min-height:520px; }
</style>
</head>
<body>
<header>
<div class="header-inner">
<div class="logo-group">
<img alt="Logo CONAP" src="conap_logo.jpg"/>
<img alt="Logo Laboratorio SIG AALA" src="aala_logo.png"/>
</div>
<div class="title-group">
<h1>Centro de consulta de datos</h1>
<p>Sistema de monitoreo de actividades</p>
<p>CONAP – Dirección Regional Altiplano Central</p>
</div>
</div>
</header>
<main>
<section class="page-header">
<h2>AC192 · Patrullajes de control y vigilancia · Tablero dinámico</h2>
<p>Este tablero se genera automáticamente desde los datos extraídos de la boleta AC 192 y permite filtrar, graficar y generar un informe PDF liviano.</p>
<span class="pill">Tablero dinámico · CSV</span>
</section>
<section aria-label="Navegación y acciones del módulo" class="topnav">
<nav aria-label="Navegación del módulo" class="tabs">
<a class="tab" href="patrullajes_dashboard.html">Dashboard geográfico</a>
<a class="tab active" href="patrullajes_tablero.html">Tablero dinámico</a>
<a class="tab" href="patrullajes_datos.html">Tabla de datos</a>
</nav>
<div class="nav-actions">
<a class="btn btn-ghost" href="index.html">Inicio</a>
<button class="btn btn-ghost" id="btn-reset" type="button">Limpiar filtros</button>
<button class="btn btn-warn" id="btn-pdf" type="button">Generar informe PDF (liviano)</button>
</div>
<div class="infobox">
<b>Sugerencia:</b> haga clic sobre la serie temporal o sobre el gráfico de barras para filtrar.
        <div aria-label="Resumen de filtros" class="chips" id="chips-filtros"></div>
</div>
<p class="subnote" id="estado" style="margin-top:10px;">Cargando datos…</p>
</section>
<section aria-label="Filtros del tablero" class="card soft" id="card-filtros">
<h3 style="margin:0 0 6px;">Filtros</h3>
<p class="subnote">Los filtros se aplican a KPIs, gráficos, mapa y tabla. Si un filtro no aplica (campo inexistente), se oculta automáticamente.</p>
<div class="filters" id="filters-grid">
<div class="field" id="wrap-anio">
<label for="f-anio">Año</label>
<select id="f-anio"></select>
</div>
<div class="field" id="wrap-mes">
<label for="f-mes">Mes</label>
<select id="f-mes"></select>
</div>
<div class="field wide" id="wrap-region">
<label for="f-region">Región</label>
<select id="f-region"></select>
</div>
<div class="field wide" id="wrap-municipio">
<label for="f-municipio">Municipio</label>
<select id="f-municipio"></select>
</div>
<div class="field wide" id="wrap-area">
<label for="f-area">Área protegida</label>
<select id="f-area"></select>
</div>
<div class="field wide" id="wrap-guarda">
<label for="f-guarda">Guardarrecursos responsable</label>
<select id="f-guarda"></select>
</div>
<div class="field wide" id="wrap-tipo">
<label for="f-tipo">Tipo de patrullaje</label>
<select id="f-tipo"></select>
</div>
<div class="field wide" id="wrap-ilegal">
<label for="f-ilegal">Actividad ilegal observada</label>
<select id="f-ilegal"></select>
</div>
<div class="field wide" id="wrap-ubicacion">
<label for="f-ubicacion">Ubicación</label>
<select id="f-ubicacion"></select>
</div>
<div class="field" id="wrap-buscar">
<label for="f-buscar">Buscar</label>
<input id="f-buscar" placeholder="palabra clave (en cualquier campo)" type="text"/>
</div>
</div>
</section>
<section aria-label="Indicadores" class="card">
<h3 style="margin:0 0 10px;">Indicadores</h3>
<div class="kpis">
<div class="kpi"><div class="t">Registros</div><div class="v" id="kpi-registros">–</div><div class="s" id="kpi-registros-s">Total</div></div>
<div class="kpi"><div class="t">Rango de fechas</div><div class="v" id="kpi-rango">–</div><div class="s">Según “Fecha de patrullaje”</div></div>
<div class="kpi"><div class="t">Regiones</div><div class="v" id="kpi-regiones">–</div><div class="s">Únicas</div></div>
<div class="kpi"><div class="t">Municipios</div><div class="v" id="kpi-municipios">–</div><div class="s">Únicos</div></div>
<div class="kpi"><div class="t">Áreas protegidas</div><div class="v" id="kpi-areas">–</div><div class="s">Únicas</div></div>
<div class="kpi"><div class="t">Con coordenadas</div><div class="v" id="kpi-coords">–</div><div class="s">Para el mapa</div></div>
</div>
</section>
<section aria-label="Gráficos" class="grid">
<div class="card col-6">
<h3 style="margin:0 0 8px;">Serie temporal (registros)</h3>
<div class="chartwrap tall"><canvas id="chart-tiempo"></canvas></div>
<p class="subnote" id="note-tiempo">Clic en un punto para filtrar por mes.</p>
</div>
<div class="card col-6">
<div class="maprow">
<h3 style="margin:0;">Distribución por tipo</h3>
<div class="mini-actions">
<button class="mini-btn" id="btn-clear-chart" type="button">Quitar filtro gráfico</button>
</div>
</div>
<div class="chartwrap tall"><canvas id="chart-tipo"></canvas></div>
<p class="subnote">Clic en una barra para filtrar por categoría.</p>
</div>
</section>
<section aria-label="Mapa" class="card">
<div class="maprow">
<h3 style="margin:0;">Mapa (si hay coordenadas)</h3>
<div class="mini-actions">
<button class="mini-btn" id="btn-centrar" type="button">Centrar</button>
<button class="mini-btn" id="btn-geojson" type="button">Descargar GeoJSON</button>
</div>
</div>
<div id="map"></div>
<p class="subnote" id="map-note">Si el CSV no incluye coordenadas, el mapa se ocultará automáticamente.</p>
</section>
<section aria-label="Tabla de registros" class="card">
<div class="maprow">
<h3 style="margin:0;">Tabla (Tabulator)</h3>
<div class="mini-actions">
<button class="mini-btn" id="btn-csv" type="button">Descargar CSV</button>
<button class="mini-btn" id="btn-xlsx" type="button">Descargar Excel</button>
</div>
</div>
<div class="tablewrap"><div id="tabla"></div></div>
<p class="subnote">Tip: use el buscador superior y el filtro por columna (en encabezados) para refinar aún más.</p>
</section>
</main>
<footer>
<p>© 2026 Laboratorio SIG AALA en apoyo a CONAP – Dirección Regional Altiplano Central</p>
</footer>
<div class="toast" id="toast">Listo</div>
<!-- Librerías locales del repositorio -->
<script src="papaparse.min.js"></script>
<script src="tabulator.min.js"></script>
<script src="xlsx.full.min.js"></script>
<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
(function () {
  // -----------------------------
  // Config
  // -----------------------------
  const CSV_CANDIDATES = [
    "./datos_patrullaje.csv",
    "datos_patrullaje.csv",
    // Fallback: raw GitHub (sirve aunque Pages esté apuntando a /docs u otra carpeta)
    "https://raw.githubusercontent.com/geograficaaala/guardarecursos_conap/main/datos_patrullaje.csv"
  ];

  // Campos esperados (según AC192). Se usan si existen en el CSV.
  const FIELD_FECHA = "Fecha de patrullaje";
  const FIELD_REGION = "Region";
  const FIELD_MUNICIPIO = "Municipio";
  const FIELD_AREA = "Area protegida";
  const FIELD_GUARDA = "Guarda recursos responsable";
  const FIELD_TIPO = "Tipo de patrullaje";
  const FIELD_ILEGAL = "Actividad ilegal observada";
  const FIELD_UBIC = "Ubicacion";

  // Coordenadas (según tu CSV)
  const FIELD_LAT = "Latitud";
  const FIELD_LON = "Longitud";

  // Rangos razonables para Guatemala (evita que un outlier arruine el zoom)
  const GT_BOUNDS = { minLat: 13.0, maxLat: 18.6, minLon: -93.5, maxLon: -88.0 };

  // -----------------------------
  // Helpers UI
  // -----------------------------
  const $ = (id) => document.getElementById(id);

  function setEstado(msg, isError) {
    const el = $("estado");
    if (!el) return;
    el.textContent = msg;
    el.style.color = isError ? "#b91c1c" : "#1f2937";
  }

  function showToast(msg) {
    const t = $("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1500);
  }

  function showOrHide(wrapperId, show) {
    const el = $(wrapperId);
    if (!el) return;
    el.style.display = show ? "" : "none";
  }

  function fillSelect(selectEl, values, placeholder) {
    if (!selectEl) return;
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder || "Todos";
    selectEl.appendChild(opt0);

    (values || []).forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    });
  }

  function fillSelectPairs(selectEl, pairs, placeholder) {
    if (!selectEl) return;
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder || "Todos";
    selectEl.appendChild(opt0);

    (pairs || []).forEach(p => {
      const o = document.createElement("option");
      o.value = p.value;
      o.textContent = p.label;
      selectEl.appendChild(o);
    });
  }

  // -----------------------------
  // Robust loading of libs
  // -----------------------------
  function loadScript(url) {
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = () => resolve(url);
      s.onerror = () => reject(new Error("No se pudo cargar: " + url));
      document.head.appendChild(s);
    });
  }

  async function ensureLib(name, testFn, urls) {
    try {
      if (testFn()) return { name, url: "preload" };
    } catch (_) {}
    for (const u of urls) {
      try {
        await loadScript(u);
        if (testFn()) return { name, url: u };
      } catch (e) { /* try next */ }
    }
    throw new Error("Falta librería: " + name);
  }

  async function ensureDependencies() {
    // Si tus archivos locales existen, se usarán primero; si no, cae a CDN.
    await ensureLib("PapaParse", () => !!window.Papa, [
      "papaparse.min.js",
      "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
    ]);
    await ensureLib("Tabulator", () => !!window.Tabulator, [
      "tabulator.min.js",
      "https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"
    ]);
    await ensureLib("XLSX", () => !!window.XLSX, [
      "xlsx.full.min.js",
      "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
    ]);
    await ensureLib("Chart.js", () => !!window.Chart, [
      "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
    ]);
    await ensureLib("Leaflet", () => !!window.L, [
      "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    ]);
    await ensureLib("html2pdf", () => !!window.html2pdf, [
      "https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"
    ]);
  }

  // -----------------------------
  // CSV decoding / parsing
  // -----------------------------
  function countReplacementChars(s) {
    let c = 0;
    for (let i = 0; i < s.length; i++) if (s.charCodeAt(i) === 0xFFFD) c++;
    return c;
  }

  function decodeSmartCsv(buffer) {
    // Intenta UTF-8 vs Windows-1252 (muy común en CSV exportados en Windows)
    try {
      const utf8 = new TextDecoder("utf-8", { fatal: false }).decode(buffer);
      let best = utf8;
      let bestScore = countReplacementChars(utf8);

      try {
        const w1252 = new TextDecoder("windows-1252", { fatal: false }).decode(buffer);
        const score2 = countReplacementChars(w1252);
        if (score2 < bestScore) {
          best = w1252;
          bestScore = score2;
        }
      } catch (_) { /* ignore */ }

      return best;
    } catch (_) {
      // Último recurso: convertir a string de bytes
      const bytes = new Uint8Array(buffer);
      let out = "";
      for (let i = 0; i < bytes.length; i++) out += String.fromCharCode(bytes[i]);
      return out;
    }
  }

  function detectarDelimitador(csvText) {
    const lines = csvText.split(/\r?\n/).slice(0, 15).join("\n");
    const cSemi = (lines.match(/;/g) || []).length;
    const cComma = (lines.match(/,/g) || []).length;
    const cTab = (lines.match(/\t/g) || []).length;
    if (cSemi >= cComma && cSemi >= cTab) return ";";
    if (cComma >= cSemi && cComma >= cTab) return ",";
    return "\t";
  }

  async function fetchFirstOk(urls) {
    let lastErr = null;
    for (const base of urls) {
      const url = base + (base.includes("?") ? "&" : "?") + "v=" + Date.now();
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
        const buffer = await res.arrayBuffer();
        return { url, buffer };
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("No se pudo descargar el CSV.");
  }

  // -----------------------------
  // Date parsing (DD/MM vs MM/DD)
  // -----------------------------
  function prepararHintsFechas(rows) {
    let seenDayFirst = 0;
    let seenMonthFirst = 0;

    const sample = rows.slice(0, 250).map(r => (r && r[FIELD_FECHA]) ? String(r[FIELD_FECHA]).trim() : "").filter(Boolean);
    for (const s of sample) {
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
      if (!m) continue;
      const a = parseInt(m[1], 10);
      const b = parseInt(m[2], 10);
      if (a > 12 && b <= 12) seenDayFirst++;
      if (b > 12 && a <= 12) seenMonthFirst++;
    }

    const dayFirst = seenDayFirst >= seenMonthFirst; // tie -> dayFirst
    rows.forEach(r => { r._dateHint = { dayFirst }; });
  }

  function parseFechaFlexible(s, hint) {
    if (!s) return null;
    const str = String(s).trim();
    if (!str) return null;

    // YYYY-MM-DD
    let m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
    if (m) {
      const y = parseInt(m[1],10), mo = parseInt(m[2],10), d = parseInt(m[3],10);
      const dt = new Date(y, mo-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // DD/MM/YYYY o MM/DD/YYYY
    m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (m) {
      let p1 = parseInt(m[1],10), p2 = parseInt(m[2],10), y = parseInt(m[3],10);
      if (y < 100) y += 2000;
      const dayFirst = hint && hint.dayFirst;
      const d = dayFirst ? p1 : p2;
      const mo = dayFirst ? p2 : p1;
      const dt = new Date(y, mo-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    return null;
  }

  function monthKey(dt) {
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    return y + "-" + m;
  }

  const MONTHS_ES = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  function labelMonthKey(k) {
    const parts = String(k).split("-");
    if (parts.length !== 2) return k;
    const y = parts[0];
    const m = parseInt(parts[1],10);
    const name = (m>=1 && m<=12) ? MONTHS_ES[m-1] : parts[1];
    return name + " " + y;
  }

  // -----------------------------
  // Data, filters, charts, map, table
  // -----------------------------
  let rawData = [];
  let filteredData = [];
  let table = null;

  let chartTiempo = null;
  let chartTipo = null;

  let map = null;
  let markersLayer = null;

  function hasField(fieldName) {
    return rawData.length && Object.prototype.hasOwnProperty.call(rawData[0], fieldName);
  }

  // Normalización para evitar duplicados (acentos / mayúsculas / espacios)
  const _STOP_WORDS = new Set(["y","de","del","la","las","los","el","al","a","en","por","con","sin"]);
  function canonText(v) {
    const s = String(v ?? "").trim().replace(/\s+/g, " ");
    if (!s) return "";
    return s.normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }
  function applyAlias(field, canon) {
    if (!canon) return "";
    let c = canon;
    if (field === "region") {
      if (c === "altiplano centraln") c = "altiplano central";
      // "Reginal" -> "Regional"
      c = c.replace(/\breginal\b/g, "regional");
    }
    return c;
  }
  function canonField(v, field) {
    return applyAlias(field, canonText(v));
  }
  function accentScore(s) {
    return (String(s||"").match(/[áéíóúÁÉÍÓÚñÑüÜ]/g) || []).length;
  }
  function bestVariant(list) {
    const arr = (list || []).map(x => String(x||"").trim()).filter(Boolean);
    if (!arr.length) return "";
    arr.sort((a,b) => {
      const dAcc = accentScore(b) - accentScore(a);
      if (dAcc) return dAcc;
      const dLen = b.length - a.length;
      if (dLen) return dLen;
      return a.localeCompare(b, "es");
    });
    return arr[0];
  }
  function prettyLabel(raw) {
    const s = String(raw||"").trim().replace(/\s+/g, " ");
    if (!s) return "";
    // Mantener siglas cortas (ej. RUMCLA)
    if (/^[A-ZÁÉÍÓÚÑÜ0-9]{2,10}$/.test(s)) return s;
    const words = s.toLocaleLowerCase("es").split(" ");
    return words.map((w,i) => {
      if (i>0 && _STOP_WORDS.has(w)) return w;
      return w.charAt(0).toLocaleUpperCase("es") + w.slice(1);
    }).join(" ");
  }
  function uniquePairs(rows, field, canonKey, canonFieldName) {
    const map = new Map(); // canon -> variants[]
    rows.forEach(r => {
      const raw = (r && r[field] != null) ? String(r[field]).trim() : "";
      const c = (r && r[canonKey]) ? String(r[canonKey]) : canonField(raw, canonFieldName || "");
      if (!raw || !c) return;
      if (!map.has(c)) map.set(c, []);
      map.get(c).push(raw);
    });
    const pairs = Array.from(map.entries()).map(([value, variants]) => ({
      value,
      label: prettyLabel(bestVariant(variants))
    }));
    pairs.sort((a,b)=>a.label.localeCompare(b.label, "es"));
    return pairs;
  }
function numFromAny(v) {
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    const clean = s.replace(",", ".");
    const n = parseFloat(clean);
    return Number.isFinite(n) ? n : null;
  }

  function isCoordInGT(lat, lon) {
    if (lat == null || lon == null) return false;
    if (Math.abs(lat) < 0.000001 && Math.abs(lon) < 0.000001) return false; // 0,0
    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) return false;
    return (lat >= GT_BOUNDS.minLat && lat <= GT_BOUNDS.maxLat && lon >= GT_BOUNDS.minLon && lon <= GT_BOUNDS.maxLon);
  }

  function getValidCoords(rows) {
    let ok = [];
    let ignored = 0;
    rows.forEach(r => {
      const lat = numFromAny(r[FIELD_LAT]);
      const lon = numFromAny(r[FIELD_LON]);
      if (isCoordInGT(lat, lon)) ok.push({ lat, lon, row: r });
      else ignored++;
    });
    return { ok, ignored };
  }

  function initFilters() {
    showOrHide("wrap-region", hasField(FIELD_REGION));
    showOrHide("wrap-municipio", hasField(FIELD_MUNICIPIO));
    showOrHide("wrap-area", hasField(FIELD_AREA));
    showOrHide("wrap-guarda", hasField(FIELD_GUARDA));
    showOrHide("wrap-tipo", hasField(FIELD_TIPO));
    showOrHide("wrap-ilegal", hasField(FIELD_ILEGAL));
    showOrHide("wrap-ubicacion", hasField(FIELD_UBIC));

    const years = Array.from(new Set(rawData.map(r => r._anio).filter(Boolean))).sort((a,b)=>a-b);
    fillSelect($("f-anio"), years.map(String), "Todos");

    // Mes depende del año seleccionado
    updateMesOptions();

    if (hasField(FIELD_REGION)) fillSelectPairs($("f-region"), uniquePairs(rawData, FIELD_REGION, "_c_region", "region"), "Todas");
    if (hasField(FIELD_MUNICIPIO)) fillSelectPairs($("f-municipio"), uniquePairs(rawData, FIELD_MUNICIPIO, "_c_municipio", "municipio"), "Todos");
    if (hasField(FIELD_AREA)) fillSelectPairs($("f-area"), uniquePairs(rawData, FIELD_AREA, "_c_area", "area"), "Todas");
    if (hasField(FIELD_GUARDA)) fillSelectPairs($("f-guarda"), uniquePairs(rawData, FIELD_GUARDA, "_c_guarda", "guarda"), "Todos");
    if (hasField(FIELD_TIPO)) fillSelectPairs($("f-tipo"), uniquePairs(rawData, FIELD_TIPO, "_c_tipo", "tipo"), "Todos");
    if (hasField(FIELD_ILEGAL)) fillSelectPairs($("f-ilegal"), uniquePairs(rawData, FIELD_ILEGAL, "_c_ilegal", "ilegal"), "Todas");
    if (hasField(FIELD_UBIC)) fillSelectPairs($("f-ubicacion"), uniquePairs(rawData, FIELD_UBIC, "_c_ubic", "ubic"), "Todas");
  }

  function updateMesOptions() {
    const anioEl = $("f-anio");
    const mesEl = $("f-mes");
    if (!anioEl || !mesEl) return;

    const anio = anioEl.value;
    const keys = new Set();
    rawData.forEach(r => {
      if (!r._monthKey) return;
      if (anio && String(r._anio) !== String(anio)) return;
      keys.add(r._monthKey);
    });
    const ordered = Array.from(keys).sort(); // YYYY-MM ordena bien lexicográficamente
    const pairs = ordered.map(k => ({ value: k, label: labelMonthKey(k) }));
    const current = mesEl.value;
    fillSelectPairs(mesEl, pairs, "Todos");
    if (current && ordered.includes(current)) mesEl.value = current;
  }

  function applyFilters() {
    const anio = $("f-anio").value;
    const mesKey = $("f-mes").value;
    const region = $("f-region").value;
    const municipio = $("f-municipio").value;
    const area = $("f-area").value;
    const guarda = $("f-guarda").value;
    const tipo = $("f-tipo").value;
    const ilegal = $("f-ilegal").value;
    const ubic = $("f-ubicacion").value;
    const q = ($("f-buscar").value || "").trim().toLowerCase();

    filteredData = rawData.filter(r => {
      if (anio && String(r._anio) !== String(anio)) return false;
      if (mesKey && r._monthKey !== mesKey) return false;

      if (region && (r._c_region || "") !== region) return false;
      if (municipio && (r._c_municipio || "") !== municipio) return false;
      if (area && (r._c_area || "") !== area) return false;
      if (guarda && (r._c_guarda || "") !== guarda) return false;
      if (tipo && (r._c_tipo || "") !== tipo) return false;
      if (ilegal && (r._c_ilegal || "") !== ilegal) return false;
      if (ubic && (r._c_ubic || "") !== ubic) return false;

      if (q) {
        const hay = Object.keys(r).some(k => {
          if (k.startsWith("_")) return false;
          const v = r[k];
          return v != null && String(v).toLowerCase().includes(q);
        });
        if (!hay) return false;
      }
      return true;
    });

    updateKpis();
    updateCharts();
    updateMap();
    updateTable();
    updateChips();
  }

  function selectedLabel(id) {
    const el = $(id);
    if (!el) return "";
    const opt = el.options[el.selectedIndex];
    if (!opt || !opt.value) return "";
    return opt.textContent || "";
  }

  function updateChips() {
    const chips = $("chips-filtros");
    if (!chips) return;
    chips.innerHTML = "";
    const mapping = [
      ["Año", $("f-anio").value],
      ["Mes", $("f-mes").value ? labelMonthKey($("f-mes").value) : ""],
      ["Región", selectedLabel("f-region")],
      ["Municipio", selectedLabel("f-municipio")],
      ["Área", selectedLabel("f-area")],
      ["Guardarrecursos", selectedLabel("f-guarda")],
      ["Tipo", selectedLabel("f-tipo")],
      ["Actividad ilegal", selectedLabel("f-ilegal")],
      ["Ubicación", selectedLabel("f-ubicacion")],
      ["Buscar", ($("f-buscar").value || "").trim()]
    ];

    mapping.forEach(([label, value]) => {
      if (!value) return;
      const el = document.createElement("span");
      el.className = "chip";
      el.innerHTML = `<b>${label}:</b> ${escapeHtml(String(value))}`;
      chips.appendChild(el);
    });
  }

  function updateKpis() {
    const total = filteredData.length;
    $("kpi-registros").textContent = total.toLocaleString("es-GT");

    // rango fechas
    const dates = filteredData.map(r => r._fechaObj).filter(Boolean).sort((a,b)=>a-b);
    if (!dates.length) {
      $("kpi-rango").textContent = "–";
    } else {
      const fmt = (d) => String(d.getDate()).padStart(2,"0") + "/" + String(d.getMonth()+1).padStart(2,"0") + "/" + d.getFullYear();
      $("kpi-rango").textContent = fmt(dates[0]) + " — " + fmt(dates[dates.length-1]);
    }

    // únicos
    const reg = hasField(FIELD_REGION) ? new Set(filteredData.map(r => (r._c_region||"")).filter(Boolean)).size : 0;
    const mun = hasField(FIELD_MUNICIPIO) ? new Set(filteredData.map(r => (r._c_municipio||"")).filter(Boolean)).size : 0;
    const ar = hasField(FIELD_AREA) ? new Set(filteredData.map(r => (r._c_area||"")).filter(Boolean)).size : 0;

    $("kpi-regiones").textContent = reg ? String(reg) : "–";
    $("kpi-municipios").textContent = mun ? String(mun) : "–";
    $("kpi-areas").textContent = ar ? String(ar) : "–";

    const coords = getValidCoords(filteredData);
    $("kpi-coords").textContent = coords.ok.length ? String(coords.ok.length) : "–";

    // Nota bajo el mapa (también sirve de diagnóstico de outliers)
    const note = $("map-note");
    if (note) {
      if (!hasField(FIELD_LAT) || !hasField(FIELD_LON)) {
        note.textContent = "Si el CSV no incluye coordenadas, el mapa se ocultará automáticamente.";
      } else if (coords.ignored) {
        note.textContent = `Mostrando puntos válidos. Se ignoraron ${coords.ignored} por inválidos/outliers.`;
      } else {
        note.textContent = "Mostrando puntos válidos del CSV.";
      }
    }
  }

  function groupCount(rows, keyFn) {
    const m = new Map();
    rows.forEach(r => {
      const k = keyFn(r);
      if (!k) return;
      m.set(k, (m.get(k) || 0) + 1);
    });
    return m;
  }

  function updateCharts() {
    // Serie temporal por mes (YYYY-MM)
    const byMonth = groupCount(filteredData, r => r._monthKey);
    const keys = Array.from(byMonth.keys()).sort();
    const counts = keys.map(k => byMonth.get(k));
    const prettyLabels = keys.map(labelMonthKey);

    const ctx1 = $("chart-tiempo");
    if (ctx1) {
      if (chartTiempo) chartTiempo.destroy();
      chartTiempo = new Chart(ctx1, {
        type: "line",
        data: {
          labels: prettyLabels,
          datasets: [{ label: "Registros", data: counts, tension: 0.2 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          onClick: (evt, elements) => {
            if (!elements || !elements.length) return;
            const idx = elements[0].index;
            const k = keys[idx];
            if (k) {
              $("f-mes").value = k;
              applyFilters();
            }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Distribución por tipo (top 10)
    const tipoFieldExists = hasField(FIELD_TIPO);
    const ctx2 = $("chart-tipo");
    if (ctx2) {
      if (chartTipo) chartTipo.destroy();
      if (!tipoFieldExists) {
        ctx2.parentElement.style.display = "none";
      } else {
        ctx2.parentElement.style.display = "";
        const byTipo = groupCount(filteredData, r => String(r[FIELD_TIPO] || "").trim());
        const entries = Array.from(byTipo.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const lbl = entries.map(e=>e[0] || "(vacío)");
        const dat = entries.map(e=>e[1]);
        chartTipo = new Chart(ctx2, {
          type: "bar",
          data: { labels: lbl, datasets: [{ label: "Registros", data: dat }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            onClick: (evt, elements) => {
              if (!elements || !elements.length) return;
              const idx = elements[0].index;
              const cat = lbl[idx];
              if (cat) {
                $("f-tipo").value = cat === "(vacío)" ? "" : cat;
                applyFilters();
              }
            },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }
  }

  function ensureMap() {
    const mapEl = $("map");
    if (!mapEl) return;

    if (!map) {
      map = L.map("map", { scrollWheelZoom: false });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);

      // altura estable
      mapEl.style.height = "340px";
    }
    setTimeout(() => { try { map.invalidateSize(); } catch (_) {} }, 50);
  }

  function updateMap() {
    const mapCard = $("map") ? $("map").closest(".card") : null;

    // Solo mostrar mapa si existe lat/lon en el CSV
    const hasCoords = hasField(FIELD_LAT) && hasField(FIELD_LON);
    if (!hasCoords) {
      if (mapCard) mapCard.style.display = "none";
      return;
    }
    if (mapCard) mapCard.style.display = "";

    ensureMap();
    if (!map || !markersLayer) return;

    markersLayer.clearLayers();

    const coords = getValidCoords(filteredData);
    const pts = coords.ok;

    if (!pts.length) {
      try { map.setView([15.5, -90.5], 7); } catch (_) {}
      return;
    }

    const bounds = [];
    pts.forEach(p => {
      const m = L.circleMarker([p.lat, p.lon], { radius: 5, weight: 1 });
      m.bindPopup(buildPopupHtml(p.row));
      m.addTo(markersLayer);
      bounds.push([p.lat, p.lon]);
    });

    try {
      map.fitBounds(bounds, { padding: [20, 20] });
    } catch (_) {}
  }

  function buildPopupHtml(row) {
    const items = [];
    function add(label, field) {
      if (!field) return;
      const v = row[field];
      if (v == null || String(v).trim() === "") return;
      items.push(`<div><b>${label}:</b> ${escapeHtml(String(v))}</div>`);
    }
    add("Fecha", FIELD_FECHA);
    add("Región", FIELD_REGION);
    add("Municipio", FIELD_MUNICIPIO);
    add("Área", FIELD_AREA);
    add("Guardarrecursos", FIELD_GUARDA);
    add("Tipo", FIELD_TIPO);
    add("Actividad ilegal", FIELD_ILEGAL);
    add("Ubicación", FIELD_UBIC);
    return `<div style="font-size:12px;line-height:1.25">${items.join("")}</div>`;
  }

  function escapeHtml(s) {
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function initTable() {
    const tableEl = $("tabla");
    if (!tableEl) return;

    const keys = rawData.length ? Object.keys(rawData[0]).filter(k => !k.startsWith("_")) : [];
    const columns = keys.map(k => ({
      title: k,
      field: k,
      headerFilter: "input",
      headerFilterPlaceholder: "Filtrar…",
      formatter: (cell) => {
        const v = cell.getValue();
        if (v == null) return "";
        return String(v);
      }
    }));

    table = new Tabulator("#tabla", {
      data: filteredData,
      layout: "fitColumns",
      height: "520px",
      placeholder: "No hay registros para los filtros seleccionados.",
      pagination: "local",
      paginationSize: 25,
      movableColumns: true,
      columns: columns
    });
  }

  function updateTable() {
    if (!table) return;
    table.replaceData(filteredData);
    try { table.redraw(true); } catch (_) {}
  }

  // -----------------------------
  // Buttons/actions
  // -----------------------------
  function resetFilters() {
    ["f-anio","f-mes","f-region","f-municipio","f-area","f-guarda","f-tipo","f-ilegal","f-ubicacion","f-buscar"].forEach(id => {
      const el = $(id);
      if (el) el.value = "";
    });
    updateMesOptions();
    applyFilters();
  }

  function downloadCSV() {
    if (!table) return;
    table.download("csv", "AC192_patrullajes_filtrados.csv");
  }

  function downloadXLSX() {
    if (!table || !window.XLSX) return;
    const rows = filteredData.map(r => {
      const out = {};
      Object.keys(r).forEach(k => { if (!k.startsWith("_")) out[k] = r[k]; });
      return out;
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "AC192");
    XLSX.writeFile(wb, "AC192_patrullajes_filtrados.xlsx");
  }

  function downloadGeoJSON() {
    const coords = getValidCoords(filteredData).ok;
    const features = coords.map(p => ({
      type: "Feature",
      geometry: { type: "Point", coordinates: [p.lon, p.lat] },
      properties: buildProperties(p.row)
    }));
    const gj = { type: "FeatureCollection", features };
    const blob = new Blob([JSON.stringify(gj, null, 2)], { type: "application/geo+json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "AC192_patrullajes_filtrados.geojson";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function buildProperties(row) {
    const props = {};
    Object.keys(row).forEach(k => { if (!k.startsWith("_")) props[k] = row[k]; });
    return props;
  }

  function centerMap() {
    updateMap(); // recalcula bounds
    showToast("Mapa centrado");
  }

  function removeChartFilter() {
    $("f-tipo").value = "";
    applyFilters();
  }

  function exportPDFLight() {
    // Crea contenedor temporal
    const tmp = document.createElement("div");
    tmp.style.padding = "10px";
    tmp.style.fontFamily = "Arial, sans-serif";

    const top = filteredData.slice(0, 15).map(r => {
      const fecha = r[FIELD_FECHA] || "";
      const mun = r[FIELD_MUNICIPIO] || "";
      const area = r[FIELD_AREA] || "";
      const tipo = r[FIELD_TIPO] || "";
      return `<tr><td>${escapeHtml(String(fecha))}</td><td>${escapeHtml(String(mun))}</td><td>${escapeHtml(String(area))}</td><td>${escapeHtml(String(tipo))}</td></tr>`;
    }).join("");

    tmp.innerHTML = `
      <h2 style="margin:0 0 6px 0">AC192 · Patrullajes (reporte liviano)</h2>
      <div style="font-size:12px;margin-bottom:8px">
        <b>Registros:</b> ${escapeHtml($("kpi-registros").textContent)} ·
        <b>Rango:</b> ${escapeHtml($("kpi-rango").textContent)} ·
        <b>Con coords:</b> ${escapeHtml($("kpi-coords").textContent)}
      </div>
      <div style="font-size:12px;margin-bottom:8px"><b>Filtros:</b> ${escapeHtml(($("chips-filtros").textContent || "Sin filtros").trim() || "Sin filtros")}</div>
      <table style="width:100%;border-collapse:collapse;font-size:11px">
        <thead><tr>
          <th style="border:1px solid #ddd;padding:4px;text-align:left">Fecha</th>
          <th style="border:1px solid #ddd;padding:4px;text-align:left">Municipio</th>
          <th style="border:1px solid #ddd;padding:4px;text-align:left">Área</th>
          <th style="border:1px solid #ddd;padding:4px;text-align:left">Tipo</th>
        </tr></thead>
        <tbody>${top || ""}</tbody>
      </table>
      <div style="font-size:10px;margin-top:8px;color:#555">Generado: ${new Date().toLocaleString("es-GT")}</div>
    `;

    document.body.appendChild(tmp);

    const opt = {
      margin: 10,
      filename: "AC192_patrullajes_reporte_liviano.pdf",
      image: { type: "jpeg", quality: 0.95 },
      html2canvas: { scale: 1.6, useCORS: true },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf().set(opt).from(tmp).save().then(() => {
      tmp.remove();
    }).catch(() => {
      tmp.remove();
    });
  }

  function initEvents() {
    // cambios de filtros
    const ids = ["f-anio","f-mes","f-region","f-municipio","f-area","f-guarda","f-tipo","f-ilegal","f-ubicacion"];
    ids.forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener("change", () => {
        if (id === "f-anio") updateMesOptions();
        applyFilters();
      });
    });

    $("f-buscar").addEventListener("input", () => applyFilters());
    $("btn-reset").addEventListener("click", resetFilters);
    $("btn-csv").addEventListener("click", downloadCSV);
    $("btn-xlsx").addEventListener("click", downloadXLSX);
    $("btn-geojson").addEventListener("click", downloadGeoJSON);
    $("btn-centrar").addEventListener("click", centerMap);
    $("btn-clear-chart").addEventListener("click", removeChartFilter);
    $("btn-pdf").addEventListener("click", exportPDFLight);
  }

  // -----------------------------
  // Main load
  // -----------------------------
  async function loadData() {
    setEstado("Cargando librerías…");
    await ensureDependencies();

    setEstado("Cargando datos…");
    try {
      const { url, buffer } = await fetchFirstOk(CSV_CANDIDATES);
      const csvText = decodeSmartCsv(buffer);
      const delimiter = detectarDelimitador(csvText);

      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        delimiter: delimiter,
        transformHeader: (h) => String(h || "").trim()
      });

      rawData = (parsed.data || []).filter(r => r && Object.keys(r).some(k => String(r[k] || "").trim() !== ""));
      if (!rawData.length) {
        setEstado("No se encontraron datos en el CSV.", true);
        return;
      }

      prepararHintsFechas(rawData);
      rawData.forEach(r => {
        const dt = parseFechaFlexible(r[FIELD_FECHA], r._dateHint);
        r._fechaObj = dt;
        r._anio = dt ? dt.getFullYear() : null;
        r._monthKey = dt ? monthKey(dt) : null;
        // campos canónicos (para deduplicar filtros)
        r._c_region = canonField(r[FIELD_REGION], "region");
        r._c_municipio = canonField(r[FIELD_MUNICIPIO], "municipio");
        r._c_area = canonField(r[FIELD_AREA], "area");
        r._c_guarda = canonField(r[FIELD_GUARDA], "guarda");
        r._c_tipo = canonField(r[FIELD_TIPO], "tipo");
        r._c_ilegal = canonField(r[FIELD_ILEGAL], "ilegal");
        r._c_ubic = canonField(r[FIELD_UBIC], "ubic");

      });

      initFilters();
      initTable();
      initEvents();
      applyFilters();

      setEstado("Listo · CSV: " + url.replace(/\?.*$/,""));
      showToast("Datos cargados");
    } catch (e) {
      console.error(e);
      setEstado("Error al cargar datos: " + e.message, true);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadData().catch(err => {
      console.error(err);
      setEstado("Error inicial: " + err.message, true);
    });
  });
})();
</script>
</body>
</html>
