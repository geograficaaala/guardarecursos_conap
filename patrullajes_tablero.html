<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC192 · Patrullajes - Tablero dinámico (CSV)</title>

  <!-- Tabulator local (repo) -->
  <link rel="stylesheet" href="tabulator.min.css">

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- html2pdf (CDN) para PDF multipágina -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      /* Pastel institucional verde/azul */
      --verde-header:#34d399;
      --verde-header-2:#60a5fa;

      --azul-boton:#2563eb;
      --azul-boton-hover:#1d4ed8;

      --gris-fondo:#f4f7fb;
      --texto-principal:#0f172a;
      --texto-secundario:#475569;
      --borde-suave: rgba(148,163,184,0.35);
      --card-radius:16px;

      /* Charts (sin bordes negros) */
      --chart-grid: rgba(2,6,23,0.08);
      --chart-tick: rgba(15,23,42,0.85);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto-principal);

      background:
        radial-gradient(circle at 10% 15%, rgba(52,211,153,0.28) 0, transparent 55%),
        radial-gradient(circle at 90% 30%, rgba(96,165,250,0.25) 0, transparent 55%),
        radial-gradient(circle at 40% 95%, rgba(14,165,233,0.12) 0, transparent 60%),
        linear-gradient(180deg, #f7fbff 0%, var(--gris-fondo) 45%, #f2fbf7 100%);

      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      background: linear-gradient(90deg, rgba(16,185,129,0.95), rgba(59,130,246,0.95));
      color:#fff;
      padding:14px 20px 18px;
      box-shadow:0 6px 24px rgba(15,23,42,.14);
      position:sticky; top:0; z-index:50;
    }

    .header-inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; flex-wrap:wrap;
    }

    .logo-group{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background-color: rgba(255,255,255,0.12);
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
    }

    .logo-group img{
      height:40px; max-width:130px; object-fit:contain;
      background-color:#fff; border-radius:999px; padding:4px 8px;
      box-shadow:0 2px 6px rgba(15,23,42,.18);
    }

    .title-group{ text-align:right; flex:1 1 260px;}
    .title-group h1{ margin:0 0 2px; font-size:22px; letter-spacing:.02em;}
    .title-group p{ margin:0; font-size:13px; opacity:.96; line-height:1.4;}

    main{
      max-width:1100px; width:100%;
      margin:16px auto 0;
      padding:0 20px 40px;
      flex:1 0 auto;
    }

    .page-header{ margin-bottom:10px; }
    .page-header h2{ margin:0 0 6px; font-size:20px;}
    .page-header p{ margin:2px 0; font-size:14px; color:var(--texto-secundario);}

    .pill{
      display:inline-block; margin-top:6px;
      padding:3px 10px; font-size:11px; border-radius:999px;
      background-color: rgba(37,99,235,0.08);
      color:#1d4ed8;
      border:1px solid rgba(191,219,254,0.9);
      text-transform:uppercase; letter-spacing:.08em;
    }

    .topnav{
      position: sticky;
      top: 82px;
      z-index: 40;
      margin: 12px 0 14px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:center;
      margin:0;
    }

    .tab{
      text-decoration:none;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(255,255,255,0.95);
      color:#0f172a;
      font-weight:750;
      font-size:13px;
    }

    .tab:hover{ background:#eef6ff; border-color:rgba(59,130,246,0.35); }

    .tab.active{
      background:var(--azul-boton);
      border-color:transparent;
      color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.16);
    }

    .nav-actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      margin-top:10px;
    }

    .card{
      background: rgba(255,255,255,0.92);
      border-radius:var(--card-radius);
      border:1px solid var(--borde-suave);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:16px;
      margin-bottom:14px;
      overflow:hidden;
      position:relative;
    }

    .card.soft{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.98));
    }

    .card::before{
      content:"";
      position:absolute; left:-60px; top:-70px;
      width:170px; height:170px; border-radius:999px;
      background: radial-gradient(circle, rgba(56,189,248,.10), transparent 65%);
      pointer-events:none;
    }

    .subnote{ margin:0; color:var(--texto-secundario); font-size:13px; }

    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-12{ grid-column:span 12; }
    .col-6{ grid-column:span 6; }

    .chartwrap{ height:360px; }
    .chartwrap.tall{ height:380px; }
    canvas{ width:100% !important; height:100% !important; }

    .filters{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      align-items:end;
      margin-top:10px;
    }

    .field{ grid-column: span 3; min-width:160px; }
    .field.wide{ grid-column: span 4; }

    label{
      display:block; font-size:12px; color:var(--texto-secundario);
      font-weight:900; margin-bottom:6px;
    }

    .hint{ font-weight:800; opacity:.8; }

    select, input{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background:#fff;
      font-size:14px;
      outline:none;
    }

    input.small{
      padding:7px 10px;
      border-radius:12px;
      background: rgba(241,245,249,.7);
      margin-bottom:6px;
    }

    select:focus, input:focus{
      border-color: rgba(59,130,246,0.55);
      box-shadow:0 0 0 3px rgba(59,130,246,.12);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; font-size:14px;
      border-radius:999px; text-decoration:none;
      cursor:pointer; border:1px solid transparent;
      font-weight:800;
      transition: background-color .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      user-select:none;
      white-space:nowrap;
    }

    .btn-primary{
      background-color:var(--azul-boton); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }

    .btn-primary:hover{
      background-color:var(--azul-boton-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.16);
    }

    .btn-ghost{
      background-color:rgba(255,255,255,.95);
      color:#0f172a;
      border-color: rgba(148,163,184,0.45);
    }

    .btn-ghost:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,.10);
    }

    .btn-warn{
      background: rgba(16,185,129,0.95); color:#fff;
      box-shadow:0 1px 3px rgba(15,23,42,.14);
    }

    .btn-warn:hover{
      background: rgba(5,150,105,0.98);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.14);
    }

    .kpis{
      display:grid; grid-template-columns:repeat(12,1fr); gap:12px;
    }

    .kpi{
      grid-column: span 2;
      border:1px solid rgba(148,163,184,0.35);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(248,250,252,.98));
      min-height:88px;
    }

    .kpi .t{ font-size:12px; color:var(--texto-secundario); font-weight:950; letter-spacing:.02em;}
    .kpi .v{ font-size:20px; font-weight:950; margin-top:6px; }
    .kpi .s{ font-size:12px; color:var(--texto-secundario); margin-top:2px; }

    .tablewrap{ overflow-x:auto; }

    .cardhead{
      display:flex; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .cardhead h3{ margin:0; }

    .mini-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }

    .mini-btn{
      padding:7px 10px;
      font-size:13px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:800;
    }

    .mini-btn:hover{
      background:#eef6ff;
      border-color: rgba(59,130,246,0.35);
      box-shadow:0 3px 10px rgba(15,23,42,.10);
    }

    .infobox{
      border:1px solid rgba(59,130,246,.18);
      background: rgba(219,234,254,.40);
      border-radius:14px;
      padding:10px 12px;
      color:#0f172a;
      font-size:13px;
      margin-top:10px;
    }

    .infobox b{ font-weight:900; }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      justify-content:center;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,0.85);
      font-size:12px;
      font-weight:700;
      color:#0f172a;
    }

    .chip b{ font-weight:800; }

    footer{
      text-align:center;
      font-size:12px;
      color:#64748b;
      padding:10px 20px 18px;
      border-top:1px solid rgba(148,163,184,0.25);
      background-color:rgba(248,250,252,.9);
      margin-top:auto;
    }

    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 10px 25px rgba(15,23,42,.30);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:9999;
    }

    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    @media (max-width: 980px){
      .field{ grid-column: span 12; min-width:unset; }
      .field.wide{ grid-column: span 12; }
      .kpi{ grid-column: span 6; }
      .col-6{ grid-column: span 12; }
      .title-group{ text-align:center; }
      .header-inner{ justify-content:center; }
      .topnav{ top: 116px; }
      .chartwrap{ height: 340px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="logo-group">
        <img src="conap_logo.jpg" alt="Logo CONAP">
        <img src="aala_logo.png" alt="Logo Laboratorio SIG AALA">
      </div>
      <div class="title-group">
        <h1>Centro de consulta de datos</h1>
        <p>Sistema de monitoreo de actividades</p>
        <p>CONAP – Dirección Regional Altiplano Central</p>
      </div>
    </div>
  </header>

  <main>
    <section class="page-header">
      <h2>AC192 · Patrullajes de control y vigilancia · Tablero dinámico</h2>
      <p>Este tablero se genera automáticamente desde <strong>datos_patrullaje.csv</strong> y permite filtrar y graficar.</p>
      <span class="pill">Tablero dinámico · CSV</span>
    </section>

    <section class="topnav" aria-label="Navegación y acciones del módulo">
      <nav class="tabs" aria-label="Navegación del módulo">
        <a class="tab" href="patrullajes_dashboard.html">Dashboard geográfico</a>
        <a class="tab active" href="patrullajes_tablero.html">Tablero dinámico</a>
        <a class="tab" href="patrullajes_datos.html">Tabla de datos</a>
      </nav>

      <div class="nav-actions">
        <a class="btn btn-ghost" href="index.html">Inicio</a>
        <a class="btn btn-ghost" href="patrullajes_dashboard.html">Dashboard</a>
        <a class="btn btn-primary" href="patrullajes_datos.html">Ir a Tabla</a>

        <button class="btn btn-ghost" id="btn-reset" type="button">Limpiar filtros</button>
        <button class="btn btn-ghost" id="btn-copy" type="button">Copiar enlace</button>
        <button class="btn btn-warn" id="btn-pdf" type="button">Generar informe PDF</button>
      </div>

      <div class="infobox" style="text-align:center;">
        <b>Sugerencia:</b> haga clic sobre una barra (Top municipios/guardas o serie temporal) para aplicar un filtro adicional.
        <div class="chips" id="chips-filtros" aria-label="Resumen de filtros"></div>
      </div>

      <p class="subnote" id="estado" style="margin-top:10px; text-align:center;">Cargando datos…</p>
    </section>

    <section class="card soft">
      <div class="filters">
        <div class="field wide">
          <label for="f-temporal">Filtro temporal</label>
          <select id="f-temporal">
            <option value="todo">Todo</option>
            <option value="mes">Por mes</option>
            <option value="semana">Por semana (ISO)</option>
            <option value="rango">Rango de fechas</option>
          </select>
        </div>

        <div class="field" id="wrap-mes" style="display:none;">
          <label for="f-mes">Mes</label>
          <select id="f-mes"></select>
        </div>

        <div class="field" id="wrap-semana" style="display:none;">
          <label for="f-semana">Semana</label>
          <select id="f-semana"></select>
        </div>

        <div class="field" id="wrap-desde" style="display:none;">
          <label for="f-desde">Desde</label>
          <input id="f-desde" type="date" />
        </div>

        <div class="field" id="wrap-hasta" style="display:none;">
          <label for="f-hasta">Hasta</label>
          <input id="f-hasta" type="date" />
        </div>

        <div class="field">
          <label for="f-guarda">Guarda recursos <span class="hint">(buscable)</span></label>
          <input id="s-guarda" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-guarda"></select>
        </div>

        <div class="field">
          <label for="f-muni">Municipio <span class="hint">(buscable)</span></label>
          <input id="s-muni" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-muni"></select>
        </div>

        <div class="field">
          <label for="f-region">Región <span class="hint">(buscable)</span></label>
          <input id="s-region" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-region"></select>
        </div>

        <div class="field">
          <label for="f-area">Área protegida <span class="hint">(buscable)</span></label>
          <input id="s-area" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-area"></select>
        </div>

        <div class="field">
          <label for="f-tipo">Tipo patrullaje <span class="hint">(buscable)</span></label>
          <input id="s-tipo" class="small" type="search" placeholder="Buscar..." autocomplete="off">
          <select id="f-tipo"></select>
        </div>

        <div class="field">
          <label for="f-ilegal">Actividad ilegal</label>
          <select id="f-ilegal">
            <option value="todo">Todas</option>
            <option value="si">Sí</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="field">
          <label for="f-inst">Instituciones</label>
          <select id="f-inst">
            <option value="todo">Todas</option>
            <option value="si">Con instituciones</option>
            <option value="no">Sin instituciones</option>
          </select>
        </div>

        <div class="field">
          <label for="f-agrupar">Agrupar serie</label>
          <select id="f-agrupar">
            <option value="dia">Día</option>
            <option value="semana">Semana</option>
            <option value="mes">Mes</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="t">Registros (filtrados)</div>
          <div class="v" id="k-total">–</div>
          <div class="s" id="k-total-s">–</div>
        </div>
        <div class="kpi">
          <div class="t">Municipios únicos</div>
          <div class="v" id="k-munis">–</div>
          <div class="s">en el filtro actual</div>
        </div>
        <div class="kpi">
          <div class="t">Guardas únicos</div>
          <div class="v" id="k-guardas">–</div>
          <div class="s">en el filtro actual</div>
        </div>
        <div class="kpi">
          <div class="t">% Actividad ilegal</div>
          <div class="v" id="k-pct-ilegal">–</div>
          <div class="s">sobre filtrados</div>
        </div>
        <div class="kpi">
          <div class="t">Horas (válidas)</div>
          <div class="v" id="k-horas">–</div>
          <div class="s">suma duraciones</div>
        </div>
        <div class="kpi">
          <div class="t">% Coordenadas válidas</div>
          <div class="v" id="k-coord">–</div>
          <div class="s">Lat/Lon o X/Y</div>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="card col-12">
        <div class="cardhead">
          <div>
            <h3 style="margin:0 0 6px;">Patrullajes en el tiempo</h3>
            <p class="subnote" style="margin:0;">Serie según el agrupamiento seleccionado.</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-tiempo" type="button">Exportar PNG</button>
          </div>
        </div>
        <div class="chartwrap tall"><canvas id="c-tiempo"></canvas></div>
      </div>

      <div class="card col-6">
        <div class="cardhead">
          <div>
            <h3 style="margin:0 0 6px;">Top municipios</h3>
            <p class="subnote" style="margin:0;">Top 10 por registros (filtro actual).</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-muni" type="button">Exportar PNG</button>
          </div>
        </div>
        <div class="chartwrap"><canvas id="c-muni"></canvas></div>
      </div>

      <div class="card col-6">
        <div class="cardhead">
          <div>
            <h3 style="margin:0 0 6px;">Top guardarecursos</h3>
            <p class="subnote" style="margin:0;">Top 10 por registros (filtro actual).</p>
          </div>
          <div class="mini-actions">
            <button class="mini-btn" id="png-guarda" type="button">Exportar PNG</button>
          </div>
        </div>
        <div class="chartwrap"><canvas id="c-guarda"></canvas></div>
      </div>
    </section>

    <section class="card">
      <div class="cardhead">
        <div>
          <h3 style="margin:0 0 6px;">Tabla pivote (Guarda × Periodo)</h3>
          <p class="subnote" style="margin:0;">Filas: guarda · Columnas: periodo (día/semana/mes) · Valores: conteo.</p>
        </div>
        <div class="mini-actions">
          <button class="mini-btn" id="piv-csv" type="button">CSV</button>
          <button class="mini-btn" id="piv-xlsx" type="button">Excel</button>
        </div>
      </div>
      <div class="tablewrap">
        <div id="tabla-pivote"></div>
      </div>
    </section>

    <section class="card">
      <div class="cardhead">
        <div>
          <h3 style="margin:0 0 6px;">Registros filtrados</h3>
          <p class="subnote" style="margin:0;">Tabla completa filtrada (exporta lo filtrado).</p>
        </div>
        <div class="mini-actions">
          <button class="mini-btn" id="btn-dl-csv" type="button">CSV</button>
          <button class="mini-btn" id="btn-dl-xlsx" type="button">Excel</button>
          <button class="mini-btn" id="btn-dl-json" type="button">JSON</button>
        </div>
      </div>
      <div class="tablewrap" style="margin-top:12px;">
        <div id="tabla-registros"></div>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2026 Laboratorio SIG AALA en apoyo a CONAP – Dirección Regional Altiplano Central</p>
  </footer>

  <div class="toast" id="toast">Listo</div>

  <!-- Librerías locales (repo) -->
  <script src="papaparse.min.js"></script>
  <script src="tabulator.min.js"></script>
  <script src="xlsx.full.min.js"></script>

  <script>
    // ===== CSV config =====
    const CSV_URL = "./datos_patrullaje.csv";
    const DELIM = ";";

    // Campos esperados
    const F = {
      fecha: "Fecha de patrullaje",
      guarda: "Guarda recursos responsable",
      municipio: "Municipio",
      region: "Region",
      area: "Area protegida",
      tipo: "Tipo de patrullaje",
      ilegal: "Actividad ilegal observada",
      hayInst: "Hay mas instituciones involucradas en el patrullaje",
      inst: "Instituciones involucradas",
      otraInst: "Otra (especifique)",
      hIni: "Hora de Inicio del patrullaje",
      hFin: "Hora de finalizacion de patrullaje",
      ubic: "Ubicacion",
      lon: "Longitud",
      lat: "Latitud",
      x: "X",
      y: "Y",
    };

    let DATA = [];
    let chartTiempo = null, chartMuni = null, chartGuarda = null;
    let tPivote = null, tRegistros = null;

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);

    const estado = $("estado");

    const fTemporal = $("f-temporal");
    const wrapMes = $("wrap-mes");
    const wrapSemana = $("wrap-semana");
    const wrapDesde = $("wrap-desde");
    const wrapHasta = $("wrap-hasta");

    const fMes = $("f-mes");
    const fSemana = $("f-semana");
    const fDesde = $("f-desde");
    const fHasta = $("f-hasta");

    const fGuarda = $("f-guarda");
    const fMuni = $("f-muni");
    const fRegion = $("f-region");
    const fArea = $("f-area");
    const fTipo = $("f-tipo");
    const fIlegal = $("f-ilegal");
    const fInst = $("f-inst");
    const fAgrupar = $("f-agrupar");

    // buscadores
    const sGuarda = $("s-guarda");
    const sMuni = $("s-muni");
    const sRegion = $("s-region");
    const sArea = $("s-area");
    const sTipo = $("s-tipo");

    // KPIs
    const kTotal = $("k-total");
    const kTotalS = $("k-total-s");
    const kMunis = $("k-munis");
    const kGuardas = $("k-guardas");
    const kPctIlegal = $("k-pct-ilegal");
    const kHoras = $("k-horas");
    const kCoord = $("k-coord");

    // Chips resumen filtros
    const chipsFiltros = $("chips-filtros");

    // Toast
    const toast = $("toast");
    let toastTimer = null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 1600);
    }

    // ===== Sonido sutil (WebAudio) =====
    const SFX = (() => {
      let ctx = null;
      function playClick(){
        try{
          ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
          const t0 = ctx.currentTime;
          const o  = ctx.createOscillator();
          const g  = ctx.createGain();

          o.type = "sine";
          o.frequency.setValueAtTime(520, t0);
          o.frequency.exponentialRampToValueAtTime(420, t0 + 0.08);

          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(0.03, t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.09);

          o.connect(g);
          g.connect(ctx.destination);

          o.start(t0);
          o.stop(t0 + 0.10);
        }catch(e){}
      }
      return { playClick };
    })();

    // ===== Helpers =====
    function norm(s){ return String(s || "").trim(); }
    function normalizar(t){
      return String(t || "").toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function isNum(v){ return v !== null && v !== "" && isFinite(Number(v)); }
    function safeNum(v){
      if (v === null || v === undefined) return null;
      const s = String(v).trim().replace(",", ".");
      if(!s) return null;
      const n = Number(s);
      return isFinite(n) ? n : null;
    }

    // Fecha: soporta "8/13/2025 18:00" y "13/8/2025 18:00" y "YYYY-MM-DD"
    function extraerFechaCompleta(fechaRaw){
      if (!fechaRaw) return null;
      let str = String(fechaRaw).trim();
      if (!str) return null;
      if (str.includes(" ")) str = str.split(" ")[0];
      if (str.includes("T")) str = str.split("T")[0];

      const mIso = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (mIso){
        const y = +mIso[1], mo = +mIso[2], d = +mIso[3];
        const dt = new Date(y, mo-1, d);
        if (isNaN(dt.getTime())) return null;
        return { anio:y, mes:mo, dia:d, date: dt };
      }

      const sep = str.includes("/") ? "/" : (str.includes("-") ? "-" : null);
      if (!sep) return null;
      const partes = str.split(sep);
      if (partes.length < 3) return null;

      let p1 = parseInt(partes[0], 10);
      let p2 = parseInt(partes[1], 10);
      let anio = parseInt(partes[2], 10);
      if (isNaN(p1) || isNaN(p2) || isNaN(anio)) return null;

      let mes, dia;
      if (p1 > 12 && p2 >= 1 && p2 <= 12) { dia = p1; mes = p2; }
      else { mes = p1; dia = p2; }

      if (mes < 1 || mes > 12 || dia < 1 || dia > 31) return null;
      const dt = new Date(anio, mes-1, dia);
      if (isNaN(dt.getTime())) return null;
      return { anio, mes, dia, date: dt };
    }

    function isoWeekKey(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${pad2(weekNo)}`;
    }

    function parseHoraMin(h){
      if(!h) return null;
      const s = String(h).trim().replace(".", ":");
      const m = s.match(/(\d{1,2}):(\d{2})/);
      if(!m) return null;
      const hh = parseInt(m[1],10), mm = parseInt(m[2],10);
      if(!isFinite(hh)||!isFinite(mm)||hh<0||hh>23||mm<0||mm>59) return null;
      return hh*60+mm;
    }

    function duracionHoras(reg){
      const a = parseHoraMin(reg[F.hIni]);
      const b = parseHoraMin(reg[F.hFin]);
      if(a==null || b==null) return null;
      let diff = b - a;
      if(diff < 0) diff += 24*60;
      return diff/60;
    }

    function tieneInstituciones(reg){
      const hay = normalizar(reg[F.hayInst]);
      if (hay === "si" || hay === "sí") return true;
      if (norm(reg[F.inst]).length) return true;
      if (norm(reg[F.otraInst]).length) return true;
      return false;
    }

    function esIlegal(reg){
      const v = normalizar(reg[F.ilegal]);
      if (!v) return false;
      if (v === "no") return false;
      return true;
    }

    function uniqueSorted(arr){
      return Array.from(new Set(arr.map(norm).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"es"));
    }

    function llenarSelect(select, valores, placeholder){
      if(!select) return;
      select.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "todo";
      o0.textContent = placeholder || "Todos";
      select.appendChild(o0);

      valores.forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        select.appendChild(o);
      });
    }

    function setTemporalUI(){
      const v = fTemporal.value;
      wrapMes.style.display = (v === "mes") ? "" : "none";
      wrapSemana.style.display = (v === "semana") ? "" : "none";
      wrapDesde.style.display = (v === "rango") ? "" : "none";
      wrapHasta.style.display = (v === "rango") ? "" : "none";
    }

    function aplicarFiltros(){
      let out = DATA.slice();

      // Temporal
      const t = fTemporal.value;
      if (t === "mes" && fMes.value !== "todo"){
        out = out.filter(r => r.__ym === fMes.value);
      } else if (t === "semana" && fSemana.value !== "todo"){
        out = out.filter(r => r.__yw === fSemana.value);
      } else if (t === "rango"){
        const d1 = fDesde.value ? new Date(fDesde.value + "T00:00:00") : null;
        const d2 = fHasta.value ? new Date(fHasta.value + "T23:59:59") : null;
        out = out.filter(r=>{
          if (!r.__date) return false;
          if (d1 && r.__date < d1) return false;
          if (d2 && r.__date > d2) return false;
          return true;
        });
      }

      // Dimensiones
      if (fGuarda.value !== "todo") out = out.filter(r => r.__guarda === fGuarda.value);
      if (fMuni.value !== "todo") out = out.filter(r => r.__muni === fMuni.value);
      if (fRegion.value !== "todo") out = out.filter(r => r.__region === fRegion.value);
      if (fArea.value !== "todo") out = out.filter(r => r.__area === fArea.value);
      if (fTipo.value !== "todo") out = out.filter(r => r.__tipo === fTipo.value);

      // Ilegal
      if (fIlegal.value === "si") out = out.filter(r => r.__ilegal === "si");
      if (fIlegal.value === "no") out = out.filter(r => r.__ilegal === "no");

      // Instituciones
      if (fInst.value === "si") out = out.filter(r => r.__inst === "si");
      if (fInst.value === "no") out = out.filter(r => r.__inst === "no");

      return out;
    }

    function actualizarKPIs(rows){
      const total = rows.length;
      kTotal.textContent = total.toLocaleString("es");
      kTotalS.textContent = `De ${DATA.length.toLocaleString("es")} registros totales`;

      const munis = new Set(rows.map(r=>r.__muni).filter(Boolean));
      const guardas = new Set(rows.map(r=>r.__guarda).filter(Boolean));
      kMunis.textContent = munis.size.toLocaleString("es");
      kGuardas.textContent = guardas.size.toLocaleString("es");

      const ilegalSi = rows.filter(r=>r.__ilegal === "si").length;
      const pct = total ? Math.round((ilegalSi*1000)/total)/10 : 0;
      kPctIlegal.textContent = total ? (pct.toLocaleString("es") + "%") : "—";

      const horas = rows.map(r=>r.__durH).filter(v=>v!=null && isFinite(v)).reduce((a,b)=>a+b, 0);
      kHoras.textContent = horas ? (Math.round(horas*10)/10).toLocaleString("es") : "—";

      // Coordenadas válidas: Lat/Lon preferido, si no X/Y
      const coordLatLon = rows.filter(r => safeNum(r[F.lat])!=null && safeNum(r[F.lon])!=null).length;
      const coordXY     = rows.filter(r => isNum(r[F.x]) && isNum(r[F.y])).length;
      const valid = Math.max(coordLatLon, coordXY);
      const pctCoord = total ? Math.round((valid*1000)/total)/10 : 0;
      kCoord.textContent = total ? (pctCoord.toLocaleString("es") + "%") : "—";
    }

    function countBy(rows, keyFn){
      const m = new Map();
      rows.forEach(r=>{
        const k = keyFn(r);
        if(!k) return;
        m.set(k, (m.get(k)||0)+1);
      });
      return m;
    }

    function topN(map, n){
      return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
    }

    // Fondo blanco para exportar PNG/PDF
    const whiteBgPlugin = {
      id: "white-bg",
      beforeDraw: (chart) => {
        const {ctx, width, height} = chart;
        ctx.save();
        ctx.globalCompositeOperation = "destination-over";
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, width, height);
        ctx.restore();
      }
    };

    // Paleta pastel
    const PASTEL = ["#A7F3D0","#BFDBFE","#FDE68A","#FBCFE8","#DDD6FE","#FED7AA","#CFFAFE","#E9D5FF","#FFE4E6","#E5E7EB"];
    function pastelArray(n){
      const out = [];
      for(let i=0;i<n;i++) out.push(PASTEL[i % PASTEL.length]);
      return out;
    }

    const STROKE = "rgba(15,23,42,0.35)";
    const NO_STROKE = "rgba(15,23,42,0)";

    function applyPastelToDatasets(cfg){
      if(!cfg || !cfg.data || !cfg.data.datasets) return cfg;

      cfg.data.datasets.forEach((ds)=>{
        const n = Array.isArray(ds.data) ? ds.data.length : 1;
        const colors = pastelArray(n);

        if(cfg.type === "bar"){
          ds.backgroundColor = colors;
          ds.borderColor = NO_STROKE;
          ds.borderWidth = 0;
          ds.borderSkipped = false;
        } else {
          ds.backgroundColor = colors[0];
          ds.borderColor = STROKE;
          ds.borderWidth = 1.5;
          ds.pointBackgroundColor = colors[0];
          ds.pointBorderColor = NO_STROKE;
          ds.pointBorderWidth = 0;
          ds.pointRadius = 3.5;
          ds.tension = 0.25;
        }
      });

      return cfg;
    }

    function commonChartOptions(extra){
      const tick = getComputedStyle(document.documentElement).getPropertyValue("--chart-tick").trim() || "rgba(15,23,42,0.85)";
      const grid = getComputedStyle(document.documentElement).getPropertyValue("--chart-grid").trim() || "rgba(2,6,23,0.08)";

      const base = {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:true, labels:{ color: tick } },
          tooltip:{ borderWidth: 0 }
        },
        scales:{
          x:{ ticks:{ color: tick }, grid:{ color: grid } },
          y:{ beginAtZero:true, ticks:{ color: tick }, grid:{ color: grid } }
        }
      };
      return Object.assign({}, base, extra || {});
    }

    function renderChart(canvasId, prev, cfg){
      const el = $(canvasId);
      if(!el) return prev;
      const ctx = el.getContext("2d");
      if(prev) prev.destroy();

      cfg = applyPastelToDatasets(cfg);
      cfg.options = commonChartOptions(cfg.options);

      return new Chart(ctx, cfg);
    }

    function actualizarCharts(rows){
      const agr = fAgrupar.value; // dia/semana/mes
      const keyFn = (agr === "mes") ? (r=>r.__ym) : (agr === "semana") ? (r=>r.__yw) : (r=>r.__yd);
      const mTiempo = countBy(rows, keyFn);
      const labelsT = Array.from(mTiempo.keys()).sort();
      const dataT = labelsT.map(k=>mTiempo.get(k));

      chartTiempo = renderChart("c-tiempo", chartTiempo, {
        type:"bar",
        data:{ labels: labelsT, datasets:[{ label:"Patrullajes", data: dataT }] },
        plugins:[whiteBgPlugin],
        options:{
          onClick:(evt, elements)=>{
            if(!elements || !elements.length) return;
            SFX.playClick();

            const idx = elements[0].index;
            const label = labelsT[idx];

            if(agr === "mes"){
              fTemporal.value = "mes";
              setTemporalUI();
              fMes.value = label;
            } else if(agr === "semana"){
              fTemporal.value = "semana";
              setTemporalUI();
              fSemana.value = label;
            } else {
              fTemporal.value = "rango";
              setTemporalUI();
              fDesde.value = label;
              fHasta.value = label;
            }
            refrescar(true);
          }
        }
      });

      const mM = countBy(rows, r=>r.__muni || "(Sin municipio)");
      const topM = topN(mM, 10);
      const labelsM = topM.map(x=>x[0]);

      chartMuni = renderChart("c-muni", chartMuni, {
        type:"bar",
        data:{ labels: labelsM, datasets:[{ label:"Registros", data: topM.map(x=>x[1]) }] },
        plugins:[whiteBgPlugin],
        options:{
          indexAxis:"y",
          onClick:(evt, elements)=>{
            if(!elements || !elements.length) return;
            SFX.playClick();

            const idx = elements[0].index;
            const label = labelsM[idx];
            fMuni.value = label;
            refrescar(true);
          },
          scales:{ x:{ beginAtZero:true } }
        }
      });

      const mG = countBy(rows, r=>r.__guarda || "(Sin guarda)");
      const topG = topN(mG, 10);
      const labelsG = topG.map(x=>x[0]);

      chartGuarda = renderChart("c-guarda", chartGuarda, {
        type:"bar",
        data:{ labels: labelsG, datasets:[{ label:"Registros", data: topG.map(x=>x[1]) }] },
        plugins:[whiteBgPlugin],
        options:{
          indexAxis:"y",
          onClick:(evt, elements)=>{
            if(!elements || !elements.length) return;
            SFX.playClick();

            const idx = elements[0].index;
            const label = labelsG[idx];
            fGuarda.value = label;
            refrescar(true);
          },
          scales:{ x:{ beginAtZero:true } }
        }
      });
    }

    function construirPivote(rows){
      const agr = fAgrupar.value;
      const keyCol = (agr === "mes") ? "__ym" : (agr === "semana") ? "__yw" : "__yd";

      const colSet = new Set();
      const map = new Map();

      rows.forEach(r=>{
        const rowKey = r.__guarda || "(Sin guarda)";
        const colKey = r[keyCol] || "(Sin fecha)";
        colSet.add(colKey);

        if(!map.has(rowKey)) map.set(rowKey, { guarda: rowKey });
        const obj = map.get(rowKey);
        obj[colKey] = (obj[colKey] || 0) + 1;
      });

      const cols = Array.from(colSet).sort((a,b)=>a.localeCompare(b));
      const data = Array.from(map.values()).sort((a,b)=>a.guarda.localeCompare(b.guarda,"es"));

      const tabCols = [
        { title:"Guarda recurso", field:"guarda", frozen:true, headerFilter:"input", minWidth:220 },
        ...cols.map(c=>({ title:c, field:c, hozAlign:"right" }))
      ];

      return { tabCols, data };
    }

    function actualizarTablas(rows){
      const piv = construirPivote(rows);
      if(!tPivote){
        tPivote = new Tabulator("#tabla-pivote", {
          data: piv.data,
          columns: piv.tabCols,
          layout:"fitDataStretch",
          pagination:"local",
          paginationSize: 15,
          paginationSizeSelector: [15, 30, 50, 100],
          movableColumns:true
        });
      } else {
        tPivote.setColumns(piv.tabCols);
        tPivote.setData(piv.data);
      }

      const cols = [
        {title:"Fecha", field:F.fecha, headerFilter:"input", width:160},
        {title:"Guarda", field:F.guarda, headerFilter:"input", minWidth:220},
        {title:"Municipio", field:F.municipio, headerFilter:"input", width:160},
        {title:"Región", field:F.region, headerFilter:"input", width:140},
        {title:"Área", field:F.area, headerFilter:"input", width:160},
        {title:"Tipo", field:F.tipo, headerFilter:"input", width:170},
        {title:"Ilegal", field:F.ilegal, headerFilter:"input", width:160},
        {title:"Instituciones", field:F.inst, headerFilter:"input", minWidth:220},
        {title:"Inicio", field:F.hIni, headerFilter:"input", width:120},
        {title:"Fin", field:F.hFin, headerFilter:"input", width:120},
        {title:"Ubicación", field:F.ubic, headerFilter:"input", minWidth:220},
      ];

      if(!tRegistros){
        tRegistros = new Tabulator("#tabla-registros", {
          data: rows,
          columns: cols,
          layout:"fitDataStretch",
          pagination:"local",
          paginationSize: 20,
          paginationSizeSelector: [10, 20, 50, 100, 200],
          movableColumns:true
        });
      } else {
        tRegistros.setData(rows);
      }
    }

    // ===== URL state =====
    function getState(){
      return {
        temporal: fTemporal.value,
        mes: fMes.value,
        semana: fSemana.value,
        desde: fDesde.value,
        hasta: fHasta.value,
        guarda: fGuarda.value,
        muni: fMuni.value,
        region: fRegion.value,
        area: fArea.value,
        tipo: fTipo.value,
        ilegal: fIlegal.value,
        inst: fInst.value,
        agrupar: fAgrupar.value
      };
    }

    function setURLFromState(){
      const s = getState();
      const p = new URLSearchParams();

      if(s.temporal !== "todo") p.set("temporal", s.temporal);
      if(s.mes && s.mes !== "todo") p.set("mes", s.mes);
      if(s.semana && s.semana !== "todo") p.set("semana", s.semana);
      if(s.desde) p.set("desde", s.desde);
      if(s.hasta) p.set("hasta", s.hasta);
      if(s.guarda !== "todo") p.set("guarda", s.guarda);
      if(s.muni !== "todo") p.set("muni", s.muni);
      if(s.region !== "todo") p.set("region", s.region);
      if(s.area !== "todo") p.set("area", s.area);
      if(s.tipo !== "todo") p.set("tipo", s.tipo);
      if(s.ilegal !== "todo") p.set("ilegal", s.ilegal);
      if(s.inst !== "todo") p.set("inst", s.inst);
      if(s.agrupar !== "dia") p.set("agrupar", s.agrupar);

      const newUrl = location.pathname + (p.toString() ? ("?" + p.toString()) : "");
      history.replaceState(null, "", newUrl);
    }

    function applyURLToControls(){
      const p = new URLSearchParams(location.search);

      const temporal = p.get("temporal");
      if(temporal && ["todo","mes","semana","rango"].includes(temporal)) fTemporal.value = temporal;

      setTemporalUI();

      const agr = p.get("agrupar");
      if(agr && ["dia","semana","mes"].includes(agr)) fAgrupar.value = agr;

      const mes = p.get("mes");
      if(mes) fMes.value = mes;

      const semana = p.get("semana");
      if(semana) fSemana.value = semana;

      const desde = p.get("desde");
      const hasta = p.get("hasta");
      if(desde) fDesde.value = desde;
      if(hasta) fHasta.value = hasta;

      const setIfExists = (sel, val) => {
        if(!val) return;
        const opt = Array.from(sel.options).some(o=>o.value === val);
        if(opt) sel.value = val;
      };

      setIfExists(fGuarda, p.get("guarda"));
      setIfExists(fMuni, p.get("muni"));
      setIfExists(fRegion, p.get("region"));
      setIfExists(fArea, p.get("area"));
      setIfExists(fTipo, p.get("tipo"));
      setIfExists(fIlegal, p.get("ilegal"));
      setIfExists(fInst, p.get("inst"));
    }

    // ===== Searchable selects =====
    const fullOptions = new Map();

    function cacheOptions(select, placeholder){
      if(!select) return;
      const values = Array.from(select.options)
        .map(o=>o.value)
        .filter(v=>v && v !== "todo");
      fullOptions.set(select.id, { placeholder, values });
    }

    function filterSelect(select, q){
      if(!select) return;
      const info = fullOptions.get(select.id);
      if(!info) return;

      const cur = select.value;
      const qq = normalizar(q);

      const filtered = info.values.filter(v=>{
        if(!qq) return true;
        return normalizar(v).includes(qq);
      });

      llenarSelect(select, filtered, info.placeholder);

      const still = Array.from(select.options).some(o=>o.value === cur);
      if(still) select.value = cur;
    }

    // ===== Export helpers =====
    function downloadDataUrl(dataUrl, filename){
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function exportChartPNG(chart, name){
      if(!chart) return;
      const url = chart.toBase64Image("image/png", 1);
      downloadDataUrl(url, name);
    }

    function resumenFiltrosTexto(){
      const parts = [];
      const t = fTemporal.value;
      if(t === "todo") parts.push("Temporal: Todo");
      if(t === "mes") parts.push("Temporal: Mes " + (fMes.value || "—"));
      if(t === "semana") parts.push("Temporal: Semana " + (fSemana.value || "—"));
      if(t === "rango") parts.push("Temporal: " + (fDesde.value||"—") + " a " + (fHasta.value||"—"));

      if(fGuarda.value !== "todo") parts.push("Guarda: " + fGuarda.value);
      if(fMuni.value !== "todo") parts.push("Municipio: " + fMuni.value);
      if(fRegion.value !== "todo") parts.push("Región: " + fRegion.value);
      if(fArea.value !== "todo") parts.push("Área: " + fArea.value);
      if(fTipo.value !== "todo") parts.push("Tipo: " + fTipo.value);
      if(fIlegal.value !== "todo") parts.push("Ilegal: " + (fIlegal.value === "si" ? "Sí" : "No"));
      if(fInst.value !== "todo") parts.push("Instituciones: " + (fInst.value === "si" ? "Con" : "Sin"));
      parts.push("Agrupar: " + fAgrupar.value);
      return parts.join(" · ");
    }

    function escapeHtml(texto) {
      return String(texto || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderChipsResumen(){
      if(!chipsFiltros) return;

      const chips = [];

      const t = fTemporal.value;
      if(t === "todo")   chips.push(["Temporal", "Todo"]);
      if(t === "mes")    chips.push(["Temporal", "Mes: " + (fMes.value || "—")]);
      if(t === "semana") chips.push(["Temporal", "Semana: " + (fSemana.value || "—")]);
      if(t === "rango")  chips.push(["Temporal", "Rango: " + (fDesde.value||"—") + " a " + (fHasta.value||"—")]);

      if(fMuni.value   !== "todo") chips.push(["Municipio", fMuni.value]);
      if(fGuarda.value !== "todo") chips.push(["Guarda recurso", fGuarda.value]);
      if(fRegion.value !== "todo") chips.push(["Región", fRegion.value]);
      if(fArea.value   !== "todo") chips.push(["Área protegida", fArea.value]);
      if(fTipo.value   !== "todo") chips.push(["Tipo patrullaje", fTipo.value]);
      if(fIlegal.value !== "todo") chips.push(["Actividad ilegal", (fIlegal.value === "si" ? "Sí" : "No")]);
      if(fInst.value   !== "todo") chips.push(["Instituciones", (fInst.value === "si" ? "Con" : "Sin")]);

      chips.push(["Agrupar", fAgrupar.value]);

      chipsFiltros.innerHTML = chips.map(([k, v]) =>
        `<span class="chip"><b>${escapeHtml(k)}:</b> ${escapeHtml(v)}</span>`
      ).join("");
    }

    function topList(rows, key, n){
      const m = countBy(rows, r=>r[key] || "(Sin dato)");
      return topN(m, n);
    }

    // ===== Informe textual + heatmap =====
    function fmtNum(n){ return (n ?? 0).toLocaleString("es"); }
    function fmtPct(num, den){
      if(!den) return "—";
      const pct = Math.round((num * 1000) / den) / 10;
      return pct.toLocaleString("es") + "%";
    }
    function fmtDateES(d){
      try{ return d.toLocaleDateString("es", {year:"numeric", month:"long", day:"2-digit"}); }
      catch(e){ return String(d || ""); }
    }

    function topItemsText(rows, key, n=5){
      const total = rows.length || 0;
      const m = countBy(rows, r => r[key] || "(Sin dato)");
      const top = topN(m, n);
      if(!top.length) return "Sin datos suficientes para ranking.";
      return top.map(([k,v], i)=>{
        const p = total ? Math.round((v*1000)/total)/10 : 0;
        return `${i+1}) ${k}: ${fmtNum(v)} (${p.toLocaleString("es")}%)`;
      }).join("; ");
    }

    function computeStatsForReport(rows){
      const total = rows.length;

      const withDate = rows.filter(r => r.__date instanceof Date && !isNaN(r.__date.getTime()));
      const dates = withDate.map(r => r.__date.getTime()).sort((a,b)=>a-b);
      const minDate = dates.length ? new Date(dates[0]) : null;
      const maxDate = dates.length ? new Date(dates[dates.length-1]) : null;

      const ilegalSi = rows.filter(r=>r.__ilegal==="si").length;
      const instSi   = rows.filter(r=>r.__inst==="si").length;

      const horasArr = rows.map(r=>r.__durH).filter(v=>v!=null && isFinite(v));
      const horasSum = horasArr.reduce((a,b)=>a+b, 0);
      const horasAvg = horasArr.length ? (horasSum/horasArr.length) : null;

      const coordLatLon = rows.filter(r => safeNum(r[F.lat])!=null && safeNum(r[F.lon])!=null).length;
      const coordXY     = rows.filter(r => isNum(r[F.x]) && isNum(r[F.y])).length;

      const munis = new Set(rows.map(r=>r.__muni).filter(Boolean)).size;
      const guardas = new Set(rows.map(r=>r.__guarda).filter(Boolean)).size;

      return {
        total, minDate, maxDate, withDateCount: withDate.length,
        ilegalSi, instSi,
        horasSum, horasAvg, horasCount: horasArr.length,
        coordLatLon, coordXY,
        munis, guardas
      };
    }

    function generarHeatmapDataUrl(rows){
      let pts = rows.map(r=>{
        const lat = safeNum(r[F.lat]);
        const lon = safeNum(r[F.lon]);
        if(lat==null || lon==null) return null;
        return { lat, lon };
      }).filter(Boolean);

      let mode = "latlon";
      if(pts.length < 3){
        const ptsXY = rows.map(r=>{
          const x = safeNum(r[F.x]);
          const y = safeNum(r[F.y]);
          if(x==null || y==null) return null;
          return { x, y };
        }).filter(Boolean);
        if(ptsXY.length >= 3){
          mode = "xy";
          pts = ptsXY;
        }
      }

      if(pts.length < 3){
        return { dataUrl:"", mode:"none", count: pts.length };
      }

      const W = 1000, H = 550;
      const pad = 18;

      let minA=Infinity, maxA=-Infinity, minB=Infinity, maxB=-Infinity;
      pts.forEach(p=>{
        const a = (mode==="latlon") ? p.lon : p.x;
        const b = (mode==="latlon") ? p.lat : p.y;
        minA = Math.min(minA,a); maxA = Math.max(maxA,a);
        minB = Math.min(minB,b); maxB = Math.max(maxB,b);
      });
      if(minA === maxA) { minA -= 1; maxA += 1; }
      if(minB === maxB) { minB -= 1; maxB += 1; }

      const c = document.createElement("canvas");
      c.width = W; c.height = H;
      const ctx = c.getContext("2d");

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,W,H);

      // grilla suave
      ctx.strokeStyle = "rgba(15,23,42,0.06)";
      ctx.lineWidth = 1;
      for(let i=0;i<=10;i++){
        const x = pad + i*(W-2*pad)/10;
        ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x,H-pad); ctx.stroke();
      }
      for(let i=0;i<=6;i++){
        const y = pad + i*(H-2*pad)/6;
        ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
      }

      const off = document.createElement("canvas");
      off.width = W; off.height = H;
      const octx = off.getContext("2d");
      octx.clearRect(0,0,W,H);

      const radius = 26;
      const alphaPerPoint = Math.min(0.08, 10/Math.max(pts.length,10));

      function toPx(p){
        const a = (mode==="latlon") ? p.lon : p.x;
        const b = (mode==="latlon") ? p.lat : p.y;
        const x = pad + ((a - minA) / (maxA - minA)) * (W - 2*pad);
        const y = pad + (1 - ((b - minB) / (maxB - minB))) * (H - 2*pad);
        return {x,y};
      }

      pts.forEach(p=>{
        const {x,y} = toPx(p);
        const g = octx.createRadialGradient(x,y,0, x,y, radius);
        g.addColorStop(0, `rgba(0,0,0,${alphaPerPoint})`);
        g.addColorStop(1, "rgba(0,0,0,0)");
        octx.fillStyle = g;
        octx.fillRect(x-radius, y-radius, radius*2, radius*2);
      });

      const grad = document.createElement("canvas");
      grad.width = 256; grad.height = 1;
      const gctx = grad.getContext("2d");
      const lg = gctx.createLinearGradient(0,0,256,0);
      lg.addColorStop(0.00, "#1e3a8a");
      lg.addColorStop(0.25, "#06b6d4");
      lg.addColorStop(0.50, "#22c55e");
      lg.addColorStop(0.75, "#f59e0b");
      lg.addColorStop(1.00, "#ef4444");
      gctx.fillStyle = lg;
      gctx.fillRect(0,0,256,1);
      const gradData = gctx.getImageData(0,0,256,1).data;

      const img = octx.getImageData(0,0,W,H);
      const d = img.data;
      for(let i=0;i<d.length;i+=4){
        const a = d[i+3];
        if(a === 0) continue;
        const idx = a; // 0..255
        d[i]   = gradData[idx*4];
        d[i+1] = gradData[idx*4+1];
        d[i+2] = gradData[idx*4+2];
        d[i+3] = 255;
      }
      ctx.putImageData(img,0,0);

      ctx.strokeStyle = "rgba(148,163,184,0.55)";
      ctx.lineWidth = 2;
      ctx.strokeRect(1,1,W-2,H-2);

      ctx.fillStyle = "#0f172a";
      ctx.font = "600 11pt system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";
      ctx.fillText("Mapa de calor (densidad de patrullajes)", pad, 22);

      const lx = W - pad - 240, ly = 18, lw = 220, lh = 12;
      ctx.drawImage(grad, lx, ly, lw, lh);
      ctx.strokeStyle = "rgba(148,163,184,0.65)";
      ctx.lineWidth = 1;
      ctx.strokeRect(lx, ly, lw, lh);
      ctx.font = "10pt system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";
      ctx.fillText("Baja", lx, ly+28);
      ctx.fillText("Alta", lx+lw-22, ly+28);

      ctx.font = "10pt system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";
      const modeLabel = (mode==="latlon")
        ? `Coordenadas: Latitud/Longitud (n=${pts.length})`
        : `Coordenadas: X/Y (plano) (n=${pts.length})`;
      ctx.fillText(modeLabel, pad, H - 10);

      return { dataUrl: c.toDataURL("image/png", 1.0), mode, count: pts.length };
    }

    function construirInformeHTML({rows, imgs, heat, stats, stamp}){
      const filtros = escapeHtml(resumenFiltrosTexto());

      // Contexto dinámico según filtros (intersección AND)
      const ctxParts = [];
      if (fGuarda.value !== "todo") ctxParts.push(`El análisis se restringe al guarda recurso responsable: ${fGuarda.value}.`);
      if (fMuni.value   !== "todo") ctxParts.push(`Municipio seleccionado: ${fMuni.value}.`);
      if (fRegion.value !== "todo") ctxParts.push(`Región seleccionada: ${fRegion.value}.`);
      if (fArea.value   !== "todo") ctxParts.push(`Área protegida seleccionada: ${fArea.value}.`);
      if (fTipo.value   !== "todo") ctxParts.push(`Tipo de patrullaje seleccionado: ${fTipo.value}.`);
      if (fIlegal.value !== "todo") ctxParts.push(`Actividad ilegal: ${fIlegal.value === "si" ? "Sí" : "No"}.`);
      if (fInst.value   !== "todo") ctxParts.push(`Instituciones: ${fInst.value === "si" ? "Con" : "Sin"}.`);

      const contextoTxt = ctxParts.length
        ? ctxParts.join(" ")
        : "No se aplicaron filtros por dimensiones; se consideran los registros del universo seleccionado por el filtro temporal/operativo vigente.";

      // Rango temporal efectivo
      const rango = (stats.minDate && stats.maxDate)
        ? `El periodo analizado abarca del ${fmtDateES(stats.minDate)} al ${fmtDateES(stats.maxDate)} (n=${fmtNum(stats.withDateCount)} registros con fecha válida).`
        : `No fue posible determinar el rango temporal por falta de fechas válidas (registros con fecha válida: n=${fmtNum(stats.withDateCount)}).`;

      // Coordenadas
      const coordTxt = (heat.mode==="latlon")
        ? `Se identificaron ${fmtNum(stats.coordLatLon)} registros con coordenadas Latitud/Longitud válidas para el análisis espacial.`
        : (heat.mode==="xy")
          ? `No hubo suficientes Latitud/Longitud; se usaron coordenadas X/Y como plano. Registros con X/Y válidas: ${fmtNum(stats.coordXY)}.`
          : `No hubo coordenadas suficientes para construir el mapa de calor. Lat/Lon válidas: ${fmtNum(stats.coordLatLon)}; X/Y válidas: ${fmtNum(stats.coordXY)}.`;

      const horasTxt = stats.horasCount
        ? `La duración total acumulada (solo registros con horas válidas) fue de ${Math.round(stats.horasSum*10)/10} horas, con un promedio de ${Math.round(stats.horasAvg*10)/10} horas por registro válido.`
        : `No se calcularon duraciones por ausencia de horas válidas.`;

      const ilegalTxt = `Se registró “actividad ilegal” en ${fmtNum(stats.ilegalSi)} de ${fmtNum(stats.total)} registros (${fmtPct(stats.ilegalSi, stats.total)}).`;
      const instTxt   = `Participación de instituciones: ${fmtNum(stats.instSi)} de ${fmtNum(stats.total)} registros (${fmtPct(stats.instSi, stats.total)}).`;

      const mostrarTopMuni   = (fMuni.value === "todo");
      const mostrarTopGuarda = (fGuarda.value === "todo");

      const topMuni = topItemsText(rows, "__muni", 5);
      const topGua  = topItemsText(rows, "__guarda", 5);
      const topArea = topItemsText(rows, "__area", 5);
      const topTipo = topItemsText(rows, "__tipo", 5);

      return `
        <style>
          .report{
            font-family: "Times New Roman", Times, serif;
            font-size: 10pt;
            line-height: 1.0;
            color: #000;
            text-align: justify;
            background: #fff;
            padding: 14px;
          }

          .r-head{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
          .r-logos{display:flex; gap:8px; align-items:center;}
          .r-logos img{height:34px; background:#fff; border-radius:999px; padding:3px 6px; border:1px solid rgba(148,163,184,0.75);}
          .muted{color:#111; opacity:.75; margin:0;}

          .title{font-weight:700; font-size:12pt; margin:10px 0 2px; text-align:left;}
          .chip{
            display:inline-block; padding:4px 10px; border:1px solid rgba(148,163,184,0.85);
            border-radius:999px; margin-top:6px; font-weight:700;
          }

          .sec{margin-top:10px;}
          .h1{font-weight:700; margin:10px 0 4px;}
          .h2{font-weight:700; margin:8px 0 4px;}
          .p{margin:0 0 6px;}

          .kgrid{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:8px;}
          .k{border:1px solid rgba(148,163,184,0.85); padding:8px; border-radius:8px;}
          .k .t{font-weight:700; margin:0 0 2px;}
          .k .v{margin:0;}

          figure{margin:10px 0; page-break-inside:avoid;}
          .figimg{width:100%; border:1px solid rgba(148,163,184,0.85); border-radius:10px; display:block;}
          .figcap{margin-top:4px; font-weight:700; text-align:left;}

          .pagebreak{page-break-after:always;}

          .sigpage{
            min-height: 260mm;
            display:flex;
            flex-direction:column;
            justify-content:flex-end;
            align-items:center;
            text-align:center;
          }
          .sigline{
            width: 70%;
            border-top: 1px solid rgba(148,163,184,0.95);
            margin: 40px auto 6px;
          }
          .sigsmall{margin:0;}
        </style>

        <div class="report">
          <div class="r-head">
            <div class="r-logos">
              <img src="conap_logo.jpg" alt="CONAP">
              <img src="aala_logo.png" alt="AALA">
            </div>
            <p class="muted">Generado: ${escapeHtml(stamp)}</p>
          </div>

          <div class="title">Informe técnico · Patrullajes de control y vigilancia (AC192)</div>
          <p class="muted">Fuente: datos_patrullaje.csv · Módulo “Tablero dinámico”</p>
          <div class="chip">${filtros}</div>

          <div class="sec kgrid">
            <div class="k"><p class="t">Registros (filtrados)</p><p class="v">${fmtNum(stats.total)}</p></div>
            <div class="k"><p class="t">Municipios únicos</p><p class="v">${fmtNum(stats.munis)}</p></div>
            <div class="k"><p class="t">Guardas únicos</p><p class="v">${fmtNum(stats.guardas)}</p></div>
            <div class="k"><p class="t">% Actividad ilegal</p><p class="v">${fmtPct(stats.ilegalSi, stats.total)}</p></div>
            <div class="k"><p class="t">% Con instituciones</p><p class="v">${fmtPct(stats.instSi, stats.total)}</p></div>
            <div class="k"><p class="t">Horas válidas (suma)</p><p class="v">${stats.horasCount ? (Math.round(stats.horasSum*10)/10).toLocaleString("es") : "—"}</p></div>
          </div>

          <div class="sec">
            <div class="h1"><b>1. Introducción</b></div>
            <p class="p">
              El presente informe técnico describe el comportamiento de los patrullajes registrados en el sistema,
              con base en el subconjunto resultante de los filtros aplicados en el tablero. Se presenta un resumen cuantitativo,
              tendencias temporales, distribución espacial (mapa de calor) y principales categorías operativas.
            </p>
          </div>

          <div class="sec">
            <div class="h1"><b>2. Metodología</b></div>

            <div class="h2"><b>2.1 Fuente de datos</b></div>
            <p class="p">
              Se utilizó el archivo <i>datos_patrullaje.csv</i>, procesado localmente en el navegador. Los campos utilizados incluyen:
              fecha de patrullaje, guarda responsable, municipio, región, área protegida, tipo de patrullaje, variables de ilegalidad,
              instituciones y coordenadas.
            </p>

            <div class="h2"><b>2.2 Criterios de filtrado</b></div>
            <p class="p">
              Los resultados corresponden estrictamente al estado actual de filtros del tablero. ${escapeHtml(contextoTxt)} ${rango}
            </p>

            <div class="h2"><b>2.3 Tratamiento de coordenadas</b></div>
            <p class="p">
              ${coordTxt} Para la visualización espacial se construyó un mapa de calor (densidad) a partir de las coordenadas
              asociadas a los registros filtrados.
            </p>
          </div>

          <div class="pagebreak"></div>

          <div class="sec">
            <div class="h1"><b>3. Resultados</b></div>

            <div class="h2"><b>3.1 Resumen técnico del subconjunto filtrado</b></div>
            <p class="p">
              Se analizaron ${fmtNum(stats.total)} registros filtrados, correspondientes a ${fmtNum(stats.munis)} municipios y
              ${fmtNum(stats.guardas)} guardarecursos. ${ilegalTxt} ${instTxt} ${horasTxt}
            </p>

            ${mostrarTopMuni ? `<p class="p"><b>Municipios con mayor frecuencia (Top 5):</b> ${escapeHtml(topMuni)}.</p>` : ``}
            ${mostrarTopGuarda ? `<p class="p"><b>Guardarecursos con mayor frecuencia (Top 5):</b> ${escapeHtml(topGua)}.</p>` : ``}
            <p class="p"><b>Áreas protegidas con mayor frecuencia (Top 5):</b> ${escapeHtml(topArea)}.</p>
            <p class="p"><b>Tipos de patrullaje con mayor frecuencia (Top 5):</b> ${escapeHtml(topTipo)}.</p>

            <div class="h2"><b>3.2 Tendencia temporal</b></div>
            ${imgs.tiempo ? `
              <figure>
                <img class="figimg" src="${imgs.tiempo}" alt="Tendencia temporal">
                <div class="figcap"><b>Figura 1.</b> Patrullajes en el tiempo (según agrupamiento seleccionado).</div>
              </figure>
            ` : `<p class="p muted">No se dispone de la gráfica temporal.</p>`}
          </div>

          <div class="pagebreak"></div>

          <div class="sec">
            <div class="h2"><b>3.3 Distribución espacial (mapa de calor)</b></div>
            ${heat.dataUrl ? `
              <figure>
                <img class="figimg" src="${heat.dataUrl}" alt="Mapa de calor">
                <div class="figcap"><b>Figura 2.</b> Mapa de calor (densidad) de registros filtrados con coordenadas válidas.</div>
              </figure>
            ` : `<p class="p muted">No se generó el mapa de calor por falta de coordenadas suficientes.</p>`}

            <div class="h2"><b>3.4 Principales categorías operativas</b></div>

            ${imgs.muni && mostrarTopMuni ? `
              <figure>
                <img class="figimg" src="${imgs.muni}" alt="Top municipios">
                <div class="figcap"><b>Figura 3.</b> Top municipios por registros (filtro actual).</div>
              </figure>
            ` : ``}

            ${imgs.guarda && mostrarTopGuarda ? `
              <figure>
                <img class="figimg" src="${imgs.guarda}" alt="Top guardarecursos">
                <div class="figcap"><b>Figura 4.</b> Top guardarecursos por registros (filtro actual).</div>
              </figure>
            ` : ``}
          </div>

          <div class="pagebreak"></div>

          <div class="sec">
            <div class="h1"><b>4. Observaciones y limitaciones</b></div>
            <p class="p">
              (a) Los porcentajes y agregados se calculan únicamente sobre el subconjunto filtrado. (b) El análisis de duración depende
              de la consistencia de las horas de inicio y fin. (c) El componente espacial depende de la presencia y validez de coordenadas.
            </p>

            <div class="h1"><b>5. Conclusiones</b></div>
            <p class="p">
              Con base en los filtros aplicados, el comportamiento operativo se caracteriza por la distribución temporal observada, la
              concentración relativa por dimensiones seleccionadas y la densidad espacial cuando existen coordenadas válidas.
            </p>
          </div>

          <div class="pagebreak"></div>

          <div class="sigpage">
            <div class="h1" style="width:100%; text-align:left;"><b>6. Firmas</b></div>
            <p class="sigsmall"><b>V.o.B.o.</b></p>
            <div class="sigline"></div>
            <p class="sigsmall"><b>Ing. Juan Carlos Bocel Chiroy</b></p>
            <p class="sigsmall">Director de RUMCLA – Altiplano Central</p>
          </div>
        </div>
      `;
    }

    async function generarInformePDFTextual(){
      if(typeof html2pdf === "undefined"){
        showToast("No se cargó html2pdf.");
        return;
      }

      const rows = aplicarFiltros();

      const imgs = {
        tiempo: chartTiempo ? chartTiempo.toBase64Image("image/png", 1) : "",
        muni:   chartMuni   ? chartMuni.toBase64Image("image/png", 1) : "",
        guarda: chartGuarda ? chartGuarda.toBase64Image("image/png", 1) : ""
      };

      const heat = generarHeatmapDataUrl(rows);
      const stats = computeStatsForReport(rows);
      const stamp = new Date().toLocaleString("es");

      const wrap = document.createElement("div");
      wrap.innerHTML = construirInformeHTML({rows, imgs, heat, stats, stamp});
      document.body.appendChild(wrap);

      const opt = {
        margin:       10,
        filename:     "informe_tecnico_patrullajes_AC192.pdf",
        image:        { type: "png", quality: 1.0 },
        html2canvas:  { scale: 2.6, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak:    { mode: ["css", "legacy"] }
      };

      try{
        await html2pdf().set(opt).from(wrap).save();
        showToast("Informe PDF generado");
      }catch(e){
        console.error(e);
        showToast("Error generando PDF");
      }finally{
        document.body.removeChild(wrap);
      }
    }

    // ===== Refresh =====
    function refrescar(updateURL){
      const rows = aplicarFiltros();
      actualizarKPIs(rows);
      actualizarCharts(rows);
      actualizarTablas(rows);
      renderChipsResumen();
      if(updateURL) setURLFromState();
    }

    function limpiarFiltros(){
      fTemporal.value = "todo";
      fMes.value = "todo";
      fSemana.value = "todo";
      fDesde.value = "";
      fHasta.value = "";
      fGuarda.value = "todo";
      fMuni.value = "todo";
      fRegion.value = "todo";
      fArea.value = "todo";
      fTipo.value = "todo";
      fIlegal.value = "todo";
      fInst.value = "todo";
      fAgrupar.value = "dia";

      sGuarda.value = ""; sMuni.value = ""; sRegion.value = ""; sArea.value = ""; sTipo.value = "";

      setTemporalUI();

      filterSelect(fGuarda, "");
      filterSelect(fMuni, "");
      filterSelect(fRegion, "");
      filterSelect(fArea, "");
      filterSelect(fTipo, "");

      refrescar(true);
    }

    function wire(){
      setTemporalUI();

      // Sonido sutil para clicks en acciones
      document.addEventListener("click", (e) => {
        const el = e.target.closest(".btn, .mini-btn, .tab");
        if(!el) return;
        SFX.playClick();
      }, { passive:true });

      const watchers = [fTemporal,fMes,fSemana,fDesde,fHasta,fGuarda,fMuni,fRegion,fArea,fTipo,fIlegal,fInst,fAgrupar];
      watchers.forEach(el=>{
        el.addEventListener("change", ()=>{
          if(el === fTemporal) setTemporalUI();
          refrescar(true);
        });
      });

      $("btn-reset").addEventListener("click", limpiarFiltros);

      $("btn-dl-csv").addEventListener("click", ()=>{
        if(tRegistros) tRegistros.download("csv", "patrullajes_filtrado.csv");
      });
      $("btn-dl-xlsx").addEventListener("click", ()=>{
        if(tRegistros) tRegistros.download("xlsx", "patrullajes_filtrado.xlsx", {sheetName:"Filtrado"});
      });
      $("btn-dl-json").addEventListener("click", ()=>{
        if(tRegistros) tRegistros.download("json", "patrullajes_filtrado.json");
      });

      $("piv-csv").addEventListener("click", ()=>{
        if(tPivote) tPivote.download("csv", "pivote_guarda_periodo.csv");
      });
      $("piv-xlsx").addEventListener("click", ()=>{
        if(tPivote) tPivote.download("xlsx", "pivote_guarda_periodo.xlsx", {sheetName:"Pivote"});
      });

      $("png-tiempo").addEventListener("click", ()=> exportChartPNG(chartTiempo, "patrullajes_tiempo.png"));
      $("png-muni").addEventListener("click", ()=> exportChartPNG(chartMuni, "patrullajes_top_municipios.png"));
      $("png-guarda").addEventListener("click", ()=> exportChartPNG(chartGuarda, "patrullajes_top_guardas.png"));

      $("btn-copy").addEventListener("click", async ()=>{
        setURLFromState();
        const url = location.origin + location.pathname + location.search;
        try{
          await navigator.clipboard.writeText(url);
          showToast("Enlace copiado");
        }catch(e){
          const ta = document.createElement("textarea");
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          showToast("Enlace copiado");
        }
      });

      // Informe PDF textual (dinámico según filtros)
      $("btn-pdf").addEventListener("click", generarInformePDFTextual);

      sGuarda.addEventListener("input", ()=> filterSelect(fGuarda, sGuarda.value));
      sMuni.addEventListener("input", ()=> filterSelect(fMuni, sMuni.value));
      sRegion.addEventListener("input", ()=> filterSelect(fRegion, sRegion.value));
      sArea.addEventListener("input", ()=> filterSelect(fArea, sArea.value));
      sTipo.addEventListener("input", ()=> filterSelect(fTipo, sTipo.value));
    }

    async function load(){
      if(typeof Papa === "undefined"){
        estado.textContent = "No se cargó papaparse.min.js (debe existir en el repo).";
        return;
      }
      if(typeof Tabulator === "undefined"){
        estado.textContent = "No se cargó tabulator.min.js (debe existir en el repo).";
        return;
      }
      if(typeof Chart === "undefined"){
        estado.textContent = "No se cargó Chart.js.";
        return;
      }

      Chart.defaults.devicePixelRatio = 2;

      estado.textContent = "Leyendo datos_patrullaje.csv…";
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
      const csvText = await res.text();

      const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true, delimiter: DELIM });
      const rows = (parsed.data || []).filter(r => r && Object.keys(r).some(k => norm(r[k])));

      DATA = rows.map(r=>{
        const info = extraerFechaCompleta(r[F.fecha]);
        const d = info ? info.date : null;

        const ym = info ? (info.anio + "-" + pad2(info.mes)) : "";
        const yd = info ? (info.anio + "-" + pad2(info.mes) + "-" + pad2(info.dia)) : "";
        const yw = d ? isoWeekKey(d) : "";

        const guarda = norm(r[F.guarda]) || "(Sin guarda)";
        const muni = norm(r[F.municipio]) || "(Sin municipio)";
        const region = norm(r[F.region]) || "(Sin región)";
        const area = norm(r[F.area]) || "(Sin área)";
        const tipo = norm(r[F.tipo]) || "(Sin tipo)";

        const ilegal = esIlegal(r) ? "si" : "no";
        const inst = tieneInstituciones(r) ? "si" : "no";

        const coordLatLon = (safeNum(r[F.lat]) != null) && (safeNum(r[F.lon]) != null);
        const coordXY = isNum(r[F.x]) && isNum(r[F.y]);
        const coordOk = coordLatLon || coordXY;

        r.__date = d;
        r.__ym = ym;
        r.__yd = yd;
        r.__yw = yw;
        r.__guarda = guarda;
        r.__muni = muni;
        r.__region = region;
        r.__area = area;
        r.__tipo = tipo;
        r.__ilegal = ilegal;
        r.__inst = inst;
        r.__durH = duracionHoras(r);
        r.__coordOk = coordOk;

        return r;
      });

      llenarSelect(fGuarda, uniqueSorted(DATA.map(r=>r.__guarda)), "Todos los guardas");
      llenarSelect(fMuni, uniqueSorted(DATA.map(r=>r.__muni)), "Todos los municipios");
      llenarSelect(fRegion, uniqueSorted(DATA.map(r=>r.__region)), "Todas las regiones");
      llenarSelect(fArea, uniqueSorted(DATA.map(r=>r.__area)), "Todas las áreas");
      llenarSelect(fTipo, uniqueSorted(DATA.map(r=>r.__tipo)), "Todos los tipos");

      cacheOptions(fGuarda, "Todos los guardas");
      cacheOptions(fMuni, "Todos los municipios");
      cacheOptions(fRegion, "Todas las regiones");
      cacheOptions(fArea, "Todas las áreas");
      cacheOptions(fTipo, "Todos los tipos");

      const meses = uniqueSorted(DATA.map(r=>r.__ym).filter(Boolean));
      fMes.innerHTML = "";
      fMes.appendChild(new Option("Todos los meses","todo"));
      meses.forEach(m=>fMes.appendChild(new Option(m,m)));

      const semanas = uniqueSorted(DATA.map(r=>r.__yw).filter(Boolean));
      fSemana.innerHTML = "";
      fSemana.appendChild(new Option("Todas las semanas","todo"));
      semanas.forEach(w=>fSemana.appendChild(new Option(w,w)));

      applyURLToControls();

      estado.textContent = `Listo. ${DATA.length.toLocaleString("es")} registros cargados.`;
      refrescar(true);
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      try{
        wire();
        load().catch(err=>{
          console.error(err);
          estado.textContent = "Error inicializando el tablero: " + err.message;
          showToast("Error: " + err.message);
        });
      }catch(err){
        console.error(err);
        estado.textContent = "Error inicializando el tablero: " + err.message;
        showToast("Error: " + err.message);
      }
    });
  </script>
</body>
</html>
